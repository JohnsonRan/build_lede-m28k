diff --git a/feeds.conf.default b/feeds.conf.default
index 98dcb2aa..d3869573 100644
--- a/feeds.conf.default
+++ b/feeds.conf.default
@@ -1,8 +1,8 @@
-src-git packages https://github.com/coolsnowwolf/packages
+src-git packages https://github.com/openwrt/packages;openwrt-24.10
 #src-git luci https://github.com/coolsnowwolf/luci
 src-git luci https://github.com/coolsnowwolf/luci.git;openwrt-23.05
-src-git routing https://github.com/coolsnowwolf/routing
-src-git telephony https://github.com/coolsnowwolf/telephony.git
+src-git routing https://github.com/openwrt/routing;openwrt-24.10
+src-git telephony https://github.com/openwrt/telephony.git;openwrt-24.10
 #src-git helloworld https://github.com/fw876/helloworld.git
 #src-git oui https://github.com/zhaojh329/oui.git
 #src-git video https://github.com/openwrt/video.git
diff --git a/include/target.mk b/include/target.mk
index 64d0f394..660be3d2 100644
--- a/include/target.mk
+++ b/include/target.mk
@@ -267,6 +267,10 @@ ifeq ($(DUMP),1)
     CPU_CFLAGS := -O2 -pipe
     CPU_CFLAGS_generic:=-march=loongarch64
   endif
+  ifeq ($(BOARD),rockchip)
+    CPU_CFLAGS = -O3 -Wl,--gc-sections -pipe
+    CPU_CFLAGS_generic = -march=armv8-a+crc+crypto
+  endif
   ifneq ($(CPU_TYPE),)
     ifndef CPU_CFLAGS_$(CPU_TYPE)
       $(warning CPU_TYPE "$(CPU_TYPE)" doesn't correspond to a known type)
diff --git a/package/base-files/files/bin/config_generate b/package/base-files/files/bin/config_generate
index 52fd105f..da58ce63 100755
--- a/package/base-files/files/bin/config_generate
+++ b/package/base-files/files/bin/config_generate
@@ -147,7 +147,7 @@ generate_network() {
 		static)
 			local ipad
 			case "$1" in
-				lan) ipad=${ipaddr:-"192.168.1.1"} ;;
+				lan) ipad=${ipaddr:-"172.20.10.1"} ;;
 				*) ipad=${ipaddr:-"192.168.$((addr_offset++)).1"} ;;
 			esac
 
diff --git a/package/libs/elfutils/Makefile b/package/libs/elfutils/Makefile
index a32dd704..472237fb 100644
--- a/package/libs/elfutils/Makefile
+++ b/package/libs/elfutils/Makefile
@@ -22,7 +22,6 @@ PKG_CPE_ID:=cpe:/a:elfutils_project:elfutils
 
 PKG_FIXUP:=autoreconf
 PKG_INSTALL:=1
-PKG_USE_MIPS16:=1
 PKG_BUILD_DEPENDS:=!USE_GLIBC:argp-standalone
 
 include $(INCLUDE_DIR)/package.mk
@@ -87,9 +86,10 @@ CONFIGURE_VARS += \
 TARGET_CFLAGS += \
 	-D_GNU_SOURCE \
 	-Wno-unused-result \
-	-Wno-format-nonliteral
+	-Wno-format-nonliteral \
+	-Wno-error
 
-ifneq ($(filter $(GCC_MAJOR_VERSION),12 13),)
+ifneq ($(CONFIG_GCC_USE_VERSION_11),y)
 TARGET_CFLAGS += \
 	-Wno-error=use-after-free
 endif
diff --git a/package/libs/pcre/Config.in b/package/libs/pcre/Config.in
deleted file mode 100644
index 15e75fc7..00000000
--- a/package/libs/pcre/Config.in
+++ /dev/null
@@ -1,11 +0,0 @@
-config PCRE_JIT_ENABLED
-	bool
-	depends on PACKAGE_libpcre && (arm || i386 || i686 || x86_64 || mips || mipsel || powerpc || sparc)
-	default y if (arm || i686 || x86_64)
-	prompt "Enable JIT compiler support"
-	help
-		Enable JIT (Just-In-Time) compiler support.
-
-		Enabling this option can give an about 10x performance increase on JIT operations. It can be desireable for e.g. high performance Apache mod_rewrite or HA-Proxy reqrep operations.
-
-		However, JIT should _only_ be enabled on architectures that are supported. Enabling JIT on unsupported platforms will result in a compilation failure. A list of supported architectures can be found here: https://pcre.org/original/doc/html/pcrejit.html#SEC3 .
diff --git a/package/libs/pcre/Makefile b/package/libs/pcre/Makefile
deleted file mode 100644
index 894f39b7..00000000
--- a/package/libs/pcre/Makefile
+++ /dev/null
@@ -1,129 +0,0 @@
-#
-# Copyright (C) 2006-2015 OpenWrt.org
-#
-# This is free software, licensed under the GNU General Public License v2.
-# See /LICENSE for more information.
-#
-
-include $(TOPDIR)/rules.mk
-
-PKG_NAME:=pcre
-PKG_VERSION:=8.45
-PKG_RELEASE:=$(AUTORELEASE)
-
-PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.bz2
-PKG_SOURCE_URL:=@SF/$(PKG_NAME)
-PKG_HASH:=4dae6fdcd2bb0bb6c37b5f97c33c2be954da743985369cddac3546e3218bffb8
-
-PKG_MAINTAINER:=Thomas Heil <heil@terminal-consulting.de>
-PKG_LICENSE:=BSD-3-Clause
-PKG_LICENSE_FILES:=LICENCE
-PKG_CPE_ID:=cpe:/a:pcre:pcre
-
-PKG_INSTALL:=1
-PKG_BUILD_PARALLEL:=1
-
-PKG_CONFIG_DEPENDS:=\
-	CONFIG_PACKAGE_libpcrecpp \
-	CONFIG_PCRE_JIT_ENABLED
-
-include $(INCLUDE_DIR)/package.mk
-include $(INCLUDE_DIR)/host-build.mk
-
-define Package/libpcre/default
-  SECTION:=libs
-  CATEGORY:=Libraries
-  URL:=https://www.pcre.org/
-endef
-
-define Package/libpcre/config
-  source "$(SOURCE)/Config.in"
-endef
-
-define Package/libpcre
-  $(call Package/libpcre/default)
-  TITLE:=A Perl Compatible Regular Expression library
-endef
-
-define Package/libpcre16
-  $(call Package/libpcre/default)
-  TITLE:=A Perl Compatible Regular Expression library (16bit support)
-endef
-
-define Package/libpcre32
-  $(call Package/libpcre/default)
-  TITLE:=A Perl Compatible Regular Expression library (32bit support)
-endef
-
-define Package/libpcrecpp
-  $(call Package/libpcre/default)
-  TITLE:=C++ wrapper for Perl Compatible Regular Expression library
-  DEPENDS:=+libpcre +libstdcpp
-endef
-
-HOST_CONFIGURE_ARGS += \
-	--disable-shared \
-	--enable-utf8 \
-	--enable-unicode-properties \
-	--enable-pcre16 \
-	--with-match-limit-recursion=16000 \
-	--enable-cpp \
-	--with-pic
-
-CONFIGURE_ARGS += \
-	--enable-utf8 \
-	--enable-unicode-properties \
-	--enable-pcre16 \
-	--enable-pcre32 \
-	$(if $(CONFIG_PCRE_JIT_ENABLED),--enable-jit,--disable-jit) \
-	--with-match-limit-recursion=16000 \
-	--$(if $(CONFIG_PACKAGE_libpcrecpp),en,dis)able-cpp \
-	--with-pic
-
-MAKE_FLAGS += \
-	CFLAGS="$(TARGET_CFLAGS)"
-
-define Build/InstallDev
-	$(INSTALL_DIR) $(1)/usr/bin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/pcre-config $(1)/usr/bin/
-	$(SED) 's,^\(prefix\|exec_prefix\)=.*,\1=$(STAGING_DIR)/usr,g' $(1)/usr/bin/pcre-config
-
-	$(INSTALL_DIR) $(2)/bin
-	$(LN) $(STAGING_DIR)/usr/bin/pcre-config $(2)/bin
-
-	$(INSTALL_DIR) $(1)/usr/include
-	$(CP) $(PKG_INSTALL_DIR)/usr/include/pcre*.h $(1)/usr/include/
-
-	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libpcre*.{a,so*} $(1)/usr/lib/
-
-	$(INSTALL_DIR) $(1)/usr/lib/pkgconfig
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/libpcre*.pc $(1)/usr/lib/pkgconfig/
-endef
-
-define Package/libpcre/install
-	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libpcre{,posix}.so.* $(1)/usr/lib/
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libpcre.so $(1)/usr/lib/
-endef
-
-define Package/libpcre16/install
-	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libpcre16.so* $(1)/usr/lib/
-endef
-
-define Package/libpcre32/install
-	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libpcre32.so* $(1)/usr/lib/
-endef
-
-define Package/libpcrecpp/install
-	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libpcrecpp.so.* $(1)/usr/lib/
-endef
-
-$(eval $(call BuildPackage,libpcre))
-$(eval $(call BuildPackage,libpcre16))
-$(eval $(call BuildPackage,libpcre32))
-$(eval $(call BuildPackage,libpcrecpp))
-$(eval $(call HostBuild))
diff --git a/package/network/services/ppp/Makefile b/package/network/services/ppp/Makefile
index 419136ca..760a31dc 100644
--- a/package/network/services/ppp/Makefile
+++ b/package/network/services/ppp/Makefile
@@ -9,27 +9,38 @@ include $(TOPDIR)/rules.mk
 include $(INCLUDE_DIR)/kernel.mk
 
 PKG_NAME:=ppp
-PKG_RELEASE:=6
+PKG_VERSION:=2.5.1
+PKG_RELEASE:=1
 
 PKG_SOURCE_PROTO:=git
-PKG_SOURCE_URL:=https://github.com/paulusmack/ppp
-PKG_SOURCE_DATE:=2021-01-04
-PKG_SOURCE_VERSION:=4fb319056f168bb8379865b91b4fd3e1ada73f1e
-PKG_MIRROR_HASH:=429cb5fcff36e1d8698766130711d4764347f08b83233dfb4831bea21616efef
+PKG_SOURCE_URL:=https://github.com/ppp-project/ppp
+PKG_SOURCE_DATE:=2024-09-18
+PKG_SOURCE_VERSION:=d5aeec65752d4a9b3bb46771d0b221c4a4a6539e
+PKG_MIRROR_HASH:=b98125933d8160ff3476b053414e787e65a94948c0ecee53f6261cd403ff4b03
+
 PKG_MAINTAINER:=Felix Fietkau <nbd@nbd.name>
 PKG_LICENSE:=BSD-4-Clause
 PKG_CPE_ID:=cpe:/a:samba:ppp
 
-PKG_RELEASE_VERSION:=2.4.9
-PKG_VERSION:=$(PKG_RELEASE_VERSION).git-$(PKG_SOURCE_DATE)
-
-PKG_BUILD_DEPENDS:=libpcap
-
 PKG_ASLR_PIE_REGULAR:=1
+PKG_BUILD_DEPENDS:=libpcap
+PKG_BUILD_FLAGS:=gc-sections lto
 PKG_BUILD_PARALLEL:=1
+PKG_FIXUP:=autoreconf
 PKG_INSTALL:=1
 
 include $(INCLUDE_DIR)/package.mk
+CONFIGURE_VARS += \
+	enable_eaptls=no \
+	enable_microsoft_extensions=yes \
+	enable_peap=no
+
+CONFIGURE_ARGS += \
+	with_openssl=no \
+	with_pam=no \
+	with_pcap=no \
+	with_srp=no \
+	with_static_pcap=yes
 
 define Package/ppp/Default
   SECTION:=net
@@ -39,7 +50,7 @@ endef
 
 define Package/ppp
 $(call Package/ppp/Default)
-  DEPENDS:=+kmod-ppp +libpthread +shellsync +kmod-mppe
+  DEPENDS:=+kmod-ppp
   TITLE:=PPP daemon
   VARIANT:=default
 endef
@@ -173,54 +184,25 @@ This tool performs the same discovery process as pppoe, but does
 not initiate a session. Can be useful to debug pppoe.
 endef
 
-
-define Build/Configure
-$(call Build/Configure/Default,, \
-	UNAME_S="Linux" \
-	UNAME_R="$(LINUX_VERSION)" \
-	UNAME_M="$(ARCH)" \
-)
-	mkdir -p $(PKG_BUILD_DIR)/pppd/plugins/pppoatm/linux
-	$(CP) \
-		$(LINUX_DIR)/include/linux/compiler.h \
-		$(LINUX_DIR)/include/$(LINUX_UAPI_DIR)linux/atm*.h \
-		$(PKG_BUILD_DIR)/pppd/plugins/pppoatm/linux/
-
-	# Kernel 4.14.9+ only, ignore the exit status of cp in case the file
-	# doesn't exits
-	-$(CP) $(LINUX_DIR)/include/linux/compiler_types.h \
-		$(PKG_BUILD_DIR)/pppd/plugins/pppoatm/linux/
-endef
-
-TARGET_CFLAGS += -ffunction-sections -fdata-sections -flto
-TARGET_LDFLAGS += -Wl,--gc-sections -flto -fuse-linker-plugin
-
-MAKE_FLAGS += COPTS="$(TARGET_CFLAGS)" \
-		PRECOMPILED_FILTER=1 \
-		STAGING_DIR="$(STAGING_DIR)"
-
 ifeq ($(BUILD_VARIANT),multilink)
-  MAKE_FLAGS += HAVE_MULTILINK=y
-else
-  MAKE_FLAGS += HAVE_MULTILINK=
-endif
-
-ifdef CONFIG_USE_MUSL
-  MAKE_FLAGS += USE_LIBUTIL=
+  CONFIGURE_VARS += \
+	enable_multilink=yes
 endif
 
 define Build/InstallDev
 	$(INSTALL_DIR) $(1)/usr/include
-	$(CP) $(PKG_INSTALL_DIR)/include/pppd $(1)/usr/include/
+	$(CP) $(PKG_INSTALL_DIR)/usr/include/pppd $(1)/usr/include/
+	$(INSTALL_DIR) $(1)/usr/lib/pkgconfig
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/*.pc $(1)/usr/lib/pkgconfig
 endef
 
 define Package/ppp/script_install
 endef
 
 define Package/ppp/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
 	$(INSTALL_DIR) $(1)/usr/sbin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/sbin/pppd $(1)/usr/sbin/
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/pppd $(1)/usr/sbin/
 	$(INSTALL_DIR) $(1)/etc/ppp
 	$(INSTALL_CONF) ./files/etc/ppp/chap-secrets $(1)/etc/ppp/
 	$(INSTALL_DATA) ./files/etc/ppp/filter $(1)/etc/ppp/
@@ -235,21 +217,21 @@ endef
 Package/ppp-multilink/install=$(Package/ppp/install)
 
 define Package/ppp-mod-pppoa/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/lib/pppd/$(PKG_RELEASE_VERSION)/pppoatm.so \
-		$(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)/
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/pppd/$(PKG_VERSION)/pppoatm.so \
+		$(1)/usr/lib/pppd/$(PKG_VERSION)/
 endef
 
 define Package/ppp-mod-pppoe/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/lib/pppd/$(PKG_RELEASE_VERSION)/pppoe.so \
-		$(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)/
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/pppd/$(PKG_VERSION)/pppoe.so \
+		$(1)/usr/lib/pppd/$(PKG_VERSION)/
 endef
 
 define Package/ppp-mod-radius/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/lib/pppd/$(PKG_RELEASE_VERSION)/radius.so \
-		$(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)/
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/pppd/$(PKG_VERSION)/radius.so \
+		$(1)/usr/lib/pppd/$(PKG_VERSION)/
 	$(INSTALL_DIR) $(1)/etc/ppp
 	$(INSTALL_DATA) ./files/etc/ppp/radius.conf $(1)/etc/ppp/
 	$(INSTALL_DIR) $(1)/etc/ppp/radius
@@ -260,43 +242,43 @@ define Package/ppp-mod-radius/install
 endef
 
 define Package/ppp-mod-pppol2tp/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/lib/pppd/$(PKG_RELEASE_VERSION)/pppol2tp.so \
-		$(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)/
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/pppd/$(PKG_VERSION)/pppol2tp.so \
+		$(1)/usr/lib/pppd/$(PKG_VERSION)/
 endef
 
 define Package/ppp-mod-pptp/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/lib/pppd/$(PKG_RELEASE_VERSION)/pptp.so \
-		$(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)/
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/pppd/$(PKG_VERSION)/pptp.so \
+		$(1)/usr/lib/pppd/$(PKG_VERSION)/
 	$(INSTALL_DIR) $(1)/etc/ppp
 	$(INSTALL_DATA) ./files/etc/ppp/options.pptp $(1)/etc/ppp/
 endef
 
 define Package/ppp-mod-passwordfd/install
-	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/lib/pppd/$(PKG_RELEASE_VERSION)/passwordfd.so \
-		$(1)/usr/lib/pppd/$(PKG_RELEASE_VERSION)/
+	$(INSTALL_DIR) $(1)/usr/lib/pppd/$(PKG_VERSION)
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/pppd/$(PKG_VERSION)/passwordfd.so \
+		$(1)/usr/lib/pppd/$(PKG_VERSION)/
 endef
 
 define Package/chat/install
 	$(INSTALL_DIR) $(1)/usr/sbin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/sbin/chat $(1)/usr/sbin/
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/chat $(1)/usr/sbin/
 endef
 
 define Package/pppdump/install
 	$(INSTALL_DIR) $(1)/usr/sbin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/sbin/pppdump $(1)/usr/sbin/
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/pppdump $(1)/usr/sbin/
 endef
 
 define Package/pppstats/install
 	$(INSTALL_DIR) $(1)/usr/sbin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/sbin/pppstats $(1)/usr/sbin/
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/pppstats $(1)/usr/sbin/
 endef
 
 define Package/pppoe-discovery/install
 	$(INSTALL_DIR) $(1)/usr/sbin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/sbin/pppoe-discovery $(1)/usr/sbin/
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/pppoe-discovery $(1)/usr/sbin/
 endef
 
 $(eval $(call BuildPackage,ppp))
diff --git a/package/network/services/ppp/files/lib/netifd/ppp6-up b/package/network/services/ppp/files/lib/netifd/ppp6-up
index 3852bf63..51339ad3 100755
--- a/package/network/services/ppp/files/lib/netifd/ppp6-up
+++ b/package/network/services/ppp/files/lib/netifd/ppp6-up
@@ -27,6 +27,8 @@ if [ -n "$AUTOIPV6" ]; then
 	[ -n "$EXTENDPREFIX" ] && json_add_string extendprefix 1
 	[ -n "$IP6TABLE" ] && json_add_string ip6table $IP6TABLE
 	[ -n "$PEERDNS" ] && json_add_boolean peerdns $PEERDNS
+	[ "$NOSOURCEFILTER" = "1" ] && json_add_boolean sourcefilter "0"
+	[ "$DELEGATE" = "0" ] && json_add_boolean delegate "0"
 	json_close_object
 	ubus call network add_dynamic "$(json_dump)"
 fi
diff --git a/package/network/services/ppp/files/ppp.sh b/package/network/services/ppp/files/ppp.sh
index f6c43b57..d7c0cdb1 100755
--- a/package/network/services/ppp/files/ppp.sh
+++ b/package/network/services/ppp/files/ppp.sh
@@ -82,13 +82,15 @@ ppp_generic_init_config() {
 	proto_config_add_boolean persist
 	proto_config_add_int maxfail
 	proto_config_add_int holdoff
+	proto_config_add_boolean sourcefilter
+	proto_config_add_boolean delegate
 }
 
 ppp_generic_setup() {
 	local config="$1"; shift
 	local localip
 
-	json_get_vars ip6table demand keepalive keepalive_adaptive username password pppd_options pppname unnumbered persist maxfail holdoff peerdns
+	json_get_vars ip6table demand keepalive keepalive_adaptive username password pppd_options pppname unnumbered persist maxfail holdoff peerdns sourcefilter delegate
 
 	[ ! -e /proc/sys/net/ipv6 ] && ipv6=0 || json_get_var ipv6 ipv6
 
@@ -133,6 +135,8 @@ ppp_generic_setup() {
 	[ "${keepalive_adaptive:-1}" -lt 1 ] && lcp_adaptive=""
 	[ -n "$connect" ] || json_get_var connect connect
 	[ -n "$disconnect" ] || json_get_var disconnect disconnect
+	[ "$sourcefilter" = "0" ] || sourcefilter=""
+	[ "$delegate" != "0" ] && delegate=""
 
 	proto_run_command "$config" /usr/sbin/pppd \
 		nodetach ipparam "$config" \
@@ -143,6 +147,8 @@ ppp_generic_setup() {
 		${autoipv6:+set AUTOIPV6=1} \
 		${ip6table:+set IP6TABLE=$ip6table} \
 		${peerdns:+set PEERDNS=$peerdns} \
+		${sourcefilter:+set NOSOURCEFILTER=1} \
+		${delegate:+set DELEGATE=0} \
 		nodefaultroute \
 		usepeerdns \
 		$demand $persist maxfail $maxfail \
@@ -231,16 +237,7 @@ proto_pppoe_setup() {
 	json_get_var padi_attempts padi_attempts
 	json_get_var padi_timeout padi_timeout
 
-#By 蝈蝈：并发拨号同步的前期准备
-	syncppp_option=""
-	[ "$(uci get syncdial.config.enabled)" -eq "1" ] && {
-		ppp_if_cnt=$(uci show network | grep -c "\.proto=\'pppoe\'$")
-		syncppp_option="syncppp $ppp_if_cnt"
-		shellsync $ppp_if_cnt 10
-	}
-
 	ppp_generic_setup "$config" \
-		$syncppp_option \
 		plugin pppoe.so \
 		${ac:+rp_pppoe_ac "$ac"} \
 		${service:+rp_pppoe_service "$service"} \
diff --git a/package/network/services/ppp/patches/010-use_target_for_configure.patch b/package/network/services/ppp/patches/010-use_target_for_configure.patch
deleted file mode 100644
index 9e8618f8..00000000
--- a/package/network/services/ppp/patches/010-use_target_for_configure.patch
+++ /dev/null
@@ -1,24 +0,0 @@
-configure: Allow overriding uname results
-
-In a cross compile setting it makes no sense to rely on the "uname" values
-reported by the build host system. This patch allows overriding the
-"uname -r", "uname -s" and "uname -m" results with the "UNAME_R", "UNAME_S"
-and "UNAME_M" environment variables.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/configure
-+++ b/configure
-@@ -10,9 +10,9 @@ CROSS_COMPILE=
- CC=cc
- CFLAGS=
- 
--system=`uname -s`
--release=`uname -r`
--arch=`uname -m`
-+system=${UNAME_S:-`uname -s`}
-+release=${UNAME_R:-`uname -r`}
-+arch=${UNAME_M:-`uname -m`}
- state="unknown"
- 
- case $system in
diff --git a/package/network/services/ppp/patches/105-debian_demand.patch b/package/network/services/ppp/patches/105-debian_demand.patch
index ff66aa8e..10ce13b2 100644
--- a/package/network/services/ppp/patches/105-debian_demand.patch
+++ b/package/network/services/ppp/patches/105-debian_demand.patch
@@ -1,6 +1,6 @@
 --- a/pppd/demand.c
 +++ b/pppd/demand.c
-@@ -36,6 +36,8 @@
+@@ -40,6 +40,8 @@
  #include <errno.h>
  #include <fcntl.h>
  #include <netdb.h>
@@ -9,16 +9,16 @@
  #include <sys/param.h>
  #include <sys/types.h>
  #include <sys/wait.h>
-@@ -43,6 +45,8 @@
+@@ -47,6 +49,8 @@
  #include <sys/resource.h>
  #include <sys/stat.h>
  #include <sys/socket.h>
 +#include <netinet/in.h>
 +#include <arpa/inet.h>
- #ifdef PPP_FILTER
+ #ifdef PPP_WITH_FILTER
  #include <pcap-bpf.h>
  #endif
-@@ -218,6 +222,14 @@ loop_chars(unsigned char *p, int n)
+@@ -223,6 +227,14 @@ loop_chars(unsigned char *p, int n)
      int c, rv;
  
      rv = 0;
@@ -33,7 +33,7 @@
      for (; n > 0; --n) {
  	c = *p++;
  	if (c == PPP_FLAG) {
-@@ -294,16 +306,100 @@ loop_frame(unsigned char *frame, int len
+@@ -299,16 +311,100 @@ loop_frame(unsigned char *frame, int len
   * loopback, now that the real serial link is up.
   */
  void
@@ -137,7 +137,7 @@
  	} else {
 --- a/pppd/ipcp.c
 +++ b/pppd/ipcp.c
-@@ -1850,7 +1850,7 @@ ipcp_up(fsm *f)
+@@ -1915,7 +1915,7 @@ ipcp_up(fsm *f)
  		    proxy_arp_set[f->unit] = 1;
  
  	}
@@ -148,7 +148,7 @@
      } else {
 --- a/pppd/ipv6cp.c
 +++ b/pppd/ipv6cp.c
-@@ -1253,7 +1253,7 @@ ipv6cp_up(fsm *f)
+@@ -1338,7 +1338,7 @@ ipv6cp_up(fsm *f)
  		if (sif6defaultroute(f->unit, go->ourid, ho->hisid))
  		    default_route_set[f->unit] = 1;
  	}
@@ -157,14 +157,14 @@
  	sifnpmode(f->unit, PPP_IPV6, NPMODE_PASS);
  
      } else {
---- a/pppd/pppd.h
-+++ b/pppd/pppd.h
-@@ -598,7 +598,7 @@ void demand_conf(void);	/* config interf
+--- a/pppd/pppd-private.h
++++ b/pppd/pppd-private.h
+@@ -368,7 +368,7 @@ void demand_conf(void);	/* config interf
  void demand_block(void);	/* set all NPs to queue up packets */
  void demand_unblock(void); /* set all NPs to pass packets */
  void demand_discard(void); /* set all NPs to discard packets */
 -void demand_rexmit(int);	/* retransmit saved frames for an NP */
-+void demand_rexmit(int, u_int32_t); /* retransmit saved frames for an NP*/
++void demand_rexmit(int, u_int32_t); /* retransmit saved frames for an NP */
  int  loop_chars(unsigned char *, int); /* process chars from loopback */
  int  loop_frame(unsigned char *, int); /* should we bring link up? */
  
diff --git a/package/network/services/ppp/patches/120-debian_ipv6_updown_option.patch b/package/network/services/ppp/patches/120-debian_ipv6_updown_option.patch
deleted file mode 100644
index 11e8d81f..00000000
--- a/package/network/services/ppp/patches/120-debian_ipv6_updown_option.patch
+++ /dev/null
@@ -1,95 +0,0 @@
-pppd: Allow specifying ipv6-up and ipv6-down scripts
-
-This patch implements the "ipv6-up-script" and "ipv6-down-script" options
-which allow to specify the path of the ipv6-up and ipv6-down scripts to call.
-
-These options default to _PATH_IPV6UP and _PATH_IPV6DOWN to retain the
-existing behaviour.
-
-The patch originated from the Debian project.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/main.c
-+++ b/pppd/main.c
-@@ -295,6 +295,8 @@ main(int argc, char *argv[])
- 
-     strlcpy(path_ipup, _PATH_IPUP, sizeof(path_ipup));
-     strlcpy(path_ipdown, _PATH_IPDOWN, sizeof(path_ipdown));
-+    strlcpy(path_ipv6up, _PATH_IPV6UP, sizeof(path_ipv6up));
-+    strlcpy(path_ipv6down, _PATH_IPV6DOWN, sizeof(path_ipv6down));
- 
-     link_stats_valid = 0;
-     new_phase(PHASE_INITIALIZE);
---- a/pppd/options.c
-+++ b/pppd/options.c
-@@ -118,6 +118,8 @@ int	req_unit = -1;		/* requested interfa
- char	path_ipup[MAXPATHLEN];	/* pathname of ip-up script */
- char	path_ipdown[MAXPATHLEN];/* pathname of ip-down script */
- char	req_ifname[MAXIFNAMELEN];	/* requested interface name */
-+char	path_ipv6up[MAXPATHLEN];	/* pathname of ipv6-up script */
-+char	path_ipv6down[MAXPATHLEN];/* pathname of ipv6-down script */
- bool	multilink = 0;		/* Enable multilink operation */
- char	*bundle_name = NULL;	/* bundle name for multilink */
- bool	dump_options;		/* print out option values */
-@@ -324,6 +326,13 @@ option_t general_options[] = {
-       "Set pathname of ip-down script",
-       OPT_PRIV|OPT_STATIC, NULL, MAXPATHLEN },
- 
-+    { "ipv6-up-script", o_string, path_ipv6up,
-+      "Set pathname of ipv6-up script",
-+      OPT_PRIV|OPT_STATIC, NULL, MAXPATHLEN },
-+    { "ipv6-down-script", o_string, path_ipv6down,
-+      "Set pathname of ipv6-down script",
-+      OPT_PRIV|OPT_STATIC, NULL, MAXPATHLEN },
-+
- #ifdef HAVE_MULTILINK
-     { "multilink", o_bool, &multilink,
-       "Enable multilink operation", OPT_PRIO | 1 },
---- a/pppd/ipv6cp.c
-+++ b/pppd/ipv6cp.c
-@@ -1295,7 +1295,7 @@ ipv6cp_up(fsm *f)
-      */
-     if (ipv6cp_script_state == s_down && ipv6cp_script_pid == 0) {
- 	ipv6cp_script_state = s_up;
--	ipv6cp_script(_PATH_IPV6UP);
-+	ipv6cp_script(path_ipv6up);
-     }
- }
- 
-@@ -1346,7 +1346,7 @@ ipv6cp_down(fsm *f)
-     /* Execute the ipv6-down script */
-     if (ipv6cp_script_state == s_up && ipv6cp_script_pid == 0) {
- 	ipv6cp_script_state = s_down;
--	ipv6cp_script(_PATH_IPV6DOWN);
-+	ipv6cp_script(path_ipv6down);
-     }
- }
- 
-@@ -1384,13 +1384,13 @@ ipv6cp_script_done(void *arg)
-     case s_up:
- 	if (ipv6cp_fsm[0].state != OPENED) {
- 	    ipv6cp_script_state = s_down;
--	    ipv6cp_script(_PATH_IPV6DOWN);
-+	    ipv6cp_script(path_ipv6down);
- 	}
- 	break;
-     case s_down:
- 	if (ipv6cp_fsm[0].state == OPENED) {
- 	    ipv6cp_script_state = s_up;
--	    ipv6cp_script(_PATH_IPV6UP);
-+	    ipv6cp_script(path_ipv6up);
- 	}
- 	break;
-     }
---- a/pppd/pppd.h
-+++ b/pppd/pppd.h
-@@ -328,6 +328,8 @@ extern int	req_unit;	/* interface unit n
- extern char	path_ipup[MAXPATHLEN]; /* pathname of ip-up script */
- extern char	path_ipdown[MAXPATHLEN]; /* pathname of ip-down script */
- extern char	req_ifname[MAXIFNAMELEN]; /* interface name to use */
-+extern char	path_ipv6up[MAXPATHLEN]; /* pathname of ipv6-up script */
-+extern char	path_ipv6down[MAXPATHLEN]; /* pathname of ipv6-down script */
- extern bool	multilink;	/* enable multilink operation */
- extern bool	noendpoint;	/* don't send or accept endpt. discrim. */
- extern char	*bundle_name;	/* bundle name for multilink */
diff --git a/package/network/services/ppp/patches/133-fix_sha1_include.patch b/package/network/services/ppp/patches/133-fix_sha1_include.patch
deleted file mode 100644
index 357d9514..00000000
--- a/package/network/services/ppp/patches/133-fix_sha1_include.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/pppd/sha1.c
-+++ b/pppd/sha1.c
-@@ -19,7 +19,7 @@
- #include <string.h>
- #include <time.h>
- #include <netinet/in.h>	/* htonl() */
--#include <net/ppp_defs.h>
-+#include "pppd.h"
- #include "sha1.h"
- 
- static void
diff --git a/package/network/services/ppp/patches/200-makefile.patch b/package/network/services/ppp/patches/200-makefile.patch
deleted file mode 100644
index d0b9a9a9..00000000
--- a/package/network/services/ppp/patches/200-makefile.patch
+++ /dev/null
@@ -1,56 +0,0 @@
-pppd: tune Linux config defaults for OpenWrt
-
-This patch adjusts a number defaults to properly match the OpenWrt environment.
-It is not intended for upstream.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/Makefile.linux
-+++ b/pppd/Makefile.linux
-@@ -49,7 +49,7 @@ MPPE=y
- # Uncomment the next line to include support for PPP packet filtering.
- # This requires that the libpcap library and headers be installed
- # and that the kernel driver support PPP packet filtering.
--FILTER=y
-+#FILTER=y
- 
- # Uncomment the next line to enable multilink PPP (enabled by default)
- # Linux distributions: Please leave multilink ENABLED in your builds
-@@ -59,7 +59,7 @@ HAVE_MULTILINK=y
- # Uncomment the next line to enable the TDB database (enabled by default.)
- # If you enable multilink, then TDB is automatically enabled also.
- # Linux distributions: Please leave TDB ENABLED in your builds.
--USE_TDB=y
-+#USE_TDB=y
- 
- # Uncomment the next line to enable Type=notify services in systemd
- # If enabled, and the user sets the up_sdnotify option, then
-@@ -85,13 +85,13 @@ USE_LIBUTIL=y
- endif
- 
- # Enable EAP-TLS authentication (requires MPPE support, libssl and libcrypto)
--USE_EAPTLS=y
-+#USE_EAPTLS=y
- 
- MAXOCTETS=y
- 
- INCLUDE_DIRS= -I../include
- 
--COMPILE_FLAGS= -DHAVE_PATHS_H -DIPX_CHANGE -DHAVE_MMAP -pipe
-+COMPILE_FLAGS= -DHAVE_PATHS_H -DHAVE_MMAP -pipe
- 
- CFLAGS= $(COPTS) $(COMPILE_FLAGS) $(INCLUDE_DIRS) '-DDESTDIR="@DESTDIR@"'
- 
-@@ -143,10 +143,10 @@ CFLAGS   += -DHAS_SHADOW
- #LIBS     += -lshadow $(LIBS)
- endif
- 
--ifeq ($(shell echo '\#include <crypt.h>' | $(CC) -E - >/dev/null 2>&1 && echo yes),yes)
-+#ifeq ($(shell echo '\#include <crypt.h>' | $(CC) -E - >/dev/null 2>&1 && echo yes),yes)
- CFLAGS  += -DHAVE_CRYPT_H=1
- LIBS	+= -lcrypt
--endif
-+#endif
- 
- ifdef USE_LIBUTIL
- CFLAGS	+= -DHAVE_LOGWTMP=1
diff --git a/package/network/services/ppp/patches/201-mppe_mppc_1.1.patch b/package/network/services/ppp/patches/201-mppe_mppc_1.1.patch
deleted file mode 100644
index 3c30517e..00000000
--- a/package/network/services/ppp/patches/201-mppe_mppc_1.1.patch
+++ /dev/null
@@ -1,1518 +0,0 @@
-pppd: add support for MPPE and MPPC encryption and compression protocols
-
-This is a forward ported version of ppp-2.4.3-mppe-mppc-1.1.patch.gz found on
-http://mppe-mppc.alphacron.de/ .
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/include/linux/ppp-comp.h
-+++ b/include/linux/ppp-comp.h
-@@ -36,7 +36,7 @@
-  */
- 
- /*
-- *  ==FILEVERSION 20020319==
-+ *  ==FILEVERSION 20020715==
-  *
-  *  NOTE TO MAINTAINERS:
-  *     If you modify this file at all, please set the above date.
-@@ -201,6 +201,33 @@ struct compressor {
- #define CI_MPPE			18	/* config option for MPPE */
- #define CILEN_MPPE		6	/* length of config option */
- 
-+/* MPPE/MPPC definitions by J.D.*/
-+#define MPPE_STATELESS          MPPE_H_BIT	/* configuration bit H */
-+#define MPPE_40BIT              MPPE_L_BIT	/* configuration bit L */
-+#define MPPE_56BIT              MPPE_M_BIT	/* configuration bit M */
-+#define MPPE_128BIT             MPPE_S_BIT	/* configuration bit S */
-+#define MPPE_MPPC               MPPE_C_BIT	/* configuration bit C */
-+
-+/*
-+ * Definitions for Stac LZS.
-+ */
-+
-+#define CI_LZS			17	/* config option for Stac LZS */
-+#define CILEN_LZS		5	/* length of config option */
-+
-+#define LZS_OVHD		4	/* max. LZS overhead */
-+#define LZS_HIST_LEN		2048	/* LZS history size */
-+#define LZS_MAX_CCOUNT		0x0FFF	/* max. coherency counter value */
-+
-+#define LZS_MODE_NONE		0
-+#define LZS_MODE_LCB		1
-+#define LZS_MODE_CRC		2
-+#define LZS_MODE_SEQ		3
-+#define LZS_MODE_EXT		4
-+
-+#define LZS_EXT_BIT_FLUSHED	0x80	/* bit A */
-+#define LZS_EXT_BIT_COMP	0x20	/* bit C */
-+
- /*
-  * Definitions for other, as yet unsupported, compression methods.
-  */
---- a/include/net/ppp-comp.h
-+++ b/include/net/ppp-comp.h
-@@ -168,6 +168,33 @@ struct compressor {
- #define CI_MPPE			18	/* config option for MPPE */
- #define CILEN_MPPE		6	/* length of config option */
- 
-+/* MPPE/MPPC definitions by J.D.*/
-+#define MPPE_STATELESS          MPPE_H_BIT	/* configuration bit H */
-+#define MPPE_40BIT              MPPE_L_BIT	/* configuration bit L */
-+#define MPPE_56BIT              MPPE_M_BIT	/* configuration bit M */
-+#define MPPE_128BIT             MPPE_S_BIT	/* configuration bit S */
-+#define MPPE_MPPC               MPPE_C_BIT	/* configuration bit C */
-+
-+/*
-+ * Definitions for Stac LZS.
-+ */
-+
-+#define CI_LZS			17	/* config option for Stac LZS */
-+#define CILEN_LZS		5	/* length of config option */
-+
-+#define LZS_OVHD		4	/* max. LZS overhead */
-+#define LZS_HIST_LEN		2048	/* LZS history size */
-+#define LZS_MAX_CCOUNT		0x0FFF	/* max. coherency counter value */
-+
-+#define LZS_MODE_NONE		0
-+#define LZS_MODE_LCB		1
-+#define LZS_MODE_CRC		2
-+#define LZS_MODE_SEQ		3
-+#define LZS_MODE_EXT		4
-+
-+#define LZS_EXT_BIT_FLUSHED	0x80	/* bit A */
-+#define LZS_EXT_BIT_COMP	0x20	/* bit C */
-+
- /*
-  * Definitions for other, as yet unsupported, compression methods.
-  */
---- a/pppd/ccp.c
-+++ b/pppd/ccp.c
-@@ -61,12 +61,10 @@ static int setdeflate (char **);
- static char bsd_value[8];
- static char deflate_value[8];
- 
--/*
-- * Option variables.
-- */
- #ifdef MPPE
--bool refuse_mppe_stateful = 1;		/* Allow stateful mode? */
--#endif
-+static int setmppe(char **);
-+static int setnomppe(void);
-+#endif /* MPPE */
- 
- static option_t ccp_option_list[] = {
-     { "noccp", o_bool, &ccp_protent.enabled_flag,
-@@ -107,54 +105,36 @@ static option_t ccp_option_list[] = {
-       "don't allow Predictor-1", OPT_ALIAS | OPT_PRIOSUB | OPT_A2CLR,
-       &ccp_allowoptions[0].predictor_1 },
- 
-+    { "lzs", o_bool, &ccp_wantoptions[0].lzs,
-+      "request Stac LZS", 1, &ccp_allowoptions[0].lzs, OPT_PRIO },
-+    { "+lzs", o_bool, &ccp_wantoptions[0].lzs,
-+      "request Stac LZS", 1, &ccp_allowoptions[0].lzs, OPT_ALIAS | OPT_PRIO },
-+    { "nolzs", o_bool, &ccp_wantoptions[0].lzs,
-+      "don't allow Stac LZS", OPT_PRIOSUB | OPT_A2CLR,
-+      &ccp_allowoptions[0].lzs },
-+    { "-lzs", o_bool, &ccp_wantoptions[0].lzs,
-+      "don't allow Stac LZS", OPT_ALIAS | OPT_PRIOSUB | OPT_A2CLR,
-+      &ccp_allowoptions[0].lzs },
-+
- #ifdef MPPE
--    /* MPPE options are symmetrical ... we only set wantoptions here */
--    { "require-mppe", o_bool, &ccp_wantoptions[0].mppe,
--      "require MPPE encryption",
--      OPT_PRIO | MPPE_OPT_40 | MPPE_OPT_128 },
--    { "+mppe", o_bool, &ccp_wantoptions[0].mppe,
--      "require MPPE encryption",
--      OPT_ALIAS | OPT_PRIO | MPPE_OPT_40 | MPPE_OPT_128 },
--    { "nomppe", o_bool, &ccp_wantoptions[0].mppe,
--      "don't allow MPPE encryption", OPT_PRIO },
--    { "-mppe", o_bool, &ccp_wantoptions[0].mppe,
--      "don't allow MPPE encryption", OPT_ALIAS | OPT_PRIO },
--
--    /* We use ccp_allowoptions[0].mppe as a junk var ... it is reset later */
--    { "require-mppe-40", o_bool, &ccp_allowoptions[0].mppe,
--      "require MPPE 40-bit encryption", OPT_PRIO | OPT_A2OR | MPPE_OPT_40,
--      &ccp_wantoptions[0].mppe },
--    { "+mppe-40", o_bool, &ccp_allowoptions[0].mppe,
--      "require MPPE 40-bit encryption", OPT_PRIO | OPT_A2OR | MPPE_OPT_40,
--      &ccp_wantoptions[0].mppe },
--    { "nomppe-40", o_bool, &ccp_allowoptions[0].mppe,
--      "don't allow MPPE 40-bit encryption",
--      OPT_PRIOSUB | OPT_A2CLRB | MPPE_OPT_40, &ccp_wantoptions[0].mppe },
--    { "-mppe-40", o_bool, &ccp_allowoptions[0].mppe,
--      "don't allow MPPE 40-bit encryption",
--      OPT_ALIAS | OPT_PRIOSUB | OPT_A2CLRB | MPPE_OPT_40,
--      &ccp_wantoptions[0].mppe },
--
--    { "require-mppe-128", o_bool, &ccp_allowoptions[0].mppe,
--      "require MPPE 128-bit encryption", OPT_PRIO | OPT_A2OR | MPPE_OPT_128,
--      &ccp_wantoptions[0].mppe },
--    { "+mppe-128", o_bool, &ccp_allowoptions[0].mppe,
--      "require MPPE 128-bit encryption",
--      OPT_ALIAS | OPT_PRIO | OPT_A2OR | MPPE_OPT_128,
--      &ccp_wantoptions[0].mppe },
--    { "nomppe-128", o_bool, &ccp_allowoptions[0].mppe,
--      "don't allow MPPE 128-bit encryption",
--      OPT_PRIOSUB | OPT_A2CLRB | MPPE_OPT_128, &ccp_wantoptions[0].mppe },
--    { "-mppe-128", o_bool, &ccp_allowoptions[0].mppe,
--      "don't allow MPPE 128-bit encryption",
--      OPT_ALIAS | OPT_PRIOSUB | OPT_A2CLRB | MPPE_OPT_128,
--      &ccp_wantoptions[0].mppe },
--
--    /* strange one; we always request stateless, but will we allow stateful? */
--    { "mppe-stateful", o_bool, &refuse_mppe_stateful,
--      "allow MPPE stateful mode", OPT_PRIO },
--    { "nomppe-stateful", o_bool, &refuse_mppe_stateful,
--      "disallow MPPE stateful mode", OPT_PRIO | 1 },
-+    { "mppc", o_bool, &ccp_wantoptions[0].mppc,
-+      "request MPPC compression", 1, &ccp_allowoptions[0].mppc },
-+    { "+mppc", o_bool, &ccp_wantoptions[0].mppc,
-+      "request MPPC compression", 1, &ccp_allowoptions[0].mppc, OPT_ALIAS },
-+    { "nomppc", o_bool, &ccp_wantoptions[0].mppc,
-+      "don't allow MPPC compression", OPT_PRIOSUB | OPT_A2CLR,
-+      &ccp_allowoptions[0].mppc },
-+    { "-mppc", o_bool, &ccp_wantoptions[0].mppc,
-+      "don't allow MPPC compression", OPT_ALIAS | OPT_PRIOSUB | OPT_A2CLR,
-+      &ccp_allowoptions[0].mppc },
-+    { "mppe", o_special, (void *)setmppe,
-+      "request MPPE encryption" },
-+    { "+mppe", o_special, (void *)setmppe,
-+      "request MPPE encryption" },
-+    { "nomppe", o_special_noarg, (void *)setnomppe,
-+      "don't allow MPPE encryption" },
-+    { "-mppe", o_special_noarg, (void *)setnomppe,
-+      "don't allow MPPE encryption" },
- #endif /* MPPE */
- 
-     { NULL }
-@@ -240,7 +220,7 @@ static fsm_callbacks ccp_callbacks = {
-  */
- #define ANY_COMPRESS(opt)	((opt).deflate || (opt).bsd_compress \
- 				 || (opt).predictor_1 || (opt).predictor_2 \
--				 || (opt).mppe)
-+				 || (opt).lzs || (opt).mppc || (opt).mppe)
- 
- /*
-  * Local state (mainly for handling reset-reqs and reset-acks).
-@@ -341,6 +321,100 @@ setdeflate(char **argv)
-     return 1;
- }
- 
-+#ifdef MPPE
-+/*
-+ * Functions called from config options
-+ */
-+/* 
-+   MPPE suboptions:
-+	required - require MPPE; disconnect if peer doesn't support it
-+	stateless - use stateless mode
-+	no40 - disable 40 bit keys
-+	no56 - disable 56 bit keys
-+	no128 - disable 128 bit keys
-+*/
-+int setmppe(char **argv)
-+{
-+    int i;
-+    char *str, cmdbuf[16];
-+
-+    ccp_allowoptions[0].mppe = 1;
-+    ccp_allowoptions[0].mppe_40 = 1;
-+    ccp_allowoptions[0].mppe_56 = 1;
-+    ccp_allowoptions[0].mppe_128 = 1;
-+    ccp_allowoptions[0].mppe_stateless = 0;
-+    ccp_wantoptions[0].mppe = 0;
-+
-+    str = *argv;
-+
-+    while (1) {
-+	i = 0;
-+	memset(cmdbuf, '\0', 16);
-+	while ((i < 16) && (*str != ',') && (*str != '\0'))
-+	    cmdbuf[i++] = *str++;
-+	cmdbuf[i] = '\0';
-+	if (!strncasecmp(cmdbuf, "no40", strlen("no40"))) {
-+	    ccp_allowoptions[0].mppe_40 = 0;
-+	    goto next_param;
-+	} else if (!strncasecmp(cmdbuf, "no56", strlen("no56"))) {
-+	    ccp_allowoptions[0].mppe_56 = 0;
-+	    goto next_param;
-+	} else if (!strncasecmp(cmdbuf, "no128", strlen("no128"))) {
-+	    ccp_allowoptions[0].mppe_128 = 0;
-+	    goto next_param;
-+	} else if (!strncasecmp(cmdbuf, "stateless", strlen("stateless"))) {
-+	    ccp_allowoptions[0].mppe_stateless = 1;
-+	    goto next_param;
-+	} else if (!strncasecmp(cmdbuf, "required", strlen("required"))) {
-+	    ccp_wantoptions[0].mppe = 1;
-+	    goto next_param;
-+	} else {
-+	    option_error("invalid parameter '%s' for mppe option", cmdbuf);
-+	    return 0;
-+	}
-+
-+    next_param:
-+	if (*str == ',') {
-+	    str++;
-+	    continue;
-+	}
-+	if (*str == '\0') {
-+	    if (!(ccp_allowoptions[0].mppe_40 || ccp_allowoptions[0].mppe_56 ||
-+		  ccp_allowoptions[0].mppe_128)) {
-+		if (ccp_wantoptions[0].mppe == 1) {
-+		    option_error("You require MPPE but you have switched off "
-+				 "all encryption key lengths.");
-+		    return 0;
-+		}
-+		ccp_wantoptions[0].mppe = ccp_allowoptions[0].mppe = 0;
-+		ccp_wantoptions[0].mppe_stateless =
-+		    ccp_allowoptions[0].mppe_stateless = 0;
-+	    } else {
-+		ccp_allowoptions[0].mppe = 1;
-+		ccp_wantoptions[0].mppe_stateless =
-+		    ccp_allowoptions[0].mppe_stateless;
-+		if (ccp_wantoptions[0].mppe == 1) {
-+		    ccp_wantoptions[0].mppe_40 = ccp_allowoptions[0].mppe_40;
-+		    ccp_wantoptions[0].mppe_56 = ccp_allowoptions[0].mppe_56;
-+		    ccp_wantoptions[0].mppe_128 = ccp_allowoptions[0].mppe_128;
-+		}
-+	    }
-+	    return 1;
-+	}
-+    }
-+}
-+
-+int setnomppe(void)
-+{
-+    ccp_wantoptions[0].mppe = ccp_allowoptions[0].mppe = 0;
-+    ccp_wantoptions[0].mppe_40 = ccp_allowoptions[0].mppe_40 = 0;
-+    ccp_wantoptions[0].mppe_56 = ccp_allowoptions[0].mppe_56 = 0;
-+    ccp_wantoptions[0].mppe_128 = ccp_allowoptions[0].mppe_128 = 0;
-+    ccp_wantoptions[0].mppe_stateless = ccp_allowoptions[0].mppe_stateless = 0;
-+    return 1;
-+}
-+#endif /* MPPE */
-+
- /*
-  * ccp_init - initialize CCP.
-  */
-@@ -374,6 +448,30 @@ ccp_init(int unit)
-     ccp_allowoptions[0].bsd_bits = BSD_MAX_BITS;
- 
-     ccp_allowoptions[0].predictor_1 = 1;
-+
-+    ccp_wantoptions[0].lzs = 0; /* Stac LZS  - will be enabled in the future */
-+    ccp_wantoptions[0].lzs_mode = LZS_MODE_SEQ;
-+    ccp_wantoptions[0].lzs_hists = 1;
-+    ccp_allowoptions[0].lzs = 0; /* Stac LZS  - will be enabled in the future */
-+    ccp_allowoptions[0].lzs_mode = LZS_MODE_SEQ;
-+    ccp_allowoptions[0].lzs_hists = 1;
-+
-+#ifdef MPPE
-+    /* by default allow and request MPPC... */
-+    ccp_wantoptions[0].mppc = ccp_allowoptions[0].mppc = 1;
-+
-+    /* ... and allow but don't request MPPE */
-+    ccp_allowoptions[0].mppe = 1;
-+    ccp_allowoptions[0].mppe_40 = 1;
-+    ccp_allowoptions[0].mppe_56 = 1;
-+    ccp_allowoptions[0].mppe_128 = 1;
-+    ccp_allowoptions[0].mppe_stateless = 1;
-+    ccp_wantoptions[0].mppe = 0;
-+    ccp_wantoptions[0].mppe_40 = 0;
-+    ccp_wantoptions[0].mppe_56 = 0;
-+    ccp_wantoptions[0].mppe_128 = 0;
-+    ccp_wantoptions[0].mppe_stateless = 0;
-+#endif /* MPPE */
- }
- 
- /*
-@@ -443,11 +541,11 @@ ccp_input(int unit, u_char *p, int len)
-     if (oldstate == OPENED && p[0] == TERMREQ && f->state != OPENED) {
- 	notice("Compression disabled by peer.");
- #ifdef MPPE
--	if (ccp_gotoptions[unit].mppe) {
-+	if (ccp_wantoptions[unit].mppe) {
- 	    error("MPPE disabled, closing LCP");
- 	    lcp_close(unit, "MPPE disabled by peer");
- 	}
--#endif
-+#endif /* MPPE */
-     }
- 
-     /*
-@@ -471,6 +569,15 @@ ccp_extcode(fsm *f, int code, int id, u_
- 	    break;
- 	/* send a reset-ack, which the transmitter will see and
- 	   reset its compression state. */
-+
-+	/* In case of MPPE/MPPC or LZS we shouldn't send CCP_RESETACK,
-+	   but we do it in order to reset compressor; CCP_RESETACK is
-+	   then silently discarded. See functions ppp_send_frame and
-+	   ppp_ccp_peek in ppp_generic.c (Linux only !!!). All the
-+	   confusion is caused by the fact that CCP code is splited
-+	   into two parts - one part is handled by pppd, the other one
-+	   is handled by kernel. */
-+
- 	fsm_sdata(f, CCP_RESETACK, id, NULL, 0);
- 	break;
- 
-@@ -498,12 +605,11 @@ ccp_protrej(int unit)
-     fsm_lowerdown(&ccp_fsm[unit]);
- 
- #ifdef MPPE
--    if (ccp_gotoptions[unit].mppe) {
-+    if (ccp_wantoptions[unit].mppe) {
- 	error("MPPE required but peer negotiation failed");
- 	lcp_close(unit, "MPPE required but peer negotiation failed");
-     }
--#endif
--
-+#endif /* MPPE */
- }
- 
- /*
-@@ -519,7 +625,7 @@ ccp_resetci(fsm *f)
-     all_rejected[f->unit] = 0;
- 
- #ifdef MPPE
--    if (go->mppe) {
-+    if (go->mppe || go->mppc) {
- 	ccp_options *ao = &ccp_allowoptions[f->unit];
- 	int auth_mschap_bits = auth_done[f->unit];
- #ifdef USE_EAPTLS
-@@ -536,95 +642,124 @@ ccp_resetci(fsm *f)
- 	 * NB: If MPPE is required, all other compression opts are invalid.
- 	 *     So, we return right away if we can't do it.
- 	 */
--
--	/* Leave only the mschap auth bits set */
--	auth_mschap_bits &= (CHAP_MS_WITHPEER  | CHAP_MS_PEER |
--			     CHAP_MS2_WITHPEER | CHAP_MS2_PEER);
--	/* Count the mschap auths */
--	auth_mschap_bits >>= CHAP_MS_SHIFT;
--	numbits = 0;
--	do {
--	    numbits += auth_mschap_bits & 1;
--	    auth_mschap_bits >>= 1;
--	} while (auth_mschap_bits);
--	if (numbits > 1) {
--	    error("MPPE required, but auth done in both directions.");
--	    lcp_close(f->unit, "MPPE required but not available");
--	    return;
--	}
-+	if (ccp_wantoptions[f->unit].mppe) {
-+	    /* Leave only the mschap auth bits set */
-+	    auth_mschap_bits &= (CHAP_MS_WITHPEER  | CHAP_MS_PEER |
-+				 CHAP_MS2_WITHPEER | CHAP_MS2_PEER);
-+	    /* Count the mschap auths */
-+	    auth_mschap_bits >>= CHAP_MS_SHIFT;
-+	    numbits = 0;
-+	    do {
-+		numbits += auth_mschap_bits & 1;
-+		auth_mschap_bits >>= 1;
-+	    } while (auth_mschap_bits);
-+	    if (numbits > 1) {
-+		error("MPPE required, but auth done in both directions.");
-+		lcp_close(f->unit, "MPPE required but not available");
-+		return;
-+	    }
- 
- #ifdef USE_EAPTLS
--    /*
--     * MPPE is also possible in combination with EAP-TLS.
--     * It is not possible to detect if we're doing EAP or EAP-TLS
--     * at this stage, hence we accept all forms of EAP. If TLS is
--     * not used then the MPPE keys will not be derived anyway.
--     */
--	/* Leave only the eap auth bits set */
--	auth_eap_bits &= (EAP_WITHPEER | EAP_PEER );
-+	    /*
-+	     * MPPE is also possible in combination with EAP-TLS.
-+	     * It is not possible to detect if we're doing EAP or EAP-TLS
-+	     * at this stage, hence we accept all forms of EAP. If TLS is
-+	     * not used then the MPPE keys will not be derived anyway.
-+	     */
-+		/* Leave only the eap auth bits set */
-+		auth_eap_bits &= (EAP_WITHPEER | EAP_PEER );
- 
--	if ((numbits == 0) && (auth_eap_bits == 0)) {
--	    error("MPPE required, but MS-CHAP[v2] nor EAP-TLS auth are performed.");
-+		if ((numbits == 0) && (auth_eap_bits == 0)) {
-+		    error("MPPE required, but MS-CHAP[v2] nor EAP-TLS auth are performed.");
- #else
--	if (!numbits) {
--	    error("MPPE required, but MS-CHAP[v2] auth not performed.");
-+	    if (!numbits) {
-+		error("MPPE required, but MS-CHAP[v2] auth not performed.");
- #endif
--	    lcp_close(f->unit, "MPPE required but not available");
--	    return;
--	}
-+		lcp_close(f->unit, "MPPE required but not available");
-+		return;
-+	    }
- 
--	/* A plugin (eg radius) may not have obtained key material. */
--	if (!mppe_keys_set) {
--	    error("MPPE required, but keys are not available.  "
--		  "Possible plugin problem?");
--	    lcp_close(f->unit, "MPPE required but not available");
--	    return;
--	}
--
--	/* LM auth not supported for MPPE */
--	if (auth_done[f->unit] & (CHAP_MS_WITHPEER | CHAP_MS_PEER)) {
--	    /* This might be noise */
--	    if (go->mppe & MPPE_OPT_40) {
--		notice("Disabling 40-bit MPPE; MS-CHAP LM not supported");
--		go->mppe &= ~MPPE_OPT_40;
--		ccp_wantoptions[f->unit].mppe &= ~MPPE_OPT_40;
-+	    /* A plugin (eg radius) may not have obtained key material. */
-+	    if (!mppe_keys_set) {
-+		error("MPPE required, but keys are not available.  "
-+		      "Possible plugin problem?");
-+		lcp_close(f->unit, "MPPE required but not available");
-+		return;
- 	    }
- 	}
- 
--	/* Last check: can we actually negotiate something? */
--	if (!(go->mppe & (MPPE_OPT_40 | MPPE_OPT_128))) {
--	    /* Could be misconfig, could be 40-bit disabled above. */
--	    error("MPPE required, but both 40-bit and 128-bit disabled.");
--	    lcp_close(f->unit, "MPPE required but not available");
--	    return;
-+	/*
-+	 * Check whether the kernel knows about the various
-+	 * compression methods we might request. Key material
-+	 * unimportant here.
-+	 */
-+	if (go->mppc) {
-+	    opt_buf[0] = CI_MPPE;
-+	    opt_buf[1] = CILEN_MPPE;
-+	    opt_buf[2] = 0;
-+	    opt_buf[3] = 0;
-+	    opt_buf[4] = 0;
-+	    opt_buf[5] = MPPE_MPPC;
-+	    if (ccp_test(f->unit, opt_buf, CILEN_MPPE, 0) <= 0)
-+		go->mppc = 0;
-+	}
-+	if (go->mppe_40) {
-+	    opt_buf[0] = CI_MPPE;
-+	    opt_buf[1] = CILEN_MPPE;
-+	    opt_buf[2] = MPPE_STATELESS;
-+	    opt_buf[3] = 0;
-+	    opt_buf[4] = 0;
-+	    opt_buf[5] = MPPE_40BIT;
-+	    if (ccp_test(f->unit, opt_buf, CILEN_MPPE + MPPE_MAX_KEY_LEN, 0) <= 0)
-+		go->mppe_40 = 0;
-+	}
-+	if (go->mppe_56) {
-+	    opt_buf[0] = CI_MPPE;
-+	    opt_buf[1] = CILEN_MPPE;
-+	    opt_buf[2] = MPPE_STATELESS;
-+	    opt_buf[3] = 0;
-+	    opt_buf[4] = 0;
-+	    opt_buf[5] = MPPE_56BIT;
-+	    if (ccp_test(f->unit, opt_buf, CILEN_MPPE + MPPE_MAX_KEY_LEN, 0) <= 0)
-+		go->mppe_56 = 0;
-+	}
-+	if (go->mppe_128) {
-+	    opt_buf[0] = CI_MPPE;
-+	    opt_buf[1] = CILEN_MPPE;
-+	    opt_buf[2] = MPPE_STATELESS;
-+	    opt_buf[3] = 0;
-+	    opt_buf[4] = 0;
-+	    opt_buf[5] = MPPE_128BIT;
-+	    if (ccp_test(f->unit, opt_buf, CILEN_MPPE + MPPE_MAX_KEY_LEN, 0) <= 0)
-+		go->mppe_128 = 0;
-+	}
-+	if (!go->mppe_40 && !go->mppe_56 && !go->mppe_128) {
-+	    if (ccp_wantoptions[f->unit].mppe) {
-+		error("MPPE required, but kernel has no support.");
-+		lcp_close(f->unit, "MPPE required but not available");
-+	    }
-+	    go->mppe = go->mppe_stateless = 0;
-+	} else {
-+	    /* MPPE is not compatible with other compression types */
-+	    if (ccp_wantoptions[f->unit].mppe) {
-+		ao->bsd_compress = go->bsd_compress = 0;
-+		ao->predictor_1  = go->predictor_1  = 0;
-+		ao->predictor_2  = go->predictor_2  = 0;
-+		ao->deflate	 = go->deflate	    = 0;
-+		ao->lzs		 = go->lzs	    = 0;
-+	    }
- 	}
--
--	/* sync options */
--	ao->mppe = go->mppe;
--	/* MPPE is not compatible with other compression types */
--	ao->bsd_compress = go->bsd_compress = 0;
--	ao->predictor_1  = go->predictor_1  = 0;
--	ao->predictor_2  = go->predictor_2  = 0;
--	ao->deflate      = go->deflate      = 0;
-     }
- #endif /* MPPE */
--
--    /*
--     * Check whether the kernel knows about the various
--     * compression methods we might request.
--     */
--#ifdef MPPE
--    if (go->mppe) {
--	opt_buf[0] = CI_MPPE;
--	opt_buf[1] = CILEN_MPPE;
--	MPPE_OPTS_TO_CI(go->mppe, &opt_buf[2]);
--	/* Key material unimportant here. */
--	if (ccp_test(f->unit, opt_buf, CILEN_MPPE + MPPE_MAX_KEY_LEN, 0) <= 0) {
--	    error("MPPE required, but kernel has no support.");
--	    lcp_close(f->unit, "MPPE required but not available");
--	}
-+    if (go->lzs) {
-+	opt_buf[0] = CI_LZS;
-+	opt_buf[1] = CILEN_LZS;
-+	opt_buf[2] = go->lzs_hists >> 8;
-+	opt_buf[3] = go->lzs_hists & 0xff;
-+	opt_buf[4] = LZS_MODE_SEQ;
-+	if (ccp_test(f->unit, opt_buf, CILEN_LZS, 0) <= 0)
-+	    go->lzs = 0;
-     }
--#endif
-     if (go->bsd_compress) {
- 	opt_buf[0] = CI_BSD_COMPRESS;
- 	opt_buf[1] = CILEN_BSD_COMPRESS;
-@@ -679,7 +814,8 @@ static int
- 	+ (go->deflate && go->deflate_draft? CILEN_DEFLATE: 0)
- 	+ (go->predictor_1? CILEN_PREDICTOR_1: 0)
- 	+ (go->predictor_2? CILEN_PREDICTOR_2: 0)
--	+ (go->mppe? CILEN_MPPE: 0);
-+	+ (go->lzs? CILEN_LZS: 0)
-+	+ ((go->mppe || go->mppc)? CILEN_MPPE: 0);
- }
- 
- /*
-@@ -690,6 +826,8 @@ static void
- {
-     int res;
-     ccp_options *go = &ccp_gotoptions[f->unit];
-+    ccp_options *ao = &ccp_allowoptions[f->unit];
-+    ccp_options *wo = &ccp_wantoptions[f->unit];
-     u_char *p0 = p;
- 
-     /*
-@@ -698,22 +836,43 @@ static void
-      * in case it gets Acked.
-      */
- #ifdef MPPE
--    if (go->mppe) {
-+    if (go->mppe || go->mppc || (!wo->mppe && ao->mppe)) {
- 	u_char opt_buf[CILEN_MPPE + MPPE_MAX_KEY_LEN];
- 
--	p[0] = opt_buf[0] = CI_MPPE;
--	p[1] = opt_buf[1] = CILEN_MPPE;
--	MPPE_OPTS_TO_CI(go->mppe, &p[2]);
--	MPPE_OPTS_TO_CI(go->mppe, &opt_buf[2]);
-+	p[0] = CI_MPPE;
-+	p[1] = CILEN_MPPE;
-+	p[2] = (go->mppe_stateless ? MPPE_STATELESS : 0);
-+	p[3] = 0;
-+	p[4] = 0;
-+	p[5] = (go->mppe_40 ? MPPE_40BIT : 0) | (go->mppe_56 ? MPPE_56BIT : 0) |
-+	    (go->mppe_128 ? MPPE_128BIT : 0) | (go->mppc ? MPPE_MPPC : 0);
-+
-+	BCOPY(p, opt_buf, CILEN_MPPE);
- 	BCOPY(mppe_recv_key, &opt_buf[CILEN_MPPE], MPPE_MAX_KEY_LEN);
- 	res = ccp_test(f->unit, opt_buf, CILEN_MPPE + MPPE_MAX_KEY_LEN, 0);
--	if (res > 0)
-+	if (res > 0) {
- 	    p += CILEN_MPPE;
--	else
-+	} else {
- 	    /* This shouldn't happen, we've already tested it! */
--	    lcp_close(f->unit, "MPPE required but not available in kernel");
-+	    go->mppe = go->mppe_40 = go->mppe_56 = go->mppe_128 =
-+		go->mppe_stateless = go->mppc = 0;
-+	    if (ccp_wantoptions[f->unit].mppe)
-+		lcp_close(f->unit, "MPPE required but not available in kernel");
-+	}
-+    }
-+#endif /* MPPE */
-+    if (go->lzs) {
-+	p[0] = CI_LZS;
-+	p[1] = CILEN_LZS;
-+	p[2] = go->lzs_hists >> 8;
-+	p[3] = go->lzs_hists & 0xff;
-+	p[4] = LZS_MODE_SEQ;
-+	res = ccp_test(f->unit, p, CILEN_LZS, 0);
-+	if (res > 0) {
-+	    p += CILEN_LZS;
-+	} else
-+	    go->lzs = 0;
-     }
--#endif
-     if (go->deflate) {
- 	p[0] = go->deflate_correct? CI_DEFLATE: CI_DEFLATE_DRAFT;
- 	p[1] = CILEN_DEFLATE;
-@@ -799,30 +958,50 @@ static void
- 
- /*
-  * ccp_ackci - process a received configure-ack, and return
-- * 1 iff the packet was OK.
-+ * 1 if the packet was OK.
-  */
- static int
-   ccp_ackci(fsm *f, u_char *p, int len)
- {
-     ccp_options *go = &ccp_gotoptions[f->unit];
-+    ccp_options *ao = &ccp_allowoptions[f->unit];
-+    ccp_options *wo = &ccp_wantoptions[f->unit];
-     u_char *p0 = p;
- 
- #ifdef MPPE
--    if (go->mppe) {
--	u_char opt_buf[CILEN_MPPE];
--
--	opt_buf[0] = CI_MPPE;
--	opt_buf[1] = CILEN_MPPE;
--	MPPE_OPTS_TO_CI(go->mppe, &opt_buf[2]);
--	if (len < CILEN_MPPE || memcmp(opt_buf, p, CILEN_MPPE))
-+    if (go->mppe || go->mppc || (!wo->mppe && ao->mppe)) {
-+	if (len < CILEN_MPPE
-+	    || p[1] != CILEN_MPPE || p[0] != CI_MPPE
-+	    || p[2] != (go->mppe_stateless ? MPPE_STATELESS : 0)
-+	    || p[3] != 0
-+	    || p[4] != 0
-+	    || (p[5] != ((go->mppe_40 ? MPPE_40BIT : 0) |
-+			 (go->mppc ? MPPE_MPPC : 0))
-+		&& p[5] != ((go->mppe_56 ? MPPE_56BIT : 0) |
-+			    (go->mppc ? MPPE_MPPC : 0))
-+		&& p[5] != ((go->mppe_128 ? MPPE_128BIT : 0) |
-+			    (go->mppc ? MPPE_MPPC : 0))))
- 	    return 0;
-+	if (go->mppe_40 || go->mppe_56 || go->mppe_128)
-+	    go->mppe = 1;
- 	p += CILEN_MPPE;
- 	len -= CILEN_MPPE;
-+	/* Cope with first/fast ack */
-+	if (p == p0 && len == 0)
-+	    return 1;
-+    }
-+#endif /* MPPE */
-+    if (go->lzs) {
-+	if (len < CILEN_LZS || p[0] != CI_LZS || p[1] != CILEN_LZS
-+	    || p[2] != go->lzs_hists>>8 || p[3] != (go->lzs_hists&0xff)
-+	    || p[4] != LZS_MODE_SEQ)
-+	    return 0;
-+	p += CILEN_LZS;
-+	len -= CILEN_LZS;
- 	/* XXX Cope with first/fast ack */
--	if (len == 0)
-+	if (p == p0 && len == 0)
- 	    return 1;
-     }
--#endif
-     if (go->deflate) {
- 	if (len < CILEN_DEFLATE
- 	    || p[0] != (go->deflate_correct? CI_DEFLATE: CI_DEFLATE_DRAFT)
-@@ -891,6 +1070,8 @@ static int
-   ccp_nakci(fsm *f, u_char *p, int len, int treat_as_reject)
- {
-     ccp_options *go = &ccp_gotoptions[f->unit];
-+    ccp_options *ao = &ccp_allowoptions[f->unit];
-+    ccp_options *wo = &ccp_wantoptions[f->unit];
-     ccp_options no;		/* options we've seen already */
-     ccp_options try;		/* options to ask for next time */
- 
-@@ -898,28 +1079,100 @@ static int
-     try = *go;
- 
- #ifdef MPPE
--    if (go->mppe && len >= CILEN_MPPE
--	&& p[0] == CI_MPPE && p[1] == CILEN_MPPE) {
--	no.mppe = 1;
--	/*
--	 * Peer wants us to use a different strength or other setting.
--	 * Fail if we aren't willing to use his suggestion.
--	 */
--	MPPE_CI_TO_OPTS(&p[2], try.mppe);
--	if ((try.mppe & MPPE_OPT_STATEFUL) && refuse_mppe_stateful) {
--	    error("Refusing MPPE stateful mode offered by peer");
--	    try.mppe = 0;
--	} else if (((go->mppe | MPPE_OPT_STATEFUL) & try.mppe) != try.mppe) {
--	    /* Peer must have set options we didn't request (suggest) */
--	    try.mppe = 0;
--	}
-+    if ((go->mppe || go->mppc || (!wo->mppe && ao->mppe)) &&
-+	len >= CILEN_MPPE && p[0] == CI_MPPE && p[1] == CILEN_MPPE) {
- 
--	if (!try.mppe) {
--	    error("MPPE required but peer negotiation failed");
--	    lcp_close(f->unit, "MPPE required but peer negotiation failed");
-+	if (go->mppc) {
-+	    no.mppc = 1;
-+	    if (!(p[5] & MPPE_MPPC))
-+		try.mppc = 0;
-+	}
-+
-+	if (go->mppe)
-+	    no.mppe = 1;
-+	if (go->mppe_40)
-+	    no.mppe_40 = 1;
-+	if (go->mppe_56)
-+	    no.mppe_56 = 1;
-+	if (go->mppe_128)
-+	    no.mppe_128 = 1;
-+	if (go->mppe_stateless)
-+	    no.mppe_stateless = 1;
-+
-+	if (ao->mppe_40) {
-+	    if ((p[5] & MPPE_40BIT))
-+		try.mppe_40 = 1;
-+	    else
-+		try.mppe_40 = (p[5] == 0) ? 1 : 0;
-+	}
-+	if (ao->mppe_56) {
-+	    if ((p[5] & MPPE_56BIT))
-+		try.mppe_56 = 1;
-+	    else
-+		try.mppe_56 = (p[5] == 0) ? 1 : 0;
-+	}
-+	if (ao->mppe_128) {
-+	    if ((p[5] & MPPE_128BIT))
-+		try.mppe_128 = 1;
-+	    else
-+		try.mppe_128 = (p[5] == 0) ? 1 : 0;
-+	}
-+
-+	if (ao->mppe_stateless) {
-+	    if ((p[2] & MPPE_STATELESS) || wo->mppe_stateless)
-+		try.mppe_stateless = 1;
-+	    else
-+		try.mppe_stateless = 0;
-+	}
-+
-+	if (!try.mppe_56 && !try.mppe_40 && !try.mppe_128) {
-+	    try.mppe = try.mppe_stateless = 0;
-+	    if (wo->mppe) {
-+		/* we require encryption, but peer doesn't support it
-+		   so we close connection */
-+		wo->mppc = wo->mppe = wo->mppe_stateless = wo->mppe_40 =
-+		    wo->mppe_56 = wo->mppe_128 = 0;
-+		lcp_close(f->unit, "MPPE required but cannot negotiate MPPE "
-+			  "key length");
-+	    }
-+        }
-+	if (wo->mppe && (wo->mppe_40 != try.mppe_40) &&
-+	    (wo->mppe_56 != try.mppe_56) && (wo->mppe_128 != try.mppe_128)) {
-+	    /* cannot negotiate key length */
-+	    wo->mppc = wo->mppe = wo->mppe_stateless = wo->mppe_40 =
-+		wo->mppe_56 = wo->mppe_128 = 0;
-+	    lcp_close(f->unit, "Cannot negotiate MPPE key length");
- 	}
-+	if (try.mppe_40 && try.mppe_56 && try.mppe_128)
-+	    try.mppe_40 = try.mppe_56 = 0;
-+	else
-+	    if (try.mppe_56 && try.mppe_128)
-+		try.mppe_56 = 0;
-+	    else
-+		if (try.mppe_40 && try.mppe_128)
-+		    try.mppe_40 = 0;
-+		else
-+		    if (try.mppe_40 && try.mppe_56)
-+			try.mppe_40 = 0;
-+
-+	p += CILEN_MPPE;
-+	len -= CILEN_MPPE;
-     }
- #endif /* MPPE */
-+
-+    if (go->lzs && len >= CILEN_LZS && p[0] == CI_LZS && p[1] == CILEN_LZS) {
-+	no.lzs = 1;
-+	if (((p[2]<<8)|p[3]) > 1 || (p[4] != LZS_MODE_SEQ &&
-+				     p[4] != LZS_MODE_EXT))
-+	    try.lzs = 0;
-+	else {
-+	    try.lzs_mode = p[4];
-+	    try.lzs_hists = (p[2] << 8) | p[3];
-+	}
-+	p += CILEN_LZS;
-+	len -= CILEN_LZS;
-+    }
-+
-     if (go->deflate && len >= CILEN_DEFLATE
- 	&& p[0] == (go->deflate_correct? CI_DEFLATE: CI_DEFLATE_DRAFT)
- 	&& p[1] == CILEN_DEFLATE) {
-@@ -989,14 +1242,50 @@ ccp_rejci(fsm *f, u_char *p, int len)
- 	return -1;
- 
- #ifdef MPPE
--    if (go->mppe && len >= CILEN_MPPE
-+    if ((go->mppe || go->mppc) && len >= CILEN_MPPE
- 	&& p[0] == CI_MPPE && p[1] == CILEN_MPPE) {
--	error("MPPE required but peer refused");
--	lcp_close(f->unit, "MPPE required but peer refused");
-+	ccp_options *wo = &ccp_wantoptions[f->unit];
-+	if (p[2] != (go->mppe_stateless ? MPPE_STATELESS : 0) ||
-+	    p[3] != 0 ||
-+	    p[4] != 0 ||
-+	    p[5] != ((go->mppe_40 ? MPPE_40BIT : 0) |
-+		     (go->mppe_56 ? MPPE_56BIT : 0) |
-+		     (go->mppe_128 ? MPPE_128BIT : 0) |
-+		     (go->mppc ? MPPE_MPPC : 0)))
-+	    return 0;
-+	if (go->mppc)
-+	    try.mppc = 0;
-+	if (go->mppe) {
-+	    try.mppe = 0;
-+	    if (go->mppe_40)
-+		try.mppe_40 = 0;
-+	    if (go->mppe_56)
-+		try.mppe_56 = 0;
-+	    if (go->mppe_128)
-+		try.mppe_128 = 0;
-+	    if (go->mppe_stateless)
-+		try.mppe_stateless = 0;
-+	    if (!try.mppe_56 && !try.mppe_40 && !try.mppe_128)
-+		try.mppe = try.mppe_stateless = 0;
-+	    if (wo->mppe) { /* we want MPPE but cannot negotiate key length */
-+		wo->mppc = wo->mppe = wo->mppe_stateless = wo->mppe_40 =
-+		    wo->mppe_56 = wo->mppe_128 = 0;
-+		lcp_close(f->unit, "MPPE required but cannot negotiate MPPE "
-+			  "key length");
-+	    }
-+	}
- 	p += CILEN_MPPE;
- 	len -= CILEN_MPPE;
-     }
--#endif
-+#endif /* MPPE */
-+    if (go->lzs && len >= CILEN_LZS && p[0] == CI_LZS && p[1] == CILEN_LZS) {
-+	if (p[2] != go->lzs_hists>>8 || p[3] != (go->lzs_hists&0xff) 
-+	    || p[4] != go->lzs_mode)
-+	    return 0;
-+	try.lzs = 0;
-+	p += CILEN_LZS;
-+	len -= CILEN_LZS;
-+    }
-     if (go->deflate_correct && len >= CILEN_DEFLATE
- 	&& p[0] == CI_DEFLATE && p[1] == CILEN_DEFLATE) {
- 	if (p[2] != DEFLATE_MAKE_OPT(go->deflate_size)
-@@ -1056,14 +1345,15 @@ static int
- ccp_reqci(fsm *f, u_char *p, int *lenp, int dont_nak)
- {
-     int ret, newret, res;
--    u_char *p0, *retp;
-+    u_char *p0, *retp, p2, p5;
-     int len, clen, type, nb;
-     ccp_options *ho = &ccp_hisoptions[f->unit];
-     ccp_options *ao = &ccp_allowoptions[f->unit];
-+    ccp_options *wo = &ccp_wantoptions[f->unit];
- #ifdef MPPE
--    bool rej_for_ci_mppe = 1;	/* Are we rejecting based on a bad/missing */
--				/* CI_MPPE, or due to other options?       */
--#endif
-+    u_char opt_buf[CILEN_MPPE + MPPE_MAX_KEY_LEN];
-+/*     int mtu; */
-+#endif /* MPPE */
- 
-     ret = CONFACK;
-     retp = p0 = p;
-@@ -1086,106 +1376,302 @@ ccp_reqci(fsm *f, u_char *p, int *lenp,
- 	    switch (type) {
- #ifdef MPPE
- 	    case CI_MPPE:
--		if (!ao->mppe || clen != CILEN_MPPE) {
-+ 		if ((!ao->mppc && !ao->mppe) || clen != CILEN_MPPE) {
- 		    newret = CONFREJ;
- 		    break;
- 		}
--		MPPE_CI_TO_OPTS(&p[2], ho->mppe);
--
--		/* Nak if anything unsupported or unknown are set. */
--		if (ho->mppe & MPPE_OPT_UNSUPPORTED) {
-+ 		p2 = p[2];
-+ 		p5 = p[5];
-+ 		/* not sure what they want, tell 'em what we got */
-+ 		if (((p[2] & ~MPPE_STATELESS) != 0 || p[3] != 0 || p[4] != 0 ||
-+ 		     (p[5] & ~(MPPE_40BIT | MPPE_56BIT | MPPE_128BIT |
-+ 			       MPPE_MPPC)) != 0 || p[5] == 0) ||
-+ 		    (p[2] == 0 && p[3] == 0 && p[4] == 0 &&  p[5] == 0)) {
- 		    newret = CONFNAK;
--		    ho->mppe &= ~MPPE_OPT_UNSUPPORTED;
--		}
--		if (ho->mppe & MPPE_OPT_UNKNOWN) {
--		    newret = CONFNAK;
--		    ho->mppe &= ~MPPE_OPT_UNKNOWN;
--		}
--
--		/* Check state opt */
--		if (ho->mppe & MPPE_OPT_STATEFUL) {
--		    /*
--		     * We can Nak and request stateless, but it's a
--		     * lot easier to just assume the peer will request
--		     * it if he can do it; stateful mode is bad over
--		     * the Internet -- which is where we expect MPPE.
--		     */
--		   if (refuse_mppe_stateful) {
--			error("Refusing MPPE stateful mode offered by peer");
--			newret = CONFREJ;
--			break;
-+ 		    p[2] = (wo->mppe_stateless ? MPPE_STATELESS : 0);
-+		    p[3] = 0;
-+ 		    p[4] = 0;
-+ 		    p[5] = (wo->mppe_40 ? MPPE_40BIT : 0) |
-+ 			(wo->mppe_56 ? MPPE_56BIT : 0) |
-+ 			(wo->mppe_128 ? MPPE_128BIT : 0) |
-+ 			(wo->mppc ? MPPE_MPPC : 0);
-+ 		    break;
-+  		}
-+
-+ 		if ((p[5] & MPPE_MPPC)) {
-+ 		    if (ao->mppc) {
-+ 			ho->mppc = 1;
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+ 			opt_buf[2] = opt_buf[3] = opt_buf[4] = 0;
-+ 			opt_buf[5] = MPPE_MPPC;
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE, 1) <= 0) {
-+ 			    ho->mppc = 0;
-+ 			    p[5] &= ~MPPE_MPPC;
-+ 			    newret = CONFNAK;
-+ 			}
-+ 		    } else {
-+		      newret = CONFREJ;
-+ 			if (wo->mppe || ao->mppe) {
-+ 			    p[5] &= ~MPPE_MPPC;
-+ 			    newret = CONFNAK;
-+ 			}
- 		    }
- 		}
--
--		/* Find out which of {S,L} are set. */
--		if ((ho->mppe & MPPE_OPT_128)
--		     && (ho->mppe & MPPE_OPT_40)) {
--		    /* Both are set, negotiate the strongest. */
--		    newret = CONFNAK;
--		    if (ao->mppe & MPPE_OPT_128)
--			ho->mppe &= ~MPPE_OPT_40;
--		    else if (ao->mppe & MPPE_OPT_40)
--			ho->mppe &= ~MPPE_OPT_128;
--		    else {
--			newret = CONFREJ;
--			break;
--		    }
--		} else if (ho->mppe & MPPE_OPT_128) {
--		    if (!(ao->mppe & MPPE_OPT_128)) {
--			newret = CONFREJ;
--			break;
--		    }
--		} else if (ho->mppe & MPPE_OPT_40) {
--		    if (!(ao->mppe & MPPE_OPT_40)) {
--			newret = CONFREJ;
--			break;
--		    }
-+ 		if (ao->mppe)
-+ 		    ho->mppe = 1;
-+ 
-+ 		if ((p[2] & MPPE_STATELESS)) {
-+ 		    if (ao->mppe_stateless) {
-+ 			if (wo->mppe_stateless)
-+ 			    ho->mppe_stateless = 1;
-+ 			else {
-+ 			    newret = CONFNAK;
-+ 			    if (!dont_nak)
-+ 				p[2] &= ~MPPE_STATELESS;
-+ 			}
-+ 		    } else {
-+ 			newret = CONFNAK;
-+ 			if (!dont_nak)
-+ 			    p[2] &= ~MPPE_STATELESS;
-+ 		    }
-+ 		} else {
-+ 		    if (wo->mppe_stateless && !dont_nak) {
-+ 			wo->mppe_stateless = 0;
-+ 			newret = CONFNAK;
-+ 			p[2] |= MPPE_STATELESS;
-+  		    }
-+  		}
-+  
-+ 		if ((p[5] & ~MPPE_MPPC) == (MPPE_40BIT|MPPE_56BIT|MPPE_128BIT)) {
-+  		    newret = CONFNAK;
-+ 		    if (ao->mppe_128) {
-+ 			ho->mppe_128 = 1;
-+ 			p[5] &= ~(MPPE_40BIT|MPPE_56BIT);
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+ 			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+ 			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+ 				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_128 = 0;
-+ 			    p[5] |= (MPPE_40BIT|MPPE_56BIT);
-+ 			    p[5] &= ~MPPE_128BIT;
-+ 			    goto check_mppe_56_40;
-+ 			}
-+ 			goto check_mppe;
-+  		    }
-+ 		    p[5] &= ~MPPE_128BIT;
-+ 		    goto check_mppe_56_40;
-+ 		}
-+ 		if ((p[5] & ~MPPE_MPPC) == (MPPE_56BIT|MPPE_128BIT)) {
-+ 		    newret = CONFNAK;
-+ 		    if (ao->mppe_128) {
-+ 			ho->mppe_128 = 1;
-+ 			p[5] &= ~MPPE_56BIT;
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+ 			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+ 				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_128 = 0;
-+ 			    p[5] |= MPPE_56BIT;
-+ 			    p[5] &= ~MPPE_128BIT;
-+ 			    goto check_mppe_56;
-+ 			}
-+ 			goto check_mppe;
-+  		    }
-+ 		    p[5] &= ~MPPE_128BIT;
-+ 		    goto check_mppe_56;
-+ 		}
-+ 		if ((p[5] & ~MPPE_MPPC) == (MPPE_40BIT|MPPE_128BIT)) {
-+ 		    newret = CONFNAK;
-+ 		    if (ao->mppe_128) {
-+ 			ho->mppe_128 = 1;
-+ 			p[5] &= ~MPPE_40BIT;
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+ 			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+ 			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+ 				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_128 = 0;
-+ 			    p[5] |= MPPE_40BIT;
-+ 			    p[5] &= ~MPPE_128BIT;
-+ 			    goto check_mppe_40;
-+ 			}
-+ 			goto check_mppe;
-+ 		    }
-+ 		    p[5] &= ~MPPE_128BIT;
-+ 		    goto check_mppe_40;
-+ 		}
-+ 		if ((p[5] & ~MPPE_MPPC) == MPPE_128BIT) {
-+ 		    if (ao->mppe_128) {
-+ 			ho->mppe_128 = 1;
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+ 			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+ 			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+ 				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_128 = 0;
-+ 			    p[5] &= ~MPPE_128BIT;
-+ 			    newret = CONFNAK;
-+ 			}
-+ 			goto check_mppe;
-+ 		    }
-+		    p[5] &= ~MPPE_128BIT;
-+ 		    newret = CONFNAK;
-+ 		    goto check_mppe;
-+ 		}
-+ 	    check_mppe_56_40:
-+		if ((p[5] & ~MPPE_MPPC) == (MPPE_40BIT|MPPE_56BIT)) {
-+ 		    newret = CONFNAK;
-+ 		    if (ao->mppe_56) {
-+ 			ho->mppe_56 = 1;
-+ 			p[5] &= ~MPPE_40BIT;
-+			BCOPY(p, opt_buf, CILEN_MPPE);
-+ 			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+ 			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_56 = 0;
-+ 			    p[5] |= MPPE_40BIT;
-+ 			    p[5] &= ~MPPE_56BIT;
-+			    newret = CONFNAK;
-+ 			    goto check_mppe_40;
-+ 			}
-+			goto check_mppe;
-+ 		    }
-+		    p[5] &= ~MPPE_56BIT;
-+ 		    goto check_mppe_40;
-+ 		}
-+ 	    check_mppe_56:
-+		if ((p[5] & ~MPPE_MPPC) == MPPE_56BIT) {
-+ 		    if (ao->mppe_56) {
-+ 			ho->mppe_56 = 1;
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+ 			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+ 				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_56 = 0;
-+ 			    p[5] &= ~MPPE_56BIT;
-+			    newret = CONFNAK;
-+ 			}
-+			goto check_mppe;
-+ 		    }
-+ 		    p[5] &= ~MPPE_56BIT;
-+ 		    newret = CONFNAK;
-+		    goto check_mppe;
-+ 		}
-+ 	    check_mppe_40:
-+		if ((p[5] & ~MPPE_MPPC) == MPPE_40BIT) {
-+ 		    if (ao->mppe_40) {
-+ 			ho->mppe_40 = 1;
-+ 			BCOPY(p, opt_buf, CILEN_MPPE);
-+			BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
-+ 			      MPPE_MAX_KEY_LEN);
-+ 			if (ccp_test(f->unit, opt_buf, CILEN_MPPE +
-+ 				     MPPE_MAX_KEY_LEN, 1) <= 0) {
-+ 			    ho->mppe_40 = 0;
-+			    p[5] &= ~MPPE_40BIT;
-+ 			    newret = CONFNAK;
-+ 			}
-+ 			goto check_mppe;
-+ 		    }
-+ 		    p[5] &= ~MPPE_40BIT;
-+ 		}
-+ 
-+ 	    check_mppe:
-+ 		if (!ho->mppe_40 && !ho->mppe_56 && !ho->mppe_128) {
-+ 		    if (wo->mppe_40 || wo->mppe_56 || wo->mppe_128) {
-+ 			newret = CONFNAK;
-+ 			p[2] |= (wo->mppe_stateless ? MPPE_STATELESS : 0);
-+			p[5] |= (wo->mppe_40 ? MPPE_40BIT : 0) |
-+ 			    (wo->mppe_56 ? MPPE_56BIT : 0) |
-+ 			    (wo->mppe_128 ? MPPE_128BIT : 0) |
-+ 			    (wo->mppc ? MPPE_MPPC : 0);
-+ 		    } else {
-+ 			ho->mppe = ho->mppe_stateless = 0;
-+ 		    }
- 		} else {
--		    /* Neither are set. */
--		    /* We cannot accept this.  */
--		    newret = CONFNAK;
--		    /* Give the peer our idea of what can be used,
--		       so it can choose and confirm */
--		    ho->mppe = ao->mppe;
--		}
--
--		/* rebuild the opts */
--		MPPE_OPTS_TO_CI(ho->mppe, &p[2]);
--		if (newret == CONFACK) {
--		    u_char opt_buf[CILEN_MPPE + MPPE_MAX_KEY_LEN];
--		    int mtu;
--
--		    BCOPY(p, opt_buf, CILEN_MPPE);
--		    BCOPY(mppe_send_key, &opt_buf[CILEN_MPPE],
--			  MPPE_MAX_KEY_LEN);
--		    if (ccp_test(f->unit, opt_buf,
--				 CILEN_MPPE + MPPE_MAX_KEY_LEN, 1) <= 0) {
--			/* This shouldn't happen, we've already tested it! */
--			error("MPPE required, but kernel has no support.");
--			lcp_close(f->unit, "MPPE required but not available");
--			newret = CONFREJ;
--			break;
--		    }
--		    /*
--		     * We need to decrease the interface MTU by MPPE_PAD
--		     * because MPPE frames **grow**.  The kernel [must]
--		     * allocate MPPE_PAD extra bytes in xmit buffers.
--		     */
--		    mtu = netif_get_mtu(f->unit);
--		    if (mtu)
--			netif_set_mtu(f->unit, mtu - MPPE_PAD);
--		    else
--			newret = CONFREJ;
--		}
--
--		/*
--		 * We have accepted MPPE or are willing to negotiate
--		 * MPPE parameters.  A CONFREJ is due to subsequent
--		 * (non-MPPE) processing.
--		 */
--		rej_for_ci_mppe = 0;
--		break;
--#endif /* MPPE */
-+ 		    /* MPPE is not compatible with other compression types */
-+ 		    if (wo->mppe) {
-+ 			ao->bsd_compress = 0;
-+ 			ao->predictor_1 = 0;
-+ 			ao->predictor_2 = 0;
-+			ao->deflate = 0;
-+ 			ao->lzs = 0;
-+ 		    }
-+ 		}
-+ 		if ((!ho->mppc || !ao->mppc) && !ho->mppe) {
-+ 		    p[2] = p2;
-+ 		    p[5] = p5;
-+  		    newret = CONFREJ;
-+  		    break;
-+  		}
-+  
-+ 		/*
-+ 		 * I have commented the code below because according to RFC1547
-+ 		 * MTU is only information for higher level protocols about
-+ 		 * "the maximum allowable length for a packet (q.v.) transmitted
-+ 		 * over a point-to-point link without incurring network layer
-+ 		 * fragmentation." Of course a PPP implementation should be able
-+ 		 * to handle overhead added by MPPE - in our case apropriate code
-+ 		 * is located in drivers/net/ppp_generic.c in the kernel sources.
-+		 *
-+ 		 * According to RFC1661:
-+ 		 * - when negotiated MRU is less than 1500 octets, a PPP
-+ 		 *   implementation must still be able to receive at least 1500
-+ 		 *   octets,
-+ 		 * - when PFC is negotiated, a PPP implementation is still
-+ 		 *   required to receive frames with uncompressed protocol field.
-+		 *
-+ 		 * So why not to handle MPPE overhead without changing MTU value?
-+ 		 * I am sure that RFC3078, unfortunately silently, assumes that.
-+ 		 */
-+ 
-+ 		/*
-+ 		 * We need to decrease the interface MTU by MPPE_PAD
-+ 		 * because MPPE frames **grow**.  The kernel [must]
-+ 		 * allocate MPPE_PAD extra bytes in xmit buffers.
-+ 		 */
-+ /*
-+ 		mtu = netif_get_mtu(f->unit);
-+ 		if (mtu) {
-+ 		    netif_set_mtu(f->unit, mtu - MPPE_PAD);
-+ 		} else {
-+		    newret = CONFREJ;
-+ 		    if (ccp_wantoptions[f->unit].mppe) {
-+ 			error("Cannot adjust MTU needed by MPPE.");
-+ 			lcp_close(f->unit, "Cannot adjust MTU needed by MPPE.");
-+ 		    }
-+ 		}
-+ */
-+ 		break;
-+  #endif /* MPPE */
-+ 
-+	    case CI_LZS:
-+ 		if (!ao->lzs || clen != CILEN_LZS) {
-+ 		    newret = CONFREJ;
-+ 		    break;
-+ 		}
-+ 
-+ 		ho->lzs = 1;
-+		ho->lzs_hists = (p[2] << 8) | p[3];
-+ 		ho->lzs_mode = p[4];
-+	if ((ho->lzs_hists != ao->lzs_hists) ||
-+		    (ho->lzs_mode != ao->lzs_mode)) {
-+ 		    newret = CONFNAK;
-+ 		    if (!dont_nak) {
-+ 			p[2] = ao->lzs_hists >> 8;
-+ 			p[3] = ao->lzs_hists & 0xff;
-+ 			p[4] = ao->lzs_mode;
-+	    } else
-+ 			break;
-+ 		}
-+ 
-+ 		if (p == p0 && ccp_test(f->unit, p, CILEN_LZS, 1) <= 0) {
-+ 		    newret = CONFREJ;
-+ 		}
-+ 		break;
- 	    case CI_DEFLATE:
- 	    case CI_DEFLATE_DRAFT:
- 		if (!ao->deflate || clen != CILEN_DEFLATE
-@@ -1327,12 +1813,6 @@ ccp_reqci(fsm *f, u_char *p, int *lenp,
- 	else
- 	    *lenp = retp - p0;
-     }
--#ifdef MPPE
--    if (ret == CONFREJ && ao->mppe && rej_for_ci_mppe) {
--	error("MPPE required but peer negotiation failed");
--	lcp_close(f->unit, "MPPE required but peer negotiation failed");
--    }
--#endif
-     return ret;
- }
- 
-@@ -1353,24 +1833,35 @@ method_name(ccp_options *opt, ccp_option
- 	char *p = result;
- 	char *q = result + sizeof(result); /* 1 past result */
- 
--	slprintf(p, q - p, "MPPE ");
--	p += 5;
--	if (opt->mppe & MPPE_OPT_128) {
--	    slprintf(p, q - p, "128-bit ");
--	    p += 8;
--	}
--	if (opt->mppe & MPPE_OPT_40) {
--	    slprintf(p, q - p, "40-bit ");
--	    p += 7;
--	}
--	if (opt->mppe & MPPE_OPT_STATEFUL)
--	    slprintf(p, q - p, "stateful");
--	else
--	    slprintf(p, q - p, "stateless");
--
-+	if (opt->mppe) {
-+	    if (opt->mppc) {
-+		slprintf(p, q - p, "MPPC/MPPE ");
-+		p += 10;
-+	    } else {
-+		slprintf(p, q - p, "MPPE ");
-+		p += 5;
-+	    }
-+	    if (opt->mppe_128) {
-+		slprintf(p, q - p, "128-bit ");
-+		p += 8;
-+	    } else if (opt->mppe_56) {
-+		slprintf(p, q - p, "56-bit ");
-+		p += 7;
-+	    } else if (opt->mppe_40) {
-+		slprintf(p, q - p, "40-bit ");
-+		p += 7;
-+	    }
-+	    if (opt->mppe_stateless)
-+		slprintf(p, q - p, "stateless");
-+	    else
-+		slprintf(p, q - p, "stateful");
-+	} else if (opt->mppc)
-+	    slprintf(p, q - p, "MPPC");
- 	break;
-     }
--#endif
-+#endif /* MPPE */
-+    case CI_LZS:
-+	return "Stac LZS";
-     case CI_DEFLATE:
-     case CI_DEFLATE_DRAFT:
- 	if (opt2 != NULL && opt2->deflate_size != opt->deflate_size)
-@@ -1425,12 +1916,12 @@ ccp_up(fsm *f)
-     } else if (ANY_COMPRESS(*ho))
- 	notice("%s transmit compression enabled", method_name(ho, NULL));
- #ifdef MPPE
--    if (go->mppe) {
-+    if (go->mppe || go->mppc) {
- 	BZERO(mppe_recv_key, MPPE_MAX_KEY_LEN);
- 	BZERO(mppe_send_key, MPPE_MAX_KEY_LEN);
- 	continue_networks(f->unit);		/* Bring up IP et al */
-     }
--#endif
-+#endif /* MPPE */
- }
- 
- /*
-@@ -1452,7 +1943,7 @@ ccp_down(fsm *f)
- 	    lcp_close(f->unit, "MPPE disabled");
- 	}
-     }
--#endif
-+#endif /* MPPE */
- }
- 
- /*
-@@ -1509,24 +2000,28 @@ ccp_printpkt(u_char *p, int plen,
- #ifdef MPPE
- 	    case CI_MPPE:
- 		if (optlen >= CILEN_MPPE) {
--		    u_char mppe_opts;
--
--		    MPPE_CI_TO_OPTS(&p[2], mppe_opts);
--		    printer(arg, "mppe %s %s %s %s %s %s%s",
--			    (p[2] & MPPE_H_BIT)? "+H": "-H",
--			    (p[5] & MPPE_M_BIT)? "+M": "-M",
--			    (p[5] & MPPE_S_BIT)? "+S": "-S",
--			    (p[5] & MPPE_L_BIT)? "+L": "-L",
-+		    printer(arg, "mppe %s %s %s %s %s %s",
-+			    (p[2] & MPPE_STATELESS)? "+H": "-H",
-+			    (p[5] & MPPE_56BIT)? "+M": "-M",
-+			    (p[5] & MPPE_128BIT)? "+S": "-S",
-+			    (p[5] & MPPE_40BIT)? "+L": "-L",
- 			    (p[5] & MPPE_D_BIT)? "+D": "-D",
--			    (p[5] & MPPE_C_BIT)? "+C": "-C",
--			    (mppe_opts & MPPE_OPT_UNKNOWN)? " +U": "");
--		    if (mppe_opts & MPPE_OPT_UNKNOWN)
-+			    (p[5] & MPPE_MPPC)? "+C": "-C");
-+		    if ((p[5] & ~(MPPE_56BIT | MPPE_128BIT | MPPE_40BIT |
-+				  MPPE_D_BIT | MPPE_MPPC)) ||
-+			(p[2] & ~MPPE_STATELESS))
- 			printer(arg, " (%.2x %.2x %.2x %.2x)",
- 				p[2], p[3], p[4], p[5]);
- 		    p += CILEN_MPPE;
- 		}
- 		break;
--#endif
-+#endif /* MPPE */
-+	    case CI_LZS:
-+		if (optlen >= CILEN_LZS) {
-+		    printer(arg, "lzs %.2x %.2x %.2x", p[2], p[3], p[4]);
-+		    p += CILEN_LZS;
-+		}
-+		break;
- 	    case CI_DEFLATE:
- 	    case CI_DEFLATE_DRAFT:
- 		if (optlen >= CILEN_DEFLATE) {
-@@ -1609,6 +2104,7 @@ ccp_datainput(int unit, u_char *pkt, int
- 	    error("Lost compression sync: disabling compression");
- 	    ccp_close(unit, "Lost compression sync");
- #ifdef MPPE
-+	    /* My module dosn't need this. J.D., 2003-07-06 */
- 	    /*
- 	     * If we were doing MPPE, we must also take the link down.
- 	     */
-@@ -1616,9 +2112,18 @@ ccp_datainput(int unit, u_char *pkt, int
- 		error("Too many MPPE errors, closing LCP");
- 		lcp_close(unit, "Too many MPPE errors");
- 	    }
--#endif
-+#endif /* MPPE */
- 	} else {
- 	    /*
-+	     * When LZS or MPPE/MPPC is negotiated we just send CCP_RESETREQ
-+	     * and don't wait for CCP_RESETACK
-+	     */
-+	    if ((ccp_gotoptions[f->unit].method == CI_LZS) ||
-+		(ccp_gotoptions[f->unit].method == CI_MPPE)) {
-+		fsm_sdata(f, CCP_RESETREQ, f->reqid = ++f->id, NULL, 0);
-+		return;
-+	    }
-+	    /*
- 	     * Send a reset-request to reset the peer's compressor.
- 	     * We don't do that if we are still waiting for an
- 	     * acknowledgement to a previous reset-request.
---- a/pppd/ccp.h
-+++ b/pppd/ccp.h
-@@ -37,9 +37,17 @@ typedef struct ccp_options {
-     bool predictor_2;		/* do Predictor-2? */
-     bool deflate_correct;	/* use correct code for deflate? */
-     bool deflate_draft;		/* use draft RFC code for deflate? */
-+    bool lzs;			/* do Stac LZS? */
-+    bool mppc;			/* do MPPC? */
-     u_char mppe;		/* MPPE bitfield */
-+    bool mppe_40;		/* allow 40 bit encryption? */
-+    bool mppe_56;		/* allow 56 bit encryption? */
-+    bool mppe_128;		/* allow 128 bit encryption? */
-+    bool mppe_stateless;	/* allow stateless encryption */
-     u_short bsd_bits;		/* # bits/code for BSD Compress */
-     u_short deflate_size;	/* lg(window size) for Deflate */
-+    u_short lzs_mode;		/* LZS check mode */
-+    u_short lzs_hists;		/* number of LZS histories */
-     short method;		/* code for chosen compression method */
- } ccp_options;
- 
---- a/pppd/chap_ms.c
-+++ b/pppd/chap_ms.c
-@@ -964,13 +964,17 @@ set_mppe_enc_types(int policy, int types
-     /*
-      * Disable undesirable encryption types.  Note that we don't ENABLE
-      * any encryption types, to avoid overriding manual configuration.
-+     *
-+     * It seems that 56 bit keys are unsupported in MS-RADIUS (see RFC 2548)
-      */
-     switch(types) {
- 	case MPPE_ENC_TYPES_RC4_40:
--	    ccp_wantoptions[0].mppe &= ~MPPE_OPT_128;	/* disable 128-bit */
-+	    ccp_wantoptions[0].mppe_128 = 0;	/* disable 128-bit */
-+	    ccp_wantoptions[0].mppe_56 = 0;	/* disable 56-bit */
- 	    break;
- 	case MPPE_ENC_TYPES_RC4_128:
--	    ccp_wantoptions[0].mppe &= ~MPPE_OPT_40;	/* disable 40-bit */
-+	    ccp_wantoptions[0].mppe_56 = 0;	/* disable 56-bit */
-+	    ccp_wantoptions[0].mppe_40 = 0;	/* disable 40-bit */
- 	    break;
- 	default:
- 	    break;
diff --git a/package/network/services/ppp/patches/203-opt_flags.patch b/package/network/services/ppp/patches/203-opt_flags.patch
deleted file mode 100644
index 705959e7..00000000
--- a/package/network/services/ppp/patches/203-opt_flags.patch
+++ /dev/null
@@ -1,38 +0,0 @@
-build: Move optimization flags into a separate variable
-
-Isolate optimization related compiler flags from CFLAGS and move them into a
-separate COPTS variable so that it is easier to override optimizations from
-the environment.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/plugins/radius/Makefile.linux
-+++ b/pppd/plugins/radius/Makefile.linux
-@@ -47,13 +47,13 @@ install: all
- 	$(INSTALL) -c -m 444 pppd-radattr.8 $(MANDIR)
- 
- radius.so: radius.o libradiusclient.a
--	$(CC) $(LDFLAGS) -o radius.so -shared radius.o libradiusclient.a
-+	$(CC) $(LDFLAGS) -fPIC -o radius.so -shared radius.o libradiusclient.a
- 
- radattr.so: radattr.o
--	$(CC) $(LDFLAGS) -o radattr.so -shared radattr.o
-+	$(CC) $(LDFLAGS) -fPIC -o radattr.so -shared radattr.o
- 
- radrealms.so: radrealms.o
--	$(CC) $(LDFLAGS) -o radrealms.so -shared radrealms.o
-+	$(CC) $(LDFLAGS) -fPIC -o radrealms.so -shared radrealms.o
- 
- CLIENTOBJS = avpair.o buildreq.o config.o dict.o ip_util.o \
- 	clientid.o sendserver.o lock.o util.o md5.o
---- a/pppd/plugins/pppoe/Makefile.linux
-+++ b/pppd/plugins/pppoe/Makefile.linux
-@@ -38,7 +38,7 @@ debug.o: debug.c
- 	$(CC) $(CFLAGS) -I../../.. -c -o debug.o debug.c
- 
- pppoe.so: plugin.o discovery.o if.o common.o
--	$(CC) $(LDFLAGS) -o pppoe.so -shared plugin.o discovery.o if.o common.o
-+	$(CC) $(LDFLAGS) -fPIC -o pppoe.so -shared plugin.o discovery.o if.o common.o
- 
- install: all
- 	$(INSTALL) -d -m 755 $(LIBDIR)
diff --git a/package/network/services/ppp/patches/204-radius_config.patch b/package/network/services/ppp/patches/204-radius_config.patch
index 2f30b9d3..3f6db59b 100644
--- a/package/network/services/ppp/patches/204-radius_config.patch
+++ b/package/network/services/ppp/patches/204-radius_config.patch
@@ -1,6 +1,6 @@
 --- a/pppd/plugins/radius/config.c
 +++ b/pppd/plugins/radius/config.c
-@@ -371,31 +371,37 @@ static int test_config(char *filename)
+@@ -381,31 +381,37 @@ static int test_config(char *filename)
  	}
  #endif
  
diff --git a/package/network/services/ppp/patches/205-no_exponential_timeout.patch b/package/network/services/ppp/patches/205-no_exponential_timeout.patch
deleted file mode 100644
index b08c2eff..00000000
--- a/package/network/services/ppp/patches/205-no_exponential_timeout.patch
+++ /dev/null
@@ -1,29 +0,0 @@
-pppd: Don't use exponential timeout in discovery phase
-
-This patch removes the exponential timeout increase between PADO or PADS
-discovery attempts.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/plugins/pppoe/discovery.c
-+++ b/pppd/plugins/pppoe/discovery.c
-@@ -632,7 +632,9 @@ discovery(PPPoEConnection *conn)
- 	conn->discoveryState = STATE_SENT_PADI;
- 	waitForPADO(conn, timeout);
- 
-+#if 0
- 	timeout *= 2;
-+#endif
-     } while (conn->discoveryState == STATE_SENT_PADI);
- 
-     timeout = conn->discoveryTimeout;
-@@ -647,7 +649,9 @@ discovery(PPPoEConnection *conn)
- 	sendPADR(conn);
- 	conn->discoveryState = STATE_SENT_PADR;
- 	waitForPADS(conn, timeout);
-+#if 0
- 	timeout *= 2;
-+#endif
-     } while (conn->discoveryState == STATE_SENT_PADR);
- 
-     if (!conn->seenMaxPayload) {
diff --git a/package/network/services/ppp/patches/207-lcp_mtu_max.patch b/package/network/services/ppp/patches/207-lcp_mtu_max.patch
index 522576c6..3ca0534f 100644
--- a/package/network/services/ppp/patches/207-lcp_mtu_max.patch
+++ b/package/network/services/ppp/patches/207-lcp_mtu_max.patch
@@ -8,18 +8,18 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
 --- a/pppd/lcp.c
 +++ b/pppd/lcp.c
-@@ -1862,12 +1862,12 @@ lcp_up(fsm *f)
+@@ -1888,12 +1888,12 @@ lcp_up(fsm *f)
       * the interface MTU is set to the lowest of that, the
       * MTU we want to use, and our link MRU.
       */
 -    mtu = ho->neg_mru? ho->mru: PPP_MRU;
 +    mtu = MIN(ho->neg_mru? ho->mru: PPP_MRU, ao->mru);
      mru = go->neg_mru? MAX(wo->mru, go->mru): PPP_MRU;
- #ifdef HAVE_MULTILINK
+ #ifdef PPP_WITH_MULTILINK
      if (!(multilink && go->neg_mrru && ho->neg_mrru))
- #endif /* HAVE_MULTILINK */
--	netif_set_mtu(f->unit, MIN(MIN(mtu, mru), ao->mru));
-+	netif_set_mtu(f->unit, MIN(mtu, mru));
+ #endif /* PPP_WITH_MULTILINK */
+-	ppp_set_mtu(f->unit, MIN(MIN(mtu, mru), ao->mru));
++	ppp_set_mtu(f->unit, MIN(mtu, mru));
      ppp_send_config(f->unit, mtu,
  		    (ho->neg_asyncmap? ho->asyncmap: 0xffffffff),
  		    ho->neg_pcompression, ho->neg_accompression);
diff --git a/package/network/services/ppp/patches/208-fix_status_code.patch b/package/network/services/ppp/patches/208-fix_status_code.patch
index 54e6c45e..10cd9453 100644
--- a/package/network/services/ppp/patches/208-fix_status_code.patch
+++ b/package/network/services/ppp/patches/208-fix_status_code.patch
@@ -12,13 +12,13 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
 --- a/pppd/main.c
 +++ b/pppd/main.c
-@@ -1034,7 +1034,8 @@ get_input(void)
+@@ -1152,7 +1152,8 @@ get_input(void)
  	}
  	notice("Modem hangup");
  	hungup = 1;
--	status = EXIT_HANGUP;
-+	if (status == EXIT_OK)
-+		status = EXIT_HANGUP;
+-	code = EXIT_HANGUP;
++	if (code == EXIT_OK)
++		code = EXIT_HANGUP;
  	lcp_lowerdown(0);	/* serial link is no longer available */
  	link_terminated(0);
  	return;
diff --git a/package/network/services/ppp/patches/300-filter-pcap-includes-lib.patch b/package/network/services/ppp/patches/300-filter-pcap-includes-lib.patch
deleted file mode 100644
index 87e340b3..00000000
--- a/package/network/services/ppp/patches/300-filter-pcap-includes-lib.patch
+++ /dev/null
@@ -1,20 +0,0 @@
-build: Add required CFLAGS for libpcap
-
-This patch adds some flags to required to properly link libpcap within the
-OpenWrt environment.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/Makefile.linux
-+++ b/pppd/Makefile.linux
-@@ -210,8 +210,8 @@ LIBS	+= -ldl
- endif
- 
- ifdef FILTER
--LIBS    += -lpcap
--CFLAGS  += -DPPP_FILTER
-+LIBS    += -lpcap -L$(STAGING_DIR)/usr/lib
-+CFLAGS  += -DPPP_FILTER -I$(STAGING_DIR)/usr/include
- endif
- 
- ifdef HAVE_INET6
diff --git a/package/network/services/ppp/patches/310-precompile_filter.patch b/package/network/services/ppp/patches/310-precompile_filter.patch
index ca91d153..ad0dd03d 100644
--- a/package/network/services/ppp/patches/310-precompile_filter.patch
+++ b/package/network/services/ppp/patches/310-precompile_filter.patch
@@ -11,62 +11,70 @@ packets which are treated as active.
 
 Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
---- a/pppd/Makefile.linux
-+++ b/pppd/Makefile.linux
-@@ -51,6 +51,9 @@ MPPE=y
- # and that the kernel driver support PPP packet filtering.
- #FILTER=y
+--- a/configure.ac
++++ b/configure.ac
+@@ -306,6 +306,9 @@ AM_CONDITIONAL(PPP_WITH_PAM, test "x${wi
+ # With libpcap support, activate pppd on network activity
+ AX_CHECK_PCAP
  
-+# Support for precompiled filters
-+PRECOMPILED_FILTER=y
++# internal statically linked pcap
++AM_CONDITIONAL(PPP_WITH_PRECOMPILED_FILTER, test "x${with_static_pcap}" = "xyes")
 +
- # Uncomment the next line to enable multilink PPP (enabled by default)
- # Linux distributions: Please leave multilink ENABLED in your builds
- # of pppd!
-@@ -214,6 +217,14 @@ LIBS    += -lpcap -L$(STAGING_DIR)/usr/l
- CFLAGS  += -DPPP_FILTER -I$(STAGING_DIR)/usr/include
+ #
+ # SunOS provides a version of libpcap that would work, but SunOS has no support for activity filter
+ AM_CONDITIONAL([PPP_WITH_FILTER], [ test "x${with_pcap}" = "xyes" && test "x${build_sunos}" != "xyes" ])
+@@ -359,6 +362,7 @@ $PACKAGE_NAME version $PACKAGE_VERSION
+     With libatm..........: ${with_atm:-no}
+     With libpam..........: ${with_pam:-no}
+     With libpcap.........: ${with_pcap:-no}
++    With static libpcap..: ${with_static_pcap:-no}
+     With libsrp..........: ${with_srp:-no}
+     C Compiler...........: $CC $CFLAGS
+     Linker...............: $LD $LDFLAGS $LIBS
+--- a/pppd/Makefile.am
++++ b/pppd/Makefile.am
+@@ -138,6 +138,12 @@ pppd_LDFLAGS += $(PCAP_LDFLAGS)
+ pppd_LIBS += $(PCAP_LIBS)
  endif
  
-+ifdef PRECOMPILED_FILTER
-+PPPDSRCS += pcap_pcc.c
-+HEADERS  += pcap_pcc.h
-+PPPDOBJS += pcap_pcc.o
-+LIBS	+= $(STAGING_DIR)/usr/lib/libpcap.a
-+CFLAGS	+= -DPPP_FILTER -DPPP_PRECOMPILED_FILTER -I$(STAGING_DIR)/usr/include
++if PPP_WITH_PRECOMPILED_FILTER
++pppd_SOURCES += pcap_pcc.c
++pppd_include_HEADERS += pcap_pcc.h
++pppd_LIBS += $(STAGING_DIR)/usr/lib/libpcap.a
 +endif
 +
- ifdef HAVE_INET6
-      PPPDSRCS += ipv6cp.c eui64.c
-      HEADERS  += ipv6cp.h eui64.h
+ if PPP_WITH_PLUGINS
+ pppd_CPPFLAGS += -DPPPD_PLUGIN_DIR='"@PPPD_PLUGIN_DIR@"'
+ pppd_LIBS += -ldl
 --- a/pppd/options.c
 +++ b/pppd/options.c
-@@ -56,6 +56,7 @@
+@@ -62,6 +62,7 @@
  
- #ifdef PPP_FILTER
+ #ifdef PPP_WITH_FILTER
  #include <pcap.h>
 +#include <pcap-bpf.h>
  /*
   * There have been 3 or 4 different names for this in libpcap CVS, but
   * this seems to be what they have settled on...
-@@ -168,6 +169,13 @@ static int setlogfile(char **);
+@@ -182,6 +183,13 @@ static int setlogfile(char **);
  static int loadplugin(char **);
  #endif
  
-+#ifdef PPP_PRECOMPILED_FILTER
++#ifdef PPP_WITH_PRECOMPILED_FILTER
 +#include "pcap_pcc.h"
 +static int setprecompiledpassfilter(char **);
 +static int setprecompiledactivefilter(char **);
-+#undef PPP_FILTER
++#undef PPP_WITH_FILTER
 +#endif
 +
- #ifdef PPP_FILTER
+ #ifdef PPP_WITH_FILTER
  static int setpassfilter(char **);
  static int setactivefilter(char **);
-@@ -360,6 +368,14 @@ option_t general_options[] = {
+@@ -391,6 +399,14 @@ struct option general_options[] = {
        "set filter for active pkts", OPT_PRIO },
  #endif
  
-+#ifdef PPP_PRECOMPILED_FILTER
++#ifdef PPP_WITH_PRECOMPILED_FILTER
 +    { "precompiled-pass-filter", 1, setprecompiledpassfilter,
 +      "set precompiled filter for packets to pass", OPT_PRIO },
 +
@@ -74,14 +82,14 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 +      "set precompiled filter for active pkts", OPT_PRIO },
 +#endif
 +
- #ifdef MAXOCTETS
      { "maxoctets", o_int, &maxoctets,
        "Set connection traffic limit",
-@@ -1468,6 +1484,27 @@ callfile(char **argv)
+       OPT_PRIO | OPT_LLIMIT | OPT_NOINCR | OPT_ZEROINF },
+@@ -1666,6 +1682,27 @@ callfile(char **argv)
      return ok;
  }
  
-+#ifdef PPP_PRECOMPILED_FILTER
++#ifdef PPP_WITH_PRECOMPILED_FILTER
 +/*
 + * setprecompiledpassfilter - Set the pass filter for packets using a
 + * precompiled expression
@@ -102,18 +110,19 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 +}
 +#endif
 +
- #ifdef PPP_FILTER
+ #ifdef PPP_WITH_FILTER
  /*
   * setpassfilter - Set the pass filter for packets
 --- /dev/null
 +++ b/pppd/pcap_pcc.c
-@@ -0,0 +1,74 @@
+@@ -0,0 +1,75 @@
 +#include <pcap.h>
 +#include <pcap-bpf.h>
 +#include <stdio.h>
 +#include <stdlib.h>
 +#include <string.h>
 +#include <errno.h>
++#include "options.h"
 +#include "pppd.h"
 +
 +int pcap_pre_compiled (char * fname, struct bpf_program *p)
@@ -123,7 +132,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 +    FILE *f = fopen (fname, "r");
 +    if (!f)
 +    {
-+       option_error("error opening precompiled active-filter '%s': %s",
++       ppp_option_error("error opening precompiled active-filter '%s': %s",
 +                    fname, strerror (errno));
 +       return 0;
 +    }
@@ -167,18 +176,18 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 +    } 
 +    if (size != index)
 +    {
-+       option_error("error in precompiled active-filter,"
-+                    " expected %d expressions, got %dn",
-+                    size, index);
++       ppp_option_error("error in precompiled active-filter,"
++                        " expected %d expressions, got %dn",
++                        size, index);
 +       ret = 0;
 +    }
 +    fclose(f);
 +    return ret;
 +
 +err:
-+  option_error("error in precompiled active-filter"
-+              " expression line %s:%d (wrong size)\n", 
-+              fname, line);
++  ppp_option_error("error in precompiled active-filter"
++                   " expression line %s:%d (wrong size)\n",
++                   fname, line);
 +  fclose (f);
 +  return 0;
 +}
diff --git a/package/network/services/ppp/patches/321-multilink_support_custom_iface_names.patch b/package/network/services/ppp/patches/321-multilink_support_custom_iface_names.patch
index 0c4d7ea9..a761ca65 100644
--- a/package/network/services/ppp/patches/321-multilink_support_custom_iface_names.patch
+++ b/package/network/services/ppp/patches/321-multilink_support_custom_iface_names.patch
@@ -8,15 +8,15 @@ Signed-off-by: George Kashperko <george@znau.edu.ua>
  2 files changed, 53 insertions(+), 14 deletions(-)
 --- a/pppd/multilink.c
 +++ b/pppd/multilink.c
-@@ -35,6 +35,7 @@
+@@ -40,6 +40,7 @@
  #include <signal.h>
  #include <netinet/in.h>
  #include <unistd.h>
 +#include <net/if.h>
  
- #include "pppd.h"
+ #include "pppd-private.h"
  #include "fsm.h"
-@@ -56,7 +57,8 @@ static void iterate_bundle_links(void (*
+@@ -62,7 +63,8 @@ static void iterate_bundle_links(void (*
  
  static int get_default_epdisc(struct epdisc *);
  static int parse_num(char *str, const char *key, int *valp);
@@ -26,7 +26,7 @@ Signed-off-by: George Kashperko <george@znau.edu.ua>
  
  #define set_ip_epdisc(ep, addr) do {	\
  	ep->length = 4;			\
-@@ -197,35 +199,38 @@ mp_join_bundle(void)
+@@ -215,35 +217,38 @@ mp_join_bundle(void)
  	key.dptr = bundle_id;
  	key.dsize = p - bundle_id;
  	pid = tdb_fetch(pppdb, key);
@@ -61,7 +61,7 @@ Signed-off-by: George Kashperko <george@znau.edu.ua>
 -		if (bundle_attach(unit)) {
 +		if (unit >= 0 && bundle_attach(unit)) {
  			set_ifunit(0);
- 			script_setenv("BUNDLE", bundle_id + 7, 0);
+ 			ppp_script_setenv("BUNDLE", bundle_id + 7, 0);
  			make_bundle_links(1);
  			unlock_db();
 -			info("Link attached to %s", ifname);
@@ -73,7 +73,7 @@ Signed-off-by: George Kashperko <george@znau.edu.ua>
  	}
  
  	/* we have to make a new bundle */
-@@ -405,20 +410,39 @@ parse_num(char *str, const char *key, in
+@@ -423,20 +428,39 @@ parse_num(char *str, const char *key, in
  	return 0;
  }
  
@@ -119,7 +119,7 @@ Signed-off-by: George Kashperko <george@znau.edu.ua>
  			&& memcmp(vd.dptr, key.dptr, vd.dsize) == 0;
 --- a/pppd/sys-linux.c
 +++ b/pppd/sys-linux.c
-@@ -706,6 +706,16 @@ void cfg_bundle(int mrru, int mtru, int
+@@ -984,6 +984,16 @@ void cfg_bundle(int mrru, int mtru, int
  	add_fd(ppp_dev_fd);
  }
  
@@ -129,14 +129,14 @@ Signed-off-by: George Kashperko <george@znau.edu.ua>
 +#ifdef USE_TDB
 +	char tmp[11];
 +	slprintf(tmp, sizeof(tmp), "%d", ifunit);
-+	script_setenv("IFUNIT", tmp, 0);
++	ppp_script_setenv("IFUNIT", tmp, 0);
 +#endif
 +}
 +
  /*
   * make_new_bundle - create a new PPP unit (i.e. a bundle)
   * and connect our channel to it.  This should only get called
-@@ -724,6 +734,8 @@ void make_new_bundle(int mrru, int mtru,
+@@ -1002,6 +1012,8 @@ void make_new_bundle(int mrru, int mtru,
  
  	/* set the mrru and flags */
  	cfg_bundle(mrru, mtru, rssn, tssn);
diff --git a/package/network/services/ppp/patches/330-retain_foreign_default_routes.patch b/package/network/services/ppp/patches/330-retain_foreign_default_routes.patch
deleted file mode 100644
index 6ccc4507..00000000
--- a/package/network/services/ppp/patches/330-retain_foreign_default_routes.patch
+++ /dev/null
@@ -1,22 +0,0 @@
-pppd: Retain foreign default routes on Linux
-
-On Linux, when pppd attempts to delete its default route it does not fill
-the rt_dev field of the struct rtentry used to match the system default route.
-As a consequence, pppd happily deletes any default route even if it belongs
-to another interface.
-
-This patch makes pppd fill out the rt_dev field so that only own default
-routes are ever matched.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/sys-linux.c
-+++ b/pppd/sys-linux.c
-@@ -1770,6 +1770,7 @@ int cifdefaultroute (int unit, u_int32_t
- 	SIN_ADDR(rt.rt_genmask) = 0L;
-     }
- 
-+    rt.rt_dev = ifname;
-     rt.rt_flags = RTF_UP;
-     if (ioctl(sock_fd, SIOCDELRT, &rt) < 0 && errno != ESRCH) {
- 	if (still_ppp()) {
diff --git a/package/network/services/ppp/patches/340-populate_default_gateway.patch b/package/network/services/ppp/patches/340-populate_default_gateway.patch
index 0f965c70..f3279713 100644
--- a/package/network/services/ppp/patches/340-populate_default_gateway.patch
+++ b/package/network/services/ppp/patches/340-populate_default_gateway.patch
@@ -13,7 +13,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
 --- a/pppd/sys-linux.c
 +++ b/pppd/sys-linux.c
-@@ -1720,6 +1720,9 @@ int sifdefaultroute (int unit, u_int32_t
+@@ -2251,6 +2251,9 @@ int sifdefaultroute (int unit, u_int32_t
      memset (&rt, 0, sizeof (rt));
      SET_SA_FAMILY (rt.rt_dst, AF_INET);
  
@@ -23,7 +23,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      rt.rt_dev = ifname;
      rt.rt_metric = dfl_route_metric + 1; /* +1 for binary compatibility */
  
-@@ -1728,7 +1731,7 @@ int sifdefaultroute (int unit, u_int32_t
+@@ -2259,7 +2262,7 @@ int sifdefaultroute (int unit, u_int32_t
  	SIN_ADDR(rt.rt_genmask) = 0L;
      }
  
diff --git a/package/network/services/ppp/patches/400-simplify_kernel_checks.patch b/package/network/services/ppp/patches/400-simplify_kernel_checks.patch
index 3c720483..311bb875 100644
--- a/package/network/services/ppp/patches/400-simplify_kernel_checks.patch
+++ b/package/network/services/ppp/patches/400-simplify_kernel_checks.patch
@@ -10,7 +10,14 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
 --- a/pppd/sys-linux.c
 +++ b/pppd/sys-linux.c
-@@ -206,7 +206,7 @@ static int driver_is_old       = 0;
+@@ -224,14 +224,10 @@ static fd_set in_fds;		/* set of fds tha
+ static int max_in_fd;		/* highest fd set in in_fds */
+ 
+ static int has_proxy_arp       = 0;
+-static int driver_version      = 0;
+-static int driver_modification = 0;
+-static int driver_patch        = 0;
+-static int driver_is_old       = 0;
  static int restore_term        = 0;	/* 1 => we've munged the terminal */
  static struct termios inittermios;	/* Initial TTY termios */
  
@@ -19,17 +26,18 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
  
  static char loop_name[20];
  static unsigned char inbuf[512]; /* buffer for chars read from loopback */
-@@ -225,8 +225,8 @@ static int	looped;			/* 1 if using loop
+@@ -249,9 +245,8 @@ static int	dynaddr_set;		/* 1 if ip_dyna
+ static int	looped;			/* 1 if using loop */
  static int	link_mtu;		/* mtu for the link (not bundle) */
  
- static struct utsname utsname;	/* for the kernel version */
+-static struct utsname utsname;	/* for the kernel version */
 -static int kernel_version;
  #define KVERSION(j,n,p)	((j)*1000000 + (n)*1000 + (p))
-+static const int kernel_version = KVERSION(2,6,37);
++static const int kernel_version = KVERSION(4,9,0);
  
  #define MAX_IFS		100
  
-@@ -1455,11 +1455,12 @@ int ccp_fatal_error (int unit)
+@@ -1970,11 +1965,12 @@ int ccp_fatal_error (int unit)
   *
   * path_to_procfs - find the path to the proc file system mount point
   */
@@ -44,7 +52,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      struct mntent *mntent;
      FILE *fp;
  
-@@ -1481,6 +1482,7 @@ static char *path_to_procfs(const char *
+@@ -1996,6 +1992,7 @@ static char *path_to_procfs(const char *
  	    fclose (fp);
  	}
      }
@@ -52,35 +60,24 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
  
      strlcpy(proc_path + proc_path_len, tail,
  	    sizeof(proc_path) - proc_path_len);
-@@ -2365,15 +2367,19 @@ int ppp_available(void)
-     int    my_version, my_modification, my_patch;
-     int osmaj, osmin, ospatch;
+@@ -2889,6 +2886,8 @@ ppp_registered(void)
  
+ int ppp_check_kernel_support(void)
+ {
++    return 1; /* OpenWrt support ppp device "/dev/ppp" by default */
 +#if 0
-     /* get the kernel version now, since we are called before sys_init */
-     uname(&utsname);
-     osmaj = osmin = ospatch = 0;
-     sscanf(utsname.release, "%d.%d.%d", &osmaj, &osmin, &ospatch);
-     kernel_version = KVERSION(osmaj, osmin, ospatch);
-+#endif
- 
-     fd = open("/dev/ppp", O_RDWR);
-     if (fd >= 0) {
-+#if 0
- 	new_style_driver = 1;
+     int s, ok, fd;
+     struct ifreq ifr;
+     int    size;
+@@ -3016,6 +3015,7 @@ int ppp_check_kernel_support(void)
+     }
+     close(s);
+     return ok;
 +#endif
+ }
  
- 	/* XXX should get from driver */
- 	driver_version = 2;
-@@ -2433,6 +2439,7 @@ int ppp_available(void)
- 
-     if (ok && ((ifr.ifr_hwaddr.sa_family & ~0xFF) != ARPHRD_PPP))
- 	ok = 0;
-+	return ok;
- 
- /*
-  *  This is the PPP device. Validate the version of the driver at this
-@@ -3106,6 +3113,7 @@ get_pty(int *master_fdp, int *slave_fdp,
+ #ifndef HAVE_LOGWTMP
+@@ -3577,6 +3577,7 @@ get_pty(int *master_fdp, int *slave_fdp,
      }
  #endif /* TIOCGPTN */
  
@@ -88,7 +85,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      if (sfd < 0) {
  	/* the old way - scan through the pty name space */
  	for (i = 0; i < 64; ++i) {
-@@ -3124,6 +3132,7 @@ get_pty(int *master_fdp, int *slave_fdp,
+@@ -3601,6 +3602,7 @@ get_pty(int *master_fdp, int *slave_fdp,
  	    }
  	}
      }
@@ -96,28 +93,40 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
  
      if (sfd < 0)
  	return 0;
+@@ -3716,6 +3718,7 @@ get_host_seed(void)
+ int
+ sys_check_options(void)
+ {
++#if 0
+     if (demand && driver_is_old) {
+ 	ppp_option_error("demand dialling is not supported by kernel driver "
+ 		     "version %d.%d.%d", driver_version, driver_modification,
+@@ -3726,6 +3729,7 @@ sys_check_options(void)
+ 	warn("Warning: multilink is not supported by the kernel driver");
+ 	multilink = 0;
+     }
++#endif
+     return 1;
+ }
+ 
 --- a/pppd/plugins/pppoatm/pppoatm.c
 +++ b/pppd/plugins/pppoatm/pppoatm.c
-@@ -171,14 +171,6 @@ static void disconnect_pppoatm(void)
- 
+@@ -180,10 +180,6 @@ static void disconnect_pppoatm(void)
  void plugin_init(void)
  {
--#ifdef linux
+ #ifdef linux
 -	extern int new_style_driver;	/* From sys-linux.c */
--	if (!ppp_available() && !new_style_driver)
+-	if (!ppp_check_kernel_support() && !new_style_driver)
 -		fatal("Kernel doesn't support ppp_generic - "
 -		    "needed for PPPoATM");
--#else
--	fatal("No PPPoATM support on this OS");
--#endif
- 	add_options(pppoa_options);
- }
- 
+ #else
+ 	fatal("No PPPoATM support on this OS");
+ #endif
 --- a/pppd/plugins/pppoe/plugin.c
 +++ b/pppd/plugins/pppoe/plugin.c
-@@ -58,9 +58,6 @@ static char const RCSID[] =
+@@ -57,9 +57,6 @@ static char const RCSID[] =
  
- char pppd_version[] = VERSION;
+ char pppd_version[] = PPPD_VERSION;
  
 -/* From sys-linux.c in pppd -- MUST FIX THIS! */
 -extern int new_style_driver;
@@ -125,30 +134,27 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
  char *pppd_pppoe_service = NULL;
  static char *acName = NULL;
  static char *existingSession = NULL;
-@@ -407,10 +404,6 @@ PPPoEDevnameHook(char *cmd, char **argv,
+@@ -421,10 +418,6 @@ PPPoEDevnameHook(char *cmd, char **argv,
  void
  plugin_init(void)
  {
--    if (!ppp_available() && !new_style_driver) {
+-    if (!ppp_check_kernel_support() && !new_style_driver) {
 -	fatal("Linux kernel does not support PPPoE -- are you running 2.4.x?");
 -    }
 -
-     add_options(Options);
+     ppp_add_options(Options);
  
-     info("PPPoE plugin from pppd %s", VERSION);
+     info("PPPoE plugin from pppd %s", PPPD_VERSION);
 --- a/pppd/plugins/pppol2tp/pppol2tp.c
 +++ b/pppd/plugins/pppol2tp/pppol2tp.c
-@@ -490,12 +490,7 @@ static void pppol2tp_cleanup(void)
- 
+@@ -501,10 +501,6 @@ static void pppol2tp_cleanup(void)
  void plugin_init(void)
  {
--#if defined(__linux__)
+ #if defined(__linux__)
 -	extern int new_style_driver;	/* From sys-linux.c */
--	if (!ppp_available() && !new_style_driver)
+-	if (!ppp_check_kernel_support() && !new_style_driver)
 -		fatal("Kernel doesn't support ppp_generic - "
 -		    "needed for PPPoL2TP");
--#else
-+#if !defined(__linux__)
+ #else
  	fatal("No PPPoL2TP support on this OS");
  #endif
- 	add_options(pppol2tp_options);
diff --git a/package/network/services/ppp/patches/401-no_record_file.patch b/package/network/services/ppp/patches/401-no_record_file.patch
index 78442606..5ef1a178 100644
--- a/package/network/services/ppp/patches/401-no_record_file.patch
+++ b/package/network/services/ppp/patches/401-no_record_file.patch
@@ -5,19 +5,19 @@ information to the permanent storage, therfore remove this option.
 
 Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
---- a/pppd/pppd.h
-+++ b/pppd/pppd.h
-@@ -317,7 +317,6 @@ extern int	holdoff;	/* Dead time before
+--- a/pppd/pppd-private.h
++++ b/pppd/pppd-private.h
+@@ -187,7 +187,6 @@ extern int	holdoff;	/* Dead time before
  extern bool	holdoff_specified; /* true if user gave a holdoff value */
  extern bool	notty;		/* Stdin/out is not a tty */
  extern char	*pty_socket;	/* Socket to connect to pty */
 -extern char	*record_file;	/* File to record chars sent/received */
- extern bool	sync_serial;	/* Device is synchronous serial device */
  extern int	maxfail;	/* Max # of unsuccessful connection attempts */
- extern char	linkname[MAXPATHLEN]; /* logical name for link */
+ extern char	linkname[];	/* logical name for link */
+ extern bool	tune_kernel;	/* May alter kernel settings as necessary */
 --- a/pppd/tty.c
 +++ b/pppd/tty.c
-@@ -143,7 +143,7 @@ char	*disconnect_script = NULL; /* Scrip
+@@ -150,7 +150,7 @@ char	*disconnect_script = NULL; /* Scrip
  char	*welcomer = NULL;	/* Script to run after phys link estab. */
  char	*ptycommand = NULL;	/* Command to run on other side of pty */
  bool	notty = 0;		/* Stdin/out is not a tty */
@@ -26,7 +26,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
  int	max_data_rate;		/* max bytes/sec through charshunt */
  bool	sync_serial = 0;	/* Device is synchronous serial device */
  char	*pty_socket = NULL;	/* Socket to connect to pty */
-@@ -199,8 +199,10 @@ option_t tty_options[] = {
+@@ -206,8 +206,10 @@ static struct option tty_options[] = {
        "Send and receive over socket, arg is host:port",
        OPT_PRIO | OPT_DEVNAM },
  
diff --git a/package/network/services/ppp/patches/403-no_wtmp.patch b/package/network/services/ppp/patches/403-no_wtmp.patch
deleted file mode 100644
index 772620ed..00000000
--- a/package/network/services/ppp/patches/403-no_wtmp.patch
+++ /dev/null
@@ -1,25 +0,0 @@
-pppd: Disable wtmp support
-
-Many uClibc based environments lack wtmp and utmp support, therfore remove
-the code updating the wtmp information.
-
-Signed-off-by: Jo-Philipp Wich <jo@mein.io>
-
---- a/pppd/sys-linux.c
-+++ b/pppd/sys-linux.c
-@@ -2503,6 +2503,7 @@ int ppp_available(void)
- 
- void logwtmp (const char *line, const char *name, const char *host)
- {
-+#if 0
-     struct utmp ut, *utp;
-     pid_t  mypid = getpid();
- #if __GLIBC__ < 2
-@@ -2568,6 +2569,7 @@ void logwtmp (const char *line, const ch
- 	close (wtmp);
-     }
- #endif
-+#endif
- }
- #endif /* HAVE_LOGWTMP */
- 
diff --git a/package/network/services/ppp/patches/404-remove_obsolete_protocol_names.patch b/package/network/services/ppp/patches/404-remove_obsolete_protocol_names.patch
index b9b6f0e5..6b2d15ed 100644
--- a/package/network/services/ppp/patches/404-remove_obsolete_protocol_names.patch
+++ b/package/network/services/ppp/patches/404-remove_obsolete_protocol_names.patch
@@ -7,7 +7,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
 --- a/pppd/main.c
 +++ b/pppd/main.c
-@@ -866,14 +866,17 @@ struct protocol_list {
+@@ -984,14 +984,17 @@ struct protocol_list {
      const char	*name;
  } protocol_list[] = {
      { 0x21,	"IP" },
@@ -25,7 +25,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x33,	"Stream Protocol ST-II" },
      { 0x35,	"Banyan Vines" },
      { 0x39,	"AppleTalk EDDP" },
-@@ -887,8 +890,11 @@ struct protocol_list {
+@@ -1005,8 +1008,11 @@ struct protocol_list {
      { 0x49,	"Serial Data Transport Protocol (PPP-SDTP)" },
      { 0x4b,	"SNA over 802.2" },
      { 0x4d,	"SNA" },
@@ -37,7 +37,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x53,	"Encryption" },
      { 0x55,	"Individual Link Encryption" },
      { 0x57,	"IPv6" },
-@@ -899,12 +905,15 @@ struct protocol_list {
+@@ -1017,12 +1023,15 @@ struct protocol_list {
      { 0x65,	"RTP IPHC Compressed non-TCP" },
      { 0x67,	"RTP IPHC Compressed UDP 8" },
      { 0x69,	"RTP IPHC Compressed RTP 8" },
@@ -53,7 +53,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x0203,	"IBM Source Routing BPDU" },
      { 0x0205,	"DEC LANBridge100 Spanning Tree" },
      { 0x0207,	"Cisco Discovery Protocol" },
-@@ -916,15 +925,19 @@ struct protocol_list {
+@@ -1034,15 +1043,19 @@ struct protocol_list {
      { 0x0231,	"Luxcom" },
      { 0x0233,	"Sigma Network Systems" },
      { 0x0235,	"Apple Client Server Protocol" },
@@ -73,7 +73,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x4001,	"Cray Communications Control Protocol" },
      { 0x4003,	"CDPD Mobile Network Registration Protocol" },
      { 0x4005,	"Expand accelerator protocol" },
-@@ -935,8 +948,10 @@ struct protocol_list {
+@@ -1053,8 +1066,10 @@ struct protocol_list {
      { 0x4023,	"RefTek Protocol" },
      { 0x4025,	"Fibre Channel" },
      { 0x4027,	"EMIT Protocols" },
@@ -84,7 +84,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x8023,	"OSI Network Layer Control Protocol" },
      { 0x8025,	"Xerox NS IDP Control Protocol" },
      { 0x8027,	"DECnet Phase IV Control Protocol" },
-@@ -945,7 +960,9 @@ struct protocol_list {
+@@ -1063,7 +1078,9 @@ struct protocol_list {
      { 0x8031,	"Bridging NCP" },
      { 0x8033,	"Stream Protocol Control Protocol" },
      { 0x8035,	"Banyan Vines Control Protocol" },
@@ -94,7 +94,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x803f,	"NETBIOS Framing Control Protocol" },
      { 0x8041,	"Cisco Systems Control Protocol" },
      { 0x8043,	"Ascom Timeplex" },
-@@ -954,18 +971,24 @@ struct protocol_list {
+@@ -1072,18 +1089,24 @@ struct protocol_list {
      { 0x8049,	"Serial Data Control Protocol (PPP-SDCP)" },
      { 0x804b,	"SNA over 802.2 Control Protocol" },
      { 0x804d,	"SNA Control Protocol" },
@@ -119,7 +119,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
      { 0x8207,	"Cisco Discovery Protocol Control" },
      { 0x8209,	"Netcs Twin Routing" },
      { 0x820b,	"STP - Control Protocol" },
-@@ -974,24 +997,29 @@ struct protocol_list {
+@@ -1092,24 +1115,29 @@ struct protocol_list {
      { 0x8281,	"MPLSCP" },
      { 0x8285,	"IEEE p1284.4 standard - Protocol Control" },
      { 0x8287,	"ETSI TETRA TNP1 Control Protocol" },
diff --git a/package/network/services/ppp/patches/405-no_multilink_option.patch b/package/network/services/ppp/patches/405-no_multilink_option.patch
index a34ec57b..654bebd5 100644
--- a/package/network/services/ppp/patches/405-no_multilink_option.patch
+++ b/package/network/services/ppp/patches/405-no_multilink_option.patch
@@ -9,7 +9,7 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
 
 --- a/pppd/options.c
 +++ b/pppd/options.c
-@@ -348,13 +348,14 @@ option_t general_options[] = {
+@@ -379,13 +379,14 @@ struct option general_options[] = {
        "Enable multilink operation", OPT_PRIOSUB | OPT_ALIAS | 1 },
      { "nomultilink", o_bool, &multilink,
        "Disable multilink operation", OPT_PRIOSUB | 0 },
@@ -18,11 +18,11 @@ Signed-off-by: Jo-Philipp Wich <jo@mein.io>
  
      { "bundle", o_string, &bundle_name,
        "Bundle name for multilink", OPT_PRIO },
- #endif /* HAVE_MULTILINK */
+ #endif /* PPP_WITH_MULTILINK */
  
 +    { "nomp", o_bool, &multilink,
 +      "Disable multilink operation", OPT_PRIOSUB | OPT_ALIAS | 0 },
 +
- #ifdef PLUGIN
+ #ifdef PPP_WITH_PLUGINS
      { "plugin", o_special, (void *)loadplugin,
        "Load a plug-in module into pppd", OPT_PRIV | OPT_A2LIST },
diff --git a/package/network/services/ppp/patches/500-add-pptp-plugin.patch b/package/network/services/ppp/patches/500-add-pptp-plugin.patch
index 96f4bcaf..4b66cd21 100644
--- a/package/network/services/ppp/patches/500-add-pptp-plugin.patch
+++ b/package/network/services/ppp/patches/500-add-pptp-plugin.patch
@@ -1,59 +1,43 @@
---- a/configure
-+++ b/configure
-@@ -133,7 +133,7 @@ if [ -d "$ksrc" ]; then
-     mkmkf $ksrc/Makedefs$compiletype Makedefs.com
-     for dir in pppd pppstats chat pppdump pppd/plugins pppd/plugins/pppoe \
- 	       pppd/plugins/radius pppd/plugins/pppoatm \
--	       pppd/plugins/pppol2tp; do
-+	       pppd/plugins/pppol2tp pppd/plugins/pptp ; do
- 	mkmkf $dir/Makefile.$makext $dir/Makefile
-     done
-     if [ -f $ksrc/Makefile.$makext$archvariant ]; then
---- a/pppd/plugins/Makefile.linux
-+++ b/pppd/plugins/Makefile.linux
-@@ -14,7 +14,7 @@ INSTALL	= install
- # EAP-TLS
- CFLAGS += -DUSE_EAPTLS=1
+--- a/configure.ac
++++ b/configure.ac
+@@ -344,6 +344,7 @@ AC_CONFIG_FILES([
+     pppd/plugins/pppoatm/Makefile
+     pppd/plugins/pppol2tp/Makefile
+     pppd/plugins/radius/Makefile
++    pppd/plugins/pptp/Makefile
+     pppdump/Makefile
+     pppstats/Makefile
+     scripts/Makefile
+--- a/pppd/plugins/Makefile.am
++++ b/pppd/plugins/Makefile.am
+@@ -21,5 +21,5 @@ winbind_la_LDFLAGS = $(PLUGIN_LDFLAGS)
+ winbind_la_SOURCES = winbind.c
  
--SUBDIRS := pppoe pppoatm pppol2tp
-+SUBDIRS := pppoe pppoatm pppol2tp pptp
- # Uncomment the next line to include the radius authentication plugin
- SUBDIRS += radius
- PLUGINS := minconn.so passprompt.so passwordfd.so winbind.so
+ if !SUNOS
+-SUBDIRS = pppoe pppoatm pppol2tp radius
++SUBDIRS = pppoe pppoatm pppol2tp radius pptp
+ endif
 --- /dev/null
-+++ b/pppd/plugins/pptp/Makefile.linux
-@@ -0,0 +1,31 @@
-+#
-+# This program may be distributed according to the terms of the GNU
-+# General Public License, version 2 or (at your option) any later version.
-+#
-+# $Id: Makefile.linux,v 1.9 2012/05/04 21:48:00 dgolle Exp $
-+#***********************************************************************
-+
-+DESTDIR = $(INSTROOT)@DESTDIR@
-+LIBDIR = $(DESTDIR)/lib/pppd/$(PPPDVERSION)
-+
-+PPPDVERSION = $(shell awk -F '"' '/VERSION/ { print $$2; }' ../../patchlevel.h)
-+
-+INSTALL	= install
-+
-+COPTS=-O2 -g
-+CFLAGS  = $(COPTS) -I. -I../.. -I../../../include -fPIC -DPPPD_VERSION=\"$(PPPDVERSION)\"
-+all: pptp.so
-+
-+%.o: %.c
-+	$(CC) $(CFLAGS) -c -o $@ $<
-+
-+pptp.so: dirutil.o orckit_quirks.o pptp.o pptp_callmgr.o pptp_ctrl.o pptp_quirks.o util.o vector.o
-+	$(CC) -o pptp.so -shared dirutil.o orckit_quirks.o pptp.o pptp_callmgr.o pptp_ctrl.o pptp_quirks.o util.o vector.o
-+
-+install: all
-+	$(INSTALL) -d -m 755 $(LIBDIR)
-+	$(INSTALL) -c -m 4550 pptp.so $(LIBDIR)
-+
-+clean:
-+	rm -f *.o *.so
-+
++++ b/pppd/plugins/pptp/Makefile.am
+@@ -0,0 +1,18 @@
++pppd_plugin_LTLIBRARIES = pptp.la
++pppd_plugindir = $(PPPD_PLUGIN_DIR)
++
++noinst_HEADERS = \
++    dirutil.h \
++    orckit_quirks.h \
++    pptp_callmgr.h \
++    pptp_ctrl.h \
++    pptp_msg.h \
++    pptp_options.h \
++    pptp_quirks.h \
++    util.h \
++    vector.h
++
++pptp_la_CPPFLAGS = -I${top_srcdir} -DSYSCONFDIR=\"${sysconfdir}\" -DPLUGIN
++pptp_la_LDFLAGS = -fPIC -module -avoid-version
++pptp_la_SOURCES = dirutil.c orckit_quirks.c pptp.c pptp_callmgr.c pptp_ctrl.c \
++    pptp_quirks.c util.c vector.c
 --- /dev/null
 +++ b/pppd/plugins/pptp/dirutil.c
 @@ -0,0 +1,68 @@
@@ -334,7 +318,7 @@
 +xeb xeb@mail.ru
 --- /dev/null
 +++ b/pppd/plugins/pptp/pptp.c
-@@ -0,0 +1,323 @@
+@@ -0,0 +1,325 @@
 +/***************************************************************************
 + *   Copyright (C) 2006 by Kozlov D. <xeb@mail.ru>                         *
 + *   some cleanup done (C) 2012 by Daniel Golle <dgolle@allnet.de>         *
@@ -377,6 +361,8 @@
 +#include <sys/ioctl.h>
 +
 +#include "pppd.h"
++#include "pppd-private.h"
++#include "options.h"
 +#include "fsm.h"
 +#include "lcp.h"
 +#include "ipcp.h"
@@ -385,7 +371,7 @@
 +
 +#include "pptp_callmgr.h"
 +#include <net/if.h>
-+#include <net/ethernet.h>
++#include <linux/if_ether.h>
 +#include <linux/if_pppox.h>
 +
 +#include <stdio.h>
@@ -437,8 +423,8 @@
 +    check_options: NULL,
 +    connect: &pptp_connect,
 +    disconnect: &pptp_disconnect,
-+    establish_ppp: &generic_establish_ppp,
-+    disestablish_ppp: &generic_disestablish_ppp,
++    establish_ppp: &ppp_generic_establish,
++    disestablish_ppp: &ppp_generic_disestablish,
 +    close: NULL,
 +    cleanup: NULL
 +};
@@ -446,7 +432,7 @@
 +static int pptp_start_server(void)
 +{
 +	pptp_fd=pptp_sock;
-+	sprintf(ppp_devnam,"pptp (%s)",pptp_client);
++	sprintf(ppp_devname,"pptp (%s)",pptp_client);
 +
 +	return pptp_fd;
 +}
@@ -527,7 +513,7 @@
 +		return -1;
 +	}
 +
-+	sprintf(ppp_devnam,"pptp (%s)",pptp_server);
++	sprintf(ppp_devname,"pptp (%s)",pptp_server);
 +
 +	return pptp_fd;
 +}
@@ -651,7 +637,7 @@
 +
 +void plugin_init(void)
 +{
-+    add_options(Options);
++    ppp_add_options(Options);
 +
 +    info("PPTP plugin version %s", PPTP_VERSION);
 +
diff --git a/package/network/services/ppp/patches/510-pptp_compile_fix.patch b/package/network/services/ppp/patches/510-pptp_compile_fix.patch
deleted file mode 100644
index 04bb620e..00000000
--- a/package/network/services/ppp/patches/510-pptp_compile_fix.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/pppd/plugins/pptp/pptp.c
-+++ b/pppd/plugins/pptp/pptp.c
-@@ -48,7 +48,7 @@
- 
- #include "pptp_callmgr.h"
- #include <net/if.h>
--#include <net/ethernet.h>
-+#include <linux/if_ether.h>
- #include <linux/if_pppox.h>
- 
- #include <stdio.h>
diff --git a/package/network/services/ppp/patches/511-pptp_cflags.patch b/package/network/services/ppp/patches/511-pptp_cflags.patch
deleted file mode 100644
index 548bf41c..00000000
--- a/package/network/services/ppp/patches/511-pptp_cflags.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/pppd/plugins/pptp/Makefile.linux
-+++ b/pppd/plugins/pptp/Makefile.linux
-@@ -20,7 +20,7 @@ all: pptp.so
- 	$(CC) $(CFLAGS) -c -o $@ $<
- 
- pptp.so: dirutil.o orckit_quirks.o pptp.o pptp_callmgr.o pptp_ctrl.o pptp_quirks.o util.o vector.o
--	$(CC) -o pptp.so -shared dirutil.o orckit_quirks.o pptp.o pptp_callmgr.o pptp_ctrl.o pptp_quirks.o util.o vector.o
-+	$(CC) -fPIC -o pptp.so -shared dirutil.o orckit_quirks.o pptp.o pptp_callmgr.o pptp_ctrl.o pptp_quirks.o util.o vector.o
- 
- install: all
- 	$(INSTALL) -d -m 755 $(LIBDIR)
diff --git a/package/network/services/ppp/patches/512-syncppp.patch b/package/network/services/ppp/patches/512-syncppp.patch
deleted file mode 100644
index 39ff5200..00000000
--- a/package/network/services/ppp/patches/512-syncppp.patch
+++ /dev/null
@@ -1,204 +0,0 @@
---- a/pppd/chap-new.c
-+++ b/pppd/chap-new.c
-@@ -37,6 +37,8 @@
- #include "chap-new.h"
- #include "chap-md5.h"
- 
-+#include "syncppp.h"
-+
- #ifdef CHAPMS
- #include "chap_ms.h"
- #define MDTYPE_ALL (MDTYPE_MICROSOFT_V2 | MDTYPE_MICROSOFT | MDTYPE_MD5)
-@@ -523,6 +525,18 @@ chap_respond(struct chap_client_state *cs, int id,
- 	p[2] = len >> 8;
- 	p[3] = len;
- 
-+	if (npppd > 1) {
-+		if (syncppp(npppd) < 0) {
-+			error("syncppp sync fail");
-+			sem_unlink(SEM_COUNT_NAME);
-+			sem_unlink(SEM_BLOCK_NAME);
-+		} else {
-+			info("syncppp sync succeeded");
-+		}
-+	} else {
-+		info("syncppp not active");
-+	}
-+
- 	output(0, response, PPP_HDRLEN + len);
- }
- 
---- a/pppd/Makefile.linux
-+++ b/pppd/Makefile.linux
-@@ -17,16 +17,16 @@ TARGETS = pppd
- 
- PPPDSRCS = main.c magic.c fsm.c lcp.c ipcp.c upap.c chap-new.c md5.c ccp.c \
- 	   ecp.c ipxcp.c auth.c options.c sys-linux.c md4.c chap_ms.c \
--	   demand.c utils.c tty.c eap.c chap-md5.c session.c
-+	   demand.c utils.c tty.c eap.c chap-md5.c session.c syncppp.c
- 
- HEADERS = ccp.h session.h chap-new.h ecp.h fsm.h ipcp.h \
- 	ipxcp.h lcp.h magic.h md5.h patchlevel.h pathnames.h pppd.h \
--	upap.h eap.h
-+	upap.h eap.h syncppp.h
- 
- MANPAGES = pppd.8
- PPPDOBJS = main.o magic.o fsm.o lcp.o ipcp.o upap.o chap-new.o md5.o ccp.o \
- 	   ecp.o auth.o options.o demand.o utils.o sys-linux.o ipxcp.o tty.o \
--	   eap.o chap-md5.o session.o
-+	   eap.o chap-md5.o session.o syncppp.o
- 
- #
- # include dependencies if present
-@@ -34,7 +34,7 @@ ifeq (.depend,$(wildcard .depend))
- include .depend
- endif
- 
--LIBS = -lrt
-+LIBS = -lpthread
- 
- # Uncomment the next line to include support for Microsoft's
- # MS-CHAP authentication protocol.  Also, edit plugins/radius/Makefile.linux.
---- a/pppd/options.c
-+++ b/pppd/options.c
-@@ -127,6 +127,7 @@ bool	dump_options;		/* print out option values */
- bool	dryrun;			/* print out option values and exit */
- char	*domain;		/* domain name set by domain option */
- int	child_wait = 5;		/* # seconds to wait for children at exit */
-+int	npppd = 0;		/* synchronize between multiple pppd */
- struct userenv *userenv_list;	/* user environment variables */
- int	dfl_route_metric = -1;	/* metric of the default route to set over the PPP link */
- 
-@@ -323,6 +324,9 @@ option_t general_options[] = {
-       "Unset user environment variable",
-       OPT_A2PRINTER | OPT_NOPRINT, (void *)user_unsetprint },
- 
-+    { "syncppp", o_int, &npppd,
-+      "sync among multiple pppd when sending chap/pap respond", OPT_PRIO },
-+
-     { "defaultroute-metric", o_int, &dfl_route_metric,
-       "Metric to use for the default route (Linux only; -1 for default behavior)",
-       OPT_PRIV|OPT_LLIMIT|OPT_INITONLY, NULL, 0, -1 },
---- a/pppd/pppd.h
-+++ b/pppd/pppd.h
-@@ -335,6 +335,7 @@ extern char	*bundle_name;	/* bundle name for multilink */
- extern bool	dump_options;	/* print out option values */
- extern bool	dryrun;		/* check everything, print options, exit */
- extern int	child_wait;	/* # seconds to wait for children at end */
-+extern int	npppd;		/* synchronize between multiple pppd */
- 
- #ifdef USE_EAPTLS
- extern char	*crl_dir;
---- /dev/null
-+++ b/pppd/syncppp.c
-@@ -0,0 +1,75 @@
-+#include<stdio.h>
-+#include<semaphore.h>
-+#include<fcntl.h>
-+#include<stdlib.h>
-+#include<time.h>
-+#include<errno.h>
-+#include "pppd.h"
-+#include "syncppp.h"
-+
-+int syncppp(int nproc)
-+{
-+    int flags;
-+    int value;
-+    sem_t *block; 
-+    sem_t *count;
-+    struct timespec ts;
-+
-+    if (nproc <= 1) {
-+        error("syncppp: number of pppd should be larger than 1");
-+        return -1;
-+    }
-+
-+    if (clock_gettime(CLOCK_REALTIME, &ts) == -1) {
-+        error("clock_gettime error");
-+        return -1;
-+    }
-+    ts.tv_sec += SYNCPPP_TIMEOUT;
-+
-+
-+    flags = O_RDWR | O_CREAT;
-+    block = sem_open(SEM_BLOCK_NAME, flags, 0644, 0);
-+    count = sem_open(SEM_COUNT_NAME, flags, 0644, 0);
-+    if (block == SEM_FAILED || count == SEM_FAILED) {
-+        error("syncppp: sem_open failed");
-+        return -1;
-+    }
-+
-+    if (sem_post(count) < 0) {
-+        error("syncppp: sem_post failed");
-+        return -1;
-+    }
-+    if (sem_getvalue(count, &value) < 0) {
-+        error("syncppp: sem_getvalue failed");
-+        return -1;
-+    }
-+    info("%d pppd have arrived, waiting for the left %d", value, nproc-value);
-+    if (value >= nproc) {
-+        while (nproc-1 > 0) {
-+            if (sem_post(block) < 0) {
-+                error("syncppp: sem_post failed");
-+                return -1;
-+            }
-+            nproc--;
-+        }
-+    } else {
-+        if (sem_timedwait(block, &ts) < 0) {
-+            if (errno == ETIMEDOUT) {
-+                error("syncppp: sem_timewait time out");
-+            } else {
-+                error("syncppp: sem_timewait error");
-+            }
-+            return -1;
-+        }
-+
-+    }
-+
-+    sem_close(count);
-+    sem_close(block);
-+
-+    sem_unlink(SEM_COUNT_NAME);
-+    sem_unlink(SEM_BLOCK_NAME);
-+
-+    return 0;
-+}
-+
---- /dev/null
-+++ b/pppd/syncppp.h
-@@ -0,0 +1,3 @@
-+#define SEM_BLOCK_NAME  "block"
-+#define SEM_COUNT_NAME  "count"
-+#define SYNCPPP_TIMEOUT 5
---- a/pppd/upap.c
-+++ b/pppd/upap.c
-@@ -50,6 +50,7 @@
- #include "pppd.h"
- #include "upap.h"
- 
-+#include "syncppp.h"
- 
- static bool hide_password = 1;
- 
-@@ -540,6 +541,18 @@ upap_sauthreq(upap_state *u)
-     PUTCHAR(u->us_passwdlen, outp);
-     BCOPY(u->us_passwd, outp, u->us_passwdlen);
- 
-+    if (npppd > 1) {
-+        if (syncppp(npppd) < 0) {
-+            error("syncppp sync fail");
-+            sem_unlink(SEM_COUNT_NAME);
-+            sem_unlink(SEM_BLOCK_NAME);
-+        } else {
-+            info("syncppp sync succeeded");
-+        }
-+    } else {
-+        info("syncppp not active");
-+    }
-+
-     output(u->us_unit, outpacket_buf, outlen + PPP_HDRLEN);
- 
-     TIMEOUT(upap_timeout, u, u->us_timeouttime);
diff --git a/package/network/services/ppp/patches/600-Revert-pppd-Use-openssl-for-the-DES-instead-of-the-l.patch b/package/network/services/ppp/patches/600-Revert-pppd-Use-openssl-for-the-DES-instead-of-the-l.patch
deleted file mode 100644
index a3042af5..00000000
--- a/package/network/services/ppp/patches/600-Revert-pppd-Use-openssl-for-the-DES-instead-of-the-l.patch
+++ /dev/null
@@ -1,89 +0,0 @@
-From 831dca008699d485f2c8e91749657ef2d0b06166 Mon Sep 17 00:00:00 2001
-From: Martin Schiller <ms@dev.tdt.de>
-Date: Thu, 6 Dec 2018 08:43:17 +0100
-Subject: [PATCH] Revert "pppd: Use openssl for the DES instead of the libcrypt
- / glibc"
-
-For musl and glibc2.27 we can keep linking to crypt; however if we
-switch to glibc 2.28 we will have to link to one of the SSL libraries.
-
-This reverts commit 3c7b86229f7bd2600d74db14b1fe5b3896be3875.
----
- pppd/Makefile.linux |  7 +++----
- pppd/pppcrypt.c     | 18 +++++++++---------
- 2 files changed, 12 insertions(+), 13 deletions(-)
-
---- a/pppd/Makefile.linux
-+++ b/pppd/Makefile.linux
-@@ -36,10 +36,10 @@ endif
- 
- LIBS = -lpthread
- 
--# Uncomment the next line to include support for Microsoft's
-+# Uncomment the next 2 lines to include support for Microsoft's
- # MS-CHAP authentication protocol.  Also, edit plugins/radius/Makefile.linux.
- CHAPMS=y
--#USE_CRYPT=y
-+USE_CRYPT=y
- # Don't use MSLANMAN unless you really know what you're doing.
- #MSLANMAN=y
- # Uncomment the next line to include support for MPPE.  CHAPMS (above) must
-@@ -158,8 +158,7 @@ endif
- 
- ifdef NEEDDES
- ifndef USE_CRYPT
--CFLAGS   += -I$(shell $(CC) --print-sysroot)/usr/include/openssl
--NEEDCRYPTOLIB = y
-+LIBS     += -ldes $(LIBS)
- else
- CFLAGS   += -DUSE_CRYPT=1
- endif
---- a/pppd/pppcrypt.c
-+++ b/pppd/pppcrypt.c
-@@ -62,7 +62,7 @@ MakeKey(u_char *key, u_char *des_key)
- 	des_key[7] = Get7Bits(key, 49);
- 
- #ifndef USE_CRYPT
--	DES_set_odd_parity((DES_cblock *)des_key);
-+	des_set_odd_parity((des_cblock *)des_key);
- #endif
- }
- 
-@@ -147,30 +147,30 @@ DesDecrypt(u_char *cipher, u_char *clear
- }
- 
- #else /* USE_CRYPT */
--static DES_key_schedule	key_schedule;
-+static des_key_schedule	key_schedule;
- 
- bool
- DesSetkey(u_char *key)
- {
--	DES_cblock des_key;
-+	des_cblock des_key;
- 	MakeKey(key, des_key);
--	DES_set_key(&des_key, &key_schedule);
-+	des_set_key(&des_key, key_schedule);
- 	return (1);
- }
- 
- bool
- DesEncrypt(u_char *clear, u_char *cipher)
- {
--	DES_ecb_encrypt((DES_cblock *)clear, (DES_cblock *)cipher,
--	    &key_schedule, 1);
-+	des_ecb_encrypt((des_cblock *)clear, (des_cblock *)cipher,
-+	    key_schedule, 1);
- 	return (1);
- }
- 
- bool
- DesDecrypt(u_char *cipher, u_char *clear)
- {
--	DES_ecb_encrypt((DES_cblock *)cipher, (DES_cblock *)clear,
--	    &key_schedule, 0);
-+	des_ecb_encrypt((des_cblock *)cipher, (des_cblock *)clear,
-+	    key_schedule, 0);
- 	return (1);
- }
- 
diff --git a/package/network/services/ppp/patches/610-pppd_compile_fix.patch b/package/network/services/ppp/patches/610-pppd_compile_fix.patch
deleted file mode 100644
index 4f66e5d7..00000000
--- a/package/network/services/ppp/patches/610-pppd_compile_fix.patch
+++ /dev/null
@@ -1,12 +0,0 @@
---- a/pppd/Makefile.linux
-+++ b/pppd/Makefile.linux
-@@ -49,7 +49,8 @@ MPPE=y
- # Uncomment the next line to include support for PPP packet filtering.
- # This requires that the libpcap library and headers be installed
- # and that the kernel driver support PPP packet filtering.
--#FILTER=y
-+# libpcap statically linked in OpenWRT, hence disabled here.
-+FILTER=
- 
- # Support for precompiled filters
- PRECOMPILED_FILTER=y
diff --git a/package/network/utils/iproute2/Makefile b/package/network/utils/iproute2/Makefile
index 302d57bf..04a4df24 100644
--- a/package/network/utils/iproute2/Makefile
+++ b/package/network/utils/iproute2/Makefile
@@ -8,17 +8,19 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=iproute2
-PKG_VERSION:=6.2.0
+PKG_VERSION:=6.11.0
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
 PKG_SOURCE_URL:=@KERNEL/linux/utils/net/iproute2
-PKG_HASH:=4d72730200ec5b2aabaa1a2f20553c6748292f065d9a154c7d5e22559df9fd62
+PKG_HASH:=1f795398a04aeaacd06a8f6ace2cfd913c33fa5953ca99daae83bb5c534611c3
 PKG_BUILD_PARALLEL:=1
 PKG_BUILD_DEPENDS:=iptables
 PKG_LICENSE:=GPL-2.0
 PKG_CPE_ID:=cpe:/a:iproute2_project:iproute2
 
+PKG_BUILD_FLAGS:=gc-sections lto
+
 include $(INCLUDE_DIR)/kernel.mk
 include $(INCLUDE_DIR)/package.mk
 include $(INCLUDE_DIR)/nls.mk
@@ -75,14 +77,7 @@ $(call Package/iproute2/Default)
   VARIANT:=tcfull
   PROVIDES:=tc
   ALTERNATIVES:=400:/sbin/tc:/usr/libexec/tc-full
-  DEPENDS:=+kmod-sched-core +(PACKAGE_devlink||PACKAGE_rdma):libmnl +libbpf +libxtables +tc-mod-iptables
-endef
-
-define Package/tc-mod-iptables
-$(call Package/iproute2/Default)
-  TITLE:=Traffic control module - iptables action
-  VARIANT:=tcfull
-  DEPENDS:=+libxtables +libbpf
+  DEPENDS:=+kmod-sched-core +(PACKAGE_devlink||PACKAGE_rdma):libmnl +libbpf +libxtables
 endef
 
 define Package/genl
@@ -100,7 +95,7 @@ endef
 define Package/ss
 $(call Package/iproute2/Default)
   TITLE:=Socket statistics utility
-  DEPENDS:=+libnl-tiny +(PACKAGE_devlink||PACKAGE_rdma):libmnl +kmod-netlink-diag
+  DEPENDS:=+libnl-tiny +(PACKAGE_devlink||PACKAGE_rdma):libmnl +libbpf +kmod-netlink-diag
 endef
 
 define Package/nstat
@@ -171,8 +166,7 @@ define Build/Configure
 		> $(PKG_BUILD_DIR)/include/SNAPSHOT.h
 endef
 
-TARGET_CFLAGS += -ffunction-sections -fdata-sections -flto
-TARGET_LDFLAGS += -Wl,--gc-sections -Wl,--as-needed
+TARGET_LDFLAGS += -Wl,--as-needed
 TARGET_CPPFLAGS += -I$(STAGING_DIR)/usr/include/libnl-tiny
 
 MAKE_FLAGS += \
@@ -231,11 +225,6 @@ define Package/tc-full/install
 	$(INSTALL_BIN) $(PKG_BUILD_DIR)/tc/tc $(1)/usr/libexec/tc-full
 endef
 
-define Package/tc-mod-iptables/install
-	$(INSTALL_DIR) $(1)/usr/lib/tc
-	$(CP) $(PKG_BUILD_DIR)/tc/m_xt.so $(1)/usr/lib/tc
-endef
-
 define Package/genl/install
 	$(INSTALL_DIR) $(1)/usr/sbin
 	$(INSTALL_BIN) $(PKG_BUILD_DIR)/genl/genl $(1)/usr/sbin/
@@ -268,9 +257,6 @@ endef
 
 $(eval $(call BuildPackage,ip-tiny))
 $(eval $(call BuildPackage,ip-full))
-# build tc-mod-iptables before its dependents, to avoid
-# spurious rebuilds when building multiple variants.
-$(eval $(call BuildPackage,tc-mod-iptables))
 $(eval $(call BuildPackage,tc-tiny))
 $(eval $(call BuildPackage,tc-bpf))
 $(eval $(call BuildPackage,tc-full))
diff --git a/package/network/utils/iproute2/patches/100-configure.patch b/package/network/utils/iproute2/patches/100-configure.patch
deleted file mode 100644
index 2d4fb7b9..00000000
--- a/package/network/utils/iproute2/patches/100-configure.patch
+++ /dev/null
@@ -1,12 +0,0 @@
---- a/configure
-+++ b/configure
-@@ -36,7 +36,8 @@ int main(int argc, char **argv) {
- }
- EOF
- 
--    if $CC -I$INCLUDE -o $TMPDIR/atmtest $TMPDIR/atmtest.c -latm >/dev/null 2>&1; then
-+# OpenWrt: disable ATM support even if present on host system
-+    if [ 1 -eq 0 ]; then
- 	echo "TC_CONFIG_ATM:=y" >>$CONFIG
- 	echo yes
-     else
diff --git a/package/network/utils/iproute2/patches/105-ipstats-Define-MIN-function-to-fix-undefined-referen.patch b/package/network/utils/iproute2/patches/105-ipstats-Define-MIN-function-to-fix-undefined-referen.patch
deleted file mode 100644
index 7bf55dd5..00000000
--- a/package/network/utils/iproute2/patches/105-ipstats-Define-MIN-function-to-fix-undefined-referen.patch
+++ /dev/null
@@ -1,27 +0,0 @@
-From c69e8e474936795a2cd7638b11ce3e99ff4d5ae7 Mon Sep 17 00:00:00 2001
-From: Nick Hainke <vincent@systemli.org>
-Date: Sat, 6 Aug 2022 10:00:20 +0200
-Subject: [PATCH] ipstats: Define MIN function to fix undefined references
-
-Fixes errors in the form of:
- in function `ipstats_show_64':
- <artificial>:(.text+0x4e30): undefined reference to `MIN'
-
-Signed-off-by: Nick Hainke <vincent@systemli.org>
----
- ip/ipstats.c | 4 ++++
- 1 file changed, 4 insertions(+)
-
---- a/ip/ipstats.c
-+++ b/ip/ipstats.c
-@@ -6,6 +6,10 @@
- #include "utils.h"
- #include "ip_common.h"
- 
-+#ifndef MIN
-+#define MIN(a, b) ((a) < (b) ? (a) : (b))
-+#endif
-+
- struct ipstats_stat_dump_filters {
- 	/* mask[0] filters outer attributes. Then individual nests have their
- 	 * filtering mask at the index of the nested attribute.
diff --git a/package/network/utils/iproute2/patches/115-add-config-xtlibdir.patch b/package/network/utils/iproute2/patches/115-add-config-xtlibdir.patch
index 03df7809..38448e6c 100644
--- a/package/network/utils/iproute2/patches/115-add-config-xtlibdir.patch
+++ b/package/network/utils/iproute2/patches/115-add-config-xtlibdir.patch
@@ -1,6 +1,6 @@
 --- a/tc/Makefile
 +++ b/tc/Makefile
-@@ -127,6 +127,9 @@ CFLAGS += -DCONFIG_GACT -DCONFIG_GACT_PR
+@@ -107,6 +107,9 @@ CFLAGS += -DCONFIG_GACT -DCONFIG_GACT_PR
  ifneq ($(IPT_LIB_DIR),)
  	CFLAGS += -DIPT_LIB_DIR=\"$(IPT_LIB_DIR)\"
  endif
diff --git a/package/network/utils/iproute2/patches/130-no_netem_tipc_dcb_man_vdpa.patch b/package/network/utils/iproute2/patches/130-no_netem_tipc_dcb_man_vdpa.patch
index 2a3f9eb9..7f946070 100644
--- a/package/network/utils/iproute2/patches/130-no_netem_tipc_dcb_man_vdpa.patch
+++ b/package/network/utils/iproute2/patches/130-no_netem_tipc_dcb_man_vdpa.patch
@@ -1,6 +1,6 @@
 --- a/Makefile
 +++ b/Makefile
-@@ -65,9 +65,9 @@ WFLAGS += -Wmissing-declarations -Wold-s
+@@ -69,9 +69,9 @@ WFLAGS += -Wmissing-declarations -Wold-s
  CFLAGS := $(WFLAGS) $(CCOPTS) -I../include -I../include/uapi $(DEFINES) $(CFLAGS)
  YACCFLAGS = -d -t -v
  
diff --git a/package/network/utils/iproute2/patches/140-keep_libmnl_optional.patch b/package/network/utils/iproute2/patches/140-keep_libmnl_optional.patch
index a8cdd103..48a4ae75 100644
--- a/package/network/utils/iproute2/patches/140-keep_libmnl_optional.patch
+++ b/package/network/utils/iproute2/patches/140-keep_libmnl_optional.patch
@@ -1,6 +1,6 @@
 --- a/configure
 +++ b/configure
-@@ -411,7 +411,7 @@ check_tirpc()
+@@ -368,7 +368,7 @@ check_tirpc()
  
  check_mnl()
  {
diff --git a/package/network/utils/iproute2/patches/145-keep_libelf_optional.patch b/package/network/utils/iproute2/patches/145-keep_libelf_optional.patch
index 0c5c3f59..99b9d326 100644
--- a/package/network/utils/iproute2/patches/145-keep_libelf_optional.patch
+++ b/package/network/utils/iproute2/patches/145-keep_libelf_optional.patch
@@ -1,6 +1,6 @@
 --- a/configure
 +++ b/configure
-@@ -266,7 +266,7 @@ EOF
+@@ -217,7 +217,7 @@ EOF
  
  check_elf()
  {
diff --git a/package/network/utils/iproute2/patches/150-keep_libcap_optional.patch b/package/network/utils/iproute2/patches/150-keep_libcap_optional.patch
index 4cce2c3c..49873f87 100644
--- a/package/network/utils/iproute2/patches/150-keep_libcap_optional.patch
+++ b/package/network/utils/iproute2/patches/150-keep_libcap_optional.patch
@@ -1,6 +1,6 @@
 --- a/configure
 +++ b/configure
-@@ -469,7 +469,7 @@ EOF
+@@ -427,7 +427,7 @@ EOF
  
  check_cap()
  {
diff --git a/package/network/utils/iproute2/patches/155-keep_tirpc_optional.patch b/package/network/utils/iproute2/patches/155-keep_tirpc_optional.patch
index 28ba7e52..9e5e4330 100644
--- a/package/network/utils/iproute2/patches/155-keep_tirpc_optional.patch
+++ b/package/network/utils/iproute2/patches/155-keep_tirpc_optional.patch
@@ -1,6 +1,6 @@
 --- a/configure
 +++ b/configure
-@@ -398,7 +398,7 @@ check_selinux()
+@@ -355,7 +355,7 @@ check_selinux()
  
  check_tirpc()
  {
diff --git a/package/network/utils/iproute2/patches/170-ip_tiny.patch b/package/network/utils/iproute2/patches/170-ip_tiny.patch
index 71081c36..149bcd2a 100644
--- a/package/network/utils/iproute2/patches/170-ip_tiny.patch
+++ b/package/network/utils/iproute2/patches/170-ip_tiny.patch
@@ -30,15 +30,15 @@
  		"Usage: ip [ OPTIONS ] OBJECT { COMMAND | help }\n"
  		"       ip [ -force ] -batch filename\n"
 +#ifndef IPROUTE2_TINY
- 		"where  OBJECT := { address | addrlabel | amt | fou | help | ila | ioam | l2tp |\n"
- 		"                   link | macsec | maddress | monitor | mptcp | mroute | mrule |\n"
+ 		"where  OBJECT := { address | addrlabel | fou | help | ila | ioam | l2tp | link |\n"
+ 		"                   macsec | maddress | monitor | mptcp | mroute | mrule |\n"
  		"                   neighbor | neighbour | netconf | netns | nexthop | ntable |\n"
- 		"                   ntbl | route | rule | sr | tap | tcpmetrics |\n"
+ 		"                   ntbl | route | rule | sr | stats | tap | tcpmetrics |\n"
  		"                   token | tunnel | tuntap | vrf | xfrm }\n"
 +#else
-+		"where  OBJECT := { address | link | maddress | monitor |\n"
++		"where  OBJECT := { address | help | link | maddress | monitor |\n"
 +		"                   neighbor | neighbour | netns | route |\n"
-+		"                   rule | token | tunnel }\n"
++		"                   rule | stats | token | tunnel }\n"
 +#endif
  		"       OPTIONS := { -V[ersion] | -s[tatistics] | -d[etails] | -r[esolve] |\n"
  		"                    -h[uman-readable] | -iec | -j[son] | -p[retty] |\n"
diff --git a/package/network/utils/iproute2/patches/175-reduce-dynamic-syms.patch b/package/network/utils/iproute2/patches/175-reduce-dynamic-syms.patch
deleted file mode 100644
index d0914848..00000000
--- a/package/network/utils/iproute2/patches/175-reduce-dynamic-syms.patch
+++ /dev/null
@@ -1,45 +0,0 @@
---- a/tc/Makefile
-+++ b/tc/Makefile
-@@ -113,7 +113,7 @@ LDLIBS += -L. -lm
- 
- ifeq ($(SHARED_LIBS),y)
- LDLIBS += -ldl
--LDFLAGS += -Wl,-export-dynamic
-+LDFLAGS += -Wl,--dynamic-list=dynsyms.list
- endif
- 
- TCLIB := tc_core.o
-@@ -143,7 +143,7 @@ MODDESTDIR := $(DESTDIR)$(LIBDIR)/tc
- all: tc $(TCSO)
- 
- tc: $(TCOBJ) $(LIBNETLINK) libtc.a
--	$(QUIET_LINK)$(CC) $^ $(LDFLAGS) $(LDLIBS) -o $@
-+	$(QUIET_LINK)$(CC) $(filter-out dynsyms.list, $^) $(LDFLAGS) $(LDLIBS) -o $@
- 
- libtc.a: $(TCLIB)
- 	$(QUIET_AR)$(AR) rcs $@ $^
-@@ -165,6 +165,7 @@ install: all
- clean:
- 	rm -f $(TCOBJ) $(TCLIB) libtc.a tc *.so emp_ematch.tab.h; \
- 	rm -f emp_ematch.tab.*
-+	rm -f dynsyms.list
- 
- q_atm.so: q_atm.c
- 	$(QUIET_CC)$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) -shared -fpic -o q_atm.so q_atm.c -latm
-@@ -204,4 +205,16 @@ static-syms.h: $(wildcard *.c)
- 		sed -n '/'$$s'[^ ]* =/{s:.* \([^ ]*'$$s'[^ ]*\) .*:extern char \1[] __attribute__((weak)); if (!strcmp(sym, "\1")) return \1;:;p}' $$files ; \
- 	done > $@
- 
-+else
-+
-+tc: dynsyms.list
-+m_xt.so: dynsyms.list
-+dynsyms.list: $(wildcard *.c)
-+	files="$(filter-out $(patsubst %.so,%.c,$(TCSO)), $^)" ; \
-+	echo "{" > $@ ; \
-+	for s in `grep -B 3 '\<dlsym' $$files | sed -n '/snprintf/{s:.*"\([^"]*\)".*:\1:;s:%s::;p}'` ; do \
-+		sed -n '/'$$s'[^ ]* =/{s:.* \([^ ]*'$$s'[^ ]*\) .*:\1;:;p}' $$files ; \
-+	done >> $@ ; \
-+	echo "show_stats; print_nl; print_tm; parse_rtattr; parse_rtattr_flags; get_u32; matches; addattr_l; addattr_nest; addattr_nest_end; };" >> $@
-+
- endif
diff --git a/package/network/utils/iproute2/patches/190-fix-nls-rpath-link.patch b/package/network/utils/iproute2/patches/190-fix-nls-rpath-link.patch
index c7fceb2e..545075fd 100644
--- a/package/network/utils/iproute2/patches/190-fix-nls-rpath-link.patch
+++ b/package/network/utils/iproute2/patches/190-fix-nls-rpath-link.patch
@@ -1,6 +1,6 @@
 --- a/configure
 +++ b/configure
-@@ -290,7 +290,7 @@ int main(int argc, char **argv) {
+@@ -241,7 +241,7 @@ int main(int argc, char **argv) {
  }
  EOF
  
@@ -9,7 +9,7 @@
      local ret=$?
  
      rm -f $TMPDIR/libbpf_test.c $TMPDIR/libbpf_test
-@@ -308,7 +308,7 @@ int main(int argc, char **argv) {
+@@ -259,7 +259,7 @@ int main(int argc, char **argv) {
  }
  EOF
  
diff --git a/package/network/utils/iproute2/patches/195-build_variant_ip_tc.patch b/package/network/utils/iproute2/patches/195-build_variant_ip_tc.patch
index 14176346..6ecf5568 100644
--- a/package/network/utils/iproute2/patches/195-build_variant_ip_tc.patch
+++ b/package/network/utils/iproute2/patches/195-build_variant_ip_tc.patch
@@ -11,7 +11,7 @@
  
 --- a/tc/Makefile
 +++ b/tc/Makefile
-@@ -140,7 +140,7 @@ MODDESTDIR := $(DESTDIR)$(LIBDIR)/tc
+@@ -120,7 +120,7 @@ MODDESTDIR := $(DESTDIR)$(LIBDIR)/tc
  	$(QUIET_CC)$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) -shared -fpic $< -o $@
  
  
@@ -19,4 +19,4 @@
 +all: $(findstring tc,$(BUILD_VARIANT)) $(TCSO)
  
  tc: $(TCOBJ) $(LIBNETLINK) libtc.a
- 	$(QUIET_LINK)$(CC) $(filter-out dynsyms.list, $^) $(LDFLAGS) $(LDLIBS) -o $@
+ 	$(QUIET_LINK)$(CC) $^ $(LDFLAGS) $(LDLIBS) -o $@
diff --git a/package/network/utils/iproute2/patches/200-drop_libbsd_dependency.patch b/package/network/utils/iproute2/patches/200-drop_libbsd_dependency.patch
index d1948860..38193be1 100644
--- a/package/network/utils/iproute2/patches/200-drop_libbsd_dependency.patch
+++ b/package/network/utils/iproute2/patches/200-drop_libbsd_dependency.patch
@@ -1,12 +1,12 @@
 --- a/configure
 +++ b/configure
-@@ -455,14 +455,8 @@ EOF
+@@ -413,14 +413,8 @@ EOF
      if $CC -I$INCLUDE -o $TMPDIR/strtest $TMPDIR/strtest.c >/dev/null 2>&1; then
  	echo "no"
      else
 -	if ${PKG_CONFIG} libbsd --exists; then
--		echo 'CFLAGS += -DHAVE_LIBBSD' `${PKG_CONFIG} libbsd --cflags` >>$CONFIG
--		echo 'LDLIBS +=' `${PKG_CONFIG} libbsd --libs` >> $CONFIG
+-		echo 'CFLAGS += -DHAVE_LIBBSD' "$(${PKG_CONFIG} libbsd --cflags)" >>$CONFIG
+-		echo 'LDLIBS +=' "$(${PKG_CONFIG} libbsd --libs)" >> $CONFIG
 -		echo "no"
 -	else
 -		echo 'CFLAGS += -DNEED_STRLCPY' >>$CONFIG
diff --git a/package/network/utils/iproute2/patches/300-selinux-configurable.patch b/package/network/utils/iproute2/patches/300-selinux-configurable.patch
index 817abf7d..9f07d317 100644
--- a/package/network/utils/iproute2/patches/300-selinux-configurable.patch
+++ b/package/network/utils/iproute2/patches/300-selinux-configurable.patch
@@ -1,6 +1,6 @@
 --- a/configure
 +++ b/configure
-@@ -385,7 +385,7 @@ check_libbpf()
+@@ -342,7 +342,7 @@ check_libbpf()
  check_selinux()
  # SELinux is a compile time option in the ss utility
  {
diff --git a/package/network/utils/iproute2/patches/400-add-nss-qdisc.patch b/package/network/utils/iproute2/patches/400-add-nss-qdisc.patch
deleted file mode 100644
index b6e969bd..00000000
--- a/package/network/utils/iproute2/patches/400-add-nss-qdisc.patch
+++ /dev/null
@@ -1,2094 +0,0 @@
---- a/include/uapi/linux/pkt_sched.h
-+++ b/include/uapi/linux/pkt_sched.h
-@@ -119,6 +119,251 @@ enum {
- 
- #define TCA_STAB_MAX (__TCA_STAB_MAX - 1)
- 
-+enum {
-+	TCA_NSS_ACCEL_MODE_NSS_FW,
-+	TCA_NSS_ACCEL_MODE_PPE,
-+	TCA_NSS_ACCEL_MODE_MAX
-+};
-+
-+/* NSSFIFO section */
-+
-+enum {
-+	TCA_NSSFIFO_UNSPEC,
-+	TCA_NSSFIFO_PARMS,
-+	__TCA_NSSFIFO_MAX
-+};
-+
-+#define TCA_NSSFIFO_MAX	(__TCA_NSSFIFO_MAX - 1)
-+
-+struct tc_nssfifo_qopt {
-+	__u32	limit;		/* Queue length: bytes for bfifo, packets for pfifo */
-+	__u8	set_default;	/* Sets qdisc to be the default qdisc for enqueue */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSWRED section */
-+
-+enum {
-+	TCA_NSSWRED_UNSPEC,
-+	TCA_NSSWRED_PARMS,
-+	__TCA_NSSWRED_MAX
-+};
-+
-+#define TCA_NSSWRED_MAX (__TCA_NSSWRED_MAX - 1)
-+#define NSSWRED_CLASS_MAX 6
-+struct tc_red_alg_parameter {
-+	__u32	min;	/* qlen_avg < min: pkts are all enqueued */
-+	__u32	max;	/* qlen_avg > max: pkts are all dropped */
-+	__u32	probability;/* Drop probability at qlen_avg = max */
-+	__u32	exp_weight_factor;/* exp_weight_factor for calculate qlen_avg */
-+};
-+
-+struct tc_nsswred_traffic_class {
-+	__u32 limit;			/* Queue length */
-+	__u32 weight_mode_value;	/* Weight mode value */
-+	struct tc_red_alg_parameter rap;/* Parameters for RED alg */
-+};
-+
-+/*
-+ * Weight modes for WRED
-+ */
-+enum tc_nsswred_weight_modes {
-+	TC_NSSWRED_WEIGHT_MODE_DSCP = 0,/* Weight mode is DSCP */
-+	TC_NSSWRED_WEIGHT_MODES,	/* Must be last */
-+};
-+typedef enum tc_nsswred_weight_modes tc_nsswred_weight_mode_t;
-+
-+struct tc_nsswred_qopt {
-+	__u32	limit;			/* Queue length */
-+	enum tc_nsswred_weight_modes weight_mode;
-+					/* Weight mode */
-+	__u32	traffic_classes;	/* How many traffic classes: DPs */
-+	__u32	def_traffic_class;	/* Default traffic if no match: def_DP */
-+	__u32	traffic_id;		/* The traffic id to be configured: DP */
-+	__u32	weight_mode_value;	/* Weight mode value */
-+	struct tc_red_alg_parameter rap;/* RED algorithm parameters */
-+	struct tc_nsswred_traffic_class tntc[NSSWRED_CLASS_MAX];
-+					/* Traffic settings for dumpping */
-+	__u8	ecn;			/* Setting ECN bit or dropping */
-+	__u8	set_default;		/* Sets qdisc to be the default for enqueue */
-+	__u8	accel_mode;		/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSCODEL section */
-+
-+enum {
-+	TCA_NSSCODEL_UNSPEC,
-+	TCA_NSSCODEL_PARMS,
-+	__TCA_NSSCODEL_MAX
-+};
-+
-+#define TCA_NSSCODEL_MAX	(__TCA_NSSCODEL_MAX - 1)
-+
-+struct tc_nsscodel_qopt {
-+	__u32	target;		/* Acceptable queueing delay */
-+	__u32	limit;		/* Max number of packets that can be held in the queue */
-+	__u32	interval;	/* Monitoring interval */
-+	__u32	flows;		/* Number of flow buckets */
-+	__u32	quantum;	/* Weight (in bytes) used for DRR of flow buckets */
-+	__u8	ecn;		/* 0 - disable ECN, 1 - enable ECN */
-+	__u8	set_default;	/* Sets qdisc to be the default qdisc for enqueue */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+struct tc_nsscodel_xstats {
-+	__u32 peak_queue_delay;	/* Peak delay experienced by a dequeued packet */
-+	__u32 peak_drop_delay;	/* Peak delay experienced by a dropped packet */
-+};
-+
-+/* NSSFQ_CODEL section */
-+
-+struct tc_nssfq_codel_xstats {
-+	__u32 new_flow_count;	/* Total number of new flows seen */
-+	__u32 new_flows_len;	/* Current number of new flows */
-+	__u32 old_flows_len;	/* Current number of old flows */
-+	__u32 ecn_mark;		/* Number of packets marked with ECN */
-+	__u32 drop_overlimit;	/* Number of packets dropped due to overlimit */
-+	__u32 maxpacket;	/* The largest packet seen so far in the queue */
-+};
-+
-+/* NSSTBL section */
-+
-+enum {
-+	TCA_NSSTBL_UNSPEC,
-+	TCA_NSSTBL_PARMS,
-+	__TCA_NSSTBL_MAX
-+};
-+
-+#define TCA_NSSTBL_MAX	(__TCA_NSSTBL_MAX - 1)
-+
-+struct tc_nsstbl_qopt {
-+	__u32	burst;		/* Maximum burst size */
-+	__u32	rate;		/* Limiting rate of TBF */
-+	__u32	peakrate;	/* Maximum rate at which TBF is allowed to send */
-+	__u32	mtu;		/* Max size of packet, or minumim burst size */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSPRIO section */
-+
-+#define TCA_NSSPRIO_MAX_BANDS 256
-+
-+enum {
-+	TCA_NSSPRIO_UNSPEC,
-+	TCA_NSSPRIO_PARMS,
-+	__TCA_NSSPRIO_MAX
-+};
-+
-+#define TCA_NSSPRIO_MAX	(__TCA_NSSPRIO_MAX - 1)
-+
-+struct tc_nssprio_qopt {
-+	__u32	bands;		/* Number of bands */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSBF section */
-+
-+enum {
-+	TCA_NSSBF_UNSPEC,
-+	TCA_NSSBF_CLASS_PARMS,
-+	TCA_NSSBF_QDISC_PARMS,
-+	__TCA_NSSBF_MAX
-+};
-+
-+#define TCA_NSSBF_MAX	(__TCA_NSSBF_MAX - 1)
-+
-+struct tc_nssbf_class_qopt {
-+	__u32	burst;		/* Maximum burst size */
-+	__u32	rate;		/* Allowed bandwidth for this class */
-+	__u32	mtu;		/* MTU of the associated interface */
-+	__u32	quantum;	/* Quantum allocation for DRR */
-+};
-+
-+struct tc_nssbf_qopt {
-+	__u16	defcls;		/* Default class value */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSWRR section */
-+
-+enum {
-+	TCA_NSSWRR_UNSPEC,
-+	TCA_NSSWRR_CLASS_PARMS,
-+	TCA_NSSWRR_QDISC_PARMS,
-+	__TCA_NSSWRR_MAX
-+};
-+
-+#define TCA_NSSWRR_MAX	(__TCA_NSSWRR_MAX - 1)
-+
-+struct tc_nsswrr_class_qopt {
-+	__u32	quantum;	/* Weight associated to this class */
-+};
-+
-+struct tc_nsswrr_qopt {
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSWFQ section */
-+
-+enum {
-+	TCA_NSSWFQ_UNSPEC,
-+	TCA_NSSWFQ_CLASS_PARMS,
-+	TCA_NSSWFQ_QDISC_PARMS,
-+	__TCA_NSSWFQ_MAX
-+};
-+
-+#define TCA_NSSWFQ_MAX	(__TCA_NSSWFQ_MAX - 1)
-+
-+struct tc_nsswfq_class_qopt {
-+	__u32	quantum;	/* Weight associated to this class */
-+};
-+
-+struct tc_nsswfq_qopt {
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSHTB section */
-+
-+enum {
-+	TCA_NSSHTB_UNSPEC,
-+	TCA_NSSHTB_CLASS_PARMS,
-+	TCA_NSSHTB_QDISC_PARMS,
-+	__TCA_NSSHTB_MAX
-+};
-+
-+#define TCA_NSSHTB_MAX	(__TCA_NSSHTB_MAX - 1)
-+
-+struct tc_nsshtb_class_qopt {
-+	__u32	burst;		/* Allowed burst size */
-+	__u32	rate;		/* Allowed bandwidth for this class */
-+	__u32	cburst;		/* Maximum burst size */
-+	__u32	crate;		/* Maximum bandwidth for this class */
-+	__u32	quantum;	/* Quantum allocation for DRR */
-+	__u32	priority;	/* Priority value associated with this class */
-+	__u32	overhead;	/* Overhead in bytes per packet */
-+};
-+
-+struct tc_nsshtb_qopt {
-+	__u32	r2q;		/* Rate to quantum ratio */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+/* NSSBLACKHOLE section */
-+
-+enum {
-+	TCA_NSSBLACKHOLE_UNSPEC,
-+	TCA_NSSBLACKHOLE_PARMS,
-+	__TCA_NSSBLACKHOLE_MAX
-+};
-+
-+#define TCA_NSSBLACKHOLE_MAX	(__TCA_NSSBLACKHOLE_MAX - 1)
-+
-+struct tc_nssblackhole_qopt {
-+	__u8	set_default;	/* Sets qdisc to be the default qdisc for enqueue */
-+	__u8	accel_mode;	/* Dictates which data plane offloads the qdisc */
-+};
-+
-+
- /* FIFO section */
- 
- struct tc_fifo_qopt {
---- a/tc/Makefile
-+++ b/tc/Makefile
-@@ -82,6 +82,7 @@ TCMODULES += q_etf.o
- TCMODULES += q_taprio.o
- TCMODULES += q_plug.o
- TCMODULES += q_ets.o
-+TCMODULES += q_nss.o
- 
- TCSO :=
- ifeq ($(TC_CONFIG_ATM),y)
---- /dev/null
-+++ b/tc/q_nss.c
-@@ -0,0 +1,1826 @@
-+/*
-+ **************************************************************************
-+ * Copyright (c) 2015, 2018 The Linux Foundation. All rights reserved.
-+ * Permission to use, copy, modify, and/or distribute this software for
-+ * any purpose with or without fee is hereby granted, provided that the
-+ * above copyright notice and this permission notice appear in all copies.
-+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
-+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
-+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
-+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
-+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
-+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
-+ * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
-+ **************************************************************************
-+ */
-+
-+#include <stdio.h>
-+#include <stdlib.h>
-+#include <unistd.h>
-+#include <syslog.h>
-+#include <fcntl.h>
-+#include <sys/socket.h>
-+#include <netinet/in.h>
-+#include <arpa/inet.h>
-+#include <string.h>
-+#include <math.h>
-+
-+#include "utils.h"
-+#include "tc_util.h"
-+#include "tc_red.h"
-+
-+/* ======================== NSSWRED =======================*/
-+
-+static void nssred_explain(void)
-+{
-+	fprintf(stderr, "Usage: ...  nssred limit BYTES avpkt BYTES [ min BYTES ] [ max BYTES ] [ probability VALUE ]\n");
-+	fprintf(stderr, "                   [ burst PACKETS ] [ecn] [ set_default ] [ accel_mode ]\n");
-+}
-+
-+static void nsswred_explain(void)
-+{
-+	fprintf(stderr, "Usage: ...  nsswred setup DPs NUMBER dp_default NUMBER [ weight_mode dscp ] [ecn] [ set_default ] [ accel_mode ]\n");
-+	fprintf(stderr, "            nsswred limit BYTES DP NUMBER min BYTES max BYTES avpkt BYTES dscp NUMBER [ probability VALUE ] [ burst PACKETS ]\n");
-+}
-+
-+static int nsswred_setup(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct rtattr *tail;
-+	struct tc_nsswred_qopt opt;
-+
-+	memset(&opt, 0, sizeof(opt));
-+	unsigned int dps = 0;
-+	unsigned int def_dp = 0;
-+	bool accel_mode = false;
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "DPs") == 0) {
-+			NEXT_ARG();
-+			if (get_unsigned(&dps, *argv, 0) || dps > NSSWRED_CLASS_MAX) {
-+
-+				fprintf(stderr, "DPs should be between 1 - %d\n", NSSWRED_CLASS_MAX);
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "weight_mode") == 0) {
-+			NEXT_ARG();
-+			if (strcmp(*argv, "dscp") == 0) {
-+				opt.weight_mode = TC_NSSWRED_WEIGHT_MODE_DSCP;
-+			} else {
-+				fprintf(stderr, "Illegal \"weight_mode\", we only support dscp at this moment\n");
-+			}
-+		} else if (strcmp(*argv, "ecn") == 0) {
-+			opt.ecn = 1;
-+		} else if (strcmp(*argv, "dp_default") == 0) {
-+			NEXT_ARG();
-+			if (get_unsigned(&def_dp, *argv, 0) || def_dp > dps) {
-+				fprintf(stderr, "Illegal dp_default value\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsswred_explain();
-+			return -1;
-+		} else if (strcmp(*argv, "set_default") == 0) {
-+			opt.set_default = 1;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nsswred_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_NSS_FW;
-+	} else if (opt.accel_mode != TCA_NSS_ACCEL_MODE_NSS_FW) {
-+		fprintf(stderr, "accel_mode should be %d\n", TCA_NSS_ACCEL_MODE_NSS_FW);
-+		return -1;
-+	}
-+
-+	if (!dps || !def_dp) {
-+		fprintf(stderr, "Illegal nsswred setup parameters\n");
-+		return -1;
-+	}
-+	opt.traffic_classes = dps;
-+	opt.def_traffic_class = def_dp;
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSWRED_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsswred_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct rtattr *tail;
-+	struct tc_nsswred_qopt opt;
-+
-+	int total_args = argc;
-+	unsigned burst = 0;
-+	unsigned avpkt = 0;
-+	double probability = 0.0;
-+	unsigned char weighted = (strcmp(qu->id, "nsswred") == 0);
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "limit") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.limit, *argv)) {
-+				fprintf(stderr, "Illegal \"limit\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "set_default") == 0) {
-+			opt.set_default = 1;
-+		} else if (strcmp(*argv, "min") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.rap.min, *argv)) {
-+				fprintf(stderr, "Illegal \"min\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "max") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.rap.max, *argv)) {
-+				fprintf(stderr, "Illegal \"max\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "burst") == 0) {
-+			NEXT_ARG();
-+			if (get_unsigned(&burst, *argv, 0)) {
-+				fprintf(stderr, "Illegal \"burst\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "avpkt") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&avpkt, *argv)) {
-+				fprintf(stderr, "Illegal \"avpkt\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "probability") == 0) {
-+			NEXT_ARG();
-+			if (sscanf(*argv, "%lg", &probability) != 1) {
-+				fprintf(stderr, "Illegal \"probability\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "ecn") == 0) {
-+			opt.ecn = 1;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			if (weighted) {
-+				nsswred_explain();
-+			} else {
-+				nssred_explain();
-+			}
-+			return -1;
-+		} else if (weighted) {
-+			if (strcmp(*argv, "setup") == 0) {
-+				if (argc != total_args) {
-+					fprintf(stderr, "Setup command must be the first parameter\n");
-+					return -1;
-+				}
-+				return nsswred_setup(qu, argc-1, argv+1, n);
-+			} else if (strcmp(*argv, "DP") == 0) {
-+				NEXT_ARG();
-+				if (get_unsigned(&opt.traffic_id, *argv, 0)) {
-+					fprintf(stderr, "Illegal \"DP\"");
-+					return -1;
-+				}
-+			} else if (strcmp(*argv, "dscp") == 0) {
-+				NEXT_ARG();
-+				if (get_unsigned(&opt.weight_mode_value, *argv, 0)) {
-+					fprintf(stderr, "Illegal \"dscp\" value\n");
-+					return -1;
-+				}
-+			}
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			if (weighted) {
-+				nsswred_explain();
-+			} else {
-+				nssred_explain();
-+			}
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "Accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	if (weighted) {
-+		if (!opt.limit || !opt.rap.min || !opt.rap.max || !opt.traffic_id || !avpkt || !opt.weight_mode_value) {
-+			fprintf(stderr, "Require limit, min, max, avpkt, DP, weight_mode_value\n");
-+			return -1;
-+		}
-+	} else {
-+		if (!opt.limit || !avpkt) {
-+			fprintf(stderr, "Require limit, avpkt");
-+			return -1;
-+		}
-+	}
-+
-+	/*
-+	 * Compute default min/max thresholds based on
-+	 * Sally Floyd's recommendations:
-+	 * http://www.icir.org/floyd/REDparameters.txt
-+	 */
-+	if (!opt.rap.max)
-+		opt.rap.max = opt.rap.min ? opt.rap.min * 3 : opt.limit / 4;
-+	if (!opt.rap.min)
-+		opt.rap.min = opt.rap.max / 3;
-+	if (!burst)
-+		burst = (2 * opt.rap.min + opt.rap.max) / (3 * avpkt);
-+	if ((opt.rap.exp_weight_factor = tc_red_eval_ewma(opt.rap.min, burst, avpkt)) < 0) {
-+		fprintf(stderr, "Failed to calculate EWMA constant.\n");
-+		return -1;
-+	}
-+
-+	/*
-+	 * project [0.0-1.0] to [0-255] to avoid floating point calculation
-+	 */
-+	opt.rap.probability = probability * (pow(2, 8)-1);
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSWRED_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsswred_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSWRED_MAX + 1];
-+	struct tc_nsswred_qopt *qopt;
-+	int i;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSWRED_MAX, opt);
-+
-+	if (tb[TCA_NSSWRED_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSWRED_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSWRED_PARMS]);
-+
-+	if (strcmp(qu->id, "nsswred") == 0) {
-+		fprintf(f, "DPs %d def_DP %d weight mode: " , qopt->traffic_classes, qopt->def_traffic_class);
-+		if (qopt->weight_mode == TC_NSSWRED_WEIGHT_MODE_DSCP)
-+			fprintf(f, "DSCP\n");
-+		else
-+			fprintf(f, "Unknown\n");
-+		for (i = 0;i < qopt->traffic_classes; i ++) {
-+			if (qopt->tntc[i].rap.exp_weight_factor) {
-+				double prob = (double)qopt->tntc[i].rap.probability;
-+				fprintf(f, "DP %d: limit %d, weight mode value: %d min: %d max: %d exp_weight_factor: %d probability %.2f\n",
-+						i + 1, qopt->tntc[i].limit, qopt->tntc[i].weight_mode_value
-+						, qopt->tntc[i].rap.min,qopt->tntc[i].rap.max,qopt->tntc[i].rap.exp_weight_factor,prob/255);
-+			}
-+		}
-+	} else {
-+		double prob = (double)qopt->rap.probability;
-+		fprintf(f, "limit %d, min: %d max: %d exp_weight_factor: %d probability %.2f\n",
-+				qopt->limit, qopt->rap.min,qopt->rap.max,qopt->rap.exp_weight_factor,prob/255);
-+	}
-+
-+	if (qopt->ecn)
-+		fprintf(f, "ECN enabled ");
-+        if (qopt->set_default)
-+                fprintf(f, "set_default ");
-+
-+	fprintf(f, "accel_mode: %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nssred_qdisc_util = {
-+	.id		= "nssred",
-+	.parse_qopt	= nsswred_parse_opt,
-+	.print_qopt	= nsswred_print_opt,
-+};
-+
-+struct qdisc_util nsswred_qdisc_util = {
-+	.id		= "nsswred",
-+	.parse_qopt	= nsswred_parse_opt,
-+	.print_qopt	= nsswred_print_opt,
-+};
-+
-+/* ======================== NSSFIFO =======================*/
-+
-+static void nssfifo_explain(void)
-+{
-+	fprintf(stderr, "Usage: ...  nsspfifo [ limit PACKETS ] [ set_default ] [ accel_mode ]\n");
-+}
-+
-+static int nssfifo_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct rtattr *tail;
-+	struct tc_nssfifo_qopt opt;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "limit") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.limit, *argv) || opt.limit == 0) {
-+				fprintf(stderr, "Illegal \"limit\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "set_default") == 0) {
-+			opt.set_default = 1;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nssfifo_explain();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nssfifo_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSFIFO_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nssfifo_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSFIFO_MAX + 1];
-+	struct tc_nssfifo_qopt *qopt;
-+	SPRINT_BUF(b1);
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSFIFO_MAX, opt);
-+
-+	if (tb[TCA_NSSFIFO_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSFIFO_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSFIFO_PARMS]);
-+
-+	if (strcmp(qu->id, "nssbfifo") == 0)
-+		fprintf(f, "limit %s ", sprint_size(qopt->limit, b1));
-+	else
-+		fprintf(f, "limit %up ", qopt->limit);
-+
-+	if (qopt->set_default)
-+		fprintf(f, "set_default ");
-+
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nsspfifo_qdisc_util = {
-+	.id		= "nsspfifo",
-+	.parse_qopt	= nssfifo_parse_opt,
-+	.print_qopt	= nssfifo_print_opt,
-+};
-+
-+struct qdisc_util nssbfifo_qdisc_util = {
-+	.id		= "nssbfifo",
-+	.parse_qopt	= nssfifo_parse_opt,
-+	.print_qopt	= nssfifo_print_opt,
-+};
-+
-+/* ======================== NSSFQ_CODEL =======================*/
-+
-+static void nssfq_codel_explain(void)
-+{
-+	fprintf(stderr, "Usage: ... nssfq_codel target TIME interval TIME [ flows NUMBER ] [ quantum BYTES ]"
-+				"[ limit PACKETS ] [ set_default ] [ accel_mode ]\n");
-+}
-+
-+static void nssfq_codel_explain_err1(void)
-+{
-+	fprintf(stderr, "Value of target and interval should be greater than 1ms\n");
-+}
-+
-+static int nssfq_codel_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct rtattr *tail;
-+	struct tc_nsscodel_qopt opt;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "target") == 0) {
-+			NEXT_ARG();
-+			if (get_time(&opt.target, *argv)) {
-+				fprintf(stderr, "Illegal \"target\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "limit") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.limit, *argv) || opt.limit == 0) {
-+				fprintf(stderr, "Illegal \"limit\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "flows") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.flows, *argv) || opt.flows == 0) {
-+				fprintf(stderr, "Illegal \"flows\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "quantum") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.quantum, *argv) || opt.quantum == 0) {
-+				fprintf(stderr, "Illegal \"quantum\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "interval") == 0) {
-+			NEXT_ARG();
-+			if (get_time(&opt.interval, *argv)) {
-+				fprintf(stderr, "Illegal \"interval\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "ecn") == 0) {
-+			fprintf(stderr, "Illegal, ECN not supported\n");
-+			nssfq_codel_explain();
-+			return -1;
-+		} else if (strcmp(*argv, "set_default") == 0) {
-+			opt.set_default = 1;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nssfq_codel_explain();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nssfq_codel_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_NSS_FW;
-+	} else if (opt.accel_mode != TCA_NSS_ACCEL_MODE_NSS_FW) {
-+		fprintf(stderr, "accel_mode should be %d\n", TCA_NSS_ACCEL_MODE_NSS_FW);
-+		return -1;
-+	}
-+
-+	if (!opt.target || !opt.interval) {
-+		nssfq_codel_explain();
-+		return -1;
-+	}
-+
-+	if (opt.target < 1000 || opt.interval < 1000) {
-+		nssfq_codel_explain_err1();
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSCODEL_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nssfq_codel_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSCODEL_MAX + 1];
-+	struct tc_nsscodel_qopt *qopt;
-+	SPRINT_BUF(b1);
-+	SPRINT_BUF(b2);
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSCODEL_MAX, opt);
-+
-+	if (tb[TCA_NSSCODEL_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSCODEL_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSCODEL_PARMS]);
-+
-+	fprintf(f, "target %s limit %up interval %s flows %u quantum %u ",
-+		sprint_time(qopt->target, b1),
-+		qopt->limit,
-+		sprint_time(qopt->interval, b2),
-+		qopt->flows,
-+		qopt->quantum);
-+
-+	if (qopt->ecn)
-+		fprintf(f, "ecn ");
-+
-+	if (qopt->set_default)
-+		fprintf(f, "set_default ");
-+
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+static int nssfq_codel_print_xstats(struct qdisc_util *qu, FILE *f, struct rtattr *xstats)
-+{
-+	struct tc_nssfq_codel_xstats *st;
-+
-+	if (xstats == NULL)
-+		return 0;
-+
-+	if (RTA_PAYLOAD(xstats) < sizeof(*st))
-+		return -1;
-+
-+	st = RTA_DATA(xstats);
-+	fprintf(f, " maxpacket %u drop_overlimit %u new_flow_count %u ecn_mark %u\n",
-+			st->maxpacket, st->drop_overlimit, st->new_flow_count, st->ecn_mark);
-+	fprintf(f, " new_flows_len %u old_flows_len %u", st->new_flows_len, st->old_flows_len);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nssfq_codel_qdisc_util = {
-+	.id		= "nssfq_codel",
-+	.parse_qopt	= nssfq_codel_parse_opt,
-+	.print_qopt	= nssfq_codel_print_opt,
-+	.print_xstats	= nssfq_codel_print_xstats,
-+};
-+
-+/* ======================== NSSCODEL =======================*/
-+
-+static void nsscodel_explain(void)
-+{
-+	fprintf(stderr, "Usage: ... nsscodel target TIME interval TIME [ limit PACKETS ] [ set_default ] [ accel_mode ]\n");
-+}
-+
-+static void nsscodel_explain_err1(void)
-+{
-+	fprintf(stderr, "Value of target and interval should be greater than 1ms\n");
-+}
-+
-+static int nsscodel_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct rtattr *tail;
-+	struct tc_nsscodel_qopt opt;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "target") == 0) {
-+			NEXT_ARG();
-+			if (get_time(&opt.target, *argv)) {
-+				fprintf(stderr, "Illegal \"target\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "limit") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.limit, *argv) || opt.limit == 0) {
-+				fprintf(stderr, "Illegal \"limit\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "interval") == 0) {
-+			NEXT_ARG();
-+			if (get_time(&opt.interval, *argv)) {
-+				fprintf(stderr, "Illegal \"interval\"\n");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "set_default") == 0) {
-+			opt.set_default = 1;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsscodel_explain();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nsscodel_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_NSS_FW;
-+	} else if (opt.accel_mode != TCA_NSS_ACCEL_MODE_NSS_FW) {
-+		fprintf(stderr, "accel_mode should be %d\n", TCA_NSS_ACCEL_MODE_NSS_FW);
-+		return -1;
-+	}
-+
-+	if (!opt.target || !opt.interval) {
-+		nsscodel_explain();
-+		return -1;
-+	}
-+
-+	if (opt.target < 1000 || opt.interval < 1000) {
-+		nsscodel_explain_err1();
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSCODEL_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsscodel_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSCODEL_MAX + 1];
-+	struct tc_nsscodel_qopt *qopt;
-+	SPRINT_BUF(b1);
-+	SPRINT_BUF(b2);
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSCODEL_MAX, opt);
-+
-+	if (tb[TCA_NSSCODEL_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSCODEL_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSCODEL_PARMS]);
-+
-+	fprintf(f, "target %s limit %up interval %s ",
-+		sprint_time(qopt->target, b1),
-+		qopt->limit,
-+		sprint_time(qopt->interval, b2));
-+
-+	if (qopt->set_default)
-+		fprintf(f, "set_default ");
-+
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+static int nsscodel_print_xstats(struct qdisc_util *qu, FILE *f, struct rtattr *xstats)
-+{
-+	struct tc_nsscodel_xstats *st;
-+
-+	if (xstats == NULL)
-+		return 0;
-+
-+	if (RTA_PAYLOAD(xstats) < sizeof(*st))
-+		return -1;
-+
-+	st = RTA_DATA(xstats);
-+	fprintf(f, " peak queue delay %ums peak drop delay %ums",
-+			st->peak_queue_delay, st->peak_drop_delay);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nsscodel_qdisc_util = {
-+	.id		= "nsscodel",
-+	.parse_qopt	= nsscodel_parse_opt,
-+	.print_qopt	= nsscodel_print_opt,
-+	.print_xstats	= nsscodel_print_xstats,
-+};
-+
-+/* ======================== NSSTBL =======================*/
-+
-+static void nsstbl_explain(void)
-+{
-+	fprintf(stderr, "Usage: ... nsstbl burst BYTES rate BPS [ mtu BYTES ] [ accel_mode ]\n");
-+}
-+
-+static int nsstbl_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	int ok = 0;
-+	struct rtattr *tail;
-+	struct tc_nsstbl_qopt opt;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "burst") == 0 ||
-+			   strcmp(*argv, "buffer") == 0 ||
-+			   strcmp(*argv, "maxburst") == 0) {
-+			NEXT_ARG();
-+			if (opt.burst) {
-+				fprintf(stderr, "Double \"buffer/burst\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.burst, *argv)) {
-+				fprintf(stderr, "Illegal \"burst\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "mtu") == 0 ||
-+			   strcmp(*argv, "minburst") == 0) {
-+			NEXT_ARG();
-+			if (opt.mtu) {
-+				fprintf(stderr, "Double \"mtu/minburst\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.mtu, *argv)) {
-+				fprintf(stderr, "Illegal \"mtu\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "rate") == 0) {
-+			NEXT_ARG();
-+			if (opt.rate) {
-+				fprintf(stderr, "Double \"rate\" spec\n");
-+				return -1;
-+			}
-+			if (get_rate(&opt.rate, *argv)) {
-+				fprintf(stderr, "Illegal \"rate\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsstbl_explain();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nsstbl_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!ok) {
-+		nsstbl_explain();
-+		return -1;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	if (!opt.rate || !opt.burst) {
-+		fprintf(stderr, "Both \"rate\" and \"burst\" are required.\n");
-+		return -1;
-+	}
-+
-+	/*
-+	 * Peakrate is currently not supported, but we keep the infrastructure
-+	 * for future use. However, we have disabled taking input for this.
-+	 */
-+	if (opt.peakrate) {
-+		if (!opt.mtu) {
-+			fprintf(stderr, "\"mtu\" is required, if \"peakrate\" is requested.\n");
-+			return -1;
-+		}
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSTBL_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsstbl_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSTBL_MAX + 1];
-+	struct tc_nsstbl_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSTBL_MAX, opt);
-+
-+	if (tb[TCA_NSSTBL_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSTBL_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSTBL_PARMS]);
-+
-+	print_size(PRINT_FP, NULL, "buffer/maxburst %s ", qopt->burst);
-+	tc_print_rate(PRINT_FP, NULL, "rate %s ", qopt->rate);
-+	print_size(PRINT_FP, NULL, "mtu %s ", qopt->mtu);
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nsstbl_qdisc_util = {
-+	.id		= "nsstbl",
-+	.parse_qopt	= nsstbl_parse_opt,
-+	.print_qopt	= nsstbl_print_opt,
-+};
-+
-+/* ======================== NSSPRIO =======================*/
-+
-+static void nssprio_explain(void)
-+{
-+	fprintf(stderr, "Usage: ... nssprio [ bands NUMBER (default 256) ] [ accel_mode ]\n");
-+}
-+
-+static int nssprio_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	int ok = 0;
-+	struct rtattr *tail;
-+	struct tc_nssprio_qopt opt;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "bands") == 0) {
-+			NEXT_ARG();
-+			if (get_unsigned(&opt.bands, *argv, 0)) {
-+				fprintf(stderr, "Illegal \"limit\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nssprio_explain();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nssprio_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!ok) {
-+		opt.bands = TCA_NSSPRIO_MAX_BANDS;
-+	} else if (opt.bands > TCA_NSSPRIO_MAX_BANDS) {
-+		nssprio_explain();
-+		return -1;
-+	}
-+
-+        if (!accel_mode) {
-+                opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+        } else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+                fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+                return -1;
-+        }
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSPRIO_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nssprio_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSPRIO_MAX + 1];
-+	struct tc_nssprio_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSPRIO_MAX, opt);
-+
-+	if (tb[TCA_NSSPRIO_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSPRIO_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSPRIO_PARMS]);
-+
-+	fprintf(f, "bands %u ", qopt->bands);
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nssprio_qdisc_util = {
-+	.id		= "nssprio",
-+	.parse_qopt	= nssprio_parse_opt,
-+	.print_qopt	= nssprio_print_opt,
-+};
-+
-+/* ======================== NSSBF =======================*/
-+
-+static void nssbf_explain_qdisc(void)
-+{
-+	fprintf(stderr,
-+		"Usage: ... nssbf [ accel_mode ]\n"
-+	);
-+}
-+
-+static void nssbf_explain_class(void)
-+{
-+	fprintf(stderr, "Usage: ... nssbf rate BPS burst BYTES [ mtu BYTES ]\n");
-+	fprintf(stderr, "                 [ quantum BYTES ]\n");
-+}
-+
-+static void nssbf_explain1(char *arg)
-+{
-+	fprintf(stderr, "NSSBF: Illegal \"%s\"\n", arg);
-+}
-+
-+static int nssbf_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct tc_nssbf_qopt opt;
-+	struct rtattr *tail;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (matches(*argv, "default") == 0) {
-+			NEXT_ARG();
-+			if (opt.defcls != 0) {
-+				fprintf(stderr, "NSSBF: Double \"default\"\n");
-+				return -1;
-+			}
-+			if (get_u16(&opt.defcls, *argv, 16) < 0) {
-+				nssbf_explain1("default");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (matches(*argv, "help") == 0) {
-+			nssbf_explain_qdisc();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "NSSBF: What is \"%s\" ?\n", *argv);
-+			nssbf_explain_qdisc();
-+			return -1;
-+		}
-+		argc--, argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_NSS_FW;
-+	} else if (opt.accel_mode != TCA_NSS_ACCEL_MODE_NSS_FW) {
-+		fprintf(stderr, "accel_mode should be %d\n", TCA_NSS_ACCEL_MODE_NSS_FW);
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSBF_QDISC_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nssbf_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSBF_MAX + 1];
-+	struct tc_nssbf_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSBF_MAX, opt);
-+
-+	if (tb[TCA_NSSBF_QDISC_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSBF_QDISC_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSBF_QDISC_PARMS]);
-+
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+static int nssbf_parse_class_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	int ok = 0;
-+	struct rtattr *tail;
-+	struct tc_nssbf_class_qopt opt;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "burst") == 0 ||
-+			   strcmp(*argv, "buffer") == 0 ||
-+			   strcmp(*argv, "maxburst") == 0) {
-+			NEXT_ARG();
-+			if (opt.burst) {
-+				fprintf(stderr, "Double \"buffer/burst\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.burst, *argv)) {
-+				fprintf(stderr, "Illegal \"burst\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "mtu") == 0) {
-+			NEXT_ARG();
-+			if (opt.mtu) {
-+				fprintf(stderr, "Double \"mtu\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.mtu, *argv)) {
-+				fprintf(stderr, "Illegal \"mtu\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "quantum") == 0) {
-+			NEXT_ARG();
-+			if (opt.quantum) {
-+				fprintf(stderr, "Double \"quantum\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.quantum, *argv)) {
-+				fprintf(stderr, "Illegal \"quantum\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "rate") == 0) {
-+			NEXT_ARG();
-+			if (opt.rate) {
-+				fprintf(stderr, "Double \"rate\" spec\n");
-+				return -1;
-+			}
-+			if (get_rate(&opt.rate, *argv)) {
-+				fprintf(stderr, "Illegal \"rate\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nssbf_explain_class();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nssbf_explain_class();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!ok) {
-+		nssbf_explain_class();
-+		return -1;
-+	}
-+
-+	if (!opt.rate || !opt.burst) {
-+		fprintf(stderr, "Both \"rate\" and \"burst\" are required.\n");
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSBF_CLASS_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nssbf_print_class_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSBF_MAX + 1];
-+	struct tc_nssbf_class_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSBF_MAX, opt);
-+
-+	if (tb[TCA_NSSBF_CLASS_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSBF_CLASS_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSBF_CLASS_PARMS]);
-+
-+	print_size(PRINT_FP, NULL, "burst %s ", qopt->burst);
-+	tc_print_rate(PRINT_FP, NULL, "rate %s ", qopt->rate);
-+	print_size(PRINT_FP, NULL, "quantum %s ", qopt->quantum);
-+	print_size(PRINT_FP, NULL, "mtu %s ", qopt->mtu);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nssbf_qdisc_util = {
-+	.id		= "nssbf",
-+	.parse_qopt	= nssbf_parse_opt,
-+	.print_qopt	= nssbf_print_opt,
-+	.parse_copt	= nssbf_parse_class_opt,
-+	.print_copt	= nssbf_print_class_opt,
-+};
-+
-+/* ======================== NSSWRR =======================*/
-+
-+static void nsswrr_explain_qdisc(void)
-+{
-+	fprintf(stderr,	"Usage (qdisc): ... nsswrr [ accel_mode ]\n");
-+}
-+
-+static void nsswrr_explain_class(void)
-+{
-+	fprintf(stderr, "Usage (class): ... nsswrr quantum PACKETS ]\n");
-+}
-+
-+static int nsswrr_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct tc_nsswrr_qopt opt;
-+	bool accel_mode = false;
-+	struct rtattr *tail;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (matches(*argv, "help") == 0) {
-+			nsswrr_explain_qdisc();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\" ?\n", *argv);
-+			nsswrr_explain_qdisc();
-+			return -1;
-+		}
-+		argc--, argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSWRR_QDISC_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsswrr_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSWRR_MAX + 1];
-+	struct tc_nsswrr_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSWRR_MAX, opt);
-+
-+	if (tb[TCA_NSSWRR_QDISC_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSWRR_QDISC_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSWRR_QDISC_PARMS]);
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+static int nsswrr_parse_class_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	int ok = 0;
-+	struct rtattr *tail;
-+	struct tc_nsswrr_class_qopt opt;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "quantum") == 0) {
-+			NEXT_ARG();
-+			if (get_u32(&opt.quantum, *argv, 10)) {
-+				fprintf(stderr, "Illegal \"quantum\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsswrr_explain_class();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nsswrr_explain_class();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!ok) {
-+		nsswrr_explain_class();
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSWRR_CLASS_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsswrr_print_class_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSWRR_MAX + 1];
-+	struct tc_nsswrr_class_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSWRR_MAX, opt);
-+
-+	if (tb[TCA_NSSWRR_CLASS_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSWRR_CLASS_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSWRR_CLASS_PARMS]);
-+
-+	fprintf(f, "quantum %up ", qopt->quantum);
-+	return 0;
-+}
-+
-+struct qdisc_util nsswrr_qdisc_util = {
-+	.id		= "nsswrr",
-+	.parse_qopt	= nsswrr_parse_opt,
-+	.print_qopt	= nsswrr_print_opt,
-+	.parse_copt	= nsswrr_parse_class_opt,
-+	.print_copt	= nsswrr_print_class_opt,
-+};
-+
-+/* ======================== NSSWFQ =======================*/
-+
-+static void nsswfq_explain_qdisc(void)
-+{
-+	fprintf(stderr, "Usage (qdisc): ... nsswfq [ accel_mode ]\n");
-+}
-+
-+static void nsswfq_explain_class(void)
-+{
-+	fprintf(stderr, "Usage (class): ... nsswfq quantum BYTES ]\n");
-+}
-+
-+static int nsswfq_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct tc_nsswfq_qopt opt;
-+	bool accel_mode = false;
-+	struct rtattr *tail;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (matches(*argv, "help") == 0) {
-+			nsswfq_explain_qdisc();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "NSSWFQ: What is \"%s\" ?\n", *argv);
-+			nsswfq_explain_qdisc();
-+			return -1;
-+		}
-+		argc--, argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSWFQ_QDISC_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsswfq_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSWFQ_MAX + 1];
-+	struct tc_nsswfq_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSWFQ_MAX, opt);
-+
-+	if (tb[TCA_NSSWFQ_QDISC_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSWFQ_QDISC_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSWFQ_QDISC_PARMS]);
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+static int nsswfq_parse_class_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	int ok = 0;
-+	struct rtattr *tail;
-+	struct tc_nsswfq_class_qopt opt;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "quantum") == 0) {
-+			NEXT_ARG();
-+			if (get_size(&opt.quantum, *argv)) {
-+				fprintf(stderr, "Illegal \"quantum\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsswfq_explain_class();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nsswfq_explain_class();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!ok) {
-+		nsswfq_explain_class();
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSWFQ_CLASS_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsswfq_print_class_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSWFQ_MAX + 1];
-+	struct tc_nsswfq_class_qopt *qopt;
-+	SPRINT_BUF(b1);
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSWFQ_MAX, opt);
-+
-+	if (tb[TCA_NSSWFQ_CLASS_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSWFQ_CLASS_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSWFQ_CLASS_PARMS]);
-+
-+	fprintf(f, "quantum %s ", sprint_size(qopt->quantum, b1));
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nsswfq_qdisc_util = {
-+	.id		= "nsswfq",
-+	.parse_qopt	= nsswfq_parse_opt,
-+	.print_qopt	= nsswfq_print_opt,
-+	.parse_copt	= nsswfq_parse_class_opt,
-+	.print_copt	= nsswfq_print_class_opt,
-+};
-+
-+/* ======================== NSSHTB =======================*/
-+
-+static void nsshtb_explain_qdisc(void)
-+{
-+	fprintf(stderr,
-+		"Usage: ... nsshtb [ r2q ] [ accel_mode ]\n"
-+	);
-+}
-+
-+static void nsshtb_explain_class(void)
-+{
-+	fprintf(stderr, "Usage: ... nsshtb priority 0-3 [ quantum BYTES ] [ rate BPS ] [ burst BYTES ] [crate BPS ] [ cburst BYTES ]\n");
-+	fprintf(stderr, "                 [ overhead BYTES ] \n");
-+}
-+
-+static void nsshtb_explain1(char *arg)
-+{
-+	fprintf(stderr, "NSSHTB: Illegal \"%s\"\n", arg);
-+}
-+
-+static int nsshtb_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct tc_nsshtb_qopt opt;
-+	struct rtattr *tail;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "r2q") == 0) {
-+			NEXT_ARG();
-+			if (opt.r2q != 0) {
-+				fprintf(stderr, "NSSHTB: Double \"r2q\"\n");
-+				return -1;
-+			}
-+			if (get_u32(&opt.r2q, *argv, 10) < 0) {
-+				nsshtb_explain1("r2q");
-+				return -1;
-+			}
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsshtb_explain_qdisc();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "NSSHTB: What is \"%s\" ?\n", *argv);
-+			nsshtb_explain_qdisc();
-+			return -1;
-+		}
-+		argc--, argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSHTB_QDISC_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsshtb_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSHTB_MAX + 1];
-+	struct tc_nsshtb_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSHTB_MAX, opt);
-+
-+	if (tb[TCA_NSSHTB_QDISC_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSHTB_QDISC_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSHTB_QDISC_PARMS]);
-+
-+	if (qopt->r2q != 0)
-+		fprintf(f, "r2q %u ", qopt->r2q);
-+
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+static int nsshtb_parse_class_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	int ok = 0;
-+	struct rtattr *tail;
-+	struct tc_nsshtb_class_qopt opt;
-+	int crate = 0;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "burst") == 0) {
-+			NEXT_ARG();
-+			if (opt.burst) {
-+				fprintf(stderr, "Double \"burst\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.burst, *argv)) {
-+				fprintf(stderr, "Illegal \"burst\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "rate") == 0) {
-+			NEXT_ARG();
-+			if (opt.rate) {
-+				fprintf(stderr, "Double \"rate\" spec\n");
-+				return -1;
-+			}
-+			if (get_rate(&opt.rate, *argv)) {
-+				fprintf(stderr, "Illegal \"rate\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "cburst") == 0) {
-+			NEXT_ARG();
-+			if (opt.cburst) {
-+				fprintf(stderr, "Double \"cburst\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.cburst, *argv)) {
-+				fprintf(stderr, "Illegal \"cburst\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "crate") == 0) {
-+			NEXT_ARG();
-+			if (opt.crate) {
-+				fprintf(stderr, "Double \"crate\" spec\n");
-+				return -1;
-+			}
-+			if (get_rate(&opt.crate, *argv)) {
-+				fprintf(stderr, "Illegal \"crate\"\n");
-+				return -1;
-+			}
-+			crate++;
-+			ok++;
-+		} else if (strcmp(*argv, "priority") == 0) {
-+			NEXT_ARG();
-+			if (opt.priority) {
-+				fprintf(stderr, "Double \"priority\" spec\n");
-+				return -1;
-+			}
-+			if (get_u32(&opt.priority, *argv, 10) < 0) {
-+				fprintf(stderr, "Illegal \"priority\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "quantum") == 0) {
-+			NEXT_ARG();
-+			if (opt.quantum) {
-+				fprintf(stderr, "Double \"quantum\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.quantum, *argv)) {
-+				fprintf(stderr, "Illegal \"quantum\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "overhead") == 0) {
-+			NEXT_ARG();
-+			if (opt.overhead) {
-+				fprintf(stderr, "Double \"overhead\" spec\n");
-+				return -1;
-+			}
-+			if (get_size(&opt.overhead, *argv)) {
-+				fprintf(stderr, "Illegal \"overhead\"\n");
-+				return -1;
-+			}
-+			ok++;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nsshtb_explain_class();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nsshtb_explain_class();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!ok) {
-+		nsshtb_explain_class();
-+		return -1;
-+	}
-+
-+	if (opt.rate && !opt.burst) {
-+		fprintf(stderr, "\"burst\" required if \"rate\" is specified.\n");
-+		return -1;
-+	}
-+
-+	if (!crate) {
-+		fprintf(stderr, "\"crate\" is required.\n");
-+		return -1;
-+	}
-+
-+	if (opt.crate && !opt.cburst) {
-+		fprintf(stderr, "\"cburst\" required if \"crate\" is non-zero.\n");
-+		return -1;
-+	}
-+
-+	if (opt.priority > 3) {
-+		fprintf(stderr, "\"priority\" should be an integer between 0 and 3.\n");
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSHTB_CLASS_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nsshtb_print_class_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSHTB_MAX + 1];
-+	struct tc_nsshtb_class_qopt *qopt;
-+	SPRINT_BUF(b1);
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSHTB_MAX, opt);
-+
-+	if (tb[TCA_NSSHTB_CLASS_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSHTB_CLASS_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSHTB_CLASS_PARMS]);
-+
-+	print_size(PRINT_FP, NULL, "burst %s ", qopt->burst);
-+	tc_print_rate(PRINT_FP, NULL, "rate %s ", qopt->rate);
-+	print_size(PRINT_FP, NULL, "cburst %s ", qopt->cburst);
-+	tc_print_rate(PRINT_FP, NULL, "crate %s ", qopt->crate);
-+	fprintf(f, "priority %u ", qopt->priority);
-+	print_size(PRINT_FP, NULL, "quantum %s ", qopt->quantum);
-+	print_size(PRINT_FP, NULL, "overhead %s ", qopt->overhead);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nsshtb_qdisc_util = {
-+	.id		= "nsshtb",
-+	.parse_qopt	= nsshtb_parse_opt,
-+	.print_qopt	= nsshtb_print_opt,
-+	.parse_copt	= nsshtb_parse_class_opt,
-+	.print_copt	= nsshtb_print_class_opt,
-+};
-+
-+/* ======================== NSSBLACKHOLE ======================= */
-+
-+static void nssblackhole_explain(void)
-+{
-+	fprintf(stderr, "Usage: ...  nssblackhole [ set_default ] [ accel_mode ]\n");
-+}
-+
-+static int nssblackhole_parse_opt(struct qdisc_util *qu, int argc, char **argv, struct nlmsghdr *n)
-+{
-+	struct rtattr *tail;
-+	struct tc_nssblackhole_qopt opt;
-+	bool accel_mode = false;
-+
-+	memset(&opt, 0, sizeof(opt));
-+
-+	while (argc > 0) {
-+		if (strcmp(*argv, "set_default") == 0) {
-+			opt.set_default = 1;
-+		} else if (strcmp(*argv, "accel_mode") == 0) {
-+			NEXT_ARG();
-+			if (get_u8(&opt.accel_mode, *argv, 0)) {
-+				fprintf(stderr, "Illegal accel_mode value\n");
-+				return -1;
-+			}
-+			accel_mode = true;
-+		} else if (strcmp(*argv, "help") == 0) {
-+			nssblackhole_explain();
-+			return -1;
-+		} else {
-+			fprintf(stderr, "What is \"%s\"?\n", *argv);
-+			nssblackhole_explain();
-+			return -1;
-+		}
-+		argc--; argv++;
-+	}
-+
-+	if (!accel_mode) {
-+		opt.accel_mode = TCA_NSS_ACCEL_MODE_PPE;
-+	} else if (opt.accel_mode >= TCA_NSS_ACCEL_MODE_MAX) {
-+		fprintf(stderr, "accel_mode should be < %d\n", TCA_NSS_ACCEL_MODE_MAX);
-+		return -1;
-+	}
-+
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, 1024, TCA_OPTIONS, NULL, 0);
-+	addattr_l(n, 1024, TCA_NSSBLACKHOLE_PARMS, &opt, sizeof(opt));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+
-+	return 0;
-+}
-+
-+static int nssblackhole_print_opt(struct qdisc_util *qu, FILE *f, struct rtattr *opt)
-+{
-+	struct rtattr *tb[TCA_NSSBLACKHOLE_MAX + 1];
-+	struct tc_nssblackhole_qopt *qopt;
-+
-+	if (opt == NULL)
-+		return 0;
-+
-+	parse_rtattr_nested(tb, TCA_NSSBLACKHOLE_MAX, opt);
-+
-+	if (tb[TCA_NSSBLACKHOLE_PARMS] == NULL)
-+		return -1;
-+
-+	if (RTA_PAYLOAD(tb[TCA_NSSBLACKHOLE_PARMS]) < sizeof(*qopt))
-+		return -1;
-+
-+	qopt = RTA_DATA(tb[TCA_NSSBLACKHOLE_PARMS]);
-+
-+	if (qopt->set_default)
-+		fprintf(f, "set_default ");
-+
-+	fprintf(f, "accel_mode %d ", qopt->accel_mode);
-+
-+	return 0;
-+}
-+
-+struct qdisc_util nssblackhole_qdisc_util = {
-+	.id		= "nssblackhole",
-+	.parse_qopt	= nssblackhole_parse_opt,
-+	.print_qopt	= nssblackhole_print_opt,
-+};
-
diff --git a/package/network/utils/iproute2/patches/500-add-nssmirred.patch b/package/network/utils/iproute2/patches/500-add-nssmirred.patch
deleted file mode 100644
index e48058e6..00000000
--- a/package/network/utils/iproute2/patches/500-add-nssmirred.patch
+++ /dev/null
@@ -1,243 +0,0 @@
---- a/tc/Makefile	2019-04-08 12:48:15.425854828 +0530
-+++ b/tc/Makefile	2019-04-08 13:03:17.204741000 +0530
-@@ -54,6 +54,7 @@ TCMODULES += m_bpf.o
- TCMODULES += m_sample.o
- TCMODULES += m_ct.o
- TCMODULES += m_gate.o
-+TCMODULES += m_nssmirred.o
- TCMODULES += p_ip.o
- TCMODULES += p_ip6.o
- TCMODULES += p_icmp.o
---- /dev/null	1970-01-01 05:30:00.000000000 +0530
-+++ b/tc/m_nssmirred.c	2019-06-19 14:25:51.369793000 +0530
-@@ -0,0 +1,183 @@
-+/*
-+ **************************************************************************
-+ * Copyright (c) 2019 The Linux Foundation. All rights reserved.
-+ * Permission to use, copy, modify, and/or distribute this software for
-+ * any purpose with or without fee is hereby granted, provided that the
-+ * above copyright notice and this permission notice appear in all copies.
-+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
-+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
-+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
-+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
-+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
-+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
-+ * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
-+ **************************************************************************
-+ */
-+
-+#include <stdio.h>
-+#include <stdlib.h>
-+#include <unistd.h>
-+#include <syslog.h>
-+#include <fcntl.h>
-+#include <sys/socket.h>
-+#include <netinet/in.h>
-+#include <arpa/inet.h>
-+#include <string.h>
-+#include "utils.h"
-+#include "tc_util.h"
-+#include "tc_common.h"
-+#include <linux/tc_act/tc_nssmirred.h>
-+
-+/*
-+ * explain()
-+ *	API to print the explaination of nssmirred action statement's
-+ *	elements.
-+ */
-+static void explain(void)
-+{
-+	fprintf(stderr, "Usage: nssmirred redirect <dev TO_DEVICENAME fromdev FROM_DEVICENAME> \n");
-+	fprintf(stderr, "where: \n");
-+	fprintf(stderr, "\tTO_DEVICENAME is the devicename to redirect to\n");
-+	fprintf(stderr, "\tFROM_DEVICENAME is the devicename to redirect from\n");
-+}
-+
-+/*
-+ * usage()
-+ *	API to show the usage of the nssmirred action.
-+ */
-+static void usage(void)
-+{
-+	explain();
-+	exit(-1);
-+}
-+
-+/*
-+ * parse_nss_mirred()
-+ *	Parse and validate the nssmirred action statement.
-+ */
-+static int parse_nss_mirred(struct action_util *a, int *argc_p, char ***argv_p,
-+	     int tca_id, struct nlmsghdr *n)
-+{
-+	int idx, argc = *argc_p;
-+	char **argv = *argv_p;
-+	struct tc_nss_mirred p;
-+	struct rtattr *tail;
-+
-+	if (argc < 0) {
-+		fprintf(stderr, "nssmirred bad argument count %d. Try option \"help\"\n", argc);
-+		goto error;
-+	}
-+
-+	if (matches(*argv, "nssmirred")) {
-+		fprintf(stderr, "nssmirred bad argument %s. Try option \"help\"\n", *argv);
-+		goto error;
-+	}
-+
-+	NEXT_ARG();
-+	if (!matches(*argv, "help")) {
-+		usage();
-+	}
-+
-+	if (matches(*argv, "redirect")) {
-+		fprintf(stderr, "nssmirred bad argument %s. Try option \"help\"\n", *argv);
-+		goto error;
-+	}
-+
-+	NEXT_ARG();
-+	if (matches(*argv, "dev")) {
-+		fprintf(stderr, "nssmirred: bad value %s. Try option \"help\"\n", *argv);
-+		goto error;
-+	}
-+
-+	NEXT_ARG();
-+	memset(&p, 0, sizeof(struct tc_nss_mirred));
-+	if ((idx = ll_name_to_index(*argv)) == 0) {
-+		fprintf(stderr, "Cannot find to device \"%s\"\n", *argv);
-+		goto error;
-+	}
-+
-+	p.to_ifindex = idx;
-+	NEXT_ARG();
-+	if (matches(*argv, "fromdev")) {
-+		fprintf(stderr, "nssmirred: bad value %s. Try option \"help\"\n", *argv);
-+		goto error;
-+	}
-+
-+	NEXT_ARG();
-+	if ((idx = ll_name_to_index(*argv)) == 0) {
-+		fprintf(stderr, "Cannot find from device \"%s\"\n", *argv);
-+		goto error;
-+	}
-+
-+	p.from_ifindex = idx;
-+	p.action = TC_ACT_STOLEN;
-+	tail = NLMSG_TAIL(n);
-+	addattr_l(n, MAX_MSG, tca_id, NULL, 0);
-+	addattr_l(n, MAX_MSG, TCA_NSS_MIRRED_PARMS, &p, sizeof (p));
-+	tail->rta_len = (void *) NLMSG_TAIL(n) - (void *) tail;
-+	argc--;
-+	argv++;
-+	*argc_p = argc;
-+	*argv_p = argv;
-+	return 0;
-+
-+error:
-+	return -1;
-+}
-+
-+/*
-+ * print_nss_mirred()
-+ *	Print information related to nssmirred action.
-+ */
-+static int print_nss_mirred(struct action_util *au, FILE * f, struct rtattr *arg)
-+{
-+	struct tc_nss_mirred *p;
-+	struct rtattr *tb[TCA_NSS_MIRRED_MAX + 1];
-+	const char *from_dev, *to_dev;
-+
-+	if (arg == NULL) {
-+		return -1;
-+	}
-+
-+	parse_rtattr_nested(tb, TCA_NSS_MIRRED_MAX, arg);
-+
-+	if (tb[TCA_NSS_MIRRED_PARMS] == NULL) {
-+		fprintf(f, "[NULL nssmirred parameters]");
-+		goto error;
-+	}
-+
-+	p = RTA_DATA(tb[TCA_NSS_MIRRED_PARMS]);
-+	if ((from_dev = ll_index_to_name(p->from_ifindex)) == 0) {
-+		fprintf(stderr, "Invalid interface (index: %d)\n", p->from_ifindex);
-+		goto error;
-+	}
-+
-+	if ((to_dev = ll_index_to_name(p->to_ifindex)) == 0) {
-+		fprintf(stderr, "Invalid interface (index: %d)\n", p->to_ifindex);
-+		goto error;
-+	}
-+
-+	fprintf(f, "nssmirred (%s to device %s) stolen\n", from_dev, to_dev);
-+	fprintf(f, "\tindex %d ref %d bind %d\n",p->index,p->refcnt,p->bindcnt);
-+
-+	if (show_stats) {
-+		if (tb[TCA_NSS_MIRRED_TM]) {
-+			struct tcf_t *tm = RTA_DATA(tb[TCA_NSS_MIRRED_TM]);
-+			print_tm(f,tm);
-+		}
-+	}
-+	return 0;
-+
-+error:
-+	return -1;
-+}
-+
-+/*
-+ * nssmirred_action_util
-+ *	nssmirred action utility structure.
-+ */
-+struct action_util nssmirred_action_util = {
-+	.id = "nssmirred",
-+	.parse_aopt = parse_nss_mirred,
-+	.print_aopt = print_nss_mirred,
-+};
---- /dev/null	1970-01-01 05:30:00.000000000 +0530
-+++ a/include/linux/tc_act/tc_nssmirred.h	2019-06-19 14:25:40.787768000 +0530
-@@ -0,0 +1,44 @@
-+/*
-+ **************************************************************************
-+ * Copyright (c) 2019 The Linux Foundation. All rights reserved.
-+ * Permission to use, copy, modify, and/or distribute this software for
-+ * any purpose with or without fee is hereby granted, provided that the
-+ * above copyright notice and this permission notice appear in all copies.
-+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
-+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
-+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
-+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
-+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
-+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
-+ * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
-+ **************************************************************************
-+ */
-+
-+#ifndef __LINUX_TC_NSS_MIR_H
-+#define __LINUX_TC_NSS_MIR_H
-+
-+#include <linux/types.h>
-+#include <linux/pkt_cls.h>
-+
-+/*
-+ * tc_nss_mirred
-+ *	Structure for nssmirred action.
-+ */
-+struct tc_nss_mirred {
-+	tc_gen;
-+	__u32                   from_ifindex;  /* ifindex of the port to be redirected from */
-+	__u32                   to_ifindex;  /* ifindex of the port to be redirected to */
-+};
-+
-+/*
-+ * Types of nssmirred action parameters.
-+ */
-+enum {
-+	TCA_NSS_MIRRED_UNSPEC,
-+	TCA_NSS_MIRRED_TM,
-+	TCA_NSS_MIRRED_PARMS,
-+	__TCA_NSS_MIRRED_MAX
-+};
-+#define TCA_NSS_MIRRED_MAX (__TCA_NSS_MIRRED_MAX - 1)
-+
-+#endif	/* __LINUX_TC_NSS_MIR_H */
diff --git a/package/network/utils/linux-atm/Makefile b/package/network/utils/linux-atm/Makefile
index c74febcb..c48309da 100644
--- a/package/network/utils/linux-atm/Makefile
+++ b/package/network/utils/linux-atm/Makefile
@@ -10,7 +10,7 @@ include $(INCLUDE_DIR)/kernel.mk
 
 PKG_NAME:=linux-atm
 PKG_VERSION:=2.5.2
-PKG_RELEASE:=7
+PKG_RELEASE:=8
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
 PKG_SOURCE_URL:=@SF/$(PKG_NAME)
@@ -21,6 +21,7 @@ PKG_BUILD_PARALLEL:=1
 PKG_LICENSE:=GPL-2.0+
 PKG_CPE_ID:=cpe:/a:linux-atm:linux-atm
 PKG_FIXUP:=autoreconf
+PKG_FLAGS:=nonshared
 
 include $(INCLUDE_DIR)/package.mk
 
@@ -98,6 +99,8 @@ endef
 
 $(foreach t,$(ATM_DEBUG_TOOLS),$(eval $(call GenAtmPlugin,atm-$(t),$(t))))
 
+TARGET_CFLAGS += -I$(LINUX_DIR)/user_headers/include
+
 define Build/Configure
 	$(call Build/Configure/Default)
 	# prevent autoheader invocation
diff --git a/package/network/utils/linux-atm/patches/000-debian_16.patch b/package/network/utils/linux-atm/patches/000-debian_16.patch
deleted file mode 100644
index 4abaac07..00000000
--- a/package/network/utils/linux-atm/patches/000-debian_16.patch
+++ /dev/null
@@ -1,270 +0,0 @@
---- a/src/arpd/io.c
-+++ b/src/arpd/io.c
-@@ -277,7 +277,8 @@ static void accept_new(void)
-     struct atm_qos qos;
-     ENTRY *entry;
-     VCC *vcc;
--    int fd,len,size,error;
-+    int fd,error;
-+    socklen_t len,size;
- 
-     len = sizeof(addr);
-     if ((fd = accept(incoming,(struct sockaddr *) &addr,&len)) < 0) {
-@@ -614,7 +615,8 @@ int ip_itf_info(int number,uint32_t *ip,
- 
- int get_local(int fd,struct sockaddr_atmsvc *addr)
- {
--    int length,result;
-+    int result;
-+    size_t length;
- 
-     length = sizeof(struct sockaddr_atmsvc);
-     result = getsockname(fd,(struct sockaddr *) addr,&length);
---- a/src/arpd/table.c
-+++ b/src/arpd/table.c
-@@ -101,7 +101,8 @@ static void dump_vcc(VCC *vcc)
-     char addr_buf[MAX_ATM_ADDR_LEN+1];
-     char qos_buf[MAX_ATM_QOS_LEN+1];
-     struct atm_qos qos;
--    int size,sndbuf;
-+    int sndbuf;
-+    socklen_t size;
- 
-     size = sizeof(addr);
-     if (getpeername(vcc->fd,(struct sockaddr *) &addr,&size) < 0) {
---- a/src/ilmid/asn1/asn_int.c
-+++ b/src/ilmid/asn1/asn_int.c
-@@ -185,7 +185,7 @@ FILE* f _AND_
- AsnInt* v _AND_
- unsigned short int indent)
- {
--    fprintf(f,"%d", *v);
-+    fprintf(f,"%ld", *v);
- } 
- 
- 
-@@ -370,5 +370,5 @@ FILE* f _AND_
- UAsnInt* v _AND_
- unsigned short int indent)
- {
--    fprintf(f,"%u", *v);
-+    fprintf(f,"%lu", *v);
- } 
---- a/src/ilmid/asn1/asn_oid.c
-+++ b/src/ilmid/asn1/asn_oid.c
-@@ -127,7 +127,7 @@ unsigned short int indent)
-     if (firstArcNum > 2)
-         firstArcNum = 2;
- 
--    fprintf(f,"%u %u", firstArcNum, arcNum - (firstArcNum * 40));
-+    fprintf(f,"%d %lu", firstArcNum, arcNum - (firstArcNum * 40));
- 
-     for (; i < v->octetLen ; )
-     {
-@@ -136,7 +136,7 @@ unsigned short int indent)
- 
-         arcNum = (arcNum << 7) + (v->octs[i] & 0x7f);
-         i++;
--        fprintf(f," %u", arcNum);
-+        fprintf(f," %lu", arcNum);
-     }
-     fprintf(f,"}");
- 
---- a/src/lane/connect.c
-+++ b/src/lane/connect.c
-@@ -258,7 +258,8 @@ static int
- data_handler(const Event_t *event, void *funcdata)
- {
-   Conn_t *tmp, *newconn;
--  int fd, nbytes;
-+  int fd;
-+  socklen_t nbytes;
-   static char buffer[BUFSIZE];
-   LaneControl_t *ctmp;
-   struct sockaddr_atmsvc addr;
---- a/src/lane/connect_bus.c
-+++ b/src/lane/connect_bus.c
-@@ -170,7 +170,8 @@ static int
- data_handler(const Event_t *event, void *funcdata)
- {
-   Conn_t *tmp, *newconn;
--  int fd, nbytes;
-+  int fd;
-+  socklen_t nbytes;
-   static char buffer[BUFSIZE];
-   struct sockaddr_atmsvc addr;
- 
---- a/src/lane/lane_atm.c
-+++ b/src/lane/lane_atm.c
-@@ -138,7 +138,7 @@ atm_connect_back(const AtmAddr_t *our_ad
-   struct atm_blli blli;
-   struct atm_qos qos;
-   int fd, ret;
--  int len = sizeof(address);
-+  socklen_t len = sizeof(address);
-   
-   fd = socket(PF_ATMSVC, SOCK_DGRAM, 0);
-   if (fd <0) {
---- a/src/lane/lecs.c
-+++ b/src/lane/lecs.c
-@@ -119,7 +119,7 @@ int main(int argc, char **argv)
-   int just_dump=0;
-   fd_set fds;
-   struct sockaddr_atmsvc client;
--  int len;
-+  socklen_t len;
-   unsigned char buffer[P_SIZE];
- 
-   while(i!=-1) {
---- a/src/lib/ans.c
-+++ b/src/lib/ans.c
-@@ -41,7 +41,7 @@
- static int ans(const char *text,int wanted,void *result,int res_len)
- {
-     unsigned char answer[MAX_ANSWER];
--    unsigned char name[MAX_NAME];
-+    char name[MAX_NAME];
-     unsigned char *pos,*data,*found;
-     int answer_len,name_len,data_len,found_len;
-     int questions,answers;
---- a/src/lib/sdu2cell.c
-+++ b/src/lib/sdu2cell.c
-@@ -15,7 +15,8 @@ int sdu2cell(int s,int sizes,const int *
- {
-     struct atm_qos qos;
-     int trailer,total,cells;
--    int size,i;
-+    int i;
-+    socklen_t size;
- 
-     size = sizeof(qos);
-     if (getsockopt(s,SOL_AAL,SO_ATMQOS,&qos,&size) < 0) return -1;
---- a/src/lib/unix.c
-+++ b/src/lib/unix.c
-@@ -63,8 +63,8 @@ int un_attach(const char *path)
- int un_recv_connect(int s,void *buf,int size)
- {
-     struct sockaddr_un addr;
--    int addr_size;
-     int len;
-+    socklen_t addr_size;
- 
-     addr_size = sizeof(addr);
-     len = recvfrom(s,buf,size,0,(struct sockaddr *) &addr,&addr_size);
---- a/src/maint/atmtcp.c
-+++ b/src/maint/atmtcp.c
-@@ -817,7 +817,8 @@ int main(int argc,char **argv)
- 	}
- 	else if (!strcmp(ARG,"listen") ||
- 	  (do_background = !strcmp(ARG,"listen-bg"))) {
--	    int fd,port,addr_len;
-+	    int fd,port;
-+	    socklen_t addr_len;
- 	    int *fd2 = alloc_t(int);
- 
- 	    if ((fd = socket(PF_INET,SOCK_STREAM,0)) < 0) {
---- a/src/maint/hediag.c
-+++ b/src/maint/hediag.c
-@@ -1,6 +1,7 @@
- #include <stdio.h>
- #include <stdlib.h>
- #include <unistd.h>
-+#include <string.h>
- #include <sys/ioctl.h>
- #include <sys/types.h>
- #include <sys/socket.h>
---- a/src/mpoad/io.c
-+++ b/src/mpoad/io.c
-@@ -521,7 +521,8 @@ static int msg_from_mps(int slot)
- static int accept_conn(int slot)
- {
-         struct sockaddr_atmsvc sa;
--        int i, new_fd, sa_len;
-+        int i, new_fd;
-+        socklen_t sa_len;
- 
-         sa_len = sizeof(sa);
-         new_fd = accept(fds[slot].fd, (struct sockaddr *)&sa, &sa_len);
---- a/src/sigd/io.c
-+++ b/src/sigd/io.c
-@@ -355,7 +355,7 @@ int get_pvc(int itf,int *vci)
-     error = 0;
-     if (bind(s,(struct sockaddr *) &addr,sizeof(addr)) < 0) error = errno;
-     else {
--	int size;
-+	socklen_t size;
- 
- 	size = sizeof(addr);
- 	if (getsockname(s,(struct sockaddr *) &addr,&size) < 0)
---- a/src/test/ttcp.c
-+++ b/src/test/ttcp.c
-@@ -92,7 +92,8 @@ struct sockaddr_in frominet;
- struct sockaddr_atmsvc satm;
- struct atm_qos qos;
- 
--int domain, fromlen;
-+int domain;
-+socklen_t fromlen;
- int fd;				/* fd of network socket */
- 
- int buflen = 8 * 1024;		/* length of buffer */
-@@ -466,7 +467,7 @@ int no_check = 0;
- 	    
- 	    {
- 		struct sockaddr_atmsvc peer;
--		int peerlen = sizeof(peer);
-+		socklen_t peerlen = sizeof(peer);
- 		if (getpeername(fd, (struct sockaddr *) &peer, 
- 				&peerlen) < 0) {
- 		    err("getpeername");
-@@ -498,7 +499,7 @@ int no_check = 0;
-     /* set socket buffer size */
- #if defined(SO_SNDBUF) || defined(SO_RCVBUF)
-     if (sockbufsize) {
--	int len;
-+	socklen_t len;
- 
- 	if (trans) {
- 	    /* set send socket buffer if we are transmitting */    
---- a/src/mpoad/mpcd.8
-+++ b/src/mpoad/mpcd.8
-@@ -28,7 +28,7 @@ mpcd \- ATM MPOA (Multi\-Protocol Over A
- .B ]]
- .SH DESCRIPTION
- MPOA client
--.SM(MPC) is responsible for creating and receiving
-+.SM (MPC) is responsible for creating and receiving
- internetwork layer shortcuts. Using these shortcuts MPCs forward
- unicast internetwork layer packets effectively over ATM without need
- for routing protocols.
-@@ -43,7 +43,7 @@ accepts shortcuts and packets arriving o
- shortcuts is done with the help of
- .SM MPOA
- server
--.SM(MPS).
-+.SM (MPS).
- .PP
- Just as the Linux
- .SM LAN
---- a/src/led/zeppelin.8
-+++ b/src/led/zeppelin.8
-@@ -99,7 +99,7 @@ Ring and ATM parts of the ELAN, so using
- recommended. Token Ring support has received less testing than its
- Ethernet counterpart.
- .SH FILES
--.IP \fI/var/run/lec[interface number].pid\fP
-+.IP \fI/var/run/lec[interface\ number].pid\fP
- The file containing the process id of zeppelin.
- .SH BUGS
- John Bonham died 1980 and Led Zeppelin broke.
---- a/src/sigd/atmsigd.conf.4
-+++ b/src/sigd/atmsigd.conf.4
-@@ -125,7 +125,7 @@ a comment. The `#' character cannot be e
- .P
- If an option is specified in \fBatmsigd.conf\fP and on the command
- line, the command line has priority.
--.COMPATIBILITY
-+.SH COMPATIBILITY
- Certain options used by past versions of \fBatmsigd\fP but no longer documented
- on the man page are still recognized and supported, but they also yield a
- warning message. Future versions of \fBatmsigd\fP will not recognize those
diff --git a/package/network/utils/linux-atm/patches/510-remove-LINUX_NETDEVICE-hack.patch b/package/network/utils/linux-atm/patches/510-remove-LINUX_NETDEVICE-hack.patch
index d76ec1ea..c16df18a 100644
--- a/package/network/utils/linux-atm/patches/510-remove-LINUX_NETDEVICE-hack.patch
+++ b/package/network/utils/linux-atm/patches/510-remove-LINUX_NETDEVICE-hack.patch
@@ -28,8 +28,8 @@ in Linux 4.20.
  #include <sys/socket.h>
 -#define _LINUX_NETDEVICE_H /* glibc2 */
  #include <linux/types.h>
+ #include <linux/if.h>
  #include <linux/if_arp.h>
- 
 --- a/src/arpd/io.c
 +++ b/src/arpd/io.c
 @@ -21,7 +21,6 @@
@@ -48,5 +48,5 @@ in Linux 4.20.
  #include <netinet/in.h> /* for ntohs, etc. */
 -#define _LINUX_NETDEVICE_H /* very crude hack for glibc2 */
  #include <linux/types.h>
+ #include <linux/if.h>
  #include <linux/if_arp.h>
- #include <linux/if_ether.h>
diff --git a/package/network/utils/linux-atm/patches/600-fix-format-errors.patch b/package/network/utils/linux-atm/patches/600-fix-format-errors.patch
deleted file mode 100644
index ef484f2f..00000000
--- a/package/network/utils/linux-atm/patches/600-fix-format-errors.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/src/test/ttcp.c
-+++ b/src/test/ttcp.c
-@@ -664,7 +664,7 @@ int no_check = 0;
-     exit(0);
- 
-   usage:
--    fprintf(stderr, Usage);
-+    fprintf(stderr, "%s", Usage);
-     exit(1);
- }
- 
diff --git a/package/network/utils/linux-atm/patches/700-musl-include.patch b/package/network/utils/linux-atm/patches/700-musl-include.patch
deleted file mode 100644
index 2b2268d8..00000000
--- a/package/network/utils/linux-atm/patches/700-musl-include.patch
+++ /dev/null
@@ -1,30 +0,0 @@
---- a/src/include/atmd.h
-+++ b/src/include/atmd.h
-@@ -10,6 +10,7 @@
- 
- #include <stdint.h>
- #include <stdio.h>
-+#include <string.h>
- #include <sys/types.h>
- #include <sys/time.h>
- 
---- a/src/lib/unix.c
-+++ b/src/lib/unix.c
-@@ -8,6 +8,7 @@
- 
- #include <stdlib.h>
- #include <stdio.h>
-+#include <string.h>
- #include <unistd.h>
- #include <errno.h>
- #include <sys/types.h>
---- a/src/sigd/kernel.c
-+++ b/src/sigd/kernel.c
-@@ -8,6 +8,7 @@
- 
- #include <stdlib.h>
- #include <stdio.h>
-+#include <string.h>
- #include <errno.h>
- #include <assert.h>
- 
diff --git a/package/network/utils/linux-atm/patches/800-include_sockios.patch b/package/network/utils/linux-atm/patches/800-include_sockios.patch
deleted file mode 100644
index edb385ca..00000000
--- a/package/network/utils/linux-atm/patches/800-include_sockios.patch
+++ /dev/null
@@ -1,21 +0,0 @@
---- a/src/maint/saaldump.c	2020-03-29 22:58:01.089711789 +0200
-+++ b/src/maint/saaldump.c	2020-03-29 22:59:17.564639387 +0200
-@@ -6,6 +6,7 @@
- #include <config.h>
- #endif
-
-+#include <linux/sockios.h>
- #include <stdlib.h>
- #include <stdarg.h>
- #include <stdio.h>
---- a/src/maint/atmdump.c	2020-03-29 22:58:18.573694469 +0200
-+++ b/src/maint/atmdump.c	2020-03-29 22:58:49.956729365 +0200
-@@ -6,6 +6,7 @@
- #include <config.h>
- #endif
-
-+#include <linux/sockios.h>
- #include <stdlib.h>
- #include <stdio.h>
- #include <unistd.h>
-
diff --git a/package/network/utils/linux-atm/patches/900-add_5.19_support.patch b/package/network/utils/linux-atm/patches/900-add_5.19_support.patch
deleted file mode 100644
index 0dc26dc4..00000000
--- a/package/network/utils/linux-atm/patches/900-add_5.19_support.patch
+++ /dev/null
@@ -1,17 +0,0 @@
---- a/src/maint/Makefile.am
-+++ b/src/maint/Makefile.am
-@@ -1,5 +1,5 @@
- BOOTPGMS=atmaddr esi
--SYSPGMS=atmloop atmtcp enitune zntune hediag # nstune
-+SYSPGMS=atmloop atmtcp enitune hediag # nstune
- USRPGMS=atmdiag atmdump sonetdiag saaldump
- 
- INCLUDES=-I$(srcdir)/../q2931 -I$(srcdir)/../saal -I.
-@@ -14,7 +14,6 @@ esi_SOURCES = esi.c
- atmloop_SOURCES = atmloop.c
- atmtcp_SOURCES = atmtcp.c
- enitune_SOURCES = enitune.c
--zntune_SOURCES = zntune.c
- #nstune_SOURCES = nstune.c
- 
- atmdiag_SOURCES = atmdiag.c
diff --git a/package/system/ubus/Makefile b/package/system/ubus/Makefile
index 40dafd68..9a807852 100644
--- a/package/system/ubus/Makefile
+++ b/package/system/ubus/Makefile
@@ -5,9 +5,9 @@ PKG_RELEASE:=1
 
 PKG_SOURCE_PROTO:=git
 PKG_SOURCE_URL=$(PROJECT_GIT)/project/ubus.git
-PKG_SOURCE_DATE:=2024-10-20
-PKG_SOURCE_VERSION:=252a9b0c1774790fb9c25735d5a09c27dba895db
-PKG_MIRROR_HASH:=475d96cc267370eb2e6ec808fc88285267cece1c5956d3966a060932d8b95175
+PKG_SOURCE_DATE:=2025-01-02
+PKG_SOURCE_VERSION:=afa57cce0aff82f4a7a0e509d4387ebc23dd3be7
+PKG_MIRROR_HASH:=a0b3c1961f5f49d31c34a44576ce44538c3ee97bfce97f86f732d7ecc1df9798
 PKG_ABI_VERSION:=$(call abi_version_str,$(PKG_SOURCE_DATE))
 CMAKE_INSTALL:=1
 
diff --git a/package/utils/util-linux/Makefile b/package/utils/util-linux/Makefile
index 44bf22f7..83f3a8c8 100644
--- a/package/utils/util-linux/Makefile
+++ b/package/utils/util-linux/Makefile
@@ -8,12 +8,12 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=util-linux
-PKG_VERSION:=2.38.1
+PKG_VERSION:=2.40.2
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
-PKG_SOURCE_URL:=@KERNEL/linux/utils/$(PKG_NAME)/v2.38
-PKG_HASH:=60492a19b44e6cf9a3ddff68325b333b8b52b6c59ce3ebd6a0ecaa4c5117e84f
+PKG_SOURCE_URL:=@KERNEL/linux/utils/$(PKG_NAME)/v2.40
+PKG_HASH:=d78b37a66f5922d70edf3bdfb01a6b33d34ed3c3cafd6628203b2a2b67c8e8b3
 PKG_CPE_ID:=cpe:/a:kernel:util-linux
 
 PKG_LICENSE:=GPL-2.0-only
@@ -25,14 +25,10 @@ PKG_LICENSE_FILES:=	COPYING					\
 			libuuid/COPYING				\
 			Documentation/licenses/COPYING.BSD-3
 
-PKG_BUILD_PARALLEL:=1
-
-PKG_FIXUP:=autoreconf
 PKG_INSTALL:=1
 
-DISABLE_NLS:=--disable-nls
-
 include $(INCLUDE_DIR)/package.mk
+include $(INCLUDE_DIR)/meson.mk
 
 define Package/util-linux/Default
   SECTION:=utils
@@ -178,6 +174,17 @@ define Package/cfdisk/description
  cfdisk is a curses-based program for partitioning any hard disk drive
 endef
 
+define Package/colrm
+$(call Package/util-linux/Default)
+  TITLE:=colrm removes selected columns from a file
+  DEPENDS:=
+endef
+
+define Package/colrm/description
+ colrm removes selected columns from a file. Input is taken from
+ standard input. Output is sent to standard output.
+endef
+
 define Package/dmesg
 $(call Package/util-linux/Default)
   TITLE:=print or control the kernel ring buffer
@@ -311,7 +318,7 @@ endef
 define Package/lsblk
 $(call Package/util-linux/Default)
   TITLE:=list block devices
-  DEPENDS:= +libblkid +libmount +libsmartcols
+  DEPENDS:= +libblkid +libmount +libsmartcols +libncurses
   SUBMENU=Disc
 endef
 
@@ -419,6 +426,17 @@ define Package/rename/description
  expression in their name by replacement
 endef
 
+define Package/rev
+$(call Package/util-linux/Default)
+  TITLE:=Reverse lines characterwise
+endef
+
+define Package/rev/description
+ rev utility copies the specified files to the standard output, reversing the
+ order of characters in every line. If no files are specified, the standard
+ input is read.
+endef
+
 define Package/partx-utils
 $(call Package/util-linux/Default)
   TITLE:=inform kernel about the presence and numbering of on-disk partitions
@@ -478,6 +496,7 @@ endef
 define Package/taskset
 $(call Package/util-linux/Default)
   TITLE:=set or retrieve a process's CPU affinity
+  ALTERNATIVES:=200:/usr/bin/taskset:/usr/bin/util-linux-taskset
 endef
 
 define Package/taskset/description
@@ -552,44 +571,70 @@ define Package/wipefs/description
  libblkid.
 endef
 
-CONFIGURE_ARGS += \
-	--disable-use-tty-group		\
-	--disable-rpath			\
-	--disable-tls			\
-	--disable-su			\
-	--disable-sulogin		\
-	--disable-makeinstall-chown	\
-	--disable-login 		\
-	--disable-nologin		\
-	--disable-lslogins		\
-	--disable-runuser		\
-	--disable-chfn-chsh		\
-	--disable-raw			\
-	--without-python		\
-	--without-udev			\
-	--without-readline		\
-	--without-libmagic		\
-	--with-ncursesw
-
-TARGET_CFLAGS += $(FPIC) -std=gnu99
+MESON_ARGS += \
+	-Dsystemd=disabled \
+	-Dtinfo=disabled \
+	-Dcryptsetup=disabled \
+	-Dlibutil=disabled \
+	-Dlibutempter=disabled \
+	-Dlibpcre2-posix=disabled \
+	-Dlibuser=disabled \
+	-Duse-tty-group=false \
+	-Duse-tls=false \
+	-Dbuild-python=disabled \
+	-Dbuild-zramctl=disabled \
+	-Dbuild-fsck=disabled \
+	-Dbuild-wipefs=disabled \
+	-Dbuild-fallocate=disabled \
+	-Dbuild-setpriv=disabled \
+	-Dbuild-hardlink=disabled \
+	-Dbuild-cramfs=disabled \
+	-Dbuild-bfs=disabled \
+	-Dbuild-minix=disabled \
+	-Dbuild-fdformat=disabled \
+	-Dbuild-lslogins=disabled \
+	-Dbuild-wdctl=disabled \
+	-Dbuild-cal=disabled \
+	-Dbuild-switch_root=disabled \
+	-Dbuild-pivot_root=disabled \
+	-Dbuild-lsmem=disabled \
+	-Dbuild-lsirq=disabled \
+	-Dbuild-irqtop=disabled \
+	-Dbuild-chmem=disabled \
+	-Dbuild-ipcrm=disabled \
+	-Dbuild-rfkill=disabled \
+	-Dbuild-tunelp=disabled \
+	-Dbuild-kill=disabled \
+	-Dbuild-last=disabled \
+	-Dbuild-utmpdump=disabled \
+	-Dbuild-line=disabled \
+	-Dbuild-mesg=disabled \
+	-Dbuild-raw=disabled \
+	-Dbuild-vipw=disabled \
+	-Dbuild-newgrp=disabled \
+	-Dbuild-chfn-chsh=disabled \
+	-Dbuild-login=disabled \
+	-Dbuild-nologin=disabled \
+	-Dbuild-sulogin=disabled \
+	-Dbuild-su=disabled \
+	-Dbuild-runuser=disabled \
+	-Dbuild-ul=disabled \
+	-Dbuild-pg=disabled \
+	-Dbuild-write=disabled \
+	-Dbuild-bash-completion=disabled \
+	-Dbuild-pylibmount=disabled \
+	-Dbuild-liblastlog2=disabled \
+	-Dreadline=disabled \
+	-Dmagic=disabled \
+	-Dncursesw=enabled
 
 define Build/InstallDev
 	$(INSTALL_DIR) $(1)/usr/lib/pkgconfig
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/blkid.pc $(1)/usr/lib/pkgconfig
-	$(SED) 's,/usr/include,$$$${prefix}/include,g' $(1)/usr/lib/pkgconfig/blkid.pc
-	$(SED) 's,/usr/lib,$$$${exec_prefix}/lib,g' $(1)/usr/lib/pkgconfig/blkid.pc
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/fdisk.pc $(1)/usr/lib/pkgconfig
-	$(SED) 's,/usr/include,$$$${prefix}/include,g' $(1)/usr/lib/pkgconfig/fdisk.pc
-	$(SED) 's,/usr/lib,$$$${exec_prefix}/lib,g' $(1)/usr/lib/pkgconfig/fdisk.pc
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/mount.pc $(1)/usr/lib/pkgconfig
-	$(SED) 's,/usr/include,$$$${prefix}/include,g' $(1)/usr/lib/pkgconfig/mount.pc
-	$(SED) 's,/usr/lib,$$$${exec_prefix}/lib,g' $(1)/usr/lib/pkgconfig/mount.pc
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/smartcols.pc $(1)/usr/lib/pkgconfig
-	$(SED) 's,/usr/include,$$$${prefix}/include,g' $(1)/usr/lib/pkgconfig/smartcols.pc
-	$(SED) 's,/usr/lib,$$$${exec_prefix}/lib,g' $(1)/usr/lib/pkgconfig/smartcols.pc
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/uuid.pc $(1)/usr/lib/pkgconfig
-	$(SED) 's,/usr/include,$$$${prefix}/include,g' $(1)/usr/lib/pkgconfig/uuid.pc
-	$(SED) 's,/usr/lib,$$$${exec_prefix}/lib,g' $(1)/usr/lib/pkgconfig/uuid.pc
 
 	$(INSTALL_DIR) $(1)/usr/include/blkid
 	$(CP) $(PKG_INSTALL_DIR)/usr/include/blkid/blkid.h $(1)/usr/include/blkid
@@ -603,43 +648,37 @@ define Build/InstallDev
 	$(CP) $(PKG_INSTALL_DIR)/usr/include/libsmartcols/libsmartcols.h $(1)/usr/include/libsmartcols
 
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libblkid.so* $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libfdisk.so* $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libmount.so* $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libuuid.so* $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libsmartcols.so* $(1)/usr/lib
-
-	$(LN) libblkid.so.1 $(1)/usr/lib/libblkid.so
-	$(LN) libfdisk.so.1 $(1)/usr/lib/libfdisk.so
-	$(LN) libmount.so.1 $(1)/usr/lib/libmount.so
-	$(LN) libuuid.so.1 $(1)/usr/lib/libuuid.so
-	$(LN) libsmartcols.so.1 $(1)/usr/lib/libsmartcols.so
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libblkid.so* $(1)/usr/lib
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libfdisk.so* $(1)/usr/lib
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libmount.so* $(1)/usr/lib
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libuuid.so* $(1)/usr/lib
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libsmartcols.so* $(1)/usr/lib
 endef
 
 
 define Package/libfdisk/install
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libfdisk.so.* $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libfdisk.so.* $(1)/usr/lib/
 endef
 
 define Package/libblkid/install
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libblkid.so.* $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libblkid.so.* $(1)/usr/lib/
 endef
 
 define Package/libmount/install
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libmount.so.* $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libmount.so.* $(1)/usr/lib/
 endef
 
 define Package/libsmartcols/install
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libsmartcols.so.* $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libsmartcols.so.* $(1)/usr/lib/
 endef
 
 define Package/libuuid/install
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/lib/libuuid.so.* $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libuuid.so.* $(1)/usr/lib/
 endef
 
 define Package/agetty/install
@@ -672,6 +711,11 @@ define Package/cfdisk/install
 	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/cfdisk $(1)/usr/sbin/
 endef
 
+define Package/colrm/install
+	$(INSTALL_DIR) $(1)/usr/bin
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/colrm $(1)/usr/bin/
+endef
+
 define Package/dmesg/install
 	$(INSTALL_DIR) $(1)/usr/bin
 	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/dmesg $(1)/usr/bin/
@@ -789,6 +833,11 @@ define Package/rename/install
 	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/rename $(1)/usr/bin/
 endef
 
+define Package/rev/install
+	$(INSTALL_DIR) $(1)/usr/bin
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/rev $(1)/usr/bin/
+endef
+
 define Package/partx-utils/install
 	$(INSTALL_DIR) $(1)/usr/sbin
 	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/partx $(1)/usr/sbin/
@@ -820,7 +869,7 @@ endef
 
 define Package/taskset/install
 	$(INSTALL_DIR) $(1)/usr/bin
-	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/taskset $(1)/usr/bin/
+	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/taskset $(1)/usr/bin/util-linux-taskset
 endef
 
 define Package/unshare/install
@@ -866,6 +915,7 @@ $(eval $(call BuildPackage,blkid))
 $(eval $(call BuildPackage,blockdev))
 $(eval $(call BuildPackage,cal))
 $(eval $(call BuildPackage,cfdisk))
+$(eval $(call BuildPackage,colrm))
 $(eval $(call BuildPackage,dmesg))
 $(eval $(call BuildPackage,eject))
 $(eval $(call BuildPackage,fdisk))
@@ -889,6 +939,7 @@ $(eval $(call BuildPackage,namei))
 $(eval $(call BuildPackage,nsenter))
 $(eval $(call BuildPackage,prlimit))
 $(eval $(call BuildPackage,rename))
+$(eval $(call BuildPackage,rev))
 $(eval $(call BuildPackage,partx-utils))
 $(eval $(call BuildPackage,script-utils))
 $(eval $(call BuildPackage,setterm))
diff --git a/package/utils/util-linux/patches/100-use_urandom.patch b/package/utils/util-linux/patches/100-use_urandom.patch
deleted file mode 100644
index 58172098..00000000
--- a/package/utils/util-linux/patches/100-use_urandom.patch
+++ /dev/null
@@ -1,14 +0,0 @@
---- a/lib/randutils.c
-+++ b/lib/randutils.c
-@@ -26,6 +26,11 @@
- #define THREAD_LOCAL static
- #endif
- 
-+/* force /dev/urandom to avoid hanging on early boot */
-+#undef HAVE_GETRANDOM
-+#undef SYS_getrandom
-+#undef __NR_getrandom
-+
- #ifdef HAVE_GETRANDOM
- # include <sys/random.h>
- #elif defined (__linux__)
diff --git a/toolchain/binutils/Config.in b/toolchain/binutils/Config.in
index 3ec4fe47..e2721b1e 100644
--- a/toolchain/binutils/Config.in
+++ b/toolchain/binutils/Config.in
@@ -2,29 +2,21 @@
 
 choice
 	prompt "Binutils Version" if TOOLCHAINOPTS
-	default BINUTILS_USE_VERSION_2_40
+	default BINUTILS_USE_VERSION_2_42
 	help
 	  Select the version of binutils you wish to use.
 
-	config BINUTILS_USE_VERSION_2_37
-		bool "Binutils 2.37"
-		select BINUTILS_VERSION_2_37
-
-	config BINUTILS_USE_VERSION_2_38
-		bool "Binutils 2.38"
-		select BINUTILS_VERSION_2_38
-
-	config BINUTILS_USE_VERSION_2_39
-		bool "Binutils 2.39"
-		select BINUTILS_VERSION_2_39
-
 	config BINUTILS_USE_VERSION_2_40
 		bool "Binutils 2.40"
 		select BINUTILS_VERSION_2_40
 
-	config BINUTILS_USE_VERSION_2_41
-		bool "Binutils 2.41"
-		select BINUTILS_VERSION_2_41
+	config BINUTILS_USE_VERSION_2_42
+		bool "Binutils 2.42"
+		select BINUTILS_VERSION_2_42
+
+	config BINUTILS_USE_VERSION_2_43
+		bool "Binutils 2.43.1"
+		select BINUTILS_VERSION_2_43
 endchoice
 
 config EXTRA_BINUTILS_CONFIG_OPTIONS
diff --git a/toolchain/binutils/Config.version b/toolchain/binutils/Config.version
index acb764bb..f616cddc 100644
--- a/toolchain/binutils/Config.version
+++ b/toolchain/binutils/Config.version
@@ -1,24 +1,16 @@
 
-config BINUTILS_VERSION_2_37
-	bool
-
-config BINUTILS_VERSION_2_38
-	bool
-
-config BINUTILS_VERSION_2_39
+config BINUTILS_VERSION_2_40
 	bool
 
-config BINUTILS_VERSION_2_40
+config BINUTILS_VERSION_2_42
 	default y if !TOOLCHAINOPTS
 	bool
 
-config BINUTILS_VERSION_2_41
+config BINUTILS_VERSION_2_43
 	bool
 
 config BINUTILS_VERSION
 	string
-	default "2.37"			if BINUTILS_VERSION_2_37
-	default "2.38"			if BINUTILS_VERSION_2_38
-	default "2.39"			if BINUTILS_VERSION_2_39
 	default "2.40"			if BINUTILS_VERSION_2_40
-	default "2.41"			if BINUTILS_VERSION_2_41
+	default "2.42"			if BINUTILS_VERSION_2_42
+	default "2.43.1"		if BINUTILS_VERSION_2_43
diff --git a/toolchain/binutils/Makefile b/toolchain/binutils/Makefile
index b2831f8c..63f0e07c 100644
--- a/toolchain/binutils/Makefile
+++ b/toolchain/binutils/Makefile
@@ -16,24 +16,16 @@ PKG_CPE_ID:=cpe:/a:gnu:binutils
 
 TAR_OPTIONS += --exclude='*.rej'
 
-ifeq ($(PKG_VERSION),2.37)
-  PKG_HASH:=820d9724f020a3e69cb337893a0b63c2db161dadcb0e06fc11dc29eb1e84a32c
-endif
-
-ifeq ($(PKG_VERSION),2.38)
-  PKG_HASH:=e316477a914f567eccc34d5d29785b8b0f5a10208d36bbacedcc39048ecfe024
-endif
-
-ifeq ($(PKG_VERSION),2.39)
-  PKG_HASH:=645c25f563b8adc0a81dbd6a41cffbf4d37083a382e02d5d3df4f65c09516d00
-endif
-
 ifeq ($(PKG_VERSION),2.40)
   PKG_HASH:=0f8a4c272d7f17f369ded10a4aca28b8e304828e95526da482b0ccc4dfc9d8e1
 endif
 
-ifeq ($(PKG_VERSION),2.41)
-  PKG_HASH:=ae9a5789e23459e59606e6714723f2d3ffc31c03174191ef0d015bdf06007450
+ifeq ($(PKG_VERSION),2.42)
+  PKG_HASH:=f6e4d41fd5fc778b06b7891457b3620da5ecea1006c6a4a41ae998109f85a800
+endif
+
+ifeq ($(PKG_VERSION),2.43.1)
+  PKG_HASH:=13f74202a3c4c51118b797a39ea4200d3f6cfbe224da6d1d95bb938480132dfd
 endif
 
 HOST_BUILD_PARALLEL:=1
@@ -55,7 +47,7 @@ HOST_CONFIGURE_ARGS = \
 	--target=$(REAL_GNU_TARGET_NAME) \
 	--with-sysroot=$(TOOLCHAIN_DIR) \
 	--with-system-zlib \
-	--without-zstd \
+	--with-zstd \
 	--enable-deterministic-archives \
 	--enable-plugins \
 	--enable-lto \
diff --git a/toolchain/binutils/patches/2.37/300-001_ld_makefile_patch.patch b/toolchain/binutils/patches/2.37/300-001_ld_makefile_patch.patch
deleted file mode 100644
index f1cbb819..00000000
--- a/toolchain/binutils/patches/2.37/300-001_ld_makefile_patch.patch
+++ /dev/null
@@ -1,22 +0,0 @@
---- a/ld/Makefile.am
-+++ b/ld/Makefile.am
-@@ -50,7 +50,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- 
- EMUL = @EMUL@
- EMULATION_OFILES = @EMULATION_OFILES@
---- a/ld/Makefile.in
-+++ b/ld/Makefile.in
-@@ -561,7 +561,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- BASEDIR = $(srcdir)/..
- BFDDIR = $(BASEDIR)/bfd
- INCDIR = $(BASEDIR)/include
diff --git a/toolchain/binutils/patches/2.37/400-mips_no_dynamic_linking_sym.patch b/toolchain/binutils/patches/2.37/400-mips_no_dynamic_linking_sym.patch
deleted file mode 100644
index 070247ec..00000000
--- a/toolchain/binutils/patches/2.37/400-mips_no_dynamic_linking_sym.patch
+++ /dev/null
@@ -1,18 +0,0 @@
---- a/bfd/elfxx-mips.c
-+++ b/bfd/elfxx-mips.c
-@@ -8057,6 +8057,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       name = SGI_COMPAT (abfd) ? "_DYNAMIC_LINK" : "_DYNAMIC_LINKING";
-       bh = NULL;
-+      if (0) {
-       if (!(_bfd_generic_link_add_one_symbol
- 	    (info, abfd, name, BSF_GLOBAL, bfd_abs_section_ptr, 0,
- 	     NULL, false, get_elf_backend_data (abfd)->collect, &bh)))
-@@ -8069,6 +8070,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       if (! bfd_elf_link_record_dynamic_symbol (info, h))
- 	return false;
-+      }
- 
-       if (! mips_elf_hash_table (info)->use_rld_obj_head)
- 	{
diff --git a/toolchain/binutils/patches/2.37/500-Change-default-emulation-for-mips64-linux.patch b/toolchain/binutils/patches/2.37/500-Change-default-emulation-for-mips64-linux.patch
deleted file mode 100644
index c5984376..00000000
--- a/toolchain/binutils/patches/2.37/500-Change-default-emulation-for-mips64-linux.patch
+++ /dev/null
@@ -1,38 +0,0 @@
---- a/bfd/config.bfd
-+++ b/bfd/config.bfd
-@@ -891,12 +891,12 @@ case "${targ}" in
-     targ_selvecs="mips_elf32_le_vec mips_elf64_be_vec mips_elf64_le_vec mips_ecoff_be_vec mips_ecoff_le_vec"
-     ;;
-   mips64*el-*-linux*)
--    targ_defvec=mips_elf32_ntrad_le_vec
--    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_le_vec mips_elf64_trad_be_vec"
-+    targ_defvec=mips_elf64_trad_le_vec
-+    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_be_vec"
-     ;;
-   mips64*-*-linux*)
--    targ_defvec=mips_elf32_ntrad_be_vec
--    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_be_vec mips_elf64_trad_le_vec"
-+    targ_defvec=mips_elf64_trad_be_vec
-+    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_le_vec"
-     ;;
-   mips*el-*-linux*)
-     targ_defvec=mips_elf32_trad_le_vec
---- a/ld/configure.tgt
-+++ b/ld/configure.tgt
-@@ -530,12 +530,12 @@ mips*-*-vxworks*)	targ_emul=elf32ebmipvx
- 			;;
- mips*-*-windiss)	targ_emul=elf32mipswindiss
- 			;;
--mips64*el-*-linux-*)	targ_emul=elf32ltsmipn32
--			targ_extra_emuls="elf32btsmipn32 elf32ltsmip elf32btsmip elf64ltsmip elf64btsmip"
-+mips64*el-*-linux-*)	targ_emul=elf64ltsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32ltsmip elf32btsmip elf64btsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
--mips64*-*-linux-*)	targ_emul=elf32btsmipn32
--			targ_extra_emuls="elf32ltsmipn32 elf32btsmip elf32ltsmip elf64btsmip elf64ltsmip"
-+mips64*-*-linux-*)	targ_emul=elf64btsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32btsmip elf32ltsmip elf64ltsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
- mips*el-*-linux-*)	targ_emul=elf32ltsmip
diff --git a/toolchain/binutils/patches/2.37/600-Close_the_file_descriptor.patch b/toolchain/binutils/patches/2.37/600-Close_the_file_descriptor.patch
deleted file mode 100644
index fef86a9c..00000000
--- a/toolchain/binutils/patches/2.37/600-Close_the_file_descriptor.patch
+++ /dev/null
@@ -1,184 +0,0 @@
-From: H.J. Lu <hjl.tools@gmail.com>
-Date: Mon, 26 Jul 2021 12:59:55 +0000 (-0700)
-Subject: bfd: Close the file descriptor if there is no archive fd
-X-Git-Url: https://sourceware.org/git/?p=binutils-gdb.git;a=commitdiff_plain;h=1c611b40e6bfc8029bff7696814330b5bc0ee5c0
-
-bfd: Close the file descriptor if there is no archive fd
-
-Close the file descriptor if there is no archive plugin file descriptor
-to avoid running out of file descriptors on thin archives with many
-archive members.
-
-bfd/
-
-	PR ld/28138
-	* plugin.c (bfd_plugin_close_file_descriptor): Close the file
-	descriptor there is no archive plugin file descriptor.
-
-ld/
-
-	PR ld/28138
-	* testsuite/ld-plugin/lto.exp: Run tmpdir/pr28138 only for
-	native build.
-
-	PR ld/28138
-	* testsuite/ld-plugin/lto.exp: Run ld/28138 tests.
-	* testsuite/ld-plugin/pr28138.c: New file.
-	* testsuite/ld-plugin/pr28138-1.c: Likewise.
-	* testsuite/ld-plugin/pr28138-2.c: Likewise.
-	* testsuite/ld-plugin/pr28138-3.c: Likewise.
-	* testsuite/ld-plugin/pr28138-4.c: Likewise.
-	* testsuite/ld-plugin/pr28138-5.c: Likewise.
-	* testsuite/ld-plugin/pr28138-6.c: Likewise.
-	* testsuite/ld-plugin/pr28138-7.c: Likewise.
-
-(cherry picked from commit 5a98fb7513b559e20dfebdbaa2a471afda3b4742)
-(cherry picked from commit 7dc37e1e1209c80e0bab784df6b6bac335e836f2)
----
-
---- a/bfd/plugin.c
-+++ b/bfd/plugin.c
-@@ -291,6 +291,14 @@ bfd_plugin_close_file_descriptor (bfd *a
- 	     && !bfd_is_thin_archive (abfd->my_archive))
- 	abfd = abfd->my_archive;
- 
-+      /* Close the file descriptor if there is no archive plugin file
-+	 descriptor.  */
-+      if (abfd->archive_plugin_fd == -1)
-+	{
-+	  close (fd);
-+	  return;
-+	}
-+
-       abfd->archive_plugin_fd_open_count--;
-       /* Dup the archive plugin file descriptor for later use, which
- 	 will be closed by _bfd_archive_close_and_cleanup.  */
---- a/ld/testsuite/ld-plugin/lto.exp
-+++ b/ld/testsuite/ld-plugin/lto.exp
-@@ -687,6 +687,40 @@ if { [is_elf_format] && [check_lto_share
-     }
- }
- 
-+run_cc_link_tests [list \
-+    [list \
-+	"Build pr28138.a" \
-+	"-T" "" \
-+	{pr28138-1.c pr28138-2.c pr28138-3.c pr28138-4.c pr28138-5.c \
-+	 pr28138-6.c pr28138-7.c} {} "pr28138.a" \
-+    ] \
-+    [list \
-+	"Build pr28138.o" \
-+	"" "" \
-+	{pr28138.c} {} \
-+    ] \
-+]
-+
-+set exec_output [run_host_cmd "sh" \
-+			      "-c \"ulimit -n 20; \
-+			      $CC -Btmpdir/ld -o tmpdir/pr28138 \
-+			      tmpdir/pr28138.o tmpdir/pr28138.a\""]
-+set exec_output [prune_warnings $exec_output]
-+if [string match "" $exec_output] then {
-+    if { [isnative] } {
-+	set exec_output [run_host_cmd "tmpdir/pr28138" ""]
-+	if [string match "PASS" $exec_output] then {
-+	    pass "PR ld/28138"
-+	} else {
-+	    fail "PR ld/28138"
-+	}
-+    } else {
-+	pass "PR ld/28138"
-+    }
-+} else {
-+    fail "PR ld/28138"
-+}
-+
- set testname "Build liblto-11.a"
- remote_file host delete "tmpdir/liblto-11.a"
- set catch_output [run_host_cmd "$ar" "rc $plug_opt tmpdir/liblto-11.a tmpdir/lto-11a.o tmpdir/lto-11b.o tmpdir/lto-11c.o"]
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-1.c
-@@ -0,0 +1,6 @@
-+extern int a0(void);
-+int
-+a1(void)
-+{
-+  return 1 + a0();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-2.c
-@@ -0,0 +1,6 @@
-+extern int a1(void);
-+int
-+a2(void)
-+{
-+  return 1 + a1();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-3.c
-@@ -0,0 +1,6 @@
-+extern int a2(void);
-+int
-+a3(void)
-+{
-+  return 1 + a2();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-4.c
-@@ -0,0 +1,6 @@
-+extern int a3(void);
-+int
-+a4(void)
-+{
-+  return 1 + a3();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-5.c
-@@ -0,0 +1,6 @@
-+extern int a4(void);
-+int
-+a5(void)
-+{
-+  return 1 + a4();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-6.c
-@@ -0,0 +1,6 @@
-+extern int a5(void);
-+int
-+a6(void)
-+{
-+  return 1 + a5();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138-7.c
-@@ -0,0 +1,6 @@
-+extern int a6(void);
-+int
-+a7(void)
-+{
-+  return 1 + a6();
-+}
---- /dev/null
-+++ b/ld/testsuite/ld-plugin/pr28138.c
-@@ -0,0 +1,20 @@
-+#include <stdio.h>
-+
-+extern int a7(void);
-+
-+int
-+a0(void)
-+{
-+  return 0;
-+}
-+
-+int
-+main()
-+{
-+  if (a7() == 7)
-+    {
-+      printf ("PASS\n");
-+      return 0;
-+    }
-+  return 1;
-+}
diff --git a/toolchain/binutils/patches/2.38/300-001_ld_makefile_patch.patch b/toolchain/binutils/patches/2.38/300-001_ld_makefile_patch.patch
deleted file mode 100644
index ecc9dd64..00000000
--- a/toolchain/binutils/patches/2.38/300-001_ld_makefile_patch.patch
+++ /dev/null
@@ -1,22 +0,0 @@
---- a/ld/Makefile.am
-+++ b/ld/Makefile.am
-@@ -50,7 +50,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- 
- EMUL = @EMUL@
- EMULATION_OFILES = @EMULATION_OFILES@
---- a/ld/Makefile.in
-+++ b/ld/Makefile.in
-@@ -563,7 +563,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- BASEDIR = $(srcdir)/..
- BFDDIR = $(BASEDIR)/bfd
- INCDIR = $(BASEDIR)/include
diff --git a/toolchain/binutils/patches/2.38/400-mips_no_dynamic_linking_sym.patch b/toolchain/binutils/patches/2.38/400-mips_no_dynamic_linking_sym.patch
deleted file mode 100644
index 070247ec..00000000
--- a/toolchain/binutils/patches/2.38/400-mips_no_dynamic_linking_sym.patch
+++ /dev/null
@@ -1,18 +0,0 @@
---- a/bfd/elfxx-mips.c
-+++ b/bfd/elfxx-mips.c
-@@ -8057,6 +8057,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       name = SGI_COMPAT (abfd) ? "_DYNAMIC_LINK" : "_DYNAMIC_LINKING";
-       bh = NULL;
-+      if (0) {
-       if (!(_bfd_generic_link_add_one_symbol
- 	    (info, abfd, name, BSF_GLOBAL, bfd_abs_section_ptr, 0,
- 	     NULL, false, get_elf_backend_data (abfd)->collect, &bh)))
-@@ -8069,6 +8070,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       if (! bfd_elf_link_record_dynamic_symbol (info, h))
- 	return false;
-+      }
- 
-       if (! mips_elf_hash_table (info)->use_rld_obj_head)
- 	{
diff --git a/toolchain/binutils/patches/2.38/500-Change-default-emulation-for-mips64-linux.patch b/toolchain/binutils/patches/2.38/500-Change-default-emulation-for-mips64-linux.patch
deleted file mode 100644
index 0797f4df..00000000
--- a/toolchain/binutils/patches/2.38/500-Change-default-emulation-for-mips64-linux.patch
+++ /dev/null
@@ -1,38 +0,0 @@
---- a/bfd/config.bfd
-+++ b/bfd/config.bfd
-@@ -928,12 +928,12 @@ case "${targ}" in
-     targ_selvecs="mips_elf32_le_vec mips_elf64_be_vec mips_elf64_le_vec mips_ecoff_be_vec mips_ecoff_le_vec"
-     ;;
-   mips64*el-*-linux*)
--    targ_defvec=mips_elf32_ntrad_le_vec
--    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_le_vec mips_elf64_trad_be_vec"
-+    targ_defvec=mips_elf64_trad_le_vec
-+    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_be_vec"
-     ;;
-   mips64*-*-linux*)
--    targ_defvec=mips_elf32_ntrad_be_vec
--    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_be_vec mips_elf64_trad_le_vec"
-+    targ_defvec=mips_elf64_trad_be_vec
-+    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_le_vec"
-     ;;
-   mips*el-*-linux*)
-     targ_defvec=mips_elf32_trad_le_vec
---- a/ld/configure.tgt
-+++ b/ld/configure.tgt
-@@ -543,12 +543,12 @@ mips*-*-vxworks*)	targ_emul=elf32ebmipvx
- 			;;
- mips*-*-windiss)	targ_emul=elf32mipswindiss
- 			;;
--mips64*el-*-linux-*)	targ_emul=elf32ltsmipn32
--			targ_extra_emuls="elf32btsmipn32 elf32ltsmip elf32btsmip elf64ltsmip elf64btsmip"
-+mips64*el-*-linux-*)	targ_emul=elf64ltsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32ltsmip elf32btsmip elf64btsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
--mips64*-*-linux-*)	targ_emul=elf32btsmipn32
--			targ_extra_emuls="elf32ltsmipn32 elf32btsmip elf32ltsmip elf64btsmip elf64ltsmip"
-+mips64*-*-linux-*)	targ_emul=elf64btsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32btsmip elf32ltsmip elf64ltsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
- mips*el-*-linux-*)	targ_emul=elf32ltsmip
diff --git a/toolchain/binutils/patches/2.39/005-ld-fix-NEWS-typos.patch b/toolchain/binutils/patches/2.39/005-ld-fix-NEWS-typos.patch
deleted file mode 100644
index 39c61d93..00000000
--- a/toolchain/binutils/patches/2.39/005-ld-fix-NEWS-typos.patch
+++ /dev/null
@@ -1,27 +0,0 @@
-From 9284b63ea39cecbfc1522d9e143ecb7727d77eb5 Mon Sep 17 00:00:00 2001
-From: Martin Liska <mliska@suse.cz>
-Date: Mon, 8 Aug 2022 13:22:26 +0200
-Subject: [PATCH 005/160] ld: fix NEWS typos
-
-ld/ChangeLog:
-
-	* NEWS: Fix 2 typos.
----
- ld/NEWS | 4 ++--
- 1 file changed, 2 insertions(+), 2 deletions(-)
-
---- a/ld/NEWS
-+++ b/ld/NEWS
-@@ -27,10 +27,10 @@ Changes in 2.39:
-   --enable-warn-rwx-segments=no
-      will make --no-warn-rwx-segments enabled by default.
-      
--  --enable-defaul-execstack=no
-+  --enable-default-execstack=no
-      will stop the creation of an executable stack simply because an input file
-      is missing a .note.GNU-stack section, even on architectures where this
--     ehaviour is the default.
-+     behaviour is the default.
- 
- * TYPE=<type> is now supported in an output section description to set the
-   section type value.
diff --git a/toolchain/binutils/patches/2.39/008-gas-Dwarf-properly-skip-zero-size-functions.patch b/toolchain/binutils/patches/2.39/008-gas-Dwarf-properly-skip-zero-size-functions.patch
deleted file mode 100644
index 055da841..00000000
--- a/toolchain/binutils/patches/2.39/008-gas-Dwarf-properly-skip-zero-size-functions.patch
+++ /dev/null
@@ -1,90 +0,0 @@
-From e8cf73215187b0c08679d726a5cc7c019fa3ea2e Mon Sep 17 00:00:00 2001
-From: Jan Beulich <jbeulich@suse.com>
-Date: Wed, 10 Aug 2022 10:34:22 +0200
-Subject: [PATCH 008/160] gas/Dwarf: properly skip zero-size functions
-
-PR gas/29451
-
-While out_debug_abbrev() properly skips such functions, out_debug_info()
-mistakenly didn't. It needs to calculate the high_pc expression ahead of
-time, in order to skip emitting any data for the function if the value
-is zero.
-
-The one case which would still leave a zero-size entry is when
-symbol_get_obj(symp)->size ends up evaluating to zero. I hope we can
-expect that to not be the case, otherwise we'd need to have a way to
-post-process .debug_info contents between resolving expressions and
-actually writing the data out to the file. Even then it wouldn't be
-entirely obvious in which way to alter the data.
-
-(cherry picked from commit d7abcbcea5ddd40a3bf28758b62f35933c59f996)
----
- gas/dwarf2dbg.c | 39 ++++++++++++++++++++-------------------
- 1 file changed, 20 insertions(+), 19 deletions(-)
-
---- a/gas/dwarf2dbg.c
-+++ b/gas/dwarf2dbg.c
-@@ -2882,6 +2882,7 @@ out_debug_info (segT info_seg, segT abbr
- 	{
- 	  const char *name;
- 	  size_t len;
-+	  expressionS size = { .X_op = O_constant };
- 
- 	  /* Skip warning constructs (see above).  */
- 	  if (symbol_get_bfdsym (symp)->flags & BSF_WARNING)
-@@ -2895,6 +2896,18 @@ out_debug_info (segT info_seg, segT abbr
- 	  if (!S_IS_DEFINED (symp) || !S_IS_FUNCTION (symp))
- 	    continue;
- 
-+#if defined (OBJ_ELF) /* || defined (OBJ_MAYBE_ELF) */
-+	  size.X_add_number = S_GET_SIZE (symp);
-+	  if (size.X_add_number == 0 && IS_ELF
-+	      && symbol_get_obj (symp)->size != NULL)
-+	    {
-+	      size.X_op = O_add;
-+	      size.X_op_symbol = make_expr_symbol (symbol_get_obj (symp)->size);
-+	    }
-+#endif
-+	  if (size.X_op == O_constant && size.X_add_number == 0)
-+	    continue;
-+
- 	  subseg_set (str_seg, 0);
- 	  name_sym = symbol_temp_new_now_octets ();
- 	  name = S_GET_NAME (symp);
-@@ -2920,29 +2933,17 @@ out_debug_info (segT info_seg, segT abbr
- 	  emit_expr (&exp, sizeof_address);
- 
- 	  /* DW_AT_high_pc */
--	  exp.X_op = O_constant;
--#if defined (OBJ_ELF) /* || defined (OBJ_MAYBE_ELF) */
--	  exp.X_add_number = S_GET_SIZE (symp);
--	  if (exp.X_add_number == 0 && IS_ELF
--	      && symbol_get_obj (symp)->size != NULL)
--	    {
--	      exp.X_op = O_add;
--	      exp.X_op_symbol = make_expr_symbol (symbol_get_obj (symp)->size);
--	    }
--#else
--	  exp.X_add_number = 0;
--#endif
- 	  if (DWARF2_VERSION < 4)
- 	    {
--	      if (exp.X_op == O_constant)
--		exp.X_op = O_symbol;
--	      exp.X_add_symbol = symp;
--	      emit_expr (&exp, sizeof_address);
-+	      if (size.X_op == O_constant)
-+		size.X_op = O_symbol;
-+	      size.X_add_symbol = symp;
-+	      emit_expr (&size, sizeof_address);
- 	    }
--	  else if (exp.X_op == O_constant)
--	    out_uleb128 (exp.X_add_number);
-+	  else if (size.X_op == O_constant)
-+	    out_uleb128 (size.X_add_number);
- 	  else
--	    emit_leb128_expr (symbol_get_value_expression (exp.X_op_symbol), 0);
-+	    emit_leb128_expr (symbol_get_value_expression (size.X_op_symbol), 0);
- 	}
- 
-       /* End of children.  */
diff --git a/toolchain/binutils/patches/2.39/009-PR29462-internal-error-in-relocate-at-powerpc.cc-107.patch b/toolchain/binutils/patches/2.39/009-PR29462-internal-error-in-relocate-at-powerpc.cc-107.patch
deleted file mode 100644
index e325d3bc..00000000
--- a/toolchain/binutils/patches/2.39/009-PR29462-internal-error-in-relocate-at-powerpc.cc-107.patch
+++ /dev/null
@@ -1,270 +0,0 @@
-From e3b5d935247084dca057dea72be61b063fe2357a Mon Sep 17 00:00:00 2001
-From: Alan Modra <amodra@gmail.com>
-Date: Wed, 10 Aug 2022 10:38:52 +0930
-Subject: [PATCH 009/160] PR29462, internal error in relocate, at
- powerpc.cc:10796
-
-Prior to the inline plt call support (commit 08be322439), the only
-local syms with plt entries were local ifunc symbols.  There shouldn't
-be stubs for other local symbols so don't look for them.  The patch
-also fixes minor bugs in get_reference_flags; Many relocs are valid
-only for ppc64 and a couple only for ppc32.
-
-	PR 29462
-	* powerpc.cc (Target_powerpc::Relocate::relocate): Rename
-	use_plt_offset to pltcal_to_direct, invert logic.  For relocs
-	not used with inline plt sequences against local symbols, only
-	look for stubs when the symbol is an ifunc.
-	(Target_powerpc::Scan::get_reference_flags): Correct reloc
-	handling for relocs not valid for both 32-bit and 64-bit.
-
-(cherry picked from commit 6158b25f77db11712b84e6a4609898f2615ac749)
----
- gold/powerpc.cc | 129 ++++++++++++++++++++++++++++--------------------
- 1 file changed, 75 insertions(+), 54 deletions(-)
-
---- a/gold/powerpc.cc
-+++ b/gold/powerpc.cc
-@@ -7675,22 +7675,18 @@ Target_powerpc<size, big_endian>::Scan::
- 
-   switch (r_type)
-     {
-+    case elfcpp::R_PPC64_TOC:
-+      if (size != 64)
-+	break;
-+      // Fall through.
-     case elfcpp::R_POWERPC_NONE:
-     case elfcpp::R_POWERPC_GNU_VTINHERIT:
-     case elfcpp::R_POWERPC_GNU_VTENTRY:
--    case elfcpp::R_PPC64_TOC:
-       // No symbol reference.
-       break;
- 
-     case elfcpp::R_PPC64_ADDR64:
-     case elfcpp::R_PPC64_UADDR64:
--    case elfcpp::R_POWERPC_ADDR32:
--    case elfcpp::R_POWERPC_UADDR32:
--    case elfcpp::R_POWERPC_ADDR16:
--    case elfcpp::R_POWERPC_UADDR16:
--    case elfcpp::R_POWERPC_ADDR16_LO:
--    case elfcpp::R_POWERPC_ADDR16_HI:
--    case elfcpp::R_POWERPC_ADDR16_HA:
-     case elfcpp::R_PPC64_ADDR16_HIGHER34:
-     case elfcpp::R_PPC64_ADDR16_HIGHERA34:
-     case elfcpp::R_PPC64_ADDR16_HIGHEST34:
-@@ -7700,6 +7696,16 @@ Target_powerpc<size, big_endian>::Scan::
-     case elfcpp::R_PPC64_D34_HI30:
-     case elfcpp::R_PPC64_D34_HA30:
-     case elfcpp::R_PPC64_D28:
-+      if (size != 64)
-+	break;
-+      // Fall through.
-+    case elfcpp::R_POWERPC_ADDR32:
-+    case elfcpp::R_POWERPC_UADDR32:
-+    case elfcpp::R_POWERPC_ADDR16:
-+    case elfcpp::R_POWERPC_UADDR16:
-+    case elfcpp::R_POWERPC_ADDR16_LO:
-+    case elfcpp::R_POWERPC_ADDR16_HI:
-+    case elfcpp::R_POWERPC_ADDR16_HA:
-       ref = Symbol::ABSOLUTE_REF;
-       break;
- 
-@@ -7710,13 +7716,14 @@ Target_powerpc<size, big_endian>::Scan::
-       ref = Symbol::FUNCTION_CALL | Symbol::ABSOLUTE_REF;
-       break;
- 
--    case elfcpp::R_PPC64_REL64:
--    case elfcpp::R_POWERPC_REL32:
-     case elfcpp::R_PPC_LOCAL24PC:
--    case elfcpp::R_POWERPC_REL16:
--    case elfcpp::R_POWERPC_REL16_LO:
--    case elfcpp::R_POWERPC_REL16_HI:
--    case elfcpp::R_POWERPC_REL16_HA:
-+      if (size != 32)
-+	break;
-+      // Fall through.
-+      ref = Symbol::RELATIVE_REF;
-+      break;
-+
-+    case elfcpp::R_PPC64_REL64:
-     case elfcpp::R_PPC64_REL16_HIGH:
-     case elfcpp::R_PPC64_REL16_HIGHA:
-     case elfcpp::R_PPC64_REL16_HIGHER:
-@@ -7729,36 +7736,45 @@ Target_powerpc<size, big_endian>::Scan::
-     case elfcpp::R_PPC64_REL16_HIGHEST34:
-     case elfcpp::R_PPC64_REL16_HIGHESTA34:
-     case elfcpp::R_PPC64_PCREL28:
-+      if (size != 64)
-+	break;
-+      // Fall through.
-+    case elfcpp::R_POWERPC_REL32:
-+    case elfcpp::R_POWERPC_REL16:
-+    case elfcpp::R_POWERPC_REL16_LO:
-+    case elfcpp::R_POWERPC_REL16_HI:
-+    case elfcpp::R_POWERPC_REL16_HA:
-       ref = Symbol::RELATIVE_REF;
-       break;
- 
-+    case elfcpp::R_PPC_PLTREL24:
-+      if (size != 32)
-+	break;
-+      ref = Symbol::FUNCTION_CALL | Symbol::RELATIVE_REF;
-+      break;
-+
-     case elfcpp::R_PPC64_REL24_NOTOC:
--      if (size == 32)
-+    case elfcpp::R_PPC64_REL24_P9NOTOC:
-+    case elfcpp::R_PPC64_PLT16_LO_DS:
-+    case elfcpp::R_PPC64_PLTSEQ_NOTOC:
-+    case elfcpp::R_PPC64_PLTCALL_NOTOC:
-+    case elfcpp::R_PPC64_PLT_PCREL34:
-+    case elfcpp::R_PPC64_PLT_PCREL34_NOTOC:
-+      if (size != 64)
- 	break;
-       // Fall through.
--    case elfcpp::R_PPC64_REL24_P9NOTOC:
-     case elfcpp::R_POWERPC_REL24:
--    case elfcpp::R_PPC_PLTREL24:
-     case elfcpp::R_POWERPC_REL14:
-     case elfcpp::R_POWERPC_REL14_BRTAKEN:
-     case elfcpp::R_POWERPC_REL14_BRNTAKEN:
-     case elfcpp::R_POWERPC_PLT16_LO:
-     case elfcpp::R_POWERPC_PLT16_HI:
-     case elfcpp::R_POWERPC_PLT16_HA:
--    case elfcpp::R_PPC64_PLT16_LO_DS:
-     case elfcpp::R_POWERPC_PLTSEQ:
--    case elfcpp::R_PPC64_PLTSEQ_NOTOC:
-     case elfcpp::R_POWERPC_PLTCALL:
--    case elfcpp::R_PPC64_PLTCALL_NOTOC:
--    case elfcpp::R_PPC64_PLT_PCREL34:
--    case elfcpp::R_PPC64_PLT_PCREL34_NOTOC:
-       ref = Symbol::FUNCTION_CALL | Symbol::RELATIVE_REF;
-       break;
- 
--    case elfcpp::R_POWERPC_GOT16:
--    case elfcpp::R_POWERPC_GOT16_LO:
--    case elfcpp::R_POWERPC_GOT16_HI:
--    case elfcpp::R_POWERPC_GOT16_HA:
-     case elfcpp::R_PPC64_GOT16_DS:
-     case elfcpp::R_PPC64_GOT16_LO_DS:
-     case elfcpp::R_PPC64_GOT_PCREL34:
-@@ -7768,11 +7784,16 @@ Target_powerpc<size, big_endian>::Scan::
-     case elfcpp::R_PPC64_TOC16_HA:
-     case elfcpp::R_PPC64_TOC16_DS:
-     case elfcpp::R_PPC64_TOC16_LO_DS:
-+      if (size != 64)
-+	break;
-+      // Fall through.
-+    case elfcpp::R_POWERPC_GOT16:
-+    case elfcpp::R_POWERPC_GOT16_LO:
-+    case elfcpp::R_POWERPC_GOT16_HI:
-+    case elfcpp::R_POWERPC_GOT16_HA:
-       ref = Symbol::RELATIVE_REF;
-       break;
- 
--    case elfcpp::R_POWERPC_GOT_TPREL16:
--    case elfcpp::R_POWERPC_TLS:
-     case elfcpp::R_PPC64_TLSGD:
-     case elfcpp::R_PPC64_TLSLD:
-     case elfcpp::R_PPC64_TPREL34:
-@@ -7781,6 +7802,11 @@ Target_powerpc<size, big_endian>::Scan::
-     case elfcpp::R_PPC64_GOT_TLSLD_PCREL34:
-     case elfcpp::R_PPC64_GOT_TPREL_PCREL34:
-     case elfcpp::R_PPC64_GOT_DTPREL_PCREL34:
-+      if (size != 64)
-+	break;
-+      // Fall through.
-+    case elfcpp::R_POWERPC_GOT_TPREL16:
-+    case elfcpp::R_POWERPC_TLS:
-       ref = Symbol::TLS_REF;
-       break;
- 
-@@ -10671,10 +10697,8 @@ Target_powerpc<size, big_endian>::Reloca
-   bool has_stub_value = false;
-   bool localentry0 = false;
-   unsigned int r_sym = elfcpp::elf_r_sym<size>(rela.get_r_info());
--  bool use_plt_offset
--    = (gsym != NULL
--       ? gsym->use_plt_offset(Scan::get_reference_flags(r_type, target))
--       : object->local_has_plt_offset(r_sym));
-+  bool pltcall_to_direct = false;
-+
-   if (is_plt16_reloc<size>(r_type)
-       || r_type == elfcpp::R_PPC64_PLT_PCREL34
-       || r_type == elfcpp::R_PPC64_PLT_PCREL34_NOTOC
-@@ -10688,21 +10712,18 @@ Target_powerpc<size, big_endian>::Reloca
-       // that the decision depends on the PLTCALL reloc, and we don't
-       // know the address of that instruction when processing others
-       // in the sequence.  So the decision needs to be made in
--      // do_relax().  For now, don't optimise inline plt calls.
--      if (gsym)
--	use_plt_offset = gsym->has_plt_offset();
--    }
--  if (use_plt_offset
--      && !is_got_reloc(r_type)
--      && !is_plt16_reloc<size>(r_type)
--      && r_type != elfcpp::R_PPC64_PLT_PCREL34
--      && r_type != elfcpp::R_PPC64_PLT_PCREL34_NOTOC
--      && r_type != elfcpp::R_POWERPC_PLTSEQ
--      && r_type != elfcpp::R_POWERPC_PLTCALL
--      && r_type != elfcpp::R_PPC64_PLTSEQ_NOTOC
--      && r_type != elfcpp::R_PPC64_PLTCALL_NOTOC
--      && (!psymval->is_ifunc_symbol()
--	  || Scan::reloc_needs_plt_for_ifunc(target, object, r_type, false)))
-+      // do_relax().
-+      pltcall_to_direct = !(gsym != NULL
-+			    ? gsym->has_plt_offset()
-+			    : object->local_has_plt_offset(r_sym));
-+    }
-+  else if ((gsym != NULL
-+	    ? gsym->use_plt_offset(Scan::get_reference_flags(r_type, target))
-+	    : psymval->is_ifunc_symbol() && object->local_has_plt_offset(r_sym))
-+	   && !is_got_reloc(r_type)
-+	   && (!psymval->is_ifunc_symbol()
-+	       || Scan::reloc_needs_plt_for_ifunc(target, object, r_type,
-+						  false)))
-     {
-       if (size == 64
- 	  && gsym != NULL
-@@ -10796,9 +10817,9 @@ Target_powerpc<size, big_endian>::Reloca
-       gold_assert(has_stub_value || !(os->flags() & elfcpp::SHF_ALLOC));
-     }
- 
--  if (use_plt_offset && (is_plt16_reloc<size>(r_type)
--			 || r_type == elfcpp::R_PPC64_PLT_PCREL34
--			 || r_type == elfcpp::R_PPC64_PLT_PCREL34_NOTOC))
-+  if (!pltcall_to_direct && (is_plt16_reloc<size>(r_type)
-+			     || r_type == elfcpp::R_PPC64_PLT_PCREL34
-+			     || r_type == elfcpp::R_PPC64_PLT_PCREL34_NOTOC))
-     {
-       const Output_data_plt_powerpc<size, big_endian>* plt;
-       if (gsym)
-@@ -10826,7 +10847,7 @@ Target_powerpc<size, big_endian>::Reloca
- 	    value -= target->toc_pointer();
- 	}
-     }
--  else if (!use_plt_offset
-+  else if (pltcall_to_direct
- 	   && (is_plt16_reloc<size>(r_type)
- 	       || r_type == elfcpp::R_POWERPC_PLTSEQ
- 	       || r_type == elfcpp::R_PPC64_PLTSEQ_NOTOC))
-@@ -10835,7 +10856,7 @@ Target_powerpc<size, big_endian>::Reloca
-       elfcpp::Swap<32, big_endian>::writeval(iview, nop);
-       r_type = elfcpp::R_POWERPC_NONE;
-     }
--  else if (!use_plt_offset
-+  else if (pltcall_to_direct
- 	   && (r_type == elfcpp::R_PPC64_PLT_PCREL34
- 	       || r_type == elfcpp::R_PPC64_PLT_PCREL34_NOTOC))
-     {
-@@ -11316,8 +11337,8 @@ Target_powerpc<size, big_endian>::Reloca
-     }
-   else if (!has_stub_value)
-     {
--      if (!use_plt_offset && (r_type == elfcpp::R_POWERPC_PLTCALL
--			      || r_type == elfcpp::R_PPC64_PLTCALL_NOTOC))
-+      if (pltcall_to_direct && (r_type == elfcpp::R_POWERPC_PLTCALL
-+				|| r_type == elfcpp::R_PPC64_PLTCALL_NOTOC))
- 	{
- 	  // PLTCALL without plt entry => convert to direct call
- 	  Insn* iview = reinterpret_cast<Insn*>(view);
diff --git a/toolchain/binutils/patches/2.39/011-PR29466-APP-NO_APP-with-.linefile.patch b/toolchain/binutils/patches/2.39/011-PR29466-APP-NO_APP-with-.linefile.patch
deleted file mode 100644
index f7b58199..00000000
--- a/toolchain/binutils/patches/2.39/011-PR29466-APP-NO_APP-with-.linefile.patch
+++ /dev/null
@@ -1,167 +0,0 @@
-From 9e855cffa1fda44629e7f9b76dfa3e5a51a440e9 Mon Sep 17 00:00:00 2001
-From: Alan Modra <amodra@gmail.com>
-Date: Thu, 11 Aug 2022 09:51:03 +0930
-Subject: [PATCH 011/160] PR29466, APP/NO_APP with .linefile
-
-Commit 53f2b36a54b9 exposed a bug in sb_scrub_and_add_sb that could
-result in losing input.  If scrubbing results in expansion past the
-holding capacity of do_scrub_chars output buffer, then do_scrub_chars
-stashes the extra input for the next call.  That call never came
-because sb_scrub_and_add_sb wrongly decided it was done.  Fix that by
-allowing sb_scrub_and_add_sb to see whether there is pending input.
-Also allow a little extra space so that in most cases we won't need
-to resize the output buffer.
-
-sb_scrub_and_add_sb also limited output to the size of the input,
-rather than the actual output buffer size.  Fixing that resulted in a
-fail of gas/testsuite/macros/dot with an extra warning: "end of file
-not at end of a line; newline inserted".  OK, so the macro in dot.s
-really does finish without end-of-line.  Apparently the macro
-expansion code relied on do_scrub_chars returning early.  So fix that
-too by adding a newline if needed in macro_expand_body.
-
-	PR 29466
-	* app.c (do_scrub_pending): New function.
-	* as.h: Declare it.
-	* input-scrub.c (input_scrub_include_sb): Add extra space for
-	two .linefile directives.
-	* sb.c (sb_scrub_and_add_sb): Take into account pending input.
-	Allow output to max.
-	* macro.c (macro_expand_body): Add terminating newline.
-	* testsuite/config/default.exp (SIZE, SIZEFLAGS): Define.
-	* testsuite/gas/macros/app5.d,
-	* testsuite/gas/macros/app5.s: New test.
-	* testsuite/gas/macros/macros.exp: Run it.
-
-(cherry picked from commit 4d74aab7aa562fe79d4669cdad0c32610531cbc0)
----
- gas/app.c                           | 13 +++++++++++++
- gas/as.h                            |  1 +
- gas/input-scrub.c                   |  6 ++++--
- gas/macro.c                         |  2 ++
- gas/sb.c                            |  5 +++--
- gas/testsuite/config/default.exp    |  8 ++++++++
- gas/testsuite/gas/macros/app5.d     |  6 ++++++
- gas/testsuite/gas/macros/app5.s     |  5 +++++
- gas/testsuite/gas/macros/macros.exp |  1 +
- 9 files changed, 43 insertions(+), 4 deletions(-)
- create mode 100644 gas/testsuite/gas/macros/app5.d
- create mode 100644 gas/testsuite/gas/macros/app5.s
-
---- a/gas/app.c
-+++ b/gas/app.c
-@@ -1537,3 +1537,16 @@ do_scrub_chars (size_t (*get) (char *, s
-     last_char = to[-1];
-   return to - tostart;
- }
-+
-+/* Return amount of pending input.  */
-+
-+size_t
-+do_scrub_pending (void)
-+{
-+  size_t len = 0;
-+  if (saved_input)
-+    len += saved_input_len;
-+  if (state == -1)
-+    len += strlen (out_string);
-+  return len;
-+}
---- a/gas/as.h
-+++ b/gas/as.h
-@@ -460,6 +460,7 @@ void   input_scrub_insert_file (char *);
- char * input_scrub_new_file (const char *);
- char * input_scrub_next_buffer (char **bufp);
- size_t do_scrub_chars (size_t (*get) (char *, size_t), char *, size_t);
-+size_t do_scrub_pending (void);
- bool   scan_for_multibyte_characters (const unsigned char *, const unsigned char *, bool);
- int    gen_to_words (LITTLENUM_TYPE *, int, long);
- int    had_err (void);
---- a/gas/input-scrub.c
-+++ b/gas/input-scrub.c
-@@ -278,9 +278,11 @@ input_scrub_include_sb (sb *from, char *
- 
-   next_saved_file = input_scrub_push (position);
- 
--  /* Allocate sufficient space: from->len + optional newline.  */
-+  /* Allocate sufficient space: from->len plus optional newline
-+     plus two ".linefile " directives, plus a little more for other
-+     expansion.  */
-   newline = from->len >= 1 && from->ptr[0] != '\n';
--  sb_build (&from_sb, from->len + newline);
-+  sb_build (&from_sb, from->len + newline + 2 * sizeof (".linefile") + 30);
-   if (expansion == expanding_repeat && from_sb_expansion >= expanding_macro)
-     expansion = expanding_nested;
-   from_sb_expansion = expansion;
---- a/gas/macro.c
-+++ b/gas/macro.c
-@@ -1056,6 +1056,8 @@ macro_expand_body (sb *in, sb *out, form
-       loclist = f;
-     }
- 
-+  if (!err && (out->len == 0 || out->ptr[out->len - 1] != '\n'))
-+    sb_add_char (out, '\n');
-   return err;
- }
- 
---- a/gas/sb.c
-+++ b/gas/sb.c
-@@ -119,11 +119,12 @@ sb_scrub_and_add_sb (sb *ptr, sb *s)
-      So we loop until the input S is consumed.  */
-   while (1)
-     {
--      size_t copy = s->len - (scrub_position - s->ptr);
-+      size_t copy = s->len - (scrub_position - s->ptr) + do_scrub_pending ();
-       if (copy == 0)
- 	break;
-       sb_check (ptr, copy);
--      ptr->len += do_scrub_chars (scrub_from_sb, ptr->ptr + ptr->len, copy);
-+      ptr->len += do_scrub_chars (scrub_from_sb, ptr->ptr + ptr->len,
-+				  ptr->max - ptr->len);
-     }
- 
-   sb_to_scrub = 0;
---- a/gas/testsuite/config/default.exp
-+++ b/gas/testsuite/config/default.exp
-@@ -52,6 +52,14 @@ if ![info exists NMFLAGS] then {
-     set NMFLAGS {}
- }
- 
-+if ![info exists SIZE] then {
-+    set SIZE [findfile $base_dir/size]
-+}
-+
-+if ![info exists SIZEFLAGS] then {
-+    set SIZEFLAGS ""
-+}
-+
- if ![info exists OBJCOPY] then {
-     set OBJCOPY [findfile $base_dir/../../binutils/objcopy]
- }
---- /dev/null
-+++ b/gas/testsuite/gas/macros/app5.d
-@@ -0,0 +1,6 @@
-+#name: APP with linefile
-+#xfail: tic30-*-*
-+#size: -G
-+# pr29466 just check that the test assembles
-+
-+#pass
---- /dev/null
-+++ b/gas/testsuite/gas/macros/app5.s
-@@ -0,0 +1,5 @@
-+#NO_APP
-+#APP
-+# 5 "foo.c" 1
-+# 0 "" 2
-+#NO_APP
---- a/gas/testsuite/gas/macros/macros.exp
-+++ b/gas/testsuite/gas/macros/macros.exp
-@@ -70,6 +70,7 @@ run_dump_test app2
- run_dump_test app3
- remote_download host "$srcdir/$subdir/app4b.s"
- run_dump_test app4
-+run_dump_test app5
- 
- run_list_test badarg ""
- 
diff --git a/toolchain/binutils/patches/2.39/039-LoongArch-ld-Fix-relocation-error-of-pcrel.patch b/toolchain/binutils/patches/2.39/039-LoongArch-ld-Fix-relocation-error-of-pcrel.patch
deleted file mode 100644
index 67e499de..00000000
--- a/toolchain/binutils/patches/2.39/039-LoongArch-ld-Fix-relocation-error-of-pcrel.patch
+++ /dev/null
@@ -1,128 +0,0 @@
-From 509a2ec6ad3ea7eb3f4cf59538cf636a2126e4c3 Mon Sep 17 00:00:00 2001
-From: liuzhensong <liuzhensong@loongson.cn>
-Date: Fri, 2 Sep 2022 16:29:14 +0800
-Subject: [PATCH 039/160] LoongArch:ld: Fix relocation error of pcrel.
-
-  Patch for branch 2.39.
-  Need to reduce the address of pc when using
-  reloction R_LARCH_SOP_PUSH_PCREL.
-
-  bfd/
-    * elfnn-loongarch.c
----
- bfd/elfnn-loongarch.c                         |  3 +-
- ld/testsuite/ld-loongarch-elf/pcrel-const.d   | 14 +++++++
- ld/testsuite/ld-loongarch-elf/pcrel-const.lds | 14 +++++++
- ld/testsuite/ld-loongarch-elf/pcrel-const.s   | 12 ++++++
- ld/testsuite/ld-loongarch-elf/pr.exp          | 39 +++++++++++++++++++
- 5 files changed, 81 insertions(+), 1 deletion(-)
- create mode 100644 ld/testsuite/ld-loongarch-elf/pcrel-const.d
- create mode 100644 ld/testsuite/ld-loongarch-elf/pcrel-const.lds
- create mode 100644 ld/testsuite/ld-loongarch-elf/pcrel-const.s
- create mode 100644 ld/testsuite/ld-loongarch-elf/pr.exp
-
---- a/bfd/elfnn-loongarch.c
-+++ b/bfd/elfnn-loongarch.c
-@@ -2341,9 +2341,10 @@ loongarch_elf_relocate_section (bfd *out
- 	case R_LARCH_SOP_PUSH_PLT_PCREL:
- 	  unresolved_reloc = false;
- 
--	  if (resolved_to_const)
-+	  if (!is_undefweak && resolved_to_const)
- 	    {
- 	      relocation += rel->r_addend;
-+	      relocation -= pc;
- 	      break;
- 	    }
- 	  else if (is_undefweak)
---- /dev/null
-+++ b/ld/testsuite/ld-loongarch-elf/pcrel-const.d
-@@ -0,0 +1,14 @@
-+#as: -mla-global-with-pcrel
-+#objdump: -Drsz
-+
-+.*:[    ]+file format .*
-+
-+
-+Disassembly of section .text:
-+
-+.* <foo>:
-+#...
-+[ 	]+8:[ 	]+02c04084[ 	]+addi.d[ 	]+\$a0,[ 	]+\$a0,[ 	]+16\(0x10\)
-+#...
-+0+14 <__sec_end>:
-+#pass
---- /dev/null
-+++ b/ld/testsuite/ld-loongarch-elf/pcrel-const.lds
-@@ -0,0 +1,14 @@
-+ENTRY(foo);
-+SECTIONS
-+{
-+	.text : {
-+		*(.text*)
-+	}
-+
-+	.data : {
-+		__sec_start = .;
-+		*(.gzdata)
-+		__sec_end = .;
-+	}
-+}
-+PROVIDE(__sec_size = __sec_end);
---- /dev/null
-+++ b/ld/testsuite/ld-loongarch-elf/pcrel-const.s
-@@ -0,0 +1,12 @@
-+	.text
-+	.align	2
-+	.globl	foo
-+	.type	foo, @function
-+foo:
-+	nop
-+	la.global	$r4,__sec_size
-+	ldptr.w	$r4,$r4,0
-+	jr	$r1
-+	.size	foo, .-foo
-+	.data
-+	.word 1
---- /dev/null
-+++ b/ld/testsuite/ld-loongarch-elf/pr.exp
-@@ -0,0 +1,39 @@
-+# Expect script for LoongArch ELF linker tests
-+#   Copyright (C) 2022 Free Software Foundation, Inc.
-+#
-+# This file is part of the GNU Binutils.
-+#
-+# This program is free software; you can redistribute it and/or modify
-+# it under the terms of the GNU General Public License as published by
-+# the Free Software Foundation; either version 3 of the License, or
-+# (at your option) any later version.
-+#
-+# This program is distributed in the hope that it will be useful,
-+# but WITHOUT ANY WARRANTY; without even the implied warranty of
-+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-+# GNU General Public License for more details.
-+#
-+# You should have received a copy of the GNU General Public License
-+# along with this program; if not, write to the Free Software
-+# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,
-+# MA 02110-1301, USA.
-+#
-+
-+if ![istarget loongarch64-*-*] {
-+  return
-+}
-+
-+set link_tests [list \
-+  [list \
-+    "pcrel const" \
-+    "-T pcrel-const.lds" "" \
-+    "-mla-global-with-pcrel" \
-+    { pcrel-const.s } \
-+    [list \
-+      [list objdump -D pcrel-const.d] \
-+    ] \
-+    "pcrel-const" \
-+  ] \
-+]
-+
-+run_ld_link_tests $link_tests
diff --git a/toolchain/binutils/patches/2.39/043-Re-PR29466-APP-NO_APP-with-linefile.patch b/toolchain/binutils/patches/2.39/043-Re-PR29466-APP-NO_APP-with-linefile.patch
deleted file mode 100644
index 1de501a1..00000000
--- a/toolchain/binutils/patches/2.39/043-Re-PR29466-APP-NO_APP-with-linefile.patch
+++ /dev/null
@@ -1,27 +0,0 @@
-From 4233be14a34d754a70b8b6f6fa42d21f35c6e030 Mon Sep 17 00:00:00 2001
-From: Alan Modra <amodra@gmail.com>
-Date: Sat, 10 Sep 2022 07:30:57 +0930
-Subject: [PATCH 043/160] Re: PR29466, APP/NO_APP with linefile
-
-It looks like I copied the SIZE init across from
-binutils/testsuite/config/default.exp without some necessary editing.
-
-	PR 29466
-	* testsuite/config/default.exp (SIZE): Adjust relative path.
-
-(cherry picked from commit 1180f540d5f2f7751b5309bdd6c38d69fcf699e7)
----
- gas/testsuite/config/default.exp | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
---- a/gas/testsuite/config/default.exp
-+++ b/gas/testsuite/config/default.exp
-@@ -53,7 +53,7 @@ if ![info exists NMFLAGS] then {
- }
- 
- if ![info exists SIZE] then {
--    set SIZE [findfile $base_dir/size]
-+    set SIZE [findfile $base_dir/../../binutils/size]
- }
- 
- if ![info exists SIZEFLAGS] then {
diff --git a/toolchain/binutils/patches/2.39/050-PowerPC64-pcrel-got-relocs-against-local-symbols.patch b/toolchain/binutils/patches/2.39/050-PowerPC64-pcrel-got-relocs-against-local-symbols.patch
deleted file mode 100644
index 5c89f680..00000000
--- a/toolchain/binutils/patches/2.39/050-PowerPC64-pcrel-got-relocs-against-local-symbols.patch
+++ /dev/null
@@ -1,38 +0,0 @@
-From 4d7bba23a39fba18d6d13a2941a3c232011a7064 Mon Sep 17 00:00:00 2001
-From: Alan Modra <amodra@gmail.com>
-Date: Fri, 16 Sep 2022 18:08:44 +0930
-Subject: [PATCH 050/160] PowerPC64 pcrel got relocs against local symbols
-
-Not that anyone would want to indirect via the GOT when an address can
-be loaded directly with pla, the following:
-
- pld 3,x@got@pcrel
-x:
-
-leads to "Internal error in md_apply_fix", because the generic parts
-of assembler fixup handling convert the fx_pcrel fixup to one without
-a symbol.  Stop that happening.
-
-	* config/tc-ppc.c (ppc_force_relocation): Add PLT_PCREL34 and
-	assorted GOT_PCREL34 relocs.
-
-(cherry picked from commit 49c3ed081fed6b8e2b48fdc48f805f11e4589514)
----
- gas/config/tc-ppc.c | 6 ++++++
- 1 file changed, 6 insertions(+)
-
---- a/gas/config/tc-ppc.c
-+++ b/gas/config/tc-ppc.c
-@@ -6676,6 +6676,12 @@ ppc_force_relocation (fixS *fix)
-     case BFD_RELOC_PPC_BA16_BRNTAKEN:
-     case BFD_RELOC_24_PLT_PCREL:
-     case BFD_RELOC_PPC64_TOC:
-+    case BFD_RELOC_PPC64_PLT_PCREL34:
-+    case BFD_RELOC_PPC64_GOT_PCREL34:
-+    case BFD_RELOC_PPC64_GOT_TLSGD_PCREL34:
-+    case BFD_RELOC_PPC64_GOT_TLSLD_PCREL34:
-+    case BFD_RELOC_PPC64_GOT_TPREL_PCREL34:
-+    case BFD_RELOC_PPC64_GOT_DTPREL_PCREL34:
-       return 1;
-     case BFD_RELOC_PPC_B26:
-     case BFD_RELOC_PPC_BA26:
diff --git a/toolchain/binutils/patches/2.39/055-Re-PowerPC64-pcrel-got-relocs-against-local-symbols.patch b/toolchain/binutils/patches/2.39/055-Re-PowerPC64-pcrel-got-relocs-against-local-symbols.patch
deleted file mode 100644
index 19b80c34..00000000
--- a/toolchain/binutils/patches/2.39/055-Re-PowerPC64-pcrel-got-relocs-against-local-symbols.patch
+++ /dev/null
@@ -1,94 +0,0 @@
-From 010db38b54b589ca3e95b498aba2831064970171 Mon Sep 17 00:00:00 2001
-From: Alan Modra <amodra@gmail.com>
-Date: Wed, 21 Sep 2022 09:06:29 +0930
-Subject: [PATCH 055/160] Re: PowerPC64 pcrel got relocs against local symbols
-
-The last patch wasn't all that shiny.  There are rather a lot more
-relocations that can hit the assertion in md_apply_fix if the symbol
-is local or absolute.  Fix them all.
-
-	* config/tc-ppc.c (ppc_force_relocation): Add all relocs that
-	expect a symbol in md_apply_fix.  Remove tls pcrel relocs
-	already covered in general tls match range.
-
-(cherry picked from commit 8b168f1a1e09e337d2a970f204a0230c091bbe58)
----
- gas/config/tc-ppc.c | 58 ++++++++++++++++++++++++++++++++++++++++-----
- 1 file changed, 52 insertions(+), 6 deletions(-)
-
---- a/gas/config/tc-ppc.c
-+++ b/gas/config/tc-ppc.c
-@@ -6666,8 +6666,6 @@ ppc_force_relocation (fixS *fix)
- int
- ppc_force_relocation (fixS *fix)
- {
--  /* Branch prediction relocations must force a relocation, as must
--     the vtable description relocs.  */
-   switch (fix->fx_r_type)
-     {
-     case BFD_RELOC_PPC_B16_BRTAKEN:
-@@ -6676,12 +6674,60 @@ ppc_force_relocation (fixS *fix)
-     case BFD_RELOC_PPC_BA16_BRNTAKEN:
-     case BFD_RELOC_24_PLT_PCREL:
-     case BFD_RELOC_PPC64_TOC:
-+    case BFD_RELOC_16_GOTOFF:
-+    case BFD_RELOC_LO16_GOTOFF:
-+    case BFD_RELOC_HI16_GOTOFF:
-+    case BFD_RELOC_HI16_S_GOTOFF:
-+    case BFD_RELOC_LO16_PLTOFF:
-+    case BFD_RELOC_HI16_PLTOFF:
-+    case BFD_RELOC_HI16_S_PLTOFF:
-+    case BFD_RELOC_GPREL16:
-+    case BFD_RELOC_16_BASEREL:
-+    case BFD_RELOC_LO16_BASEREL:
-+    case BFD_RELOC_HI16_BASEREL:
-+    case BFD_RELOC_HI16_S_BASEREL:
-+    case BFD_RELOC_PPC_TOC16:
-+    case BFD_RELOC_PPC64_TOC16_LO:
-+    case BFD_RELOC_PPC64_TOC16_HI:
-+    case BFD_RELOC_PPC64_TOC16_HA:
-+    case BFD_RELOC_PPC64_PLTGOT16:
-+    case BFD_RELOC_PPC64_PLTGOT16_LO:
-+    case BFD_RELOC_PPC64_PLTGOT16_HI:
-+    case BFD_RELOC_PPC64_PLTGOT16_HA:
-+    case BFD_RELOC_PPC64_GOT16_DS:
-+    case BFD_RELOC_PPC64_GOT16_LO_DS:
-+    case BFD_RELOC_PPC64_PLT16_LO_DS:
-+    case BFD_RELOC_PPC64_SECTOFF_DS:
-+    case BFD_RELOC_PPC64_SECTOFF_LO_DS:
-+    case BFD_RELOC_PPC64_TOC16_DS:
-+    case BFD_RELOC_PPC64_TOC16_LO_DS:
-+    case BFD_RELOC_PPC64_PLTGOT16_DS:
-+    case BFD_RELOC_PPC64_PLTGOT16_LO_DS:
-+    case BFD_RELOC_PPC_EMB_NADDR16:
-+    case BFD_RELOC_PPC_EMB_NADDR16_LO:
-+    case BFD_RELOC_PPC_EMB_NADDR16_HI:
-+    case BFD_RELOC_PPC_EMB_NADDR16_HA:
-+    case BFD_RELOC_PPC_EMB_SDAI16:
-+    case BFD_RELOC_PPC_EMB_SDA2I16:
-+    case BFD_RELOC_PPC_EMB_SDA2REL:
-+    case BFD_RELOC_PPC_EMB_SDA21:
-+    case BFD_RELOC_PPC_EMB_MRKREF:
-+    case BFD_RELOC_PPC_EMB_RELSEC16:
-+    case BFD_RELOC_PPC_EMB_RELST_LO:
-+    case BFD_RELOC_PPC_EMB_RELST_HI:
-+    case BFD_RELOC_PPC_EMB_RELST_HA:
-+    case BFD_RELOC_PPC_EMB_BIT_FLD:
-+    case BFD_RELOC_PPC_EMB_RELSDA:
-+    case BFD_RELOC_PPC_VLE_SDA21:
-+    case BFD_RELOC_PPC_VLE_SDA21_LO:
-+    case BFD_RELOC_PPC_VLE_SDAREL_LO16A:
-+    case BFD_RELOC_PPC_VLE_SDAREL_LO16D:
-+    case BFD_RELOC_PPC_VLE_SDAREL_HI16A:
-+    case BFD_RELOC_PPC_VLE_SDAREL_HI16D:
-+    case BFD_RELOC_PPC_VLE_SDAREL_HA16A:
-+    case BFD_RELOC_PPC_VLE_SDAREL_HA16D:
-     case BFD_RELOC_PPC64_PLT_PCREL34:
-     case BFD_RELOC_PPC64_GOT_PCREL34:
--    case BFD_RELOC_PPC64_GOT_TLSGD_PCREL34:
--    case BFD_RELOC_PPC64_GOT_TLSLD_PCREL34:
--    case BFD_RELOC_PPC64_GOT_TPREL_PCREL34:
--    case BFD_RELOC_PPC64_GOT_DTPREL_PCREL34:
-       return 1;
-     case BFD_RELOC_PPC_B26:
-     case BFD_RELOC_PPC_BA26:
diff --git a/toolchain/binutils/patches/2.39/058-elf-Reset-alignment-for-each-PT_LOAD-segment.patch b/toolchain/binutils/patches/2.39/058-elf-Reset-alignment-for-each-PT_LOAD-segment.patch
deleted file mode 100644
index aaf7a1b0..00000000
--- a/toolchain/binutils/patches/2.39/058-elf-Reset-alignment-for-each-PT_LOAD-segment.patch
+++ /dev/null
@@ -1,89 +0,0 @@
-From a98316d5cf970cbc99689797d84c2ea832bcdcbb Mon Sep 17 00:00:00 2001
-From: "H.J. Lu" <hjl.tools@gmail.com>
-Date: Mon, 1 Aug 2022 16:02:39 -0700
-Subject: [PATCH 058/160] elf: Reset alignment for each PT_LOAD segment
-
-Reset alignment for each PT_LOAD segment to avoid using alignment from
-the previous PT_LOAD segment.
-
-bfd/
-
-	PR ld/29435
-	* elf.c (assign_file_positions_for_load_sections): Reset
-	alignment for each PT_LOAD segment.
-
-ld/
-
-	PR ld/29435
-	* testsuite/ld-elf/pr29435.d: New file.
-	* testsuite/ld-elf/pr29435.s: Likewise.
-
-(cherry picked from commit 59f214544c50ec7ebbca285ff2b4949f48671690)
----
- bfd/elf.c                     |  7 ++++---
- ld/testsuite/ld-elf/pr29435.d | 11 +++++++++++
- ld/testsuite/ld-elf/pr29435.s |  6 ++++++
- 3 files changed, 21 insertions(+), 3 deletions(-)
- create mode 100644 ld/testsuite/ld-elf/pr29435.d
- create mode 100644 ld/testsuite/ld-elf/pr29435.s
-
---- a/bfd/elf.c
-+++ b/bfd/elf.c
-@@ -5438,8 +5438,6 @@ assign_file_positions_for_load_sections
-   Elf_Internal_Phdr *p;
-   file_ptr off;  /* Octets.  */
-   bfd_size_type maxpagesize;
--  bfd_size_type p_align;
--  bool p_align_p = false;
-   unsigned int alloc, actual;
-   unsigned int i, j;
-   struct elf_segment_map **sorted_seg_map;
-@@ -5524,7 +5522,6 @@ assign_file_positions_for_load_sections
-     qsort (sorted_seg_map, alloc, sizeof (*sorted_seg_map),
- 	   elf_sort_segments);
- 
--  p_align = bed->p_align;
-   maxpagesize = 1;
-   if ((abfd->flags & D_PAGED) != 0)
-     {
-@@ -5559,6 +5556,8 @@ assign_file_positions_for_load_sections
-       asection **secpp;
-       bfd_vma off_adjust;  /* Octets.  */
-       bool no_contents;
-+      bfd_size_type p_align;
-+      bool p_align_p;
- 
-       /* An ELF segment (described by Elf_Internal_Phdr) may contain a
- 	 number of sections with contents contributing to both p_filesz
-@@ -5569,6 +5568,8 @@ assign_file_positions_for_load_sections
-       p = phdrs + m->idx;
-       p->p_type = m->p_type;
-       p->p_flags = m->p_flags;
-+      p_align = bed->p_align;
-+      p_align_p = false;
- 
-       if (m->count == 0)
- 	p->p_vaddr = m->p_vaddr_offset * opb;
---- /dev/null
-+++ b/ld/testsuite/ld-elf/pr29435.d
-@@ -0,0 +1,11 @@
-+#ld: -shared -z separate-code -z relro
-+#xfail: ![check_shared_lib_support]
-+#xfail: ![check_relro_support]
-+#readelf: -Wl
-+
-+#failif
-+#...
-+ +LOAD +0x[0-9a-f]+ 0x[0-9a-f]+ 0x[0-9a-f]+ 0x[0-9a-f]+ 0x[0-9a-f]+ .* 0x8000
-+#...
-+ +LOAD +0x[0-9a-f]+ 0x[0-9a-f]+ 0x[0-9a-f]+ 0x[0-9a-f]+ 0x[0-9a-f]+ .* 0x8000
-+#...
---- /dev/null
-+++ b/ld/testsuite/ld-elf/pr29435.s
-@@ -0,0 +1,6 @@
-+        .text
-+	.balign 0x8000
-+	.globl	foo
-+	.type	foo, %function
-+foo:
-+	.byte 0
diff --git a/toolchain/binutils/patches/2.39/063-PR29542-PowerPC-gold-internal-error-in-get_output_vi.patch b/toolchain/binutils/patches/2.39/063-PR29542-PowerPC-gold-internal-error-in-get_output_vi.patch
deleted file mode 100644
index 0d66b775..00000000
--- a/toolchain/binutils/patches/2.39/063-PR29542-PowerPC-gold-internal-error-in-get_output_vi.patch
+++ /dev/null
@@ -1,29 +0,0 @@
-From 041c22e35de06d22566f4c71e4425c3351215e66 Mon Sep 17 00:00:00 2001
-From: Alan Modra <amodra@gmail.com>
-Date: Sun, 25 Sep 2022 12:07:36 +0930
-Subject: [PATCH 063/160] PR29542, PowerPC gold internal error in
- get_output_view,
-
-We were attempting to set a BSS style section contents.
-
-	PR 29542
-	* powerpc.cc (Output_data_plt_powerpc::do_write): Don't set .plt,
-	.iplt or .lplt section contents when position independent.
-
-(cherry picked from commit c21736aed1d4877e090df60362413669dbdc391d)
----
- gold/powerpc.cc | 3 ++-
- 1 file changed, 2 insertions(+), 1 deletion(-)
-
---- a/gold/powerpc.cc
-+++ b/gold/powerpc.cc
-@@ -4338,7 +4338,8 @@ template<int size, bool big_endian>
- void
- Output_data_plt_powerpc<size, big_endian>::do_write(Output_file* of)
- {
--  if (!this->sym_ents_.empty())
-+  if (!this->sym_ents_.empty()
-+      && !parameters->options().output_is_position_independent())
-     {
-       const section_size_type offset = this->offset();
-       const section_size_type oview_size
diff --git a/toolchain/binutils/patches/2.39/116-arm-Use-DWARF-numbering-convention-for-pseudo-regist.patch b/toolchain/binutils/patches/2.39/116-arm-Use-DWARF-numbering-convention-for-pseudo-regist.patch
deleted file mode 100644
index 82a015ee..00000000
--- a/toolchain/binutils/patches/2.39/116-arm-Use-DWARF-numbering-convention-for-pseudo-regist.patch
+++ /dev/null
@@ -1,301 +0,0 @@
-From 88ac930a725b8aac8284a2738f03b843f4343dd0 Mon Sep 17 00:00:00 2001
-From: Victor Do Nascimento <Victor.DoNascimento@arm.com>
-Date: Thu, 17 Nov 2022 14:48:37 +0000
-Subject: [PATCH 116/160] arm: Use DWARF numbering convention for
- pseudo-register representation
-
-The patch, initially submitted to trunk in
-https://sourceware.org/pipermail/binutils/2022-July/122092.html ensures correct
-support for handling .save directives for mixed-register type lists involving
-the ra_auth_code pseudo-register, whereby the support first introduced in 2.39
-(https://sourceware.org/pipermail/binutils/2022-May/120672.html) led to the
-generation of unwinder code popping registers in reversed order.
-
-gas/Changelog:
-
-  * config/tc-arm.c (REG_RA_AUTH_CODE): New.
-  (parse_dot_save): Likewise.
-  (parse_reg_list): Remove obsolete code.
-  (reg_names): Set ra_auth_code to 143.
-  (s_arm_unwind_save): Handle core and pseudo-register lists via
-  parse_dot_save.
-  (s_arm_unwind_save_mixed): Deleted.
-  (s_arm_unwind_save_pseudo): Handle one register at a time.
-  * testsuite/gas/arm/unwind-pacbti-m-readelf.d: Fix test.
-  * testsuite/gas/arm/unwind-pacbti-m.d: Likewise.
-
-(cherry picked from commit 3a368c4c248f6e9f4bda3a5369befa17a4560293)
----
- gas/config/tc-arm.c                           | 159 ++++++++++--------
- .../gas/arm/unwind-pacbti-m-readelf.d         |   4 +-
- gas/testsuite/gas/arm/unwind-pacbti-m.d       |   2 +-
- 3 files changed, 95 insertions(+), 70 deletions(-)
-
---- a/gas/config/tc-arm.c
-+++ b/gas/config/tc-arm.c
-@@ -742,6 +742,7 @@ const char * const reg_expected_msgs[] =
- #define REG_SP	13
- #define REG_LR	14
- #define REG_PC	15
-+#define REG_RA_AUTH_CODE 143
- 
- /* ARM instructions take 4bytes in the object file, Thumb instructions
-    take 2:  */
-@@ -1943,21 +1944,6 @@ parse_reg_list (char ** strp, enum reg_l
- 
- 	      reg = arm_reg_parse (&str, rt);
- 
--	      /* Skip over allowed registers of alternative types in mixed-type
--	         register lists.  */
--	      if (reg == FAIL && rt == REG_TYPE_PSEUDO
--		  && ((reg = arm_reg_parse (&str, REG_TYPE_RN)) != FAIL))
--		{
--		  cur_reg = reg;
--		  continue;
--		}
--	      else if (reg == FAIL && rt == REG_TYPE_RN
--		       && ((reg = arm_reg_parse (&str, REG_TYPE_PSEUDO)) != FAIL))
--		{
--		  cur_reg = reg;
--		  continue;
--		}
--
- 	      if (etype == REGLIST_CLRM)
- 		{
- 		  if (reg == REG_SP || reg == REG_PC)
-@@ -4139,7 +4125,6 @@ s_arm_unwind_fnstart (int ignored ATTRIB
-   unwind.sp_restored = 0;
- }
- 
--
- /* Parse a handlerdata directive.  Creates the exception handling table entry
-    for the function.  */
- 
-@@ -4297,15 +4282,19 @@ s_arm_unwind_personality (int ignored AT
- /* Parse a directive saving pseudo registers.  */
- 
- static void
--s_arm_unwind_save_pseudo (long range)
-+s_arm_unwind_save_pseudo (int regno)
- {
-   valueT op;
- 
--  if (range & (1 << 12))
-+  switch (regno)
-     {
-+    case REG_RA_AUTH_CODE:
-       /* Opcode for restoring RA_AUTH_CODE.  */
-       op = 0xb4;
-       add_unwind_opcode (op, 1);
-+      break;
-+    default:
-+      as_bad (_("Unknown register %d encountered\n"), regno);
-     }
- }
- 
-@@ -4375,6 +4364,80 @@ s_arm_unwind_save_core (long range)
-     }
- }
- 
-+/* Implement correct handling of .save lists enabling the split into
-+sublists where necessary, while preserving correct sublist ordering.  */
-+
-+static void
-+parse_dot_save (char **str_p, int prev_reg)
-+{
-+  long core_regs = 0;
-+  int reg;
-+  int in_range = 0;
-+
-+  if (**str_p == ',')
-+    *str_p += 1;
-+  if (**str_p == '}')
-+    {
-+      *str_p += 1;
-+      return;
-+    }
-+
-+  while ((reg = arm_reg_parse (str_p, REG_TYPE_RN)) != FAIL)
-+    {
-+      if (!in_range)
-+	{
-+	  if (core_regs & (1 << reg))
-+	    as_tsktsk (_("Warning: duplicated register (r%d) in register list"),
-+		       reg);
-+	  else if (reg <= prev_reg)
-+	    as_tsktsk (_("Warning: register list not in ascending order"));
-+
-+	  core_regs |= (1 << reg);
-+	  prev_reg = reg;
-+	  if (skip_past_char(str_p, '-') != FAIL)
-+	    in_range = 1;
-+	  else if (skip_past_comma(str_p) == FAIL)
-+	    first_error (_("bad register list"));
-+	}
-+      else
-+	{
-+	  int i;
-+	  if (reg <= prev_reg)
-+	    first_error (_("bad range in register list"));
-+	  for (i = prev_reg + 1; i <= reg; i++)
-+	    {
-+	      if (core_regs & (1 << i))
-+		as_tsktsk (_("Warning: duplicated register (r%d) in register list"),
-+			   i);
-+	      else
-+		core_regs |= 1 << i;
-+	    }
-+	  in_range = 0;
-+	}
-+    }
-+  if (core_regs)
-+    {
-+      /* Higher register numbers go in higher memory addresses.  When splitting a list,
-+	 right-most sublist should therefore be .saved first.  Use recursion for this.  */
-+      parse_dot_save (str_p, reg);
-+      /* We're back from recursion, so emit .save insn for sublist.  */
-+      s_arm_unwind_save_core (core_regs);
-+      return;
-+    }
-+  /* Handle pseudo-regs, under assumption these are emitted singly.  */
-+  else if ((reg = arm_reg_parse (str_p, REG_TYPE_PSEUDO)) != FAIL)
-+    {
-+      /* Recurse for remainder of input.  Note: No assumption is made regarding which
-+	 register in core register set holds pseudo-register.  It's not considered in
-+	 ordering check beyond ensuring it's not sandwiched between 2 consecutive
-+	 registers.  */
-+      parse_dot_save (str_p, prev_reg + 1);
-+      s_arm_unwind_save_pseudo (reg);
-+      return;
-+    }
-+  else
-+    as_bad (BAD_SYNTAX);
-+}
- 
- /* Parse a directive saving FPA registers.  */
- 
-@@ -4716,39 +4779,13 @@ s_arm_unwind_save_mmxwcg (void)
-   ignore_rest_of_line ();
- }
- 
--/* Convert range and mask_range into a sequence of s_arm_unwind_core
--   and s_arm_unwind_pseudo operations.  We assume that mask_range will
--   not have consecutive bits set, or that one operation per bit is
--   acceptable.  */
--
--static void
--s_arm_unwind_save_mixed (long range, long mask_range)
--{
--  while (mask_range)
--    {
--      long mask_bit = mask_range & -mask_range;
--      long subrange = range & (mask_bit - 1);
--
--      if (subrange)
--	s_arm_unwind_save_core (subrange);
--
--      s_arm_unwind_save_pseudo (mask_bit);
--      range &= ~subrange;
--      mask_range &= ~mask_bit;
--    }
--
--  if (range)
--    s_arm_unwind_save_core (range);
--}
--
- /* Parse an unwind_save directive.
-    If the argument is non-zero, this is a .vsave directive.  */
- 
- static void
- s_arm_unwind_save (int arch_v6)
- {
--  char *peek, *mask_peek;
--  long range, mask_range;
-+  char *peek;
-   struct reg_entry *reg;
-   bool had_brace = false;
- 
-@@ -4756,7 +4793,7 @@ s_arm_unwind_save (int arch_v6)
-     as_bad (MISSING_FNSTART);
- 
-   /* Figure out what sort of save we have.  */
--  peek = mask_peek = input_line_pointer;
-+  peek = input_line_pointer;
- 
-   if (*peek == '{')
-     {
-@@ -4788,20 +4825,13 @@ s_arm_unwind_save (int arch_v6)
- 
-     case REG_TYPE_PSEUDO:
-     case REG_TYPE_RN:
--      mask_range = parse_reg_list (&mask_peek, REGLIST_PSEUDO);
--      range = parse_reg_list (&input_line_pointer, REGLIST_RN);
--
--      if (range == FAIL || mask_range == FAIL)
--	{
--	  as_bad (_("expected register list"));
--	  ignore_rest_of_line ();
--	  return;
--	}
--
--      demand_empty_rest_of_line ();
--
--      s_arm_unwind_save_mixed (range, mask_range);
--      return;
-+      {
-+	if (had_brace)
-+	  input_line_pointer++;
-+	parse_dot_save (&input_line_pointer, -1);
-+	demand_empty_rest_of_line ();
-+	return;
-+      }
- 
-     case REG_TYPE_VFD:
-       if (arch_v6)
-@@ -23993,12 +24023,8 @@ static const struct reg_entry reg_names[
-   /* XScale accumulator registers.  */
-   REGNUM(acc,0,XSCALE), REGNUM(ACC,0,XSCALE),
- 
--  /* DWARF ABI defines RA_AUTH_CODE to 143. It also reserves 134-142 for future
--     expansion.  RA_AUTH_CODE here is given the value 143 % 134 to make it easy
--     for tc_arm_regname_to_dw2regnum to translate to DWARF reg number using
--     134 + reg_number should the range 134 to 142 be used for more pseudo regs
--     in the future.  This also helps fit RA_AUTH_CODE into a bitmask.  */
--  REGDEF(ra_auth_code,12,PSEUDO),
-+  /* AADWARF32 defines RA_AUTH_CODE to 143.  */
-+  REGDEF(ra_auth_code,143,PSEUDO),
- };
- #undef REGDEF
- #undef REGNUM
-@@ -27905,7 +27931,6 @@ create_unwind_entry (int have_data)
-   return 0;
- }
- 
--
- /* Initialize the DWARF-2 unwind information for this procedure.  */
- 
- void
---- a/gas/testsuite/gas/arm/unwind-pacbti-m-readelf.d
-+++ b/gas/testsuite/gas/arm/unwind-pacbti-m-readelf.d
-@@ -10,11 +10,11 @@ Unwind section '.ARM.exidx' at offset 0x
- 
- 0x0 <foo>: @0x0
-   Compact model index: 1
--  0x84 0x00 pop {r14}
-   0xb4      pop {ra_auth_code}
-   0x84 0x00 pop {r14}
--  0xb4      pop {ra_auth_code}
-   0xa3      pop {r4, r5, r6, r7}
-   0xb4      pop {ra_auth_code}
-+  0x84 0x00 pop {r14}
-+  0xb4      pop {ra_auth_code}
-   0xa8      pop {r4, r14}
-   0xb0      finish
---- a/gas/testsuite/gas/arm/unwind-pacbti-m.d
-+++ b/gas/testsuite/gas/arm/unwind-pacbti-m.d
-@@ -8,4 +8,4 @@
- .*:     file format.*
- 
- Contents of section .ARM.extab:
-- 0000 (00840281 b40084b4 b0a8b4a3|81028400 b48400b4 a3b4a8b0) 00000000  .*
-+ 0000 (84b40281 84b4a300 b0a8b400|8102b484 00a3b484 00b4a8b0) 00000000  .*
diff --git a/toolchain/binutils/patches/2.39/300-001_ld_makefile_patch.patch b/toolchain/binutils/patches/2.39/300-001_ld_makefile_patch.patch
deleted file mode 100644
index ac80bf42..00000000
--- a/toolchain/binutils/patches/2.39/300-001_ld_makefile_patch.patch
+++ /dev/null
@@ -1,22 +0,0 @@
---- a/ld/Makefile.am
-+++ b/ld/Makefile.am
-@@ -50,7 +50,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- 
- EMUL = @EMUL@
- EMULATION_OFILES = @EMULATION_OFILES@
---- a/ld/Makefile.in
-+++ b/ld/Makefile.in
-@@ -569,7 +569,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- BASEDIR = $(srcdir)/..
- BFDDIR = $(BASEDIR)/bfd
- INCDIR = $(BASEDIR)/include
diff --git a/toolchain/binutils/patches/2.39/400-mips_no_dynamic_linking_sym.patch b/toolchain/binutils/patches/2.39/400-mips_no_dynamic_linking_sym.patch
deleted file mode 100644
index f499dfdc..00000000
--- a/toolchain/binutils/patches/2.39/400-mips_no_dynamic_linking_sym.patch
+++ /dev/null
@@ -1,18 +0,0 @@
---- a/bfd/elfxx-mips.c
-+++ b/bfd/elfxx-mips.c
-@@ -8066,6 +8066,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       name = SGI_COMPAT (abfd) ? "_DYNAMIC_LINK" : "_DYNAMIC_LINKING";
-       bh = NULL;
-+      if (0) {
-       if (!(_bfd_generic_link_add_one_symbol
- 	    (info, abfd, name, BSF_GLOBAL, bfd_abs_section_ptr, 0,
- 	     NULL, false, get_elf_backend_data (abfd)->collect, &bh)))
-@@ -8078,6 +8079,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       if (! bfd_elf_link_record_dynamic_symbol (info, h))
- 	return false;
-+      }
- 
-       if (! mips_elf_hash_table (info)->use_rld_obj_head)
- 	{
diff --git a/toolchain/binutils/patches/2.39/500-Change-default-emulation-for-mips64-linux.patch b/toolchain/binutils/patches/2.39/500-Change-default-emulation-for-mips64-linux.patch
deleted file mode 100644
index 8a43563d..00000000
--- a/toolchain/binutils/patches/2.39/500-Change-default-emulation-for-mips64-linux.patch
+++ /dev/null
@@ -1,38 +0,0 @@
---- a/bfd/config.bfd
-+++ b/bfd/config.bfd
-@@ -928,12 +928,12 @@ case "${targ}" in
-     targ_selvecs="mips_elf32_le_vec mips_elf64_be_vec mips_elf64_le_vec mips_ecoff_be_vec mips_ecoff_le_vec"
-     ;;
-   mips64*el-*-linux*)
--    targ_defvec=mips_elf32_ntrad_le_vec
--    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_le_vec mips_elf64_trad_be_vec"
-+    targ_defvec=mips_elf64_trad_le_vec
-+    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_be_vec"
-     ;;
-   mips64*-*-linux*)
--    targ_defvec=mips_elf32_ntrad_be_vec
--    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_be_vec mips_elf64_trad_le_vec"
-+    targ_defvec=mips_elf64_trad_be_vec
-+    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_le_vec"
-     ;;
-   mips*el-*-linux*)
-     targ_defvec=mips_elf32_trad_le_vec
---- a/ld/configure.tgt
-+++ b/ld/configure.tgt
-@@ -580,12 +580,12 @@ mips*-*-vxworks*)	targ_emul=elf32ebmipvx
- 			;;
- mips*-*-windiss)	targ_emul=elf32mipswindiss
- 			;;
--mips64*el-*-linux-*)	targ_emul=elf32ltsmipn32
--			targ_extra_emuls="elf32btsmipn32 elf32ltsmip elf32btsmip elf64ltsmip elf64btsmip"
-+mips64*el-*-linux-*)	targ_emul=elf64ltsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32ltsmip elf32btsmip elf64btsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
--mips64*-*-linux-*)	targ_emul=elf32btsmipn32
--			targ_extra_emuls="elf32ltsmipn32 elf32btsmip elf32ltsmip elf64btsmip elf64ltsmip"
-+mips64*-*-linux-*)	targ_emul=elf64btsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32btsmip elf32ltsmip elf64ltsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
- mips*el-*-linux-*)	targ_emul=elf32ltsmip
diff --git a/toolchain/binutils/patches/2.41/300-001_ld_makefile_patch.patch b/toolchain/binutils/patches/2.41/300-001_ld_makefile_patch.patch
deleted file mode 100644
index 2dafd92a..00000000
--- a/toolchain/binutils/patches/2.41/300-001_ld_makefile_patch.patch
+++ /dev/null
@@ -1,22 +0,0 @@
---- a/ld/Makefile.am
-+++ b/ld/Makefile.am
-@@ -50,7 +50,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- 
- EMUL = @EMUL@
- EMULATION_OFILES = @EMULATION_OFILES@
---- a/ld/Makefile.in
-+++ b/ld/Makefile.in
-@@ -573,7 +573,7 @@ AM_CFLAGS = $(WARN_CFLAGS) $(ELF_CLFAGS)
- # We put the scripts in the directory $(scriptdir)/ldscripts.
- # We can't put the scripts in $(datadir) because the SEARCH_DIR
- # directives need to be different for native and cross linkers.
--scriptdir = $(tooldir)/lib
-+scriptdir = $(libdir)
- BASEDIR = $(srcdir)/..
- BFDDIR = $(BASEDIR)/bfd
- INCDIR = $(BASEDIR)/include
diff --git a/toolchain/binutils/patches/2.41/400-mips_no_dynamic_linking_sym.patch b/toolchain/binutils/patches/2.41/400-mips_no_dynamic_linking_sym.patch
deleted file mode 100644
index c50a988d..00000000
--- a/toolchain/binutils/patches/2.41/400-mips_no_dynamic_linking_sym.patch
+++ /dev/null
@@ -1,18 +0,0 @@
---- a/bfd/elfxx-mips.c
-+++ b/bfd/elfxx-mips.c
-@@ -8144,6 +8144,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       name = SGI_COMPAT (abfd) ? "_DYNAMIC_LINK" : "_DYNAMIC_LINKING";
-       bh = NULL;
-+      if (0) {
-       if (!(_bfd_generic_link_add_one_symbol
- 	    (info, abfd, name, BSF_GLOBAL, bfd_abs_section_ptr, 0,
- 	     NULL, false, get_elf_backend_data (abfd)->collect, &bh)))
-@@ -8156,6 +8157,7 @@ _bfd_mips_elf_create_dynamic_sections (b
- 
-       if (! bfd_elf_link_record_dynamic_symbol (info, h))
- 	return false;
-+      }
- 
-       if (! mips_elf_hash_table (info)->use_rld_obj_head)
- 	{
diff --git a/toolchain/binutils/patches/2.41/500-Change-default-emulation-for-mips64-linux.patch b/toolchain/binutils/patches/2.41/500-Change-default-emulation-for-mips64-linux.patch
deleted file mode 100644
index 60676bbe..00000000
--- a/toolchain/binutils/patches/2.41/500-Change-default-emulation-for-mips64-linux.patch
+++ /dev/null
@@ -1,48 +0,0 @@
---- a/bfd/config.bfd
-+++ b/bfd/config.bfd
-@@ -947,8 +947,8 @@ case "${targ}" in
-     want64=true
-     ;;
-   mips64*el-*-linux*)
--    targ_defvec=mips_elf32_ntrad_le_vec
--    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_le_vec mips_elf64_trad_be_vec"
-+    targ_defvec=mips_elf64_trad_le_vec
-+    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_ntrad_be_vec mips_elf32_trad_le_vec mips_elf32_trad_be_vec mips_elf64_trad_be_vec"
-     ;;
-   mips64*-*-linux*-gnuabi64)
-     targ_defvec=mips_elf64_trad_be_vec
-@@ -956,8 +956,8 @@ case "${targ}" in
-     want64=true
-     ;;
-   mips64*-*-linux*)
--    targ_defvec=mips_elf32_ntrad_be_vec
--    targ_selvecs="mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_be_vec mips_elf64_trad_le_vec"
-+    targ_defvec=mips_elf64_trad_be_vec
-+    targ_selvecs="mips_elf32_ntrad_be_vec mips_elf32_ntrad_le_vec mips_elf32_trad_be_vec mips_elf32_trad_le_vec mips_elf64_trad_le_vec"
-     ;;
-   mips*el-*-linux*)
-     targ_defvec=mips_elf32_trad_le_vec
---- a/ld/configure.tgt
-+++ b/ld/configure.tgt
-@@ -585,8 +585,8 @@ mips64*el-*-linux-gnuabi64)
- 			targ_extra_emuls="elf64btsmip elf32ltsmipn32 elf32btsmipn32 elf32ltsmip elf32btsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
--mips64*el-*-linux-*)	targ_emul=elf32ltsmipn32
--			targ_extra_emuls="elf32btsmipn32 elf32ltsmip elf32btsmip elf64ltsmip elf64btsmip"
-+mips64*el-*-linux-*)	targ_emul=elf64ltsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32ltsmip elf32btsmip elf64btsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
- mips64*-*-linux-gnuabi64)
-@@ -594,8 +594,8 @@ mips64*-*-linux-gnuabi64)
- 			targ_extra_emuls="elf64ltsmip elf32btsmipn32 elf32ltsmipn32 elf32btsmip elf32ltsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
--mips64*-*-linux-*)	targ_emul=elf32btsmipn32
--			targ_extra_emuls="elf32ltsmipn32 elf32btsmip elf32ltsmip elf64btsmip elf64ltsmip"
-+mips64*-*-linux-*)	targ_emul=elf64btsmip
-+			targ_extra_emuls="elf32btsmipn32 elf32ltsmipn32 elf32btsmip elf32ltsmip elf64ltsmip"
- 			targ_extra_libpath=$targ_extra_emuls
- 			;;
- mips*el-*-linux-*)	targ_emul=elf32ltsmip
diff --git a/toolchain/gcc/Config.in b/toolchain/gcc/Config.in
index 714620db..b306040f 100644
--- a/toolchain/gcc/Config.in
+++ b/toolchain/gcc/Config.in
@@ -2,22 +2,21 @@
 
 choice
 	prompt "GCC compiler Version" if TOOLCHAINOPTS
-	default GCC_USE_VERSION_8 if mips || mipsel || mips64 || mips64el
 	default GCC_USE_VERSION_13
 	help
 	  Select the version of gcc you wish to use.
 
-	config GCC_USE_VERSION_8
-		bool "gcc 8.x"
-
 	config GCC_USE_VERSION_11
 		bool "gcc 11.x"
 
 	config GCC_USE_VERSION_12
 		bool "gcc 12.x"
-		
+
 	config GCC_USE_VERSION_13
-		bool "gcc 13.x"	
+		bool "gcc 13.x"
+
+	config GCC_USE_VERSION_14
+		bool "gcc 14.x"
 endchoice
 
 config GCC_USE_GRAPHITE
@@ -34,21 +33,18 @@ config EXTRA_GCC_CONFIG_OPTIONS
 config GCC_DEFAULT_PIE
 	bool
 	prompt "Build executable with PIE enabled by default" if TOOLCHAINOPTS
-	default n
 	help
 	    Use gcc configure option --enable-default-pie to turn on -fPIE and -pie by default.
 
 config GCC_DEFAULT_SSP
 	bool
 	prompt "Build executable with Stack-Smashing Protection enabled by default" if TOOLCHAINOPTS
-	default n
 	help
 	    Use gcc configure option --enable-default-ssp to turn on -fstack-protector-strong by default.
 
 config SJLJ_EXCEPTIONS
 	bool
 	prompt "Use setjump()/longjump() exceptions" if TOOLCHAINOPTS
-	default n
 	help
 	    Use old setjump()/longjump() exceptions instead of the newer
 	    frame unwinding exceptions handling routines.  Warning: increases
@@ -57,7 +53,6 @@ config SJLJ_EXCEPTIONS
 config INSTALL_GFORTRAN
 	bool
 	prompt "Build/install fortran compiler?" if TOOLCHAINOPTS
-	default n
 	help
 	    Build/install GNU fortran compiler ?
 
@@ -65,6 +60,5 @@ config INSTALL_GCCGO
 	bool
 	prompt "Build/install Go compiler?" if TOOLCHAINOPTS
 	depends on USE_GLIBC || BROKEN
-	default n
 	help
 	    Build/install GNU gccgo compiler ?
diff --git a/toolchain/gcc/Config.version b/toolchain/gcc/Config.version
index 83d07717..49bb3686 100644
--- a/toolchain/gcc/Config.version
+++ b/toolchain/gcc/Config.version
@@ -1,8 +1,3 @@
-config GCC_VERSION_8
-	default y if GCC_USE_VERSION_8
-	default y if mips || mipsel || mips64 || mips64el
-	bool
-
 config GCC_VERSION_11
 	default y if GCC_USE_VERSION_11
 	bool
@@ -11,9 +6,19 @@ config GCC_VERSION_12
 	default y if GCC_USE_VERSION_12
 	bool
 
+config GCC_VERSION_14
+	default y if GCC_USE_VERSION_14
+	bool
+
 config GCC_VERSION
 	string
-	default "8.4.0"		if GCC_VERSION_8
+	default EXTERNAL_GCC_VERSION	if EXTERNAL_TOOLCHAIN && !NATIVE_TOOLCHAIN
 	default "11.3.0"	if GCC_VERSION_11
-	default "12.2.0"	if GCC_VERSION_12
+	default "12.3.0"	if GCC_VERSION_12
+	default "14.2.0"	if GCC_VERSION_14
 	default "13.3.0"
+
+config GCC_USE_DEFAULT_VERSION
+	bool
+	default y if !TOOLCHAINOPTS || GCC_USE_VERSION_13
+	imply KERNEL_WERROR
diff --git a/toolchain/gcc/common.mk b/toolchain/gcc/common.mk
index 55be6228..0ccf55bd 100644
--- a/toolchain/gcc/common.mk
+++ b/toolchain/gcc/common.mk
@@ -28,23 +28,24 @@ GCC_DIR:=$(PKG_NAME)-$(PKG_VERSION)
 
 PKG_SOURCE_URL:=@GNU/gcc/gcc-$(PKG_VERSION)
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
-
-ifeq ($(PKG_VERSION),8.4.0)
-  PKG_HASH:=e30a6e52d10e1f27ed55104ad233c30bd1e99cfb5ff98ab022dc941edd1b2dd4
-endif
+PKG_CPE_ID:=cpe:/a:gnu:gcc
 
 ifeq ($(PKG_VERSION),11.3.0)
   PKG_HASH:=b47cf2818691f5b1e21df2bb38c795fac2cfbd640ede2d0a5e1c89e338a3ac39
 endif
 
-ifeq ($(PKG_VERSION),12.2.0)
-  PKG_HASH:=e549cf9cf3594a00e27b6589d4322d70e0720cdd213f39beb4181e06926230ff
+ifeq ($(PKG_VERSION),12.3.0)
+  PKG_HASH:=949a5d4f99e786421a93b532b22ffab5578de7321369975b91aec97adfda8c3b
 endif
 
 ifeq ($(PKG_VERSION),13.3.0)
   PKG_HASH:=0845e9621c9543a13f484e94584a49ffc0129970e9914624235fc1d061a0c083
 endif
 
+ifeq ($(PKG_VERSION),14.2.0)
+  PKG_HASH:=a7b39bc69cbf9e25826c5a60ab26477001f7c08d85cec04bc0e29cabed6f3cc9
+endif
+
 PATCH_DIR=../patches-$(GCC_MAJOR_VERSION).x
 
 BUGURL=http://bugs.openwrt.org/
@@ -74,6 +75,9 @@ TAR_OPTIONS += \
 	--exclude-from='$(CURDIR)/../exclude-testsuite' --exclude=gcc/ada/*.ad* \
 	--exclude=libjava
 
+# this needs to be without -L/-lzstd flags or other parts fail to build
+# use an absolute path to ensure it really picks up our version
+export ac_cv_search_ZSTD_compress=$(STAGING_DIR_HOST)/lib/libzstd.a -pthread
 export libgcc_cv_fixed_point=no
 ifdef CONFIG_INSTALL_GCCGO
   export libgo_cv_c_split_stack_supported=no
@@ -87,10 +91,6 @@ endif
 
 GCC_CONFIGURE:= \
 	SHELL="$(BASH)" \
-	$(if $(shell gcc --version 2>&1 | grep -E "Apple.(LLVM|clang)"), \
-		CFLAGS="-O2 -fbracket-depth=512 -pipe" \
-		CXXFLAGS="-O2 -fbracket-depth=512 -pipe" \
-	) \
 	$(HOST_SOURCE_DIR)/configure \
 		--with-bugurl=$(BUGURL) \
 		--with-pkgversion="$(PKGVERSION)" \
@@ -114,6 +114,8 @@ GCC_CONFIGURE:= \
 			--with-abi=$(call qstrip,$(CONFIG_MIPS64_ABI))) \
 		$(if $(CONFIG_arc),--with-cpu=$(CONFIG_CPU_TYPE)) \
 		$(if $(CONFIG_powerpc64), $(if $(CONFIG_USE_MUSL),--with-abi=elfv2)) \
+		--with-system-zlib=$(STAGING_DIR_HOST) \
+		--with-zstd=$(STAGING_DIR_HOST) \
 		--with-gmp=$(STAGING_DIR_HOST) \
 		--with-mpfr=$(STAGING_DIR_HOST) \
 		--with-mpc=$(STAGING_DIR_HOST) \
@@ -172,29 +174,34 @@ ifeq ($(CONFIG_TARGET_x86)$(CONFIG_USE_GLIBC)$(CONFIG_INSTALL_GCCGO),yyy)
   TARGET_CFLAGS+=-fno-split-stack
 endif
 
+CFLAGS:=$(HOST_CFLAGS) -pipe
+ifneq ($(shell gcc --version 2>&1 | grep -E "Apple.(LLVM|clang)"),)
+  CFLAGS+= -fbracket-depth=512
+endif
+
+GCC_CONFIGURE+= \
+	CFLAGS="$(CFLAGS)" \
+	CXXFLAGS="$(CFLAGS)" \
+	CFLAGS_FOR_TARGET="$(TARGET_CFLAGS)" \
+	CXXFLAGS_FOR_TARGET="$(TARGET_CFLAGS)" \
+	GOCFLAGS_FOR_TARGET="$(TARGET_CFLAGS)"
+
 GCC_MAKE:= \
 	export SHELL="$(BASH)"; \
-	$(MAKE) \
-		CFLAGS="$(HOST_CFLAGS)" \
-		CFLAGS_FOR_TARGET="$(TARGET_CFLAGS)" \
-		CXXFLAGS_FOR_TARGET="$(TARGET_CFLAGS)" \
-		GOCFLAGS_FOR_TARGET="$(TARGET_CFLAGS)"
+	$(MAKE)
 
 define Host/SetToolchainInfo
 	$(SED) 's,TARGET_CROSS=.*,TARGET_CROSS=$(REAL_GNU_TARGET_NAME)-,' $(TOOLCHAIN_DIR)/info.mk
 	$(SED) 's,GCC_VERSION=.*,GCC_VERSION=$(GCC_VERSION),' $(TOOLCHAIN_DIR)/info.mk
 endef
 
+
 ifeq ($(GCC_MAJOR_VERSION),11)
 	GCC_VERSION_FILE:=gcc/version.c
 else
 	GCC_VERSION_FILE:=gcc/genversion.cc
 endif
 
-ifeq ($(GCC_MAJOR_VERSION),8)
-	GCC_VERSION_FILE:=gcc/version.c
-endif
-
 ifneq ($(GCC_PREPARE),)
   define Host/Prepare
 	$(call Host/SetToolchainInfo)
diff --git a/toolchain/gcc/final/Makefile b/toolchain/gcc/final/Makefile
index 049ddf61..78a5576b 100644
--- a/toolchain/gcc/final/Makefile
+++ b/toolchain/gcc/final/Makefile
@@ -8,6 +8,7 @@ GCC_CONFIGURE += \
 	--enable-shared \
 	--enable-threads \
 	--with-slibdir=$(TOOLCHAIN_DIR)/lib \
+	--enable-plugins \
 	--enable-lto \
 	--with-libelf=$(STAGING_DIR_HOST)
 
diff --git a/toolchain/gcc/initial/Makefile b/toolchain/gcc/initial/Makefile
index c71b17dd..7cb4a73d 100644
--- a/toolchain/gcc/initial/Makefile
+++ b/toolchain/gcc/initial/Makefile
@@ -19,18 +19,10 @@ endef
 
 define Host/Install
 	+$(GCC_MAKE) $(HOST_JOBS) -C $(GCC_BUILD_DIR) \
-		prefix="$(TOOLCHAIN_DIR)/initial" \
 		install-gcc \
 		install-target-libgcc
 
-	# XXX: glibc insists on linking against libgcc_eh
-	( cd $(TOOLCHAIN_DIR)/initial/lib/gcc/$(REAL_GNU_TARGET_NAME)/$(PKG_VERSION) ; \
-		[ -e libgcc_eh.a ] || ln -sf libgcc.a libgcc_eh.a ; \
-		cp libgcc.a libgcc_initial.a; \
-	)
-
-	$(call FixupLibdir,$(TOOLCHAIN_DIR)/initial)
-	$$(call file_copy,$(TOOLCHAIN_DIR)/initial/.,$(TOOLCHAIN_DIR)/)
+	$(call FixupLibdir,$(TOOLCHAIN_DIR))
 endef
 
 $(eval $(call HostBuild))
diff --git a/toolchain/gcc/patches-11.x/910-mbsd_multi.patch b/toolchain/gcc/patches-11.x/910-mbsd_multi.patch
index 21f53204..2d1c3d1b 100644
--- a/toolchain/gcc/patches-11.x/910-mbsd_multi.patch
+++ b/toolchain/gcc/patches-11.x/910-mbsd_multi.patch
@@ -114,7 +114,7 @@ Date:   Tue Jul 31 00:52:27 2007 +0000
  ; On SVR4 targets, it also controls whether or not to emit a
 --- a/gcc/doc/invoke.texi
 +++ b/gcc/doc/invoke.texi
-@@ -9058,6 +9058,17 @@ This option is only supported for C and
+@@ -9059,6 +9059,17 @@ This option is only supported for C and
  @option{-Wall} and by @option{-Wpedantic}, which can be disabled with
  @option{-Wno-pointer-sign}.
  
diff --git a/toolchain/gcc/patches-11.x/980-libiberty-set_32 call.patch b/toolchain/gcc/patches-11.x/980-libiberty-set_32 call.patch
deleted file mode 100644
index 7489504c..00000000
--- a/toolchain/gcc/patches-11.x/980-libiberty-set_32 call.patch	
+++ /dev/null
@@ -1,33 +0,0 @@
-From 38757aa88735ab2e511bc428e2407a5a5e9fa0be Mon Sep 17 00:00:00 2001
-From: Iain Sandoe <iain@sandoe.co.uk>
-Date: Mon, 23 Aug 2021 17:34:43 +0100
-Subject: [PATCH] libiberty, Darwin: Fix a build warning.
-
-r12-3005-g220c410162ebece4f missed a cast for the set_32 call.
-Fixed thus.
-
-Signed-off-by: Iain Sandoe <iain@sandoe.co.uk>
-
-libiberty/ChangeLog:
-
-	* simple-object-mach-o.c (simple_object_mach_o_write_segment):
-	Cast the first argument to set_32 as needed.
----
- libiberty/simple-object-mach-o.c | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/libiberty/simple-object-mach-o.c b/libiberty/simple-object-mach-o.c
-index 72b69d19c216..a8869e7c6395 100644
---- a/libiberty/simple-object-mach-o.c
-+++ b/libiberty/simple-object-mach-o.c
-@@ -1228,7 +1228,7 @@ simple_object_mach_o_write_segment (simple_object_write *sobj, int descriptor,
-       /* Swap the indices, if required.  */
- 
-       for (i = 0; i < (nsects_in * 4); ++i)
--	set_32 (&index[i], index[i]);
-+	set_32 ((unsigned char *) &index[i], index[i]);
- 
-       sechdr_offset += sechdrsize;
- 
--- 
-2.43.5
diff --git a/toolchain/gcc/patches-12.x/230-musl_libssp.patch b/toolchain/gcc/patches-12.x/230-musl_libssp.patch
index 3ce5e495..a909d638 100644
--- a/toolchain/gcc/patches-12.x/230-musl_libssp.patch
+++ b/toolchain/gcc/patches-12.x/230-musl_libssp.patch
@@ -1,6 +1,6 @@
 --- a/gcc/gcc.cc
 +++ b/gcc/gcc.cc
-@@ -985,7 +985,9 @@ proper position among the other output f
+@@ -987,7 +987,9 @@ proper position among the other output f
  #endif
  
  #ifndef LINK_SSP_SPEC
diff --git a/toolchain/gcc/patches-12.x/910-mbsd_multi.patch b/toolchain/gcc/patches-12.x/910-mbsd_multi.patch
index 4033c5b2..9233c6a1 100644
--- a/toolchain/gcc/patches-12.x/910-mbsd_multi.patch
+++ b/toolchain/gcc/patches-12.x/910-mbsd_multi.patch
@@ -114,7 +114,7 @@ Date:   Tue Jul 31 00:52:27 2007 +0000
  ; On SVR4 targets, it also controls whether or not to emit a
 --- a/gcc/doc/invoke.texi
 +++ b/gcc/doc/invoke.texi
-@@ -9596,6 +9596,17 @@ This option is only supported for C and
+@@ -9597,6 +9597,17 @@ This option is only supported for C and
  @option{-Wall} and by @option{-Wpedantic}, which can be disabled with
  @option{-Wno-pointer-sign}.
  
@@ -134,7 +134,7 @@ Date:   Tue Jul 31 00:52:27 2007 +0000
  @opindex Wno-stack-protector
 --- a/gcc/opts.cc
 +++ b/gcc/opts.cc
-@@ -2692,6 +2692,9 @@ common_handle_option (struct gcc_options
+@@ -2699,6 +2699,9 @@ common_handle_option (struct gcc_options
        add_comma_separated_to_vector (&opts->x_flag_ignored_attributes, arg);
        break;
  
diff --git a/toolchain/gcc/patches-12.x/920-specs_nonfatal_getenv.patch b/toolchain/gcc/patches-12.x/920-specs_nonfatal_getenv.patch
index 0f7d40b2..59bd3500 100644
--- a/toolchain/gcc/patches-12.x/920-specs_nonfatal_getenv.patch
+++ b/toolchain/gcc/patches-12.x/920-specs_nonfatal_getenv.patch
@@ -7,7 +7,7 @@ Date:   Sat Apr 21 03:02:39 2012 +0000
 
 --- a/gcc/gcc.cc
 +++ b/gcc/gcc.cc
-@@ -10213,8 +10213,10 @@ getenv_spec_function (int argc, const ch
+@@ -10186,8 +10186,10 @@ getenv_spec_function (int argc, const ch
      }
  
    if (!value)
diff --git a/toolchain/gcc/patches-12.x/970-macos_arm64-building-fix.patch b/toolchain/gcc/patches-12.x/970-macos_arm64-building-fix.patch
index 86fa68e1..89730449 100644
--- a/toolchain/gcc/patches-12.x/970-macos_arm64-building-fix.patch
+++ b/toolchain/gcc/patches-12.x/970-macos_arm64-building-fix.patch
@@ -17,7 +17,7 @@ Date:   Mon Aug 16 13:16:21 2021 +0100
 
 --- a/gcc/config/aarch64/aarch64.h
 +++ b/gcc/config/aarch64/aarch64.h
-@@ -1290,7 +1290,7 @@ extern const char *aarch64_rewrite_mcpu
+@@ -1293,7 +1293,7 @@ extern const char *aarch64_rewrite_mcpu
  #define MCPU_TO_MARCH_SPEC_FUNCTIONS \
    { "rewrite_mcpu", aarch64_rewrite_mcpu },
  
diff --git a/toolchain/gcc/patches-8.x/002-case_insensitive.patch b/toolchain/gcc/patches-8.x/002-case_insensitive.patch
deleted file mode 100644
index 3442076d..00000000
--- a/toolchain/gcc/patches-8.x/002-case_insensitive.patch
+++ /dev/null
@@ -1,24 +0,0 @@
-commit 81cc26c706b2bc8c8c1eb1a322e5c5157900836e
-Author: Felix Fietkau <nbd@openwrt.org>
-Date:   Sun Oct 19 21:45:51 2014 +0000
-
-    gcc: do not assume that the Mac OS X filesystem is case insensitive
-    
-    Signed-off-by: Felix Fietkau <nbd@openwrt.org>
-    
-    SVN-Revision: 42973
-
---- a/include/filenames.h
-+++ b/include/filenames.h
-@@ -43,11 +43,6 @@ extern "C" {
- #  define IS_DIR_SEPARATOR(c) IS_DOS_DIR_SEPARATOR (c)
- #  define IS_ABSOLUTE_PATH(f) IS_DOS_ABSOLUTE_PATH (f)
- #else /* not DOSish */
--#  if defined(__APPLE__)
--#    ifndef HAVE_CASE_INSENSITIVE_FILE_SYSTEM
--#      define HAVE_CASE_INSENSITIVE_FILE_SYSTEM 1
--#    endif
--#  endif /* __APPLE__ */
- #  define HAS_DRIVE_SPEC(f) (0)
- #  define IS_DIR_SEPARATOR(c) IS_UNIX_DIR_SEPARATOR (c)
- #  define IS_ABSOLUTE_PATH(f) IS_UNIX_ABSOLUTE_PATH (f)
diff --git a/toolchain/gcc/patches-8.x/010-documentation.patch b/toolchain/gcc/patches-8.x/010-documentation.patch
deleted file mode 100644
index c7e3d4ad..00000000
--- a/toolchain/gcc/patches-8.x/010-documentation.patch
+++ /dev/null
@@ -1,35 +0,0 @@
-commit 098bd91f5eae625c7d2ee621e10930fc4434e5e2
-Author: Luka Perkov <luka@openwrt.org>
-Date:   Tue Feb 26 16:16:33 2013 +0000
-
-    gcc: don't build documentation
-    
-    This closes #13039.
-    
-    Signed-off-by: Luka Perkov <luka@openwrt.org>
-    
-    SVN-Revision: 35807
-
---- a/gcc/Makefile.in
-+++ b/gcc/Makefile.in
-@@ -3204,18 +3204,10 @@ doc/gcc.info: $(TEXI_GCC_FILES)
- doc/gccint.info: $(TEXI_GCCINT_FILES)
- doc/cppinternals.info: $(TEXI_CPPINT_FILES)
- 
--doc/%.info: %.texi
--	if [ x$(BUILD_INFO) = xinfo ]; then \
--		$(MAKEINFO) $(MAKEINFOFLAGS) -I . -I $(gcc_docdir) \
--			-I $(gcc_docdir)/include -o $@ $<; \
--	fi
-+doc/%.info:
- 
- # Duplicate entry to handle renaming of gccinstall.info
--doc/gccinstall.info: $(TEXI_GCCINSTALL_FILES)
--	if [ x$(BUILD_INFO) = xinfo ]; then \
--		$(MAKEINFO) $(MAKEINFOFLAGS) -I $(gcc_docdir) \
--			-I $(gcc_docdir)/include -o $@ $<; \
--	fi
-+doc/gccinstall.info:
- 
- doc/cpp.dvi: $(TEXI_CPP_FILES)
- doc/gcc.dvi: $(TEXI_GCC_FILES)
diff --git a/toolchain/gcc/patches-8.x/110-Fix-MIPS-PR-84790.patch b/toolchain/gcc/patches-8.x/110-Fix-MIPS-PR-84790.patch
deleted file mode 100644
index b89eca2f..00000000
--- a/toolchain/gcc/patches-8.x/110-Fix-MIPS-PR-84790.patch
+++ /dev/null
@@ -1,20 +0,0 @@
-Fix https://gcc.gnu.org/bugzilla/show_bug.cgi?id=84790.
-MIPS16 functions have a static assembler prologue which clobbers
-registers v0 and v1. Add these register clobbers to function call
-instructions.
-
---- a/gcc/config/mips/mips.c
-+++ b/gcc/config/mips/mips.c
-@@ -3102,6 +3102,12 @@ mips_emit_call_insn (rtx pattern, rtx or
-       emit_insn (gen_update_got_version ());
-     }
- 
-+  if (TARGET_MIPS16 && TARGET_USE_GOT)
-+    {
-+      clobber_reg (&CALL_INSN_FUNCTION_USAGE (insn), MIPS16_PIC_TEMP);
-+      clobber_reg (&CALL_INSN_FUNCTION_USAGE (insn), MIPS_PROLOGUE_TEMP (word_mode));
-+    }
-+
-   if (TARGET_MIPS16
-       && TARGET_EXPLICIT_RELOCS
-       && TARGET_CALL_CLOBBERED_GP)
diff --git a/toolchain/gcc/patches-8.x/230-musl_libssp.patch b/toolchain/gcc/patches-8.x/230-musl_libssp.patch
deleted file mode 100644
index b3ab79ca..00000000
--- a/toolchain/gcc/patches-8.x/230-musl_libssp.patch
+++ /dev/null
@@ -1,13 +0,0 @@
---- a/gcc/gcc.c
-+++ b/gcc/gcc.c
-@@ -868,7 +868,9 @@ proper position among the other output f
- #endif
- 
- #ifndef LINK_SSP_SPEC
--#ifdef TARGET_LIBC_PROVIDES_SSP
-+#if DEFAULT_LIBC == LIBC_MUSL
-+#define LINK_SSP_SPEC "-lssp_nonshared"
-+#elif defined(TARGET_LIBC_PROVIDES_SSP)
- #define LINK_SSP_SPEC "%{fstack-protector|fstack-protector-all" \
- 		       "|fstack-protector-strong|fstack-protector-explicit:}"
- #else
diff --git a/toolchain/gcc/patches-8.x/300-mips_Os_cpu_rtx_cost_model.patch b/toolchain/gcc/patches-8.x/300-mips_Os_cpu_rtx_cost_model.patch
deleted file mode 100644
index 2e2c609e..00000000
--- a/toolchain/gcc/patches-8.x/300-mips_Os_cpu_rtx_cost_model.patch
+++ /dev/null
@@ -1,21 +0,0 @@
-commit ecf7671b769fe96f7b5134be442089f8bdba55d2
-Author: Felix Fietkau <nbd@nbd.name>
-Date:   Thu Aug 4 20:29:45 2016 +0200
-
-gcc: add a patch to generate better code with Os on mips
-
-Also happens to reduce compressed code size a bit
-
-Signed-off-by: Felix Fietkau <nbd@nbd.name>
-
---- a/gcc/config/mips/mips.c
-+++ b/gcc/config/mips/mips.c
-@@ -19847,7 +19847,7 @@ mips_option_override (void)
-     flag_pcc_struct_return = 0;
- 
-   /* Decide which rtx_costs structure to use.  */
--  if (optimize_size)
-+  if (0 && optimize_size)
-     mips_cost = &mips_rtx_cost_optimize_size;
-   else
-     mips_cost = &mips_rtx_cost_data[mips_tune];
diff --git a/toolchain/gcc/patches-8.x/800-arm_v5te_no_ldrd_strd.patch b/toolchain/gcc/patches-8.x/800-arm_v5te_no_ldrd_strd.patch
deleted file mode 100644
index 172295f2..00000000
--- a/toolchain/gcc/patches-8.x/800-arm_v5te_no_ldrd_strd.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/gcc/config/arm/arm.h
-+++ b/gcc/config/arm/arm.h
-@@ -155,7 +155,7 @@ extern tree arm_fp16_type_node;
- /* Thumb-1 only.  */
- #define TARGET_THUMB1_ONLY		(TARGET_THUMB1 && !arm_arch_notm)
- 
--#define TARGET_LDRD			(arm_arch5e && ARM_DOUBLEWORD_ALIGN \
-+#define TARGET_LDRD			(arm_arch6 && ARM_DOUBLEWORD_ALIGN \
-                                          && !TARGET_THUMB1)
- 
- #define TARGET_CRC32			(arm_arch_crc)
diff --git a/toolchain/gcc/patches-8.x/810-arm-softfloat-libgcc.patch b/toolchain/gcc/patches-8.x/810-arm-softfloat-libgcc.patch
deleted file mode 100644
index 5c9d86ae..00000000
--- a/toolchain/gcc/patches-8.x/810-arm-softfloat-libgcc.patch
+++ /dev/null
@@ -1,33 +0,0 @@
-commit 8570c4be394cff7282f332f97da2ff569a927ddb
-Author: Imre Kaloz <kaloz@openwrt.org>
-Date:   Wed Feb 2 20:06:12 2011 +0000
-
-    fixup arm soft-float symbols
-    
-    SVN-Revision: 25325
-
---- a/libgcc/config/arm/t-linux
-+++ b/libgcc/config/arm/t-linux
-@@ -1,6 +1,10 @@
- LIB1ASMSRC = arm/lib1funcs.S
- LIB1ASMFUNCS = _udivsi3 _divsi3 _umodsi3 _modsi3 _dvmd_lnx _clzsi2 _clzdi2 \
--	_ctzsi2 _arm_addsubdf3 _arm_addsubsf3
-+	_ctzsi2 _arm_addsubdf3 _arm_addsubsf3 \
-+	_arm_negdf2 _arm_muldivdf3 _arm_cmpdf2 _arm_unorddf2 \
-+	_arm_fixdfsi _arm_fixunsdfsi _arm_truncdfsf2 \
-+	_arm_negsf2 _arm_muldivsf3 _arm_cmpsf2 _arm_unordsf2 \
-+	_arm_fixsfsi _arm_fixunssfsi
- 
- # Just for these, we omit the frame pointer since it makes such a big
- # difference.
---- a/gcc/config/arm/linux-elf.h
-+++ b/gcc/config/arm/linux-elf.h
-@@ -58,8 +58,6 @@
-    %{shared:-lc} \
-    %{!shared:%{profile:-lc_p}%{!profile:-lc}}"
- 
--#define LIBGCC_SPEC "%{mfloat-abi=soft*:-lfloat} -lgcc"
--
- #define GLIBC_DYNAMIC_LINKER "/lib/ld-linux.so.2"
- 
- #define LINUX_TARGET_LINK_SPEC  "%{h*} \
diff --git a/toolchain/gcc/patches-8.x/820-libgcc_pic.patch b/toolchain/gcc/patches-8.x/820-libgcc_pic.patch
deleted file mode 100644
index 1a9678d4..00000000
--- a/toolchain/gcc/patches-8.x/820-libgcc_pic.patch
+++ /dev/null
@@ -1,44 +0,0 @@
-commit c96312958c0621e72c9b32da5bc224ffe2161384
-Author: Felix Fietkau <nbd@openwrt.org>
-Date:   Mon Oct 19 23:26:09 2009 +0000
-
-    gcc: create a proper libgcc_pic.a static library for relinking (4.3.3+ for now, backport will follow)
-    
-    SVN-Revision: 18086
-
---- a/libgcc/Makefile.in
-+++ b/libgcc/Makefile.in
-@@ -923,11 +923,12 @@ $(libgcov-driver-objects): %$(objext): $
- 
- # Static libraries.
- libgcc.a: $(libgcc-objects)
-+libgcc_pic.a: $(libgcc-s-objects)
- libgcov.a: $(libgcov-objects)
- libunwind.a: $(libunwind-objects)
- libgcc_eh.a: $(libgcc-eh-objects)
- 
--libgcc.a libgcov.a libunwind.a libgcc_eh.a:
-+libgcc.a libgcov.a libunwind.a libgcc_eh.a libgcc_pic.a:
- 	-rm -f $@
- 
- 	objects="$(objects)";					\
-@@ -948,7 +949,7 @@ all: libunwind.a
- endif
- 
- ifeq ($(enable_shared),yes)
--all: libgcc_eh.a libgcc_s$(SHLIB_EXT)
-+all: libgcc_eh.a libgcc_pic.a libgcc_s$(SHLIB_EXT)
- ifneq ($(LIBUNWIND),)
- all: libunwind$(SHLIB_EXT)
- libgcc_s$(SHLIB_EXT): libunwind$(SHLIB_EXT)
-@@ -1154,6 +1155,10 @@ install-shared:
- 	chmod 644 $(DESTDIR)$(inst_libdir)/libgcc_eh.a
- 	$(RANLIB) $(DESTDIR)$(inst_libdir)/libgcc_eh.a
- 
-+	$(INSTALL_DATA) libgcc_pic.a $(mapfile) $(DESTDIR)$(inst_libdir)/
-+	chmod 644 $(DESTDIR)$(inst_libdir)/libgcc_pic.a
-+	$(RANLIB) $(DESTDIR)$(inst_libdir)/libgcc_pic.a
-+
- 	$(subst @multilib_dir@,$(MULTIDIR),$(subst \
- 		@shlib_base_name@,libgcc_s,$(subst \
- 		@shlib_slibdir_qual@,$(MULTIOSSUBDIR),$(SHLIB_INSTALL))))
diff --git a/toolchain/gcc/patches-8.x/840-armv4_pass_fix-v4bx_to_ld.patch b/toolchain/gcc/patches-8.x/840-armv4_pass_fix-v4bx_to_ld.patch
deleted file mode 100644
index b9c9b161..00000000
--- a/toolchain/gcc/patches-8.x/840-armv4_pass_fix-v4bx_to_ld.patch
+++ /dev/null
@@ -1,28 +0,0 @@
-commit 7edc8ca5456d9743dd0075eb3cc5b04f4f24c8cc
-Author: Imre Kaloz <kaloz@openwrt.org>
-Date:   Wed Feb 2 19:34:36 2011 +0000
-
-    add armv4 fixup patches
-    
-    SVN-Revision: 25322
-
-
---- a/gcc/config/arm/linux-eabi.h
-+++ b/gcc/config/arm/linux-eabi.h
-@@ -88,10 +88,15 @@
- #define MUSL_DYNAMIC_LINKER \
-   "/lib/ld-musl-arm" MUSL_DYNAMIC_LINKER_E "%{mfloat-abi=hard:hf}.so.1"
- 
-+/* For armv4 we pass --fix-v4bx to linker to support EABI */
-+#undef TARGET_FIX_V4BX_SPEC
-+#define TARGET_FIX_V4BX_SPEC " %{mcpu=arm8|mcpu=arm810|mcpu=strongarm*"\
-+  "|march=armv4|mcpu=fa526|mcpu=fa626:--fix-v4bx}"
-+
- /* At this point, bpabi.h will have clobbered LINK_SPEC.  We want to
-    use the GNU/Linux version, not the generic BPABI version.  */
- #undef  LINK_SPEC
--#define LINK_SPEC EABI_LINK_SPEC					\
-+#define LINK_SPEC EABI_LINK_SPEC TARGET_FIX_V4BX_SPEC			\
-   LINUX_OR_ANDROID_LD (LINUX_TARGET_LINK_SPEC,				\
- 		       LINUX_TARGET_LINK_SPEC " " ANDROID_LINK_SPEC)
- 
diff --git a/toolchain/gcc/patches-8.x/850-use_shared_libgcc.patch b/toolchain/gcc/patches-8.x/850-use_shared_libgcc.patch
deleted file mode 100644
index f619f0e6..00000000
--- a/toolchain/gcc/patches-8.x/850-use_shared_libgcc.patch
+++ /dev/null
@@ -1,54 +0,0 @@
-commit dcfc40358b5a3cae7320c17f8d1cebd5ad5540cd
-Author: Felix Fietkau <nbd@openwrt.org>
-Date:   Sun Feb 12 20:25:47 2012 +0000
-
-    gcc 4.6: port over the missing patch 850-use_shared_libgcc.patch to prevent libgcc crap from leaking into every single binary
-    
-    SVN-Revision: 30486
---- a/gcc/config/arm/linux-eabi.h
-+++ b/gcc/config/arm/linux-eabi.h
-@@ -126,10 +126,6 @@
-   "%{Ofast|ffast-math|funsafe-math-optimizations:crtfastmath.o%s} "	\
-   LINUX_OR_ANDROID_LD (GNU_USER_TARGET_ENDFILE_SPEC, ANDROID_ENDFILE_SPEC)
- 
--/* Use the default LIBGCC_SPEC, not the version in linux-elf.h, as we
--   do not use -lfloat.  */
--#undef LIBGCC_SPEC
--
- /* Clear the instruction cache from `beg' to `end'.  This is
-    implemented in lib1funcs.S, so ensure an error if this definition
-    is used.  */
---- a/gcc/config/linux.h
-+++ b/gcc/config/linux.h
-@@ -53,6 +53,10 @@ see the files COPYING3 and COPYING.RUNTI
- 	builtin_assert ("system=posix");			\
-     } while (0)
- 
-+#ifndef LIBGCC_SPEC
-+#define LIBGCC_SPEC "%{static|static-libgcc:-lgcc}%{!static:%{!static-libgcc:-lgcc_s}}"
-+#endif
-+
- /* Determine which dynamic linker to use depending on whether GLIBC or
-    uClibc or Bionic or musl is the default C library and whether
-    -muclibc or -mglibc or -mbionic or -mmusl has been passed to change
---- a/libgcc/mkmap-symver.awk
-+++ b/libgcc/mkmap-symver.awk
-@@ -136,5 +136,5 @@ function output(lib) {
-   else if (inherit[lib])
-     printf("} %s;\n", inherit[lib]);
-   else
--    printf ("\n  local:\n\t*;\n};\n");
-+    printf ("\n\t*;\n};\n");
- }
---- a/gcc/config/rs6000/linux.h
-+++ b/gcc/config/rs6000/linux.h
-@@ -60,6 +60,9 @@
- #undef	CPP_OS_DEFAULT_SPEC
- #define CPP_OS_DEFAULT_SPEC "%(cpp_os_linux)"
- 
-+#undef LIBGCC_SPEC
-+#define LIBGCC_SPEC "%{!static:%{!static-libgcc:-lgcc_s}} -lgcc"
-+
- #undef  LINK_SHLIB_SPEC
- #define LINK_SHLIB_SPEC "%{shared:-shared} %{!shared: %{static:-static}} \
-   %{static-pie:-static -pie --no-dynamic-linker -z text}"
diff --git a/toolchain/gcc/patches-8.x/851-libgcc_no_compat.patch b/toolchain/gcc/patches-8.x/851-libgcc_no_compat.patch
deleted file mode 100644
index d710e407..00000000
--- a/toolchain/gcc/patches-8.x/851-libgcc_no_compat.patch
+++ /dev/null
@@ -1,22 +0,0 @@
-commit 64661de100da1ec1061ef3e5e400285dce115e6b
-Author: Felix Fietkau <nbd@openwrt.org>
-Date:   Sun May 10 13:16:35 2015 +0000
-
-    gcc: add some size optimization patches
-    
-    Signed-off-by: Felix Fietkau <nbd@openwrt.org>
-    
-    SVN-Revision: 45664
-
---- a/libgcc/config/t-libunwind
-+++ b/libgcc/config/t-libunwind
-@@ -2,8 +2,7 @@
- 
- HOST_LIBGCC2_CFLAGS += -DUSE_GAS_SYMVER
- 
--LIB2ADDEH = $(srcdir)/unwind-sjlj.c $(srcdir)/unwind-c.c \
--  $(srcdir)/unwind-compat.c $(srcdir)/unwind-dw2-fde-compat.c
-+LIB2ADDEH = $(srcdir)/unwind-sjlj.c $(srcdir)/unwind-c.c
- LIB2ADDEHSTATIC = $(srcdir)/unwind-sjlj.c $(srcdir)/unwind-c.c
- 
- # Override the default value from t-slibgcc-elf-ver and mention -lunwind
diff --git a/toolchain/gcc/patches-8.x/870-ppc_no_crtsavres.patch b/toolchain/gcc/patches-8.x/870-ppc_no_crtsavres.patch
deleted file mode 100644
index 51d11c3d..00000000
--- a/toolchain/gcc/patches-8.x/870-ppc_no_crtsavres.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/gcc/config/rs6000/rs6000.c
-+++ b/gcc/config/rs6000/rs6000.c
-@@ -24780,7 +24780,7 @@ rs6000_savres_strategy (rs6000_stack_t *
-   /* Define cutoff for using out-of-line functions to save registers.  */
-   if (DEFAULT_ABI == ABI_V4 || TARGET_ELF)
-     {
--      if (!optimize_size)
-+      if (1)
- 	{
- 	  strategy |= SAVE_INLINE_FPRS | REST_INLINE_FPRS;
- 	  strategy |= SAVE_INLINE_GPRS | REST_INLINE_GPRS;
diff --git a/toolchain/gcc/patches-8.x/881-no_tm_section.patch b/toolchain/gcc/patches-8.x/881-no_tm_section.patch
deleted file mode 100644
index fab5db3b..00000000
--- a/toolchain/gcc/patches-8.x/881-no_tm_section.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/libgcc/crtstuff.c
-+++ b/libgcc/crtstuff.c
-@@ -152,7 +152,7 @@ call_ ## FUNC (void)					\
- #endif
- 
- #if !defined(USE_TM_CLONE_REGISTRY) && defined(OBJECT_FORMAT_ELF)
--# define USE_TM_CLONE_REGISTRY 1
-+# define USE_TM_CLONE_REGISTRY 0
- #endif
- 
- /* We do not want to add the weak attribute to the declarations of these
diff --git a/toolchain/gcc/patches-8.x/900-bad-mips16-crt.patch b/toolchain/gcc/patches-8.x/900-bad-mips16-crt.patch
deleted file mode 100644
index dd6e9dc8..00000000
--- a/toolchain/gcc/patches-8.x/900-bad-mips16-crt.patch
+++ /dev/null
@@ -1,9 +0,0 @@
---- a/libgcc/config/mips/t-mips16
-+++ b/libgcc/config/mips/t-mips16
-@@ -43,3 +43,6 @@ SYNC_CFLAGS = -mno-mips16
- 
- # Version these symbols if building libgcc.so.
- SHLIB_MAPFILES += $(srcdir)/config/mips/libgcc-mips16.ver
-+
-+CRTSTUFF_T_CFLAGS += -mno-mips16
-+CRTSTUFF_T_CFLAGS_S += -mno-mips16
diff --git a/toolchain/gcc/patches-8.x/910-mbsd_multi.patch b/toolchain/gcc/patches-8.x/910-mbsd_multi.patch
deleted file mode 100644
index c566ea35..00000000
--- a/toolchain/gcc/patches-8.x/910-mbsd_multi.patch
+++ /dev/null
@@ -1,146 +0,0 @@
-commit 99368862e44740ff4fd33760893f04e14f9dbdf1
-Author: Felix Fietkau <nbd@openwrt.org>
-Date:   Tue Jul 31 00:52:27 2007 +0000
-
-    Port the mbsd_multi patch from freewrt, which adds -fhonour-copts. This will emit warnings in packages that don't use our target cflags properly
-    
-    SVN-Revision: 8256
-
-	This patch brings over a feature from MirBSD:
-	* -fhonour-copts
-	  If this option is not given, it's warned (depending
-	  on environment variables). This is to catch errors
-	  of misbuilt packages which override CFLAGS themselves.
-
-	This patch was authored by Thorsten Glaser <tg at mirbsd.de>
-	with copyright assignment to the FSF in effect.
-
---- a/gcc/c-family/c-opts.c
-+++ b/gcc/c-family/c-opts.c
-@@ -107,6 +107,9 @@ static dump_flags_t original_dump_flags;
- /* Whether any standard preincluded header has been preincluded.  */
- static bool done_preinclude;
- 
-+/* Check if a port honours COPTS.  */
-+static int honour_copts = 0;
-+
- static void handle_OPT_d (const char *);
- static void set_std_cxx98 (int);
- static void set_std_cxx11 (int);
-@@ -459,6 +462,12 @@ c_common_handle_option (size_t scode, co
-       flag_no_builtin = !value;
-       break;
- 
-+    case OPT_fhonour_copts:
-+      if (c_language == clk_c) {
-+        honour_copts++;
-+      }
-+      break;
-+
-     case OPT_fconstant_string_class_:
-       constant_string_class_name = arg;
-       break;
-@@ -1125,6 +1134,47 @@ c_common_init (void)
-       return false;
-     }
- 
-+  if (c_language == clk_c) {
-+    char *ev = getenv ("GCC_HONOUR_COPTS");
-+    int evv;
-+    if (ev == NULL)
-+      evv = -1;
-+    else if ((*ev == '0') || (*ev == '\0'))
-+      evv = 0;
-+    else if (*ev == '1')
-+      evv = 1;
-+    else if (*ev == '2')
-+      evv = 2;
-+    else if (*ev == 's')
-+      evv = -1;
-+    else {
-+      warning (0, "unknown GCC_HONOUR_COPTS value, assuming 1");
-+      evv = 1; /* maybe depend this on something like MIRBSD_NATIVE?  */
-+    }
-+    if (evv == 1) {
-+      if (honour_copts == 0) {
-+        error ("someone does not honour COPTS at all in lenient mode");
-+        return false;
-+      } else if (honour_copts != 1) {
-+        warning (0, "someone does not honour COPTS correctly, passed %d times",
-+         honour_copts);
-+      }
-+    } else if (evv == 2) {
-+      if (honour_copts == 0) {
-+        error ("someone does not honour COPTS at all in strict mode");
-+        return false;
-+      } else if (honour_copts != 1) {
-+        error ("someone does not honour COPTS correctly, passed %d times",
-+         honour_copts);
-+        return false;
-+      }
-+    } else if (evv == 0) {
-+      if (honour_copts != 1)
-+        inform (UNKNOWN_LOCATION, "someone does not honour COPTS correctly, passed %d times",
-+         honour_copts);
-+    }
-+  }
-+
-   return true;
- }
- 
---- a/gcc/c-family/c.opt
-+++ b/gcc/c-family/c.opt
-@@ -1469,6 +1469,9 @@ C++ ObjC++ Optimization Alias(fexception
- fhonor-std
- C++ ObjC++ Ignore Warn(switch %qs is no longer supported)
- 
-+fhonour-copts
-+C ObjC C++ ObjC++ RejectNegative
-+
- fhosted
- C ObjC
- Assume normal C execution environment.
---- a/gcc/common.opt
-+++ b/gcc/common.opt
-@@ -1551,6 +1551,9 @@ fguess-branch-probability
- Common Report Var(flag_guess_branch_prob) Optimization
- Enable guessing of branch probabilities.
- 
-+fhonour-copts
-+Common RejectNegative
-+
- ; Nonzero means ignore `#ident' directives.  0 means handle them.
- ; Generate position-independent code for executables if possible
- ; On SVR4 targets, it also controls whether or not to emit a
---- a/gcc/opts.c
-+++ b/gcc/opts.c
-@@ -2073,6 +2073,9 @@ common_handle_option (struct gcc_options
- 			       opts, opts_set, loc, dc);
-       break;
- 
-+    case OPT_fhonour_copts:
-+      break;
-+
-     case OPT_Wlarger_than_:
-       opts->x_larger_than_size = value;
-       opts->x_warn_larger_than = value != -1;
---- a/gcc/doc/invoke.texi
-+++ b/gcc/doc/invoke.texi
-@@ -7013,6 +7013,17 @@ This option is only supported for C and
- @option{-Wall} and by @option{-Wpedantic}, which can be disabled with
- @option{-Wno-pointer-sign}.
- 
-+@item -fhonour-copts
-+@opindex fhonour-copts
-+If @env{GCC_HONOUR_COPTS} is set to 1, abort if this option is not
-+given at least once, and warn if it is given more than once.
-+If @env{GCC_HONOUR_COPTS} is set to 2, abort if this option is not
-+given exactly once.
-+If @env{GCC_HONOUR_COPTS} is set to 0 or unset, warn if this option
-+is not given exactly once.
-+The warning is quelled if @env{GCC_HONOUR_COPTS} is set to @samp{s}.
-+This flag and environment variable only affect the C language.
-+
- @item -Wstack-protector
- @opindex Wstack-protector
- @opindex Wno-stack-protector
diff --git a/toolchain/gcc/patches-8.x/920-specs_nonfatal_getenv.patch b/toolchain/gcc/patches-8.x/920-specs_nonfatal_getenv.patch
deleted file mode 100644
index c3836e63..00000000
--- a/toolchain/gcc/patches-8.x/920-specs_nonfatal_getenv.patch
+++ /dev/null
@@ -1,22 +0,0 @@
-Author: Jo-Philipp Wich <jow@openwrt.org>
-Date:   Sat Apr 21 03:02:39 2012 +0000
-
-    gcc: add patch to make the getenv() spec function nonfatal if requested environment variable is unset
-    
-    SVN-Revision: 31390
-
---- a/gcc/gcc.c
-+++ b/gcc/gcc.c
-@@ -9347,8 +9347,10 @@ getenv_spec_function (int argc, const ch
-     value = varname;
- 
-   if (!value)
--    fatal_error (input_location,
--		 "environment variable %qs not defined", varname);
-+    {
-+      warning (input_location, "environment variable %qs not defined", varname);
-+      value = "";
-+    }
- 
-   /* We have to escape every character of the environment variable so
-      they are not interpreted as active spec characters.  A
diff --git a/toolchain/gcc/patches-8.x/930-fix-mips-noexecstack.patch b/toolchain/gcc/patches-8.x/930-fix-mips-noexecstack.patch
deleted file mode 100644
index ed8ada22..00000000
--- a/toolchain/gcc/patches-8.x/930-fix-mips-noexecstack.patch
+++ /dev/null
@@ -1,111 +0,0 @@
-From da45b3fde60095756f5f6030f6012c23a3d34429 Mon Sep 17 00:00:00 2001
-From: Andrew McDonnell <bugs@andrewmcdonnell.net>
-Date: Fri, 3 Oct 2014 19:09:00 +0930
-Subject: Add .note.GNU-stack section
-
-See http://lists.busybox.net/pipermail/uclibc/2014-October/048671.html
-Below copied from https://gcc.gnu.org/ml/gcc-patches/2014-09/msg02430.html
-
-Re: [Patch, MIPS] Add .note.GNU-stack section
-
-    From: Steve Ellcey <sellcey at mips dot com>
-
-On Wed, 2014-09-10 at 10:15 -0700, Eric Christopher wrote:
->
->
-> On Wed, Sep 10, 2014 at 9:27 AM, <pinskia@gmail.com> wrote:
-
->         This works except you did not update the assembly files in
->         libgcc or glibc. We (Cavium) have the same patch in our tree
->         for a few released versions.
-
-> Mind just checking yours in then Andrew?
-
-> Thanks!
-> -eric
-
-I talked to Andrew about what files he changed in GCC and created and
-tested this new patch.  Andrew also mentioned changing some assembly
-files in glibc but I don't see any use of '.section .note.GNU-stack' in
-any assembly files in glibc (for any platform) so I wasn't planning on
-creating a glibc to add them to mips glibc assembly language files.
-
-OK to check in this patch?
-
-Steve Ellcey
-sellcey@mips.com
-
-
-
-2014-09-26  Steve Ellcey  <sellcey@mips.com>
----
- gcc/config/mips/mips.c          | 3 +++
- libgcc/config/mips/crti.S       | 4 ++++
- libgcc/config/mips/crtn.S       | 3 +++
- libgcc/config/mips/mips16.S     | 4 ++++
- libgcc/config/mips/vr4120-div.S | 4 ++++
- 5 files changed, 18 insertions(+)
-
---- a/gcc/config/mips/mips.c
-+++ b/gcc/config/mips/mips.c
-@@ -22640,6 +22640,9 @@ mips_starting_frame_offset (void)
- #undef TARGET_STARTING_FRAME_OFFSET
- #define TARGET_STARTING_FRAME_OFFSET mips_starting_frame_offset
- 
-+#undef TARGET_ASM_FILE_END
-+#define TARGET_ASM_FILE_END file_end_indicate_exec_stack
-+
- struct gcc_target targetm = TARGET_INITIALIZER;
- 
- #include "gt-mips.h"
---- a/libgcc/config/mips/crti.S
-+++ b/libgcc/config/mips/crti.S
-@@ -21,6 +21,10 @@ a copy of the GCC Runtime Library Except
- see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see
- <http://www.gnu.org/licenses/>.  */
- 
-+
-+/* An executable stack is *not* required for these functions.  */
-+	.section .note.GNU-stack,"",%progbits
-+
- /* 4 slots for argument spill area.  1 for cpreturn, 1 for stack.
-    Return spill offset of 40 and 20.  Aligned to 16 bytes for n32.  */
- 
---- a/libgcc/config/mips/crtn.S
-+++ b/libgcc/config/mips/crtn.S
-@@ -21,6 +21,9 @@ a copy of the GCC Runtime Library Except
- see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see
- <http://www.gnu.org/licenses/>.  */
- 
-+/* An executable stack is *not* required for these functions.  */
-+	.section .note.GNU-stack,"",%progbits
-+
- /* 4 slots for argument spill area.  1 for cpreturn, 1 for stack.
-    Return spill offset of 40 and 20.  Aligned to 16 bytes for n32.  */
- 
---- a/libgcc/config/mips/mips16.S
-+++ b/libgcc/config/mips/mips16.S
-@@ -48,6 +48,10 @@ see the files COPYING3 and COPYING.RUNTI
-    values using the soft-float calling convention, but do the actual
-    operation using the hard floating point instructions.  */
- 
-+/* An executable stack is *not* required for these functions.  */
-+	.section .note.GNU-stack,"",%progbits
-+	.previous
-+
- #if defined _MIPS_SIM && (_MIPS_SIM == _ABIO32 || _MIPS_SIM == _ABIO64)
- 
- /* This file contains 32-bit assembly code.  */
---- a/libgcc/config/mips/vr4120-div.S
-+++ b/libgcc/config/mips/vr4120-div.S
-@@ -26,6 +26,10 @@ see the files COPYING3 and COPYING.RUNTI
-    -mfix-vr4120.  div and ddiv do not give the correct result when one
-    of the operands is negative.  */
- 
-+/* An executable stack is *not* required for these functions.  */
-+	.section .note.GNU-stack,"",%progbits
-+	.previous
-+
- 	.set	nomips16
- 
- #define DIV								\
diff --git a/toolchain/gcc/patches-8.x/931-libffi-fix-MIPS-softfloat-build-issue.patch b/toolchain/gcc/patches-8.x/931-libffi-fix-MIPS-softfloat-build-issue.patch
deleted file mode 100644
index fb4cb153..00000000
--- a/toolchain/gcc/patches-8.x/931-libffi-fix-MIPS-softfloat-build-issue.patch
+++ /dev/null
@@ -1,168 +0,0 @@
-From c0c62fa4256f805389f16ebfc4a60cf789129b50 Mon Sep 17 00:00:00 2001
-From: BangLang Huang <banglang.huang@foxmail.com>
-Date: Wed, 9 Nov 2016 10:36:49 +0800
-Subject: [PATCH] libffi: fix MIPS softfloat build issue
-
-Backported from github.com/libffi/libffi#272
-
-Signed-off-by: BangLang Huang <banglang.huang@foxmail.com>
-Signed-off-by: Yousong Zhou <yszhou4tech@gmail.com>
----
- libffi/src/mips/n32.S | 17 +++++++++++++++++
- libffi/src/mips/o32.S | 17 +++++++++++++++++
- 2 files changed, 34 insertions(+)
-
---- a/libffi/src/mips/n32.S
-+++ b/libffi/src/mips/n32.S
-@@ -107,6 +107,16 @@ loadregs:
- 
- 	REG_L	t6, 3*FFI_SIZEOF_ARG($fp)  # load the flags word into t6.
- 
-+#ifdef __mips_soft_float
-+	REG_L	a0, 0*FFI_SIZEOF_ARG(t9)
-+	REG_L	a1, 1*FFI_SIZEOF_ARG(t9)
-+	REG_L	a2, 2*FFI_SIZEOF_ARG(t9)
-+	REG_L	a3, 3*FFI_SIZEOF_ARG(t9)
-+	REG_L	a4, 4*FFI_SIZEOF_ARG(t9)
-+	REG_L	a5, 5*FFI_SIZEOF_ARG(t9)
-+	REG_L	a6, 6*FFI_SIZEOF_ARG(t9)
-+	REG_L	a7, 7*FFI_SIZEOF_ARG(t9)
-+#else
- 	and	t4, t6, ((1<<FFI_FLAG_BITS)-1)
- 	REG_L	a0, 0*FFI_SIZEOF_ARG(t9)
- 	beqz	t4, arg1_next
-@@ -193,6 +203,7 @@ arg7_next:
- arg8_doublep:	
-  	l.d	$f19, 7*FFI_SIZEOF_ARG(t9)	
- arg8_next:	
-+#endif
- 
- callit:		
- 	# Load the function pointer
-@@ -214,6 +225,7 @@ retint:
- 	b	epilogue
- 
- retfloat:
-+#ifndef __mips_soft_float
- 	bne     t6, FFI_TYPE_FLOAT, retdouble
- 	jal	t9
- 	REG_L	t4, 4*FFI_SIZEOF_ARG($fp)
-@@ -272,6 +284,7 @@ retstruct_f_d:
- 	s.s	$f0, 0(t4)
- 	s.d	$f2, 8(t4)
- 	b	epilogue
-+#endif
- 
- retstruct_d_soft:
- 	bne	t6, FFI_TYPE_STRUCT_D_SOFT, retstruct_f_soft
-@@ -429,6 +442,7 @@ ffi_closure_N32:
- 	REG_S	a6, A6_OFF2($sp)
- 	REG_S	a7, A7_OFF2($sp)
- 
-+#ifndef __mips_soft_float
- 	# Store all possible float/double registers.
- 	s.d	$f12, F12_OFF2($sp)
- 	s.d	$f13, F13_OFF2($sp)
-@@ -438,6 +452,7 @@ ffi_closure_N32:
- 	s.d	$f17, F17_OFF2($sp)
- 	s.d	$f18, F18_OFF2($sp)
- 	s.d	$f19, F19_OFF2($sp)
-+#endif
- 
- 	# Call ffi_closure_mips_inner_N32 to do the real work.
- 	LA	t9, ffi_closure_mips_inner_N32
-@@ -458,6 +473,7 @@ cls_retint:
- 	b	cls_epilogue
- 
- cls_retfloat:
-+#ifndef __mips_soft_float
- 	bne     v0, FFI_TYPE_FLOAT, cls_retdouble
- 	l.s	$f0, V0_OFF2($sp)
- 	b	cls_epilogue
-@@ -500,6 +516,7 @@ cls_retstruct_f_d:
- 	l.s	$f0, V0_OFF2($sp)
- 	l.d	$f2, V1_OFF2($sp)
- 	b	cls_epilogue
-+#endif
- 	
- cls_retstruct_small2:	
- 	REG_L	v0, V0_OFF2($sp)
---- a/libffi/src/mips/o32.S
-+++ b/libffi/src/mips/o32.S
-@@ -82,13 +82,16 @@ sixteen:
- 		
- 	ADDU	$sp, 4 * FFI_SIZEOF_ARG		# adjust $sp to new args
- 
-+#ifndef __mips_soft_float
- 	bnez	t0, pass_d			# make it quick for int
-+#endif
- 	REG_L	a0, 0*FFI_SIZEOF_ARG($sp)	# just go ahead and load the
- 	REG_L	a1, 1*FFI_SIZEOF_ARG($sp)	# four regs.
- 	REG_L	a2, 2*FFI_SIZEOF_ARG($sp)
- 	REG_L	a3, 3*FFI_SIZEOF_ARG($sp)
- 	b	call_it
- 
-+#ifndef __mips_soft_float
- pass_d:
- 	bne	t0, FFI_ARGS_D, pass_f
- 	l.d	$f12, 0*FFI_SIZEOF_ARG($sp)	# load $fp regs from args
-@@ -130,6 +133,7 @@ pass_f_d:
-  #	bne	t0, FFI_ARGS_F_D, call_it
- 	l.s	$f12, 0*FFI_SIZEOF_ARG($sp)	# load $fp regs from args
- 	l.d	$f14, 2*FFI_SIZEOF_ARG($sp)	# passing double and float
-+#endif
- 
- call_it:	
- 	# Load the function pointer
-@@ -158,14 +162,23 @@ retfloat:
- 	bne     t2, FFI_TYPE_FLOAT, retdouble
- 	jalr	t9
- 	REG_L	t0, SIZEOF_FRAME + 4*FFI_SIZEOF_ARG($fp)
-+#ifndef __mips_soft_float
- 	s.s	$f0, 0(t0)
-+#else
-+	REG_S v0, 0(t0)
-+#endif
- 	b	epilogue
- 
- retdouble:	
- 	bne	t2, FFI_TYPE_DOUBLE, noretval
- 	jalr	t9
- 	REG_L	t0, SIZEOF_FRAME + 4*FFI_SIZEOF_ARG($fp)
-+#ifndef __mips_soft_float
- 	s.d	$f0, 0(t0)
-+#else
-+	REG_S v1, 4(t0)
-+	REG_S v0, 0(t0)
-+#endif
- 	b	epilogue
- 	
- noretval:	
-@@ -261,9 +274,11 @@ $LCFI7:
- 	li	$13, 1		# FFI_O32
- 	bne	$16, $13, 1f	# Skip fp save if FFI_O32_SOFT_FLOAT
- 	
-+#ifndef __mips_soft_float
- 	# Store all possible float/double registers.
- 	s.d	$f12, FA_0_0_OFF2($fp)
- 	s.d	$f14, FA_1_0_OFF2($fp)
-+#endif
- 1:	
- 	# Call ffi_closure_mips_inner_O32 to do the work.
- 	la	t9, ffi_closure_mips_inner_O32
-@@ -281,6 +296,7 @@ $LCFI7:
- 	li	$13, 1		# FFI_O32
- 	bne	$16, $13, 1f	# Skip fp restore if FFI_O32_SOFT_FLOAT
- 
-+#ifndef __mips_soft_float
- 	li	$9, FFI_TYPE_FLOAT
- 	l.s	$f0, V0_OFF2($fp)
- 	beq	$8, $9, closure_done
-@@ -288,6 +304,7 @@ $LCFI7:
- 	li	$9, FFI_TYPE_DOUBLE
- 	l.d	$f0, V0_OFF2($fp)
- 	beq	$8, $9, closure_done
-+#endif
- 1:	
- 	REG_L	$3, V1_OFF2($fp)
- 	REG_L	$2, V0_OFF2($fp)
diff --git a/toolchain/gcc/patches-8.x/960-gotools-fix-compilation-when-making-cross-compiler.patch b/toolchain/gcc/patches-8.x/960-gotools-fix-compilation-when-making-cross-compiler.patch
deleted file mode 100644
index 1dd05080..00000000
--- a/toolchain/gcc/patches-8.x/960-gotools-fix-compilation-when-making-cross-compiler.patch
+++ /dev/null
@@ -1,67 +0,0 @@
-From dda6b050cd74a352670787a294596a9c56c21327 Mon Sep 17 00:00:00 2001
-From: Yousong Zhou <yszhou4tech@gmail.com>
-Date: Fri, 4 May 2018 18:20:53 +0800
-Subject: [PATCH] gotools: fix compilation when making cross compiler
-
-libgo is "the runtime support library for the Go programming language.
-This library is intended for use with the Go frontend."
-
-gccgo will link target files with libgo.so which depends on libgcc_s.so.1, but
-the linker will complain that it cannot find it.  That's because shared libgcc
-is not present in the install directory yet.  libgo.so was made without problem
-because gcc will emit -lgcc_s when compiled with -shared option.  When gotools
-were being made, it was supplied with -static-libgcc thus no link option was
-provided.  Check LIBGO in gcc/go/gcc-spec.c for how gccgo make a builtin spec
-for linking with libgo.so
-
-- GccgoCrossCompilation, https://github.com/golang/go/wiki/GccgoCrossCompilation
-- Cross-building instructions, http://www.eglibc.org/archives/patches/msg00078.html
-
-When 3-pass GCC compilation is used, shared libgcc runtime libraries will be
-available after gcc pass2 completed and will meet the gotools link requirement
-at gcc pass3
----
- gotools/Makefile.am | 4 +++-
- gotools/Makefile.in | 4 +++-
- 2 files changed, 6 insertions(+), 2 deletions(-)
-
---- a/gotools/Makefile.am
-+++ b/gotools/Makefile.am
-@@ -26,6 +26,7 @@ PWD_COMMAND = $${PWDCMD-pwd}
- STAMP = echo timestamp >
- 
- libgodir = ../$(target_noncanonical)/libgo
-+libgccdir = ../$(target_noncanonical)/libgcc
- LIBGODEP = $(libgodir)/libgo.la
- 
- LIBGOTOOL = $(libgodir)/libgotool.a
-@@ -41,7 +42,8 @@ GOCFLAGS = $(CFLAGS_FOR_TARGET)
- GOCOMPILE = $(GOCOMPILER) $(GOCFLAGS)
- 
- AM_GOCFLAGS = -I $(libgodir)
--AM_LDFLAGS = -L $(libgodir) -L $(libgodir)/.libs
-+AM_LDFLAGS = -L $(libgodir) -L $(libgodir)/.libs \
-+	-L $(libgccdir) -L $(libgccdir)/.libs -lgcc_s
- GOLINK = $(GOCOMPILER) $(GOCFLAGS) $(AM_GOCFLAGS) $(LDFLAGS) $(AM_LDFLAGS) -o $@
- 
- libgosrcdir = $(srcdir)/../libgo/go
---- a/gotools/Makefile.in
-+++ b/gotools/Makefile.in
-@@ -263,6 +263,7 @@ mkinstalldirs = $(SHELL) $(toplevel_srcd
- PWD_COMMAND = $${PWDCMD-pwd}
- STAMP = echo timestamp >
- libgodir = ../$(target_noncanonical)/libgo
-+libgccdir = ../$(target_noncanonical)/libgcc
- LIBGODEP = $(libgodir)/libgo.la
- LIBGOTOOL = $(libgodir)/libgotool.a
- @NATIVE_FALSE@GOCOMPILER = $(GOC)
-@@ -271,7 +272,8 @@ LIBGOTOOL = $(libgodir)/libgotool.a
- @NATIVE_TRUE@GOCOMPILER = $(GOC_FOR_TARGET) $(XGCC_FLAGS_FOR_TARGET)
- GOCOMPILE = $(GOCOMPILER) $(GOCFLAGS)
- AM_GOCFLAGS = -I $(libgodir)
--AM_LDFLAGS = -L $(libgodir) -L $(libgodir)/.libs
-+AM_LDFLAGS = -L $(libgodir) -L $(libgodir)/.libs \
-+	-L $(libgccdir) -L $(libgccdir)/.libs -lgcc_s
- GOLINK = $(GOCOMPILER) $(GOCFLAGS) $(AM_GOCFLAGS) $(LDFLAGS) $(AM_LDFLAGS) -o $@
- libgosrcdir = $(srcdir)/../libgo/go
- cmdsrcdir = $(libgosrcdir)/cmd
diff --git a/toolchain/gcc/patches-8.x/999-fix-apple-silicon-support.patch b/toolchain/gcc/patches-8.x/999-fix-apple-silicon-support.patch
deleted file mode 100644
index 5e8d84f3..00000000
--- a/toolchain/gcc/patches-8.x/999-fix-apple-silicon-support.patch
+++ /dev/null
@@ -1,30 +0,0 @@
-diff -ru a/gcc/config/host-darwin.c b/gcc/config/host-darwin.c
---- a/gcc/config/host-darwin.c	2021-05-14 10:42:08.000000000 +0200
-+++ b/gcc/config/host-darwin.c	2021-08-07 22:51:11.000000000 +0200
-@@ -22,6 +22,8 @@
- #include "coretypes.h"
- #include "diagnostic-core.h"
- #include "config/host-darwin.h"
-+#include "hosthooks.h"
-+#include "hosthooks-def.h"
- 
- /* Yes, this is really supposed to work.  */
- static char pch_address_space[1024*1024*1024] __attribute__((aligned (4096)));
-@@ -75,3 +77,5 @@
- 
-   return ret;
- }
-+
-+const struct host_hooks host_hooks = HOST_HOOKS_INITIALIZER;
-diff -ru a/gcc/config/aarch64/aarch64.h b/gcc/config/aarch64/aarch64.h
---- a/gcc/config/aarch64/aarch64.h  2021-05-14 10:42:08.000000000 +0200
-+++ b/gcc/config/aarch64/aarch64.h  2021-08-10 00:54:13.000000000 +0200
-@@ -1013,7 +1013,7 @@
- #define MCPU_TO_MARCH_SPEC_FUNCTIONS \
-   { "rewrite_mcpu", aarch64_rewrite_mcpu },
- 
--#if defined(__aarch64__)
-+#if defined(__aarch64__) && ! defined(__APPLE__)
- extern const char *host_detect_local_cpu (int argc, const char **argv);
- #define HAVE_LOCAL_CPU_DETECT
- # define EXTRA_SPEC_FUNCTIONS                  \
\ No newline at end of file
diff --git a/tools/dwarves/Makefile b/tools/dwarves/Makefile
index bcb16dd3..53461267 100644
--- a/tools/dwarves/Makefile
+++ b/tools/dwarves/Makefile
@@ -3,12 +3,12 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=dwarves
-PKG_VERSION:=1.27
+PKG_VERSION:=1.28
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.bz2
 PKG_SOURCE_URL:=https://fedorapeople.org/~acme/dwarves/
-PKG_HASH:=ef7f21f1c6016896d03a01f05cab225151f9068e19cc8cddc6e754b2b5cbe279
+PKG_HASH:=826efc0fc9237d3c1e9c01553ea387a8cb46e8dc119ff863889043f4ed54b2ae
 
 PKG_MAINTAINER:=Tony Ambardar <itugrok@yahoo.com>
 PKG_LICENSE:=GPL-2.0-only
diff --git a/tools/dwarves/patches/100-reproducible-builds.patch b/tools/dwarves/patches/100-reproducible-builds.patch
index 15bddd56..d8cbd114 100644
--- a/tools/dwarves/patches/100-reproducible-builds.patch
+++ b/tools/dwarves/patches/100-reproducible-builds.patch
@@ -1,6 +1,6 @@
 --- a/pahole.c
 +++ b/pahole.c
-@@ -3723,6 +3723,9 @@ int main(int argc, char *argv[])
+@@ -3681,6 +3681,9 @@ int main(int argc, char *argv[])
  		goto out;
  	}
  
